<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ConfigMap文件存储</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-7-ConfigMap%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-7-ConfigMap%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="文件存储ConfigMap"><a href="#文件存储ConfigMap" class="headerlink" title="文件存储ConfigMap"></a>文件存储ConfigMap</h2><h3 id="1-为什么要用configMap？"><a href="#1-为什么要用configMap？" class="headerlink" title="1.为什么要用configMap？"></a>1.为什么要用configMap？</h3><ol><li><p>将配置文件和POD解耦 </p></li><li><p>可以修改配置文件  如：/etc/nginx/nginx.conf /etc/php-fpm.d/www.conf </p></li><li><p>可以增加配置文件  如：/etc/nginx/conf.d/blog.zls.com.conf</p></li></ol><h3 id="2-ConfigMap如何存储配置文件？"><a href="#2-ConfigMap如何存储配置文件？" class="headerlink" title="2.ConfigMap如何存储配置文件？"></a>2.ConfigMap如何存储配置文件？</h3><ol><li>键值对存储         key:value </li><li>文件存储             文件名:配置文件内容</li></ol><h3 id="3-ConfigMap支持的配置类型？"><a href="#3-ConfigMap支持的配置类型？" class="headerlink" title="3.ConfigMap支持的配置类型？"></a>3.ConfigMap支持的配置类型？</h3><ol><li><p>直接定义key:value键值对 </p></li><li><p>基于文件创建键值对</p></li></ol><h3 id="4-ConfigMap创建方式"><a href="#4-ConfigMap创建方式" class="headerlink" title="4.ConfigMap创建方式"></a>4.ConfigMap创建方式</h3><ol><li><p>命令行创建 </p></li><li><p>资源清单创建</p></li></ol><h3 id="5-如何将ConfigMap存储到POD中"><a href="#5-如何将ConfigMap存储到POD中" class="headerlink" title="5.如何将ConfigMap存储到POD中"></a>5.如何将ConfigMap存储到POD中</h3><ol><li><p>通过变量传递 </p></li><li><p>通过数据卷挂载</p></li></ol><h3 id="6-使用configMap的限制条件"><a href="#6-使用configMap的限制条件" class="headerlink" title="6.使用configMap的限制条件"></a>6.使用configMap的限制条件</h3><ol><li><p>ConfigMap必须在Pod之前创建，Pod才能引用他 </p></li><li><p>ConfigMap受限于命名空间限制，只有处于同一个命名空间中的Pod才可以被引用</p></li></ol><h2 id="ConfigMap创建"><a href="#ConfigMap创建" class="headerlink" title="ConfigMap创建"></a>ConfigMap创建</h2><h3 id="命令行创建ConfigMap"><a href="#命令行创建ConfigMap" class="headerlink" title="命令行创建ConfigMap"></a>命令行创建ConfigMap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式</span></span><br><span class="line">kubectl create configmap NAME [--from-file=[key=]<span class="built_in">source</span>] [--from-literal=key1=value1] [--dry-run=server|client|none]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 命令行定义变量</span></span><br><span class="line">kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=www.zls.com</span><br><span class="line"></span><br><span class="line">create configmap// 创建configmap</span><br><span class="line">nginx-config// configmap名字</span><br><span class="line">--from-literal// 定义变量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看ConfigMap</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get cm</span></span><br><span class="line">NAME DATA AGE</span><br><span class="line">nginx-config 2 6s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看ConfigMap详细信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe cm nginx-config</span></span><br></pre></td></tr></table></figure><p><strong>POD引用变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-cm</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: ZLS_NGINX_PORT</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: nginx-config</span><br><span class="line">          key: nginx_port</span><br><span class="line">    - name: SERVER_NAME</span><br><span class="line">      valueFrom:</span><br><span class="line">        configMapKeyRef:</span><br><span class="line">          name: nginx-config</span><br><span class="line">          key: server_name</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616174404106.png" alt="image-20230616174404106"></p><p><strong>关键参数解析</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 关键参数</span></span><br><span class="line"></span><br><span class="line">valueFrom: 引用变量</span><br><span class="line">configMapKeyRef: 引用congfigmap</span><br><span class="line">name: nginx-config 引用的congfigmap名称</span><br><span class="line">key: nginx_port 应用congfigmap里的具体的key</span><br></pre></td></tr></table></figure><p><strong>构建环境变量的镜像</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 使用环境变量渲染配置文件</span></span><br><span class="line">envsubst <span class="string">&#x27;$&#123;HOME&#125;,$&#123;PATH&#125;&#x27;</span> &lt; cjavapy.txt &gt; cjavapy1.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wordpress：</span><br><span class="line">-e WORDPRESS_DB_HOST=...</span><br><span class="line">-e WORDPRESS_DB_USER=...</span><br><span class="line">-e WORDPRESS_DB_PASSWORD=...</span><br><span class="line">-e WORDPRESS_DB_NAME=...</span><br><span class="line">-e WORDPRESS_TABLE_PREFIX=...</span><br><span class="line"></span><br><span class="line"><span class="comment">## 构建一个带环境变量的镜像</span></span><br><span class="line">FROM centos:7</span><br><span class="line">RUN <span class="built_in">rm</span> -f /etc/yum.repos.d/* &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; \</span><br><span class="line">yum install -y gettext nginx &amp;&amp; \</span><br><span class="line">yum clean all &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -f /etc/yum.repos.d/*</span><br><span class="line">COPY wp-config-docker.php /</span><br><span class="line">COPY start.sh /start.sh</span><br><span class="line">CMD [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat start.sh</span></span><br><span class="line">envsubst <span class="string">&#x27;$WP_USER,$WP_DB,$WP_PASS&#x27;</span> &lt; /wp-config-docker.php &gt; /wp-config.php</span><br><span class="line">/sbin/nginx -g <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat wp-config-docker.php</span></span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, getenv_docker(<span class="string">&#x27;WORDPRESS_DB_NAME&#x27;</span>, <span class="string">&quot;<span class="variable">$WP_DB</span>&quot;</span>) );</span><br><span class="line">/** Database username */</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, getenv_docker(<span class="string">&#x27;WORDPRESS_DB_USER&#x27;</span>, <span class="string">&quot;<span class="variable">$WP_USER</span>&quot;</span>) );</span><br><span class="line">/** Database password */</span><br><span class="line">define( <span class="string">&#x27;DB_PASSWORD&#x27;</span>, getenv_docker(<span class="string">&#x27;WORDPRESS_DB_PASSWORD&#x27;</span>, <span class="string">&quot;<span class="variable">$WP_PASS</span>&quot;</span>) );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打镜像</span></span><br><span class="line">docker build -t wordpress:v1 .</span><br></pre></td></tr></table></figure><p><strong>查看pod是否引入了变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it nginx-cm /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo $&#123;NGINX_PORT&#125;</span></span><br><span class="line">80</span><br><span class="line"><span class="comment"># echo $&#123;SERVER_NAME&#125;</span></span><br><span class="line">www.zls.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># printenv |egrep &quot;NGINX_PORT|SERVER_NAME&quot;</span></span><br><span class="line">NGINX_PORT=80</span><br><span class="line">SERVER_NAME=www.zls.com</span><br></pre></td></tr></table></figure><p><strong>注意</strong></p><ol><li>变量传递的形式，修改confMap的配置，POD内并不会生效 </li><li>因为变量只有在创建POD的时候才会引用生效，POD一旦创建好，环境变量就不变了</li></ol><h3 id="配置文件创建ConfigMap"><a href="#配置文件创建ConfigMap" class="headerlink" title="配置文件创建ConfigMap"></a>配置文件创建ConfigMap</h3><p><strong>手动准备ConfigMap</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建配置文件</span></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name www.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/www;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.命令行创建资源</span></span><br><span class="line"><span class="comment"># kubectl create configmap nginx-blog --from-file=blog.conf=./blog.zls.com.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查看cm资源</span></span><br><span class="line"><span class="comment"># kubectl describe cm nginx-blog</span></span><br><span class="line">Name: nginx-blog</span><br><span class="line">Namespace: default</span><br><span class="line">Labels: &lt;none&gt;</span><br><span class="line">Annotations: &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">blog.conf:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name www.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/www;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Events: &lt;none&gt;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">4.<span class="comment"># 在线修改配置文件</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>POD挂载数据卷</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-cm</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:1.14.0</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: nginx-www</span><br><span class="line">      mountPath: /etc/nginx/conf.d/</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-www</span><br><span class="line">    configMap:</span><br><span class="line">      name: nginx-www</span><br><span class="line">      items:</span><br><span class="line">      - key: www.conf</span><br><span class="line">        path: www.conf</span><br></pre></td></tr></table></figure><p><strong>在线修改配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm nginx-blog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是无法控制重启，需要手动重启</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616181024741.png" alt="image-20230616181024741"></p><p><strong>自动：configmap资源清单</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim nginx-cm-test.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: new-nginx</span><br><span class="line">data:</span><br><span class="line">  zh.conf: |</span><br><span class="line">    server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name zh.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/zh;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  wp.conf: |</span><br><span class="line">    server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name blog.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/blog;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">kubectl apply -f nginx-cm-test.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">kubectl get cm</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl describe cm new-nginx</span></span><br><span class="line">Name: new-nginx</span><br><span class="line">Namespace: default</span><br><span class="line">Labels: &lt;none&gt;</span><br><span class="line">Annotations: &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">wp.conf:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name blog.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/blog;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zh.conf:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name zh.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/zh;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Events: &lt;none&gt;</span><br></pre></td></tr></table></figure><p><strong>使用pod挂载</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: new-nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: zh-wp</span><br><span class="line">    configMap:</span><br><span class="line">      name: new-nginx</span><br><span class="line">      items:</span><br><span class="line">      - key: zh.conf</span><br><span class="line">        path: zh.zls.com.conf</span><br><span class="line">      - key: wp.conf</span><br><span class="line">        path: blog.zls.com.conf</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pod</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: zh-wp</span><br><span class="line">      mountPath: /etc/nginx/conf.d/</span><br></pre></td></tr></table></figure><p><strong>查看</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it new-nginx-pod /bin/sh</span></span><br><span class="line">/ <span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line"></span><br><span class="line">/etc/nginx/conf.d <span class="comment"># ls</span></span><br><span class="line">blog.zls.com.conf zh.zls.com.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/etc/nginx/conf.d <span class="comment"># cat blog.zls.com.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name blog.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/blog;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/etc/nginx/conf.d <span class="comment"># cat zh.zls.com.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name zh.zls.com;</span><br><span class="line">location / &#123;</span><br><span class="line">root /usr/share/nginx/html/zh;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>wordpress部署和持久化存储</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-6-k8s-wordpress%E9%83%A8%E7%BD%B2%EF%BC%8C%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-6-k8s-wordpress%E9%83%A8%E7%BD%B2%EF%BC%8C%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230615183347562.png" alt="image-20230615183347562"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">我们也可以使用DNS域名的形式访问Service，如果在同一个命名空间里甚至可以直接使用service(clusterIP的名字)名来访问服务。</span><br><span class="line">如果在不同的名称空间，想要通信 servicename.namespace.svc.cluster.local</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping php-cluster.default.svc.cluster.local</span></span><br></pre></td></tr></table></figure><h2 id="启动wordpress镜像和资源清单"><a href="#启动wordpress镜像和资源清单" class="headerlink" title="启动wordpress镜像和资源清单"></a>启动wordpress镜像和资源清单</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 镜像</span></span><br><span class="line">wordpress:latest</span><br><span class="line"></span><br><span class="line">mysql:5.7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># wordpress资源清单</span></span><br><span class="line">- namespace</span><br><span class="line">- deployment</span><br><span class="line">- clusterip</span><br><span class="line">- ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql资源清单</span></span><br><span class="line">- deployment</span><br><span class="line">- clusterip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果想做共享存储 NFS（宿主机启动）</span></span><br><span class="line"><span class="comment"># 可以直接使用k8s上的nfs资源</span></span><br></pre></td></tr></table></figure><h2 id="部署NFS"><a href="#部署NFS" class="headerlink" title="部署NFS"></a>部署NFS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装nfs</span></span><br><span class="line">[root@nfs ~]<span class="comment"># yum install -y nfs-utils</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.创建www用户</span></span><br><span class="line">[root@nfs ~]<span class="comment"># groupadd www -g 666</span></span><br><span class="line">[root@nfs ~]<span class="comment"># useradd www -u 666 -g 666 -s /sbin/nologin -M</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.编辑nfs配置文件</span></span><br><span class="line">[root@nfs ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/wp 172.16.1.0/24(rw,<span class="built_in">sync</span>,anonuid=666,anongid=666,all_squash)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.创建共享目录授权</span></span><br><span class="line">[root@nfs ~]<span class="comment"># mkdir /data/wp</span></span><br><span class="line">[root@nfs ~]<span class="comment"># chown -R www.www /data/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.启动NFS</span></span><br><span class="line">[root@nfs ~]<span class="comment"># systemctl start nfs-server</span></span><br></pre></td></tr></table></figure><p><strong>node节点要保证有nfs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## node节点</span></span><br><span class="line"></span><br><span class="line">yum -y install nfs-utils</span><br></pre></td></tr></table></figure><h2 id="编写wordpress资源清单"><a href="#编写wordpress资源清单" class="headerlink" title="编写wordpress资源清单"></a>编写wordpress资源清单</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: blog</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-dp</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: mysql</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: db-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/mysql</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --character-set-server=utf8</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: <span class="string">&#x27;wp&#x27;</span></span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: db-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 3306</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-cluster</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: mysql</span><br><span class="line">  ports:</span><br><span class="line">  - name: mysql-port</span><br><span class="line">    port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-dp</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: wp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: wp-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: wp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: wp-data</span><br><span class="line">        nfs:</span><br><span class="line">          path: /data/wp</span><br><span class="line">          server: 172.16.1.31</span><br><span class="line">      containers:</span><br><span class="line">      - name: wp-container</span><br><span class="line">        image: wordpress:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment">#livenessProbe:</span></span><br><span class="line">        <span class="comment"># httpGet:</span></span><br><span class="line">        <span class="comment"># path: /</span></span><br><span class="line">        <span class="comment"># port: 80</span></span><br><span class="line">        <span class="comment"># initialDelaySeconds: 5</span></span><br><span class="line">        <span class="comment"># periodSeconds: 1</span></span><br><span class="line">        <span class="comment"># failureThreshold: 3</span></span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;mysql-cluster&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_NAME</span><br><span class="line">          value: <span class="string">&#x27;wp&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: wp-data</span><br><span class="line">          mountPath: /var/www/html/</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-cluster</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: wp</span><br><span class="line">  ports:</span><br><span class="line">  - name: wp-port</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-ingress</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: blog.zls.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: wp-cluster</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h2 id="资源检查"><a href="#资源检查" class="headerlink" title="资源检查"></a>资源检查</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 wordpress]<span class="comment"># kubectl get pod -n blog</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">mysql-dp-58b85667c9-hxvrr 1/1 Running 0 47s</span><br><span class="line"></span><br><span class="line">[root@k8s01 wordpress]<span class="comment"># kubectl get svc -n blog</span></span><br><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">mysql-cluster ClusterIP 10.1.16.133 &lt;none&gt; 3306/TCP 20s</span><br><span class="line"></span><br><span class="line">[root@k8s01 wordpress]<span class="comment"># kubectl describe svc -n blog mysql-cluster</span></span><br><span class="line">Name: mysql-cluster</span><br><span class="line">Namespace: blog</span><br><span class="line">Labels: &lt;none&gt;</span><br><span class="line">Annotations: &lt;none&gt;</span><br><span class="line">Selector: run=mysql</span><br><span class="line">Type: ClusterIP</span><br><span class="line">IP: 10.1.16.133</span><br><span class="line">Port: mysql-port 3306/TCP</span><br><span class="line">TargetPort: 3306/TCP</span><br><span class="line">Endpoints: 10.2.2.128:3306</span><br><span class="line">Session Affinity: None</span><br><span class="line">Events: &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 不在同一名称空间（使用clusterIP名字和名称空间的方式）</span></span><br><span class="line">WORDPRESS_DB_HOST: mysql-cluster.blog.svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在同一名称空间（直接使用clusterIP名字）</span></span><br><span class="line">WORDPRESS_DB_HOST: mysql-cluster</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 wordpress]<span class="comment"># kubectl apply -f wordpress.yaml</span></span><br><span class="line">namespace/blog created</span><br><span class="line">deployment.apps/mysql-dp created</span><br><span class="line">service/mysql-cluster created</span><br><span class="line">deployment.apps/wp-dp created</span><br><span class="line">service/wp-cluster created</span><br><span class="line">ingress.networking.k8s.io/wp-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># NFS：权限</span></span><br><span class="line">/data/wp 172.16.1.0/24(rw,<span class="built_in">sync</span>,root_squash)</span><br></pre></td></tr></table></figure><h2 id="k8s存储介绍"><a href="#k8s存储介绍" class="headerlink" title="k8s存储介绍"></a>k8s存储介绍</h2><p>容器内部的的存储在生命周期是短暂的，会随着容器环境的销毁而销毁，具有不稳定性。</p><p>在k8s里将对容 器应用所需的存储资源抽象为存储卷(Volume)概念来解决这些问题。 </p><p>k8s目前支持的Volume类型包括k8s的内部资源对象类型，开源共享存储类型和公有云存储等。分类如 下：</p><h3 id="k8s特定的资源对象"><a href="#k8s特定的资源对象" class="headerlink" title="k8s特定的资源对象"></a>k8s特定的资源对象</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ConfigMap <span class="comment"># 应用配置</span></span><br><span class="line">Secret <span class="comment"># 加密数据</span></span><br><span class="line">ServiceAccountToken <span class="comment"># token数据</span></span><br></pre></td></tr></table></figure><h3 id="k8s本地存储类型"><a href="#k8s本地存储类型" class="headerlink" title="k8s本地存储类型:"></a>k8s本地存储类型:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EmptDir: <span class="comment"># 临时存储</span></span><br><span class="line">HostPath: <span class="comment"># 宿主机目录</span></span><br></pre></td></tr></table></figure><h3 id="持久化存储-PV-和网络共享存储："><a href="#持久化存储-PV-和网络共享存储：" class="headerlink" title="持久化存储(PV)和网络共享存储："></a>持久化存储(PV)和网络共享存储：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CephFS: 开源共享存储系统</span><br><span class="line">GlusterFS: 开源共享存储系统</span><br><span class="line">NFS: 开源共享存储</span><br><span class="line">PersistentVolumeClaim: 简称PVC，持久化存储的申请空间</span><br></pre></td></tr></table></figure><h2 id="EmptyDir本地存储"><a href="#EmptyDir本地存储" class="headerlink" title="EmptyDir本地存储"></a>EmptyDir本地存储</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># vim mysql.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-dp-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: mysql</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: db-data</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">        - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: db-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f mysql.yaml</span></span><br><span class="line">deployment.apps/mysql-dp-test created</span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE IP</span><br><span class="line">NODE NOMINATED NODE READINESS GATES</span><br><span class="line">mysql-dp-test-cbd4b6458-mzzc9 1/1 Running 0 15s</span><br><span class="line">10.2.2.147 k8s02 &lt;none&gt; &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@k8s02 ~]<span class="comment"># ll /var/lib/kubelet/pods/2afa45d3-3ec6-431c-8413-07979eb25449/volumes/kubernetes.io~empty-dir/db-data</span></span><br><span class="line">total 188484</span><br><span class="line">-rw-r----- 1 polkitd input 56 Jun 15 11:47 auto.cnf</span><br><span class="line">-rw------- 1 polkitd input 1676 Jun 15 11:47 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input 1112 Jun 15 11:47 ca.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input 1112 Jun 15 11:47 client-cert.pem</span><br><span class="line">-rw------- 1 polkitd input 1676 Jun 15 11:47 client-key.pem</span><br><span class="line">-rw-r----- 1 polkitd input 1352 Jun 15 11:47 ib_buffer_pool</span><br><span class="line">-rw-r----- 1 polkitd input 79691776 Jun 15 11:47 ibdata1</span><br><span class="line">-rw-r----- 1 polkitd input 50331648 Jun 15 11:47 ib_logfile0</span><br><span class="line">-rw-r----- 1 polkitd input 50331648 Jun 15 11:47 ib_logfile1</span><br><span class="line">-rw-r----- 1 polkitd input 12582912 Jun 15 11:47 ibtmp1</span><br><span class="line">drwxr-x--- 2 polkitd input 4096 Jun 15 11:47 mysql</span><br><span class="line">drwxr-x--- 2 polkitd input 8192 Jun 15 11:47 performance_schema</span><br><span class="line">-rw------- 1 polkitd input 1680 Jun 15 11:47 private_key.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input 452 Jun 15 11:47 public_key.pem</span><br><span class="line">-rw-r--r-- 1 polkitd input 1112 Jun 15 11:47 server-cert.pem</span><br><span class="line">-rw------- 1 polkitd input 1680 Jun 15 11:47 server-key.pem</span><br><span class="line">drwxr-x--- 2 polkitd input 8192 Jun 15 11:47 sys</span><br><span class="line"></span><br><span class="line">[root@k8s02 ~]<span class="comment"># ll /var/lib/kubelet/pods/2afa45d3-3ec6-431c-8413-07979eb25449/volumes/kubernetes.io~empty-dir/db-data</span></span><br><span class="line"><span class="built_in">ls</span>: cannot access /var/lib/kubelet/pods/2afa45d3-3ec6-431c-8413-</span><br><span class="line">07979eb25449/volumes/kubernetes.io~empty-dir/db-data: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在宿主机上生成一个临时的目录存储数据，如果POD删除，则目录也会删除</span></span><br></pre></td></tr></table></figure><h2 id="hostPath本地存储"><a href="#hostPath本地存储" class="headerlink" title="hostPath本地存储"></a>hostPath本地存储</h2><h3 id="警告"><a href="#警告" class="headerlink" title="警告"></a>警告</h3><p>HostPath 卷存在许多安全风险，最佳做法是尽可能避免使用 HostPath。 当必须使用 HostPath 卷时， 它的范围应仅限于所需的文件或目录，并以只读方式挂载。</p><p>如果通过 AdmissionPolicy 限制 HostPath 对特定目录的访问，则必须要求 volumeMounts 使用 readOnly 挂载以使策略生效。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hostPath : HostPathVolumeSource v1 core</span><br><span class="line">path : string</span><br><span class="line"><span class="built_in">type</span> : string</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加磁盘：</span></span><br><span class="line">fdisk -l</span><br><span class="line"></span><br><span class="line">- 分区</span><br><span class="line">fdisk /dev/sdb</span><br><span class="line"></span><br><span class="line">- 格式化</span><br><span class="line">mkfs.xfs /dev/sdb1</span><br><span class="line"></span><br><span class="line">- 挂载</span><br><span class="line">blkid /dev/sbd1</span><br></pre></td></tr></table></figure><h3 id="type类型"><a href="#type类型" class="headerlink" title="type类型"></a>type类型</h3><div class="table-container"><table><thead><tr><th>取值</th><th>行为</th></tr></thead><tbody><tr><td></td><td>空字符串（默认）用于向后兼容，这意味着在安装 hostPath 卷之前不会 执行任何检查。</td></tr><tr><td>DirectoryOrCreate</td><td>如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设 置为 0755，具有与 kubelet 相同的组和属主信息。</td></tr><tr><td>Directory</td><td>在给定路径上必须存在的目录。</td></tr><tr><td>FileOrCreate</td><td>如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件， 权限设置为 0644，具有与 kubelet 相同的组和所有权。</td></tr><tr><td>File</td><td>在给定路径上必须存在的文件。</td></tr><tr><td>Socket</td><td>在给定路径上必须存在的 UNIX 套接字。</td></tr><tr><td>CharDevice</td><td>在给定路径上必须存在的字符设备。</td></tr><tr><td>BlockDevice</td><td>在给定路径上必须存在的块设备。</td></tr></tbody></table></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-dp-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: mysql</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: db-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /opt/mysql</span><br><span class="line">          <span class="built_in">type</span>: Directory</span><br><span class="line">      containers:</span><br><span class="line">        - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: db-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br></pre></td></tr></table></figure><h2 id="K8S持久化存储"><a href="#K8S持久化存储" class="headerlink" title="K8S持久化存储"></a>K8S持久化存储</h2><h3 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. emptyDir</span></span><br><span class="line">临时存储，宿主机上会有有一个临时目录，如果POD结束，目录删除</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用场景</span></span><br><span class="line">初始化容器，想要修改主容器内的数据，那么需要在一个POD中，共享初始化容器和主容器的目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. hostPath</span></span><br><span class="line">永久存储，指定一个目录，会存储主容器的数据</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用场景</span></span><br><span class="line">MySQL数据目录</span><br><span class="line">gitlab配置文件目录、数据目录、日志目录</span><br><span class="line">jenkins数据目录</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">保证数据的持久化，存储主容器内的数据目录</span><br></pre></td></tr></table></figure><h3 id="网络存储"><a href="#网络存储" class="headerlink" title="网络存储"></a>网络存储</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CephFS</span><br><span class="line"></span><br><span class="line">GlsterFS ===》 GFS 就是NFS的集群版</span><br><span class="line"></span><br><span class="line">fastDFS</span><br><span class="line"></span><br><span class="line">PVC</span><br></pre></td></tr></table></figure><h2 id="PV和PVC"><a href="#PV和PVC" class="headerlink" title="PV和PVC"></a>PV和PVC</h2><h3 id="PV和PVC介绍"><a href="#PV和PVC介绍" class="headerlink" title="PV和PVC介绍"></a>PV和PVC介绍</h3><ol><li><p>PV是对底层网络共享存储的抽象，将共享存储定义为一种“资源”。 </p></li><li><p>PV由管理员创建和配置 </p></li><li><p>PVC则是用户对存储资源的一个“申请”。 </p></li><li><p>PVC就像Pod消费Node的资源一样，能够“消费”PV资源 </p></li><li><p>PVC可以申请特定的存储空间和访问模式</p></li></ol><h3 id="PV和PVC的生命周期"><a href="#PV和PVC的生命周期" class="headerlink" title="PV和PVC的生命周期"></a>PV和PVC的生命周期</h3><ol><li>准备好共享存储服务器，nfs,gfs…</li><li>PV把共享服务器资源划分成不同的大小</li><li>PVC去向PV申请资源</li><li>POD去匹配挂载这些PVC资源</li><li>使用完毕后，删除PVC并回收PV资源</li><li>persistentVolumeReclaimPolicy: Retain状态下，是不会自动回收的</li></ol><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616160345182.png" alt="image-20230616160345182"></p><h3 id="PV和PVC需要注意的地方"><a href="#PV和PVC需要注意的地方" class="headerlink" title="PV和PVC需要注意的地方"></a>PV和PVC需要注意的地方</h3><p><strong>PV的4种不同的阶段</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv pvxxx</span><br><span class="line"></span><br><span class="line">Avaliable（可用）： <span class="comment"># 表示可用状态，还未被任何PVC绑定</span></span><br><span class="line">Bound（可绑定）：<span class="comment"># 表示PV已经被PVC绑定</span></span><br><span class="line">Released（已释放）：<span class="comment"># PVC被删除，但是资源还未被集群重新声明</span></span><br><span class="line">Failed（失败）： <span class="comment"># 表示该PV的自动回收失败</span></span><br></pre></td></tr></table></figure><h3 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h3><ol><li><p>创建PVC之后，k8s就会去查找满足我们声明要求的PV,比如 storageClassName , accessModes 以及容 量这些是否满足要求，如果满足要求就将PV和PVC绑定在一起。 </p></li><li><p>需要注意的是目前PV和PVC之间是一对一绑定的关系，也就是说一个PV只能被一个PVC绑定。</p></li></ol><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616162548001.png" alt="image-20230616162548001"></p><h2 id="开始部署PV-PVC-POD"><a href="#开始部署PV-PVC-POD" class="headerlink" title="开始部署PV,PVC,POD"></a>开始部署PV,PVC,POD</h2><h3 id="部署NFS-1"><a href="#部署NFS-1" class="headerlink" title="部署NFS"></a>部署NFS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs ~]<span class="comment"># yum install nfs-utils -y</span></span><br><span class="line"></span><br><span class="line">[root@nfs ~]<span class="comment"># cat /etc/exports</span></span><br><span class="line">/data/wp 172.16.1.0/24(rw,<span class="built_in">sync</span>,root_squash)</span><br><span class="line">/data/test1 172.16.1.0/24(rw,<span class="built_in">sync</span>,no_root_squash,no_all_squash)</span><br><span class="line">/data/test2 172.16.1.0/24(rw,<span class="built_in">sync</span>,no_root_squash,no_all_squash)</span><br><span class="line">/data/test3 172.16.1.0/24(rw,<span class="built_in">sync</span>,no_root_squash,no_all_squash)</span><br><span class="line">/data/test4 172.16.1.0/24(rw,<span class="built_in">sync</span>,no_root_squash,no_all_squash)</span><br><span class="line"></span><br><span class="line">[root@nfs ~]<span class="comment"># mkdir /data/test1</span></span><br><span class="line">[root@nfs ~]<span class="comment"># mkdir /data/test2</span></span><br><span class="line"></span><br><span class="line">[root@nfs ~]<span class="comment"># systemctl start nfs</span></span><br></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th>nfs共享参数</th><th>参数作用</th></tr></thead><tbody><tr><td>rw*</td><td>读写权限</td></tr><tr><td>ro</td><td>只读权限</td></tr><tr><td>root_squash</td><td>当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)</td></tr><tr><td>no_root_squash</td><td>当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)</td></tr><tr><td>all_squash</td><td>无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)</td></tr><tr><td>no_all_squash</td><td>无论NFS客户端使用什么账户访问，都不进行压缩</td></tr><tr><td>sync*</td><td>同时将数据写入到内存与硬盘中，保证不丢失数据</td></tr><tr><td>async</td><td>优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td></tr><tr><td>anonuid*</td><td>配置all_squash使用,指定NFS的用户UID,必须存在系统</td></tr><tr><td>anongid*</td><td>配置all_squash使用,指定NFS的用户UID,必须存在系统</td></tr></tbody></table></div><h3 id="创建PV资源，划分NFS磁盘空间"><a href="#创建PV资源，划分NFS磁盘空间" class="headerlink" title="创建PV资源，划分NFS磁盘空间"></a>创建PV资源，划分NFS磁盘空间</h3><p><strong>nfs-pv1.yaml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv01</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/test1</span><br><span class="line">    server: 172.16.1.31</span><br></pre></td></tr></table></figure><p><strong>nfs-pv2.yaml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv02</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain<span class="comment">## 需要手动创建</span></span><br><span class="line">  storageClassName: nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/test2</span><br><span class="line">    server: 172.16.1.31</span><br></pre></td></tr></table></figure><p><strong>nfs-pv3.yaml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv03</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/test3</span><br><span class="line">    server: 172.16.1.31</span><br></pre></td></tr></table></figure><p><strong>local-pv4.yaml</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv04</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: localhost</span><br><span class="line">  hostPath:</span><br><span class="line">    path: /data/local</span><br></pre></td></tr></table></figure><h3 id="启动-amp-查看"><a href="#启动-amp-查看" class="headerlink" title="启动&amp;查看"></a>启动&amp;查看</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">kubectl apply -f nfs-pv1.yaml</span><br><span class="line">kubectl apply -f nfs-pv2.yaml</span><br><span class="line">kubectl apply -f nfs-pv3.yaml</span><br><span class="line">kubectl apply -f nfs-pv4.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure><h3 id="资源清单注解"><a href="#资源清单注解" class="headerlink" title="资源清单注解"></a>资源清单注解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">capacity: <span class="comment"># PV存储的容量</span></span><br><span class="line"></span><br><span class="line">accessModes: <span class="comment"># 访问模式,k8s支持的访问模式如下</span></span><br><span class="line">------------------------------------------------------</span><br><span class="line">ReadWriteOnce(RWO): <span class="comment"># 读写权限，并且只能被单个Node挂载</span></span><br><span class="line">ReadOnlyMany(ROX): <span class="comment"># 只读权限，允许被多个Node挂载</span></span><br><span class="line">ReadWriteMany(RWX): <span class="comment"># 读写权限，允许被多个Node挂载</span></span><br><span class="line">------------------------------------------------------</span><br><span class="line"></span><br><span class="line">persistentVolumeReclaimPolicy: <span class="comment"># 回收策略</span></span><br><span class="line">------------------------------------------------------</span><br><span class="line"></span><br><span class="line">storageClassName:</span><br><span class="line">具有特定类别的PV只能与请求了该类别的PVC绑定。未指定类型的PV则只能对与不请求任何类别的PVC绑定。</span><br><span class="line">------------------------------------------------------</span><br></pre></td></tr></table></figure><h3 id="访问模式—persistentVolumeReclaimPolicy"><a href="#访问模式—persistentVolumeReclaimPolicy" class="headerlink" title="访问模式—persistentVolumeReclaimPolicy"></a>访问模式—persistentVolumeReclaimPolicy</h3><p><strong>访问模式的作用</strong></p><ol><li>是否数据持久化 </li><li>是否能被其他PVC绑定</li></ol><p><strong>Retain:</strong></p><ol><li>保留数据，需要手工处理 保留（Retain）</li><li>回收策略 Retain 使得用户可以手动回收资源。</li><li>当 PVC 对象被删除时， PV 卷仍然存在，对应的数据卷被视为”已释放（released）”。 由于卷上仍然存在这前 一申领人的数据，该卷还不能用于其他申领。 </li></ol><ul><li><strong>管理员可以通过下面的步骤来手动回收该卷</strong></li></ul><ol><li>删除 PV 对象。与之相关的、位于外部基础设施中的存储资产 （例如 AWS EBS、GCE PD、Azure Disk 或 Cinder 卷）在 PV 删除之后仍然存在。 </li><li>根据情况，手动清除所关联的存储资产上的数据。 手动删除所关联的存储资产。 </li><li>如果你希望重用该存储资产，可以基于存储资产的定义创建新的 PersistentVolume 卷对象。 </li></ol><p><strong>Recycle:</strong></p><ol><li><p>简单清除文件的操作(例如运行rm -rf /dada/* 命令)</p></li><li><p>如果下层的卷插件支持，回收策略 Recycle 会在卷上执行一些基本的擦除 （rm -rf /thevolume/*）操作，之后允许该卷用于新的 PVC 申领。 </p></li></ol><p><strong>Delete:</strong></p><ol><li>与PV相连的后端存储完成Volume的删除操作，这个模式会连PV一起标记，不能使用</li></ol><p><strong>目前只有NFS和HostPath两种类型的PV支持Recycle策略。</strong> </p><h3 id="使用PVC申请资源"><a href="#使用PVC申请资源" class="headerlink" title="使用PVC申请资源"></a>使用PVC申请资源</h3><p><strong>PVC关联PV</strong></p><ol><li><p>accessModes</p></li><li><p>storageClassName </p></li><li><p>storage: 2Gi</p></li></ol><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616170306887.png" alt="image-20230616170306887"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例子1</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc01</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line">  storageClassName: nfs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## PVC资源关键参数：</span></span><br><span class="line">accessModes: <span class="comment"># 访问模式，与PV定义的一样</span></span><br><span class="line">resources: <span class="comment"># 描述对存储资源的请求，设置需要的存储空间大小</span></span><br><span class="line">storageClassName: <span class="comment"># 存储类别，与PV的存储类型相匹配</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616170437591.png" alt="image-20230616170437591"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例子2</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc03</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 8Gi</span><br><span class="line">  storageClassName: bendicunchu</span><br></pre></td></tr></table></figure><p><strong>目前完成步骤</strong></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230616171136528.png" alt="image-20230616171136528"></p><h3 id="创建POD使用PVC资源"><a href="#创建POD使用PVC资源" class="headerlink" title="创建POD使用PVC资源"></a>创建POD使用PVC资源</h3><p><strong>PVC关联PV</strong></p><ul><li>accessModes </li><li>storageClassName</li><li>storage: 2Gi </li></ul><p><strong>POD关联PVC</strong></p><ul><li>通过PVC名字</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 如果没有可以绑定的PV则会进入pending状态</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE</span><br><span class="line">pvc04 Pending bendicunchu 42s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 如果是recycle，pvc解绑之后，PV资源会被回收，那么如果满足pending状态的PVC，则会被绑定，如果Ratin，则永远无法被绑定，除非手动删除回收资源</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE</span><br><span class="line">pvc04 Bound bendicunchu 42s</span><br></pre></td></tr></table></figure><p><strong>例子：mysql-deployment绑定pvc</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-dp-pvc</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: mysql</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: nfs-pvc</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: pvc02</span><br><span class="line">      <span class="comment">#- name: nfs-pvc</span></span><br><span class="line">      <span class="comment"># nfs:</span></span><br><span class="line">      <span class="comment"># path: /data/test1</span></span><br><span class="line">      <span class="comment"># server: 172.16.1.31</span></span><br><span class="line"></span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nfs-pvc</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 关键参数解释：</span></span><br><span class="line">persistentVolumeClaim: <span class="comment"># // 引用PVC</span></span><br><span class="line">claimName: mysql-pvc <span class="comment"># // 具体PVC的名称</span></span><br></pre></td></tr></table></figure><p><strong>测试方法</strong></p><ol><li>创建nfs-pv </li><li>创建mysql-pvc </li><li>创建mysql-deployment并挂载mysq-pvc </li><li>登陆到mysql的pod里创建一个数据库 </li><li>将这个pod删掉，因为deployment设置了副本数，所以会自动再创建一个新的pod </li><li>登录这个新的pod，查看刚才创建的数据库是否依然能看到 </li><li>如果仍然能看到，则说明数据是持久化保存的</li></ol><p><strong>共享存储应用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">------ 没有限制磁盘空间 -------</span><br><span class="line">CephFS: <span class="comment"># 开源共享存储系统</span></span><br><span class="line">GlusterFS: <span class="comment"># 开源共享存储系统</span></span><br><span class="line">NFS: <span class="comment"># 开源共享存储</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## k8s不支持</span></span><br><span class="line">fastDFS</span><br><span class="line">------ 需要PV划分资源空间 -------</span><br><span class="line"></span><br><span class="line"><span class="comment"># PVC绑定到PV上</span></span><br><span class="line">PersistentVolumeClaim: 简称PVC，持久化存储的申请空间</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>HPA,Service,Ingress部署</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-5-k8s-HPA%EF%BC%8CService%EF%BC%8CIngress/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-5-k8s-HPA%EF%BC%8CService%EF%BC%8CIngress/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="HPA自动扩缩容"><a href="#HPA自动扩缩容" class="headerlink" title="HPA自动扩缩容"></a>HPA自动扩缩容</h2><h3 id="HPA工作原理"><a href="#HPA工作原理" class="headerlink" title="HPA工作原理"></a>HPA工作原理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HAP通过收集来的监控指标分析所有Pod的负载情况，并且根据我们设定好的标准来自动扩容收缩ReplicationController、 Deployment、ReplicaSet 或 StatefulSet 中的 Pod 数量</span><br><span class="line"></span><br><span class="line">RC</span><br><span class="line">RS</span><br><span class="line">DP</span><br><span class="line">StatefulSet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.需要一个 Metric Server 收集所有POD负载情况</span><br><span class="line">2.必须使用除了DaemonSet以外的控制器</span><br></pre></td></tr></table></figure><h3 id="Metrics-Server介绍"><a href="#Metrics-Server介绍" class="headerlink" title="Metrics Server介绍"></a>Metrics Server介绍</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在HAP早期版本使用的是一个叫Heapster组件来提供CPU和内存指标的，在后期的版本k8s转向了使用Metrcis Server组件来提供Pod的CPU和内存指标</span><br><span class="line">Metrcis Server通过Metrics API将数据暴露出来，然后我们就可以使用k8s的API来获取相应的数据</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614153033659.png" alt="image-20230614153033659"></p><h3 id="部署MetricServer"><a href="#部署MetricServer" class="headerlink" title="部署MetricServer"></a>部署MetricServer</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.下载yaml文件</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.4.0/components.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.修改yaml文件</span></span><br><span class="line"><span class="comment"># 直接apply yaml文件会报错</span></span><br><span class="line">1.镜像无法拉取</span><br><span class="line">- 下载镜像，导入到所有Node节点</span><br><span class="line">[root@k8s02 ~]<span class="comment"># docker load &lt; metrics-server.tar</span></span><br><span class="line">2.Deployment控制器，每一台node都要起 （DaemonSet）</span><br><span class="line">- kind: Deployment 改为 kind: DaemonSet</span><br><span class="line">3.跳过证书检查，如果不跳过，就绪性探针无法正常检测，POD虽然是running但是永远0/1</span><br><span class="line">args:</span><br><span class="line">- - --kubelet-insecure-tls</span><br><span class="line">4.启动MetricServer的POD必须跟宿主机共享网络，使用docker的host网络模式</span><br><span class="line">spec:</span><br><span class="line">  hostNetwork: <span class="literal">true</span></span><br><span class="line">  containers:</span><br><span class="line">  - name: xxx</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.应用yaml文件</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f components.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.查看POD状态</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -n kube-system</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">metrics-server-7j7vh 1/1 Running 0 11m</span><br><span class="line">metrics-server-hx4jz 1/1 Running 0 11m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.测试命令</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl top node</span></span><br><span class="line">NAME CPU(cores) CPU% MEMORY(bytes) MEMORY%</span><br><span class="line">k8s01 143m 7% 1726Mi 45%</span><br><span class="line">k8s02 49m 4% 637Mi 16%</span><br><span class="line">k8s03 52m 5% 998Mi 114%</span><br></pre></td></tr></table></figure><h3 id="生成一个php-apache镜像（也可以直接使用官方做好的镜像）"><a href="#生成一个php-apache镜像（也可以直接使用官方做好的镜像）" class="headerlink" title="生成一个php-apache镜像（也可以直接使用官方做好的镜像）"></a>生成一个php-apache镜像（也可以直接使用官方做好的镜像）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.准备php代码</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># cat index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">  <span class="variable">$x</span> = 0.0001;</span><br><span class="line">  <span class="keyword">for</span> (<span class="variable">$i</span> = 0; <span class="variable">$i</span> &lt;= 1000000; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$x</span> += sqrt(<span class="variable">$x</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;OK!&quot;</span>;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.编写dockerfile构建镜像</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># vim dockerfile</span></span><br><span class="line">FROM php:5-apache</span><br><span class="line">ADD index.php /var/www/html/index.php</span><br><span class="line">RUN <span class="built_in">chmod</span> a+rx index.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.构建镜像</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># docker build -t php:v1 .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.将镜像导出，发送到所有node上</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># docker save php:v1 &gt; /tmp/php_v1.tgz</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># scp /tmp/php_v1.tgz 172.16.1.12:/tmp</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># scp /tmp/php_v1.tgz 172.16.1.13:/tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.其他node导入php镜像</span></span><br><span class="line">[root@k8s02 ~]<span class="comment"># docker load &lt; /tmp/php_v1.tgz</span></span><br><span class="line">[root@k8s03 ~]<span class="comment"># docker load &lt; /tmp/php_v1.tgz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.启动一个Deployment资源</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># cat php-apache.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: php-apache</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: php-apache</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: php-apache</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: php:v1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: php-apache</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.启动资源</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f php-apache.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.查看资源</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br><span class="line">php-apache-f49845445-mrmlh 1/1 Running 0 11s 10.2.2.91 k8s02 &lt;none&gt; &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="创建HPA资源"><a href="#创建HPA资源" class="headerlink" title="创建HPA资源"></a>创建HPA资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># vim hpa.yaml</span></span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: php-apache</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: php-apache</span><br><span class="line">  targetCPUUtilizationPercentage: 50</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f hpa.yaml</span></span><br><span class="line">horizontalpodautoscaler.autoscaling/php-apache created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看HPA</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE</span><br><span class="line">php-apache Deployment/php-apache 2%/50% 1 10 1 33s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 压测</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># while true; do wget -q -O- http://你们的IP; done</span></span><br></pre></td></tr></table></figure><h2 id="Service网络服务"><a href="#Service网络服务" class="headerlink" title="Service网络服务"></a>Service网络服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NodePort： <span class="comment">## 宿主机节点的端口</span></span><br><span class="line"></span><br><span class="line">ClusterIP：<span class="comment">## 用来动态发现和负载均衡POD的IP，通过 Label（标签） 绑定POD</span></span><br><span class="line"></span><br><span class="line">PodIP：<span class="comment">## 提供POD使用的IP</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614154046059.png" alt="image-20230614154046059"></p><h3 id="ClusterIP资源清单"><a href="#ClusterIP资源清单" class="headerlink" title="ClusterIP资源清单"></a>ClusterIP资源清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># vim clusterip.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: apache-cluster</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: php-apache <span class="comment">## POD的标签</span></span><br><span class="line">  ports:</span><br><span class="line">  - name: php</span><br><span class="line">    port: 8080 <span class="comment">## clusterIP 端口</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80 <span class="comment">## POD的端口</span></span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f clusterip.yaml</span></span><br><span class="line">service/apache-cluster created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">apache-cluster ClusterIP 10.1.232.8 &lt;none&gt; 80/TCP 22s</span><br><span class="line">kubernetes ClusterIP 10.1.0.1 &lt;none&gt; 443/TCP 5d23h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># curl 10.1.232.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe svc apache-cluster</span></span><br><span class="line">Name: apache-cluster</span><br><span class="line">Namespace: default</span><br><span class="line">Labels: &lt;none&gt;</span><br><span class="line">Annotations: &lt;none&gt;</span><br><span class="line">Selector: run=php-apache</span><br><span class="line">Type: ClusterIP</span><br><span class="line">IP: 10.1.232.8</span><br><span class="line">Port: php 80/TCP</span><br><span class="line">TargetPort: 80/TCP</span><br><span class="line">Endpoints: 10.2.1.46:80,10.2.2.103:80,10.2.2.110:80 + 2 more...</span><br><span class="line">Session Affinity: None</span><br><span class="line">Events: &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="NodePort资源"><a href="#NodePort资源" class="headerlink" title="NodePort资源"></a>NodePort资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># vim nodeport.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: apache-nodeport</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: apache-php</span><br><span class="line">  ports:</span><br><span class="line">  - name: php</span><br><span class="line">    port: 8080 <span class="comment">## clusterIP端口</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80 <span class="comment">## POD的端口</span></span><br><span class="line">    nodePort: 30000 <span class="comment">## node宿主机上映射的端口</span></span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NodePort端口映射过程</span></span><br><span class="line">宿主机:30000 -&gt; ClusterIP:8080 -&gt; POD:80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">apache-nodeport NodePort 10.1.88.98 &lt;none&gt; 8080:30000/TCP 9s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 注意：如果使用nodeport，默认会启动一个clusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 问题</span></span><br><span class="line">1.宿主机使用30000端口，用户体验不好？</span><br><span class="line">2.域名该绑定在哪台机器？</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报错（端口问题）</span></span><br><span class="line"><span class="comment"># nodeport端口范围----(30000-32767)</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f nodeport.yaml</span></span><br><span class="line">The Service <span class="string">&quot;apache-nodeport&quot;</span> is invalid: spec.ports[0].nodePort: Invalid value:80: provided port is not <span class="keyword">in</span> the valid range. The range of valid ports is 30000-32767</span><br></pre></td></tr></table></figure><h3 id="实例：使用k8s资源启动h5小游戏-ns：h5"><a href="#实例：使用k8s资源启动h5小游戏-ns：h5" class="headerlink" title="实例：使用k8s资源启动h5小游戏(ns：h5)"></a>实例：使用k8s资源启动h5小游戏(ns：h5)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要用到的k8s资源</span></span><br><span class="line">1.namespace</span><br><span class="line">2.deployment &amp; pod</span><br><span class="line">3.HPA</span><br><span class="line">4.ClusterIP/NodePort</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.名称空间 h5</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># vim h5-ns.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: h5</span><br><span class="line"></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-ns.yaml</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get ns</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.POD：deployment</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># vim h5-dp.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-dp</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: h5</span><br><span class="line">  replicas: 5</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: h5</span><br><span class="line">      name: h5-pod</span><br><span class="line">      namespace: h5</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: h5-code</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /code/h5</span><br><span class="line">      containers:</span><br><span class="line">      - name: h5-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: h5-code</span><br><span class="line">          mountPath: /usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-dp.yaml</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get pod -n h5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.HPA</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># vim h5-hpa.yaml</span></span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-hpa</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 10<span class="comment">## 最大扩容数</span></span><br><span class="line">  minReplicas: 1<span class="comment">## 最小缩容数</span></span><br><span class="line">  scaleTargetRef:<span class="comment">## 关联控制器</span></span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment<span class="comment">## 控制器</span></span><br><span class="line">    name: h5-dp<span class="comment">## 控制器名称</span></span><br><span class="line">  targetCPUUtilizationPercentage: 50<span class="comment">## CPU利用率，超过就扩容</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-hpa.yaml</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get hpa -n h5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.ClusterIP/NodePort</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment">#vim h5-node.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-nodeport</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: h5</span><br><span class="line">  ports:</span><br><span class="line">  - name: h5</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 32767</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-node.yaml</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get svc -n h5</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl describe svc h5-nodeport -n h5</span></span><br><span class="line">Name: h5-nodeport</span><br><span class="line">Namespace: h5</span><br><span class="line">Labels: &lt;none&gt;</span><br><span class="line">Annotations: &lt;none&gt;</span><br><span class="line">Selector: app=h5</span><br><span class="line">Type: NodePort</span><br><span class="line">IP: 10.1.74.22</span><br><span class="line">Port: h5 80/TCP</span><br><span class="line">TargetPort: 80/TCP</span><br><span class="line">NodePort: h5 32767/TCP</span><br><span class="line">Endpoints: 10.2.1.51:80,10.2.1.52:80,10.2.2.116:80 + 2 more...</span><br><span class="line">Session Affinity: None</span><br><span class="line">External Traffic Policy: Cluster</span><br><span class="line">Events: &lt;none&gt;</span><br></pre></td></tr></table></figure><h4 id="h5资源清单整合"><a href="#h5资源清单整合" class="headerlink" title="h5资源清单整合"></a>h5资源清单整合</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 h5_game]<span class="comment"># cat h5-game.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: h5</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-dp</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: h5</span><br><span class="line">  replicas: 5</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: h5</span><br><span class="line">      name: h5-pod</span><br><span class="line">      namespace: h5</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: h5-code</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /code/h5</span><br><span class="line">      containers:</span><br><span class="line">      - name: h5-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: h5-code</span><br><span class="line">          mountPath: /usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-hpa</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 10<span class="comment">## 最大扩容数</span></span><br><span class="line">  minReplicas: 1<span class="comment">## 最小缩容数</span></span><br><span class="line">  scaleTargetRef:<span class="comment">## 关联控制器</span></span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment<span class="comment">## 控制器</span></span><br><span class="line">    name: h5-dp<span class="comment">## 控制器名称</span></span><br><span class="line">  targetCPUUtilizationPercentage: 50<span class="comment">## CPU利用率，超过就扩容</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-nodeport</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: h5</span><br><span class="line">  ports:</span><br><span class="line">  - name: h5</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 32767</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line"><span class="comment">## 应用</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-game.yaml</span></span><br><span class="line">namespace/h5 created</span><br><span class="line">deployment.apps/h5-dp created</span><br><span class="line">horizontalpodautoscaler.autoscaling/h5-hpa created</span><br><span class="line">service/h5-nodeport created</span><br></pre></td></tr></table></figure><h3 id="nodeport-缺点"><a href="#nodeport-缺点" class="headerlink" title="nodeport 缺点"></a>nodeport 缺点</h3><ul><li>1.没有ingress之前，pod对外提供服务只能通过NodeIP:NodePort的形式，但是这种形式有缺点，一个节 点上的PORT不能重复利用。比如某个服务占用了80，那么其他服务就不能在用这个端口了。 </li><li>2.NodePort是4层代理，不能解析7层的http，不能通过域名区分流量 </li><li>3.为了解决这个问题，我们需要用到资源控制器叫Ingress，作用就是提供一个统一的访问入口。工作在7层 </li><li>4.虽然我们可以使用nginx/haproxy来实现类似的效果，但是传统部署不能动态的发现我们新创建的资源， 必须手动修改配置文件并重启。 </li><li>5.适用于k8s的ingress控制器主流的有nginx-ingress和traefik</li></ul><h3 id="不使用ingress解决nodeport缺陷"><a href="#不使用ingress解决nodeport缺陷" class="headerlink" title="不使用ingress解决nodeport缺陷"></a>不使用ingress解决nodeport缺陷</h3><ul><li>搞一台Nginx代理服务器</li><li>代理一下nodeport</li><li>域名解析</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream xxx.com &#123;</span><br><span class="line">server xxx.xxx.xxx.xxx;</span><br><span class="line">server xxx.xxx.xxx.xxx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name xxx.com;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://xxx.com;</span><br><span class="line">include proxy_params;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h2><h3 id="使用ingress解决nodeport缺陷"><a href="#使用ingress解决nodeport缺陷" class="headerlink" title="使用ingress解决nodeport缺陷"></a>使用ingress解决nodeport缺陷</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614162617774.png" alt="image-20230614162617774"></p><h3 id="ingress部署"><a href="#ingress部署" class="headerlink" title="ingress部署"></a>ingress部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.官方ingress</span></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingressnginx/master/deploy/static/provider/baremetal/deploy.yaml -O nginx-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.github搜索kubeguide</span></span><br><span class="line"><span class="comment"># 找到第五版，第四章</span></span><br><span class="line">wget https://github.com/kubeguide/K8sDefinitiveGuide-V5-Sourcecode/blob/main/Chapter04/4.6.1%20nginx-ingress-controller.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改内容</span></span><br><span class="line">1）kind: Deployment 改为 kind: DaemonSet</span><br><span class="line">2）删除 replicas: 1</span><br><span class="line">3）删除 nodeSelector:</span><br><span class="line">role: ingress-nginx-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f ingress.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -n nginx-ingress</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">nginx-ingress-4bwfl 1/1 Running 0 53s</span><br><span class="line">nginx-ingress-77s5c 1/1 Running 0 53s</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614162708833.png" alt="image-20230614162708833"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614162717773.png" alt="image-20230614162717773"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614162731294.png" alt="image-20230614162731294"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230614162740066.png" alt="image-20230614162740066"></p><h3 id="实例：启动h5网站"><a href="#实例：启动h5网站" class="headerlink" title="实例：启动h5网站"></a>实例：启动h5网站</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要用到的k8s资源</span></span><br><span class="line">1.namespace</span><br><span class="line">2.Controller</span><br><span class="line">- pod</span><br><span class="line">...</span><br><span class="line">3.HPA</span><br><span class="line">4.ClusterIP</span><br><span class="line">5.ingress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.namespace</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># vim h5-ns.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: h5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.deployment</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># vim h5-dp.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-dp</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: h5</span><br><span class="line">  replicas: 5</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: h5</span><br><span class="line">      name: h5-pod</span><br><span class="line">      namespace: h5</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: h5-code</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /code/h5</span><br><span class="line">      containers:</span><br><span class="line">      - name: h5-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: h5-code</span><br><span class="line">          mountPath: /usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ingress的后端是ClusterIP</span></span><br><span class="line"><span class="comment"># 3.ClusterIP</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment">#vim h5-node.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-cluster</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: h5</span><br><span class="line">  ports:</span><br><span class="line">  - name: h5</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-ns.yaml</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-dp.yaml</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-cluster.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get pod -n h5</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get svc -n h5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用ingress关联ClusterIP</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># vim h5-ingress.yaml</span></span><br><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-ingress</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: game.h5.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: h5-cluster</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动ingress资源</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl apply -f h5-ingress.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[root@k8s01 h5_game]<span class="comment"># kubectl get ingress -n h5</span></span><br></pre></td></tr></table></figure><h3 id="结合"><a href="#结合" class="headerlink" title="结合"></a>结合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: h5</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-dp</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: h5</span><br><span class="line">  replicas: 5</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: h5</span><br><span class="line">      name: h5-pod</span><br><span class="line">      namespace: h5</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: h5-code</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /code/h5</span><br><span class="line">      containers:</span><br><span class="line">      - name: h5-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: h5-code</span><br><span class="line">          mountPath: /usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-cluster</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: h5</span><br><span class="line">  ports:</span><br><span class="line">  - name: h5</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: h5-ingress</span><br><span class="line">  namespace: h5</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: game.h5.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: h5-cluster</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure><h3 id="ingress配置详解"><a href="#ingress配置详解" class="headerlink" title="ingress配置详解"></a>ingress配置详解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ingress配置详解</span></span><br><span class="line">spec:</span><br><span class="line">  rules:<span class="comment"># 网站规则</span></span><br><span class="line">  - host: www.h5.com<span class="comment"># 域名</span></span><br><span class="line">    http:<span class="comment"># http层</span></span><br><span class="line">      paths:<span class="comment"># location(nginx)</span></span><br><span class="line">      - path: /<span class="comment"># location /(nginx)</span></span><br><span class="line">        pathType: ImplementationSpecific<span class="comment"># 路径匹配规则 系统默认</span></span><br><span class="line">        backend:<span class="comment"># 后端配置，ingress要找到后端的ClusterIP</span></span><br><span class="line">          service:<span class="comment"># service网络</span></span><br><span class="line">            name: h5-cluster<span class="comment"># ClusterIP名字</span></span><br><span class="line">            port:<span class="comment"># ClusterIP端口</span></span><br><span class="line">              number: 80<span class="comment"># 端口号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pathType：</span></span><br><span class="line">- ImplementationSpecific 系统默认，由IngressClass控制器提供</span><br><span class="line">- Exact 精确匹配URL路径，区分大小写</span><br><span class="line">- Prefix 匹配URL路径的前缀，区分大小写</span><br></pre></td></tr></table></figure><h2 id="使用k8s启动wordpress"><a href="#使用k8s启动wordpress" class="headerlink" title="使用k8s启动wordpress"></a>使用k8s启动wordpress</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## wordpress 要运行在k8s中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## MySQL</span></span><br><span class="line">1.名称空间： blog</span><br><span class="line">2.镜像mysql:5.7</span><br><span class="line">3.环境变量</span><br><span class="line">- root密码：123</span><br><span class="line">- 数据库：wordpress</span><br><span class="line">- 用户：wordpress</span><br><span class="line">- 参数：字符集</span><br><span class="line">4.数据持久化：在宿主机的/data/mysql/data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## mysql-svc需求</span></span><br><span class="line">名称空间：blog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## wordpress需求</span></span><br><span class="line">副本数为2</span><br><span class="line">镜像：自己打（有坑），或者官方</span><br><span class="line">数据库地址：cluster ip</span><br><span class="line">数据库名称：wordpress</span><br><span class="line">用户：wordpress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wordpress：单独起2pod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql：单独起pod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.ns</span><br><span class="line">2.Controller</span><br><span class="line">- pod</span><br><span class="line">initContainer</span><br><span class="line">存活探针</span><br><span class="line">就绪探针</span><br><span class="line">3.clusterIP</span><br><span class="line">4.ingress</span><br></pre></td></tr></table></figure><h3 id="wordpress资源清单"><a href="#wordpress资源清单" class="headerlink" title="wordpress资源清单"></a>wordpress资源清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: blog</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-dp</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: mysql-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: mysql</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: db-data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/mysql</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --character-set-server=utf8</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: <span class="string">&#x27;wp&#x27;</span></span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: db-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 3306</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-cluster</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: mysql</span><br><span class="line">  ports:</span><br><span class="line">  - name: mysql-port</span><br><span class="line">    port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-dp</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      run: wp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: wp-pod</span><br><span class="line">      labels:</span><br><span class="line">        run: wp</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: wp-data</span><br><span class="line">        nfs:</span><br><span class="line">          path: /data/wp</span><br><span class="line">          server: 172.16.1.31</span><br><span class="line">      containers:</span><br><span class="line">      - name: wp-container</span><br><span class="line">        image: wordpress:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="comment">#livenessProbe:</span></span><br><span class="line">        <span class="comment"># httpGet:</span></span><br><span class="line">        <span class="comment"># path: /</span></span><br><span class="line">        <span class="comment"># port: 80</span></span><br><span class="line">        <span class="comment"># initialDelaySeconds: 5</span></span><br><span class="line">        <span class="comment"># periodSeconds: 1</span></span><br><span class="line">        <span class="comment"># failureThreshold: 3</span></span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name: WORDPRESS_DB_HOST</span><br><span class="line">          value: <span class="string">&#x27;mysql-cluster&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">        - name: WORDPRESS_DB_NAME</span><br><span class="line">          value: <span class="string">&#x27;wp&#x27;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: wp-data</span><br><span class="line">          mountPath: /var/www/html/</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-cluster</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    run: wp</span><br><span class="line">  ports:</span><br><span class="line">  - name: wp-port</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: wp-ingress</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: blog.zls.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: ImplementationSpecific</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: wp-cluster</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>控制器-rc,rs,deployment</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-4-k8s-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%8Crc-rs-dp/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-4-k8s-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%8Crc-rs-dp/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="控制器作用"><a href="#控制器作用" class="headerlink" title="控制器作用"></a>控制器作用</h2><ul><li>1.pod类型的资源，删除pod后，不会重建（使用控制器就会）</li><li>2.替用户监视并保证相应的节点上始终有用户所期望的副本数量的pod在运行 </li><li>3.如果所运行的pod副本数超过了用户期望的，那么控制器就会删掉，直到和用户期望的一致 </li><li>4.如果所运行的pod副本数低于用户期望的，那么控制器就会创建，直到和用户期望的一致</li></ul><h2 id="控制器类型"><a href="#控制器类型" class="headerlink" title="控制器类型"></a>控制器类型</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RC：Replication Controller</span><br><span class="line">StatefulSet: 有状态应用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 重点，常用</span></span><br><span class="line">RS：ReplicaSet 按用户期望的副本创建pod,并始终保持相应数量副本</span><br><span class="line"></span><br><span class="line">deployment：</span><br><span class="line">1.Deployment通过控制RS来保证POD始终保持相应的数量副本 // deployment不能直接控制POD，而是控制RS控制器</span><br><span class="line">2.支持滚动更新，回滚,回滚默认保留10个版本 // 支持版本更新</span><br><span class="line">3.提供声明式配置，支持动态修改 // 支持动态修改</span><br><span class="line">4.管理无状态应用最理想的控制器</span><br><span class="line">5.node节点可能会运行0个或多个POD</span><br><span class="line"></span><br><span class="line">daemonset：保证每个node节点，有且只有一个POD启动</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230613161951051.png" alt="image-20230613161951051"></p><h2 id="RS控制器的资源清单"><a href="#RS控制器的资源清单" class="headerlink" title="RS控制器的资源清单"></a>RS控制器的资源清单</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 错误写法</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line"><span class="comment"># RS控制器的metadata</span></span><br><span class="line">metadata:</span><br><span class="line"><span class="comment"># RS控制器的名字</span></span><br><span class="line">  name: nginx-rs</span><br><span class="line">spec:</span><br><span class="line"><span class="comment"># 副本数量</span></span><br><span class="line">  replicas: 10</span><br><span class="line">  template:</span><br><span class="line"><span class="comment"># POD的metadata</span></span><br><span class="line">    metadata:</span><br><span class="line"><span class="comment"># POD名字</span></span><br><span class="line">      name: nginx-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 正确写法</span></span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line"><span class="comment"># RS控制器的metadata</span></span><br><span class="line">metadata:</span><br><span class="line"><span class="comment"># RS控制器的名字</span></span><br><span class="line">  name: nginx-rs</span><br><span class="line">spec:</span><br><span class="line"><span class="comment"># 副本数量</span></span><br><span class="line">  replicas: 5</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: zls</span><br><span class="line"><span class="comment">########### POD ############</span></span><br><span class="line">  template:</span><br><span class="line"><span class="comment"># POD的metadata</span></span><br><span class="line">    metadata:</span><br><span class="line"><span class="comment"># POD名字</span></span><br><span class="line">      name: nginx-pod</span><br><span class="line"><span class="comment"># POD标签名</span></span><br><span class="line">      labels:</span><br><span class="line">        name: zls</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##### selector（标签选择器，必须要写）######</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 总结：</span></span><br><span class="line">1.RS控制器的接口版本不是v1</span><br><span class="line">2.RS控制器spec中，selector（标签选择器，必须要写）</span><br><span class="line">3.POD必须使用labels打标签</span><br><span class="line">4.RS控制器的template要包住原来的POD资源内容</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看pod信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">nginx-rs-47gkr 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-52h99 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-5ptcs 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-84qn6 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-8nfpd 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-jx29k 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-qps77 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-ws9t4 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-wsqsf 1/1 Running 0 2m13s</span><br><span class="line">nginx-rs-zw97k 1/1 Running 0 2m13s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看pod详细信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE IP NODE</span><br><span class="line">NOMINATED NODE READINESS GATES</span><br><span class="line">nginx-rs-47gkr 1/1 Running 0 2m42s 10.2.1.16 k8s03 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-52h99 1/1 Running 0 2m42s 10.2.2.36 k8s02 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-5ptcs 1/1 Running 0 2m42s 10.2.2.33 k8s02 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-84qn6 1/1 Running 0 2m42s 10.2.2.38 k8s02 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-8nfpd 1/1 Running 0 2m42s 10.2.1.14 k8s03 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-jx29k 1/1 Running 0 2m42s 10.2.1.17 k8s03 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-qps77 1/1 Running 0 2m42s 10.2.2.35 k8s02 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-ws9t4 1/1 Running 0 2m42s 10.2.1.15 k8s03 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-wsqsf 1/1 Running 0 2m42s 10.2.2.37 k8s02 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line">nginx-rs-zw97k 1/1 Running 0 2m42s 10.2.2.34 k8s02 &lt;none&gt;</span><br><span class="line">&lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看pod的标签</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod --show-labels</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE LABELS</span><br><span class="line">nginx-rs-47gkr 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-52h99 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-5ptcs 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-84qn6 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-8nfpd 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-jx29k 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-qps77 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-ws9t4 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-wsqsf 1/1 Running 0 3m16s name=zls</span><br><span class="line">nginx-rs-zw97k 1/1 Running 0 3m16s name=zls</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看rs控制器</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME DESIRED CURRENT READY AGE</span><br><span class="line">nginx-rs 10 10 10 3m45s</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe rs nginx-rs</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="动态扩缩容"><a href="#动态扩缩容" class="headerlink" title="动态扩缩容"></a>动态扩缩容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.通过edit直接修改rs资源清单</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl edit rs nginx-rs</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.使用scale命令扩缩容</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl scale rs nginx-rs --replicas=6</span></span><br></pre></td></tr></table></figure><h2 id="Deployment控制器"><a href="#Deployment控制器" class="headerlink" title="Deployment控制器"></a>Deployment控制器</h2><h3 id="Deployment控制器-与-RS控制器的关系"><a href="#Deployment控制器-与-RS控制器的关系" class="headerlink" title="Deployment控制器 与 RS控制器的关系"></a>Deployment控制器 与 RS控制器的关系</h3><p>虽然我们创建的是Deployment类型资源，但实际上控制副本还是由RS来控制的，Deployment只是替我 们去创建RS控制器，然后再由RS去控制POD副本. </p><p>Deployment控制器还有一个比较重要的功能就是滚动更新和版本回滚，而这个功能就是以来RS控制器。</p><p><strong>Deployment控制器升级版本执行流程</strong></p><ul><li>1.Deployment控制器是先创建一个RS控制器</li><li>2.通过资源清单，控制新的RS控制器来创建新的POD</li><li>3.旧的POD先标记删除</li><li>4.新的POD创建running之后，running一个删除一个旧的POD</li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230613162817650.png" alt="image-20230613162817650"></p><h3 id="Deployment控制器资源清单"><a href="#Deployment控制器资源清单" class="headerlink" title="Deployment控制器资源清单"></a>Deployment控制器资源清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># vim nginx-dp.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dp</span><br><span class="line">spec:</span><br><span class="line">  replicas: 5</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: zls</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: nginx-pod</span><br><span class="line">      labels:</span><br><span class="line">        name: zls</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看资源</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">nginx-dp-6945b555b4-2mfqg 1/1 Running 0 8s</span><br><span class="line">nginx-dp-6945b555b4-5m8dt 1/1 Running 0 8s</span><br><span class="line">nginx-dp-6945b555b4-97vtf 0/1 ContainerCreating 0 8s</span><br><span class="line">nginx-dp-6945b555b4-cfjlx 1/1 Running 0 8s</span><br><span class="line">nginx-dp-6945b555b4-h6zkc 0/1 ContainerCreating 0 8s</span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME DESIRED CURRENT READY AGE</span><br><span class="line">nginx-dp-6945b555b4 5 5 5   23s</span><br><span class="line">nginx-rs 6 6 6   46m</span><br><span class="line"></span><br><span class="line"><span class="comment">## rs信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe rs nginx-dp-6945b555b4</span></span><br><span class="line">Name:  nginx-dp-6945b555b4</span><br><span class="line">Namespace:  default</span><br><span class="line">Selector:  name=zls,pod-template-hash=6945b555b4</span><br><span class="line">Labels:  name=zls</span><br><span class="line"> pod-template-hash=6945b555b4</span><br><span class="line">Annotations: deployment.kubernetes.io/desired-replicas: 5</span><br><span class="line"> deployment.kubernetes.io/max-replicas: 7</span><br><span class="line"> deployment.kubernetes.io/revision: 1</span><br><span class="line">Controlled By: Deployment/nginx-dp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## pod信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe pod nginx-dp-6945b555b4-2mfqg</span></span><br><span class="line">Name: nginx-dp-6945b555b4-2mfqg</span><br><span class="line">Namespace: default</span><br><span class="line">Priority: 0</span><br><span class="line">Node: k8s02/10.0.0.12</span><br><span class="line">Start Time: Tue, 13 Jun 2023 11:18:35 +0800</span><br><span class="line">Labels: name=zls</span><br><span class="line">pod-template-hash=6945b555b4</span><br><span class="line">Annotations: &lt;none&gt;</span><br><span class="line">Status: Running</span><br><span class="line">IP: 10.2.2.54</span><br><span class="line">IPs:</span><br><span class="line">IP: 10.2.2.54</span><br><span class="line">Controlled By: ReplicaSet/nginx-dp-6945b555b4</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看rs 和 dp</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME DESIRED CURRENT READY AGE</span><br><span class="line">nginx-dp-6945b555b4 0 0 0 19m</span><br><span class="line">nginx-dp-84fd86dfc5 5 5 5 11m</span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get deploy</span></span><br><span class="line">NAME READY UP-TO-DATE AVAILABLE AGE</span><br><span class="line">nginx-dp 5/5 5 5 19m</span><br></pre></td></tr></table></figure><h3 id="动态修改dp资源"><a href="#动态修改dp资源" class="headerlink" title="动态修改dp资源"></a>动态修改dp资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改资源清单</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl edit nginx-dp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看基本信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe deploy nginx-dp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 1.命令行 根据资源清单 更新镜像(第一种)</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl set image -f nginx-dp.yaml nginx-container=nginx:1.21.3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.命令行 不指定资源清单(第二种)</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl set image deployment nginx-dp nginxcontainer=nginx:1.21.4</span></span><br></pre></td></tr></table></figure><h3 id="deployment-回滚到上一个版本"><a href="#deployment-回滚到上一个版本" class="headerlink" title="deployment 回滚到上一个版本"></a>deployment 回滚到上一个版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看当前dp镜像版本</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe deployments.apps nginx-dp</span></span><br><span class="line">  Containers:</span><br><span class="line">    nginx-container:</span><br><span class="line">      Image: nginx:1.21.</span><br><span class="line">      </span><br><span class="line"><span class="comment">## 查看rs状态</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get rs -o wide</span></span><br><span class="line">NAME DESIRED CURRENT READY AGE CONTAINERS</span><br><span class="line">IMAGES SELECTOR</span><br><span class="line">nginx-dp-5b5d49959  5 5 5 5m45s nginx-container nginx:1.21.4 name=zls,pod-template-hash=5b5d49959</span><br><span class="line">nginx-dp-5c7f84b79d 0 0 0 8m34s nginx-container nginx:1.21.3 name=zls,pod-template-hash=5c7f84b79d</span><br><span class="line">nginx-dp-686f58fd46 0 0 0 13m nginx-container nginx:1.20.2 name=zls,pod-template-hash=686f58fd46</span><br><span class="line">nginx-dp-6945b555b4 0 0 0 33m nginx-container nginx:alpine name=zls,pod-template-hash=6945b555b4</span><br><span class="line">nginx-dp-84fd86dfc5 0 0 0 26m nginx-container nginx:1.20.1 name=zls,pod-template-hash=84fd86dfc5</span><br><span class="line"></span><br><span class="line"><span class="comment">## 回滚(只能回滚到上一个版本)</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl rollout undo deployment nginx-dp</span></span><br><span class="line">deployment.apps/nginx-dp rolled back</span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get rs -o wide</span></span><br><span class="line">NAME DESIRED CURRENT READY AGE CONTAINERS</span><br><span class="line">IMAGES SELECTOR</span><br><span class="line">nginx-dp-5b5d49959  0 0 0 6m37s nginx-container nginx:1.21.4 name=zls,pod-template-hash=5b5d49959</span><br><span class="line">nginx-dp-5c7f84b79d 5 5 5 9m26s nginx-container nginx:1.21.3 name=zls,pod-template-hash=5c7f84b79d</span><br><span class="line">nginx-dp-686f58fd46 0 0 0 13m nginx-container nginx:1.20.2 name=zls,pod-template-hash=686f58fd46</span><br><span class="line">nginx-dp-6945b555b4 0 0 0 34m nginx-container nginx:alpine name=zls,pod-template-hash=6945b555b4</span><br><span class="line">nginx-dp-84fd86dfc5 0 0 0 26m nginx-container nginx:1.20.1 name=zls,pod-template-hash=84fd86dfc5</span><br></pre></td></tr></table></figure><h3 id="deployment回滚到指定版本"><a href="#deployment回滚到指定版本" class="headerlink" title="deployment回滚到指定版本"></a>deployment回滚到指定版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### nginx-dp是deployment的名字</span></span><br><span class="line"><span class="comment">### --record会把这条命令记录成下一个版本的标签备注</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 1.查看dp所有的历史版本</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl rollout history deployment nginx-dp</span></span><br><span class="line">REVISION CHANGE-CAUSE</span><br><span class="line">1 &lt;none&gt;</span><br><span class="line">2 &lt;none&gt;</span><br><span class="line">3 &lt;none&gt;</span><br><span class="line">5 &lt;none&gt;</span><br><span class="line">6 &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.回滚到指定版本</span></span><br><span class="line">kubectl rollout undo deployment nginx-dp --to-revision=3</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.apply时加上--record</span></span><br><span class="line">kubectl apply -f nginx-dp.yaml --record</span><br><span class="line"></span><br><span class="line"><span class="comment">## 4.修改镜像版本时，加上--record</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment nginx-dp nginx-container=nginx:1.20.6 --record</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment nginx-dp</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl rollout history deployment nginx-dp</span></span><br><span class="line">deployment.apps/nginx-dp</span><br><span class="line">REVISION CHANGE-CAUSE</span><br><span class="line">1 &lt;none&gt;</span><br><span class="line">2 &lt;none&gt;</span><br><span class="line">5 &lt;none&gt;</span><br><span class="line">6 &lt;none&gt;</span><br><span class="line">7 &lt;none&gt;</span><br><span class="line">8 kubectl apply --filename=nginx-dp.yaml --record=<span class="literal">true</span></span><br><span class="line">9 kubectl apply --filename=nginx-dp.yaml --record=<span class="literal">true</span></span><br><span class="line">10kubectl <span class="built_in">set</span> image deployment nginx-dp nginx-container=nginx:1.20.6 --record=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看指定revision版本</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl rollout history deployment nginx-dp --revision=5</span></span><br><span class="line">deployment.apps/nginx-dp with revision <span class="comment">#5</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels: name=zls</span><br><span class="line">     pod-template-hash=5b5d49959</span><br><span class="line">  Containers:</span><br><span class="line">    nginx-container:</span><br><span class="line">      Image: nginx:1.21.4</span><br><span class="line">      Port: &lt;none&gt;</span><br><span class="line">      Host Port: &lt;none&gt;</span><br><span class="line">      Environment: &lt;none&gt;</span><br><span class="line">      Mounts: &lt;none&gt;</span><br><span class="line">    Volumes: &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="deployment扩缩容（命令修改需求POD个数）"><a href="#deployment扩缩容（命令修改需求POD个数）" class="headerlink" title="deployment扩缩容（命令修改需求POD个数）"></a>deployment扩缩容（命令修改需求POD个数）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># kubectl scale deployment nginx-dp --replicas=3</span></span><br></pre></td></tr></table></figure><h2 id="DaemonSet控制器"><a href="#DaemonSet控制器" class="headerlink" title="DaemonSet控制器"></a>DaemonSet控制器</h2><p><strong>简单来说就是每个节点部署一个POD副本</strong> </p><p><strong>常见的应用场景：</strong> </p><ul><li>监控容器 </li><li>日志收集容器</li><li>比如客户端</li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230613165506624.png" alt="image-20230613165506624"></p><h3 id="资源清单"><a href="#资源清单" class="headerlink" title="资源清单"></a>资源清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 相比较deployment：</span></span><br><span class="line"><span class="comment"># 修改了kind: DaemonSet</span></span><br><span class="line"><span class="comment"># 去除了replicas: 5</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># cat nginx-ds.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: db-dp</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: db-pod</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: mysql:5.7</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pod的生命周期，启动cicd应用</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-3-k8s-Pod%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%8C%E5%90%AF%E5%8A%A8cicd%E5%BA%94%E7%94%A8/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-3-k8s-Pod%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%8C%E5%90%AF%E5%8A%A8cicd%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="POD的生命周期"><a href="#POD的生命周期" class="headerlink" title="POD的生命周期"></a>POD的生命周期</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230612175735069.png" alt="image-20230612175735069"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230612175754812.png" alt="image-20230612175754812"></p><h2 id="初始化容器"><a href="#初始化容器" class="headerlink" title="初始化容器"></a>初始化容器</h2><p>初始化容器是指，在主容器启动之前，我们可以让他做一些准备工作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如</span></span><br><span class="line">1.两个容器做了共享存储，那么我们可以让它先启动一个容器，来对目录进行更改用户和授权</span><br><span class="line">2.容器需要连接数据库，那么可以让初始化容器检测数据库是否可以正常连接，如果可以再启动主容器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 例（args列表类型第一种写法）</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: init-dir</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">  initContainers:</span><br><span class="line">  - name: init</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    args:</span><br><span class="line">    - <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">    - <span class="string">&#x27;-c&#x27;</span></span><br><span class="line">    - <span class="string">&#x27;/bin/echo test_k8s_init &gt; /data/nginx/index.html&#x27;</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: init-dir</span><br><span class="line">      mountPath: /data/nginx</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-c</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: init-dir</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"><span class="comment">## 例（args列表类型第二种写法）</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: init-dir</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">  initContainers:</span><br><span class="line">  - name: init</span><br><span class="line">    image: busybox</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    args: [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;/bin/echo testxxxxxxxxxxxxxxxxxxxxxxxx &gt; /data/nginx/index.html&#x27;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: init-dir</span><br><span class="line">      mountPath: /data/nginx</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-c</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: init-dir</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br></pre></td></tr></table></figure><h2 id="钩子在jenkins中的体现"><a href="#钩子在jenkins中的体现" class="headerlink" title="钩子在jenkins中的体现"></a>钩子在jenkins中的体现</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230612180305873.png" alt="image-20230612180305873"></p><h2 id="钩子（hook）web-hook"><a href="#钩子（hook）web-hook" class="headerlink" title="钩子（hook）web hook"></a>钩子（hook）web hook</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## hook</span></span><br><span class="line">Pre：在....之前</span><br><span class="line">Post：在....之后</span><br><span class="line">PostStart：启动钩子 在容器启动创建后，立即执行，但时间不能太长，否则容器不会是running状态</span><br><span class="line">PreStop：在容器停止前，执行一些命令，主要用于优雅关闭程序</span><br></pre></td></tr></table></figure><h3 id="PostStart-启动钩子"><a href="#PostStart-启动钩子" class="headerlink" title="PostStart 启动钩子"></a>PostStart 启动钩子</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## PostStart 启动钩子（启动之后的操作）</span></span><br><span class="line"><span class="built_in">exec</span>: <span class="comment"># 执行命令</span></span><br><span class="line"><span class="built_in">command</span>:<span class="comment"># 要执行的命令</span></span><br><span class="line">httpGet: <span class="comment"># 发送HTTP请求（检测页面健康状态）</span></span><br><span class="line">host: <span class="comment"># blog.zls.com</span></span><br><span class="line">path: <span class="comment">#  /index.html</span></span><br><span class="line">port: <span class="comment"># 80</span></span><br><span class="line">tcpSocket: <span class="comment"># 建立TCP连接</span></span><br><span class="line">host: <span class="comment"># 10.0.0.51</span></span><br><span class="line">port: <span class="comment"># 3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动钩子exec</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-c</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle:</span><br><span class="line">      postStart:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;/bin/echo test_POST_start &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br></pre></td></tr></table></figure><h3 id="PreStop-停止钩子"><a href="#PreStop-停止钩子" class="headerlink" title="PreStop 停止钩子"></a>PreStop 停止钩子</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## PreStop 停止钩子（停止之前的操作）</span></span><br><span class="line"><span class="built_in">exec</span>: <span class="comment"># 执行命令</span></span><br><span class="line"><span class="built_in">command</span>:<span class="comment"># 要执行的命令</span></span><br><span class="line">httpGet: <span class="comment"># 发送HTTP请求（检测页面健康状态）</span></span><br><span class="line">host: <span class="comment"># blog.zls.com</span></span><br><span class="line">path: <span class="comment">#  /index.html</span></span><br><span class="line">port: <span class="comment"># 80</span></span><br><span class="line">tcpSocket: <span class="comment"># 建立TCP连接</span></span><br><span class="line">host: <span class="comment"># 10.0.0.51</span></span><br><span class="line">port: <span class="comment"># 3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 停止钩子exec（挂载是为了停止钩子命令的体现）</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pre-nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: <span class="built_in">test</span></span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/nginx</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-pre</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle:</span><br><span class="line">      preStop:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;/bin/echo bye &gt; /tmp/1.txt&#x27;</span>]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: <span class="built_in">test</span></span><br><span class="line">      mountPath: /tmp/</span><br></pre></td></tr></table></figure><h2 id="POD探针"><a href="#POD探针" class="headerlink" title="POD探针"></a>POD探针</h2><h3 id="存活性探针"><a href="#存活性探针" class="headerlink" title="存活性探针"></a>存活性探针</h3><p>存活探针简单来说就是用来检测容器的应用程序是否还正常工作，如果应用程序不正常，即使容器还活 着也没有意义了，所以这时候就可以使用存活探针来探测，如果应用程序不正常，就重启POD。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 存活性探针</span></span><br><span class="line">livenessprobe：</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>: 执行命令</span><br><span class="line">  <span class="built_in">command</span>: [需要执行的命令]</span><br><span class="line"></span><br><span class="line">httpGet:</span><br><span class="line">  host: blog.zls.com</span><br><span class="line">  path: /index.html</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">tcpSocket:</span><br><span class="line">  port: 3306</span><br><span class="line"></span><br><span class="line">timeoutSeconds: 超时时间</span><br><span class="line">initialDelaySeconds: 第一次执行执行存活探针，需要等待的时间（等待服务启动的时间）</span><br><span class="line">failureThreshold: 检测失败的次数（达到指定次数后，才重启POD）</span><br><span class="line">periodSeconds: 执行探针间隔时间</span><br><span class="line">successThreshold: 检测成功的次数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># cat livenessprobe.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: live-nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: live-nginx</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /root/nginx</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-c</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle:</span><br><span class="line">      postStart:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;/bin/echo test live &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /index.html</span><br><span class="line">        port: 80</span><br><span class="line">      timeoutSeconds: 20</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      periodSeconds: 1</span><br><span class="line"></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: live-nginx</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br></pre></td></tr></table></figure><h3 id="就绪性探针"><a href="#就绪性探针" class="headerlink" title="就绪性探针"></a>就绪性探针</h3><p>有时候我们Pod本身已经起来了，但是pod的容器还没有完全准备好对外提供服务，那么这时候流量进 来就会造成请求失败的情况出现，针对这种情况k8s有一种探针叫就绪探针，他的作用就是让k8s知道你 的Pod内应用是否准备好为请求提供服务。只有就绪探针ok了才会把流量转发到pod上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 就绪性探针</span></span><br><span class="line">readnessprobe：</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>: <span class="comment"># 执行命令</span></span><br><span class="line">  <span class="built_in">command</span>: <span class="comment"># [需要执行的命令]</span></span><br><span class="line"></span><br><span class="line">httpGet:</span><br><span class="line">  host: <span class="comment"># blog.zls.com</span></span><br><span class="line">  path: <span class="comment"># /index.html</span></span><br><span class="line">  port: <span class="comment"># 80</span></span><br><span class="line"></span><br><span class="line">tcpSocket:</span><br><span class="line">  port: <span class="comment"># 3306</span></span><br><span class="line"></span><br><span class="line">timeoutSeconds: 超时时间</span><br><span class="line">initialDelaySeconds: 第一次执行执行存活探针，需要等待的时间（等待服务启动的时间）</span><br><span class="line">failureThreshold: 检测失败的次数（达到指定次数后，才重启POD）</span><br><span class="line">periodSeconds: 执行探针间隔时间</span><br><span class="line">successThreshold: 检测成功的次数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># cat readnessprobe.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line"> name: read-nginx-pod</span><br><span class="line">spec:</span><br><span class="line"> volumes:</span><br><span class="line"> - name: read-nginx</span><br><span class="line">   hostPath:</span><br><span class="line">     path: /root/nginx</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-c</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    lifecycle:</span><br><span class="line">      postStart:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>: [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;/bin/echo test live &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存活性探针</span></span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /index.html</span><br><span class="line">        port: 80</span><br><span class="line">      timeoutSeconds: 20</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      periodSeconds: 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 就绪性探针</span></span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 3306</span><br><span class="line">      timeoutSeconds: 20</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">      periodSeconds: 1</span><br><span class="line"></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: read-nginx</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br></pre></td></tr></table></figure><h2 id="启动gitlab、jenkins"><a href="#启动gitlab、jenkins" class="headerlink" title="启动gitlab、jenkins"></a>启动gitlab、jenkins</h2><h3 id="启动gitlab"><a href="#启动gitlab" class="headerlink" title="启动gitlab"></a>启动gitlab</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> docker-compose.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">version: <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: <span class="string">&#x27;gitlab/gitlab-ce:latest&#x27;</span></span><br><span class="line">    container_name: gitlab</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url <span class="string">&#x27;http://10.0.0.21&#x27;</span></span><br><span class="line">        gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222</span><br><span class="line">        prometheus[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        prometheus[<span class="string">&#x27;monitor_kubernetes&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        prometheus_monitoring[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        alertmanager[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        node_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        redis_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        postgres_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        grafana[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;2222:22&#x27;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&#x27;/data/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;/data/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;/data/gitlab/data:/var/opt/gitlab&#x27;</span></span><br><span class="line">    shm_size: <span class="string">&#x27;256m&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="gitlab资源清单"><a href="#gitlab资源清单" class="headerlink" title="gitlab资源清单"></a>gitlab资源清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: gitlab-conf</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/gitlab/config</span><br><span class="line">  - name: gitlab-log</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/gitlab/logs</span><br><span class="line">  - name: gitlab-data</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/gitlab/data</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: gitlab-c</span><br><span class="line">    image: gitlab/gitlab-ce:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: gitlab-conf</span><br><span class="line">      mountPath: /etc/gitlab</span><br><span class="line">    - name: gitlab-log</span><br><span class="line">      mountPath: /var/log/gitlab</span><br><span class="line">    - name: gitlab-data</span><br><span class="line">      mountPath: /var/opt/data</span><br></pre></td></tr></table></figure><h3 id="启动jenkins"><a href="#启动jenkins" class="headerlink" title="启动jenkins"></a>启动jenkins</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">jenkins:</span><br><span class="line">  image: jenkins/jenkins</span><br><span class="line">  container_name: jenkins</span><br><span class="line">  restart: always</span><br><span class="line">  ports:</span><br><span class="line">    - <span class="string">&#x27;8080:8080&#x27;</span></span><br><span class="line">    - <span class="string">&#x27;50000:50000&#x27;</span></span><br><span class="line">  volumes:</span><br><span class="line">    - /etc/docker/daemon.json:/etc/docker/daemon.json</span><br><span class="line">    - /data/jenkins:/var/jenkins_home</span><br><span class="line">    - /usr/bin/docker:/usr/bin/docker</span><br><span class="line">    - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">    - /root/.docker/:/root/.docker/</span><br><span class="line">    - /root/.ssh/:/root/.ssh/</span><br><span class="line">  user: root</span><br><span class="line">  privileged: <span class="literal">true</span></span><br><span class="line">  links:</span><br><span class="line">    - gitlab</span><br></pre></td></tr></table></figure><h3 id="jenkins资源清单"><a href="#jenkins资源清单" class="headerlink" title="jenkins资源清单"></a>jenkins资源清单</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: docker-conf</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /etc/docker/daemon.json</span><br><span class="line">  - name: jenkins-data</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/jenkins</span><br><span class="line">  - name: docker-cmd</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /usr/bin/docker</span><br><span class="line">  - name: docker-sock</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /var/run/docker.sock</span><br><span class="line">      </span><br><span class="line">  containers:</span><br><span class="line">  - name: jenkins-c</span><br><span class="line">    image: jenkins/jenkins</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: docker-conf</span><br><span class="line">      mountPath: /etc/docker/daemon.json</span><br><span class="line">    - name: jenkins-data</span><br><span class="line">      mountPath: /var/jenkins_home</span><br><span class="line">    - name: docker-cmd</span><br><span class="line">      mountPath: /usr/bin/docker</span><br><span class="line">    - name: docker-sock</span><br><span class="line">      mountPath: /var/run/docker.sock</span><br></pre></td></tr></table></figure><h3 id="同时启动"><a href="#同时启动" class="headerlink" title="同时启动"></a>同时启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: gitlab-conf</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/gitlab/config</span><br><span class="line">  - name: gitlab-log</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/gitlab/logs</span><br><span class="line">  - name: gitlab-data</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/gitlab/data</span><br><span class="line">  - name: docker-conf</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /etc/docker/daemon.json</span><br><span class="line">  - name: jenkins-data</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/jenkins</span><br><span class="line">  - name: docker-cmd</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /usr/bin/docker</span><br><span class="line">  - name: docker-sock</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /var/run/docker.sock</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: gitlab-c</span><br><span class="line">    image: gitlab/gitlab-ce:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: gitlab-conf</span><br><span class="line">      mountPath: /etc/gitlab</span><br><span class="line">    - name: gitlab-log</span><br><span class="line">      mountPath: /var/log/gitlab</span><br><span class="line">    - name: gitlab-data</span><br><span class="line">      mountPath: /var/opt/data</span><br><span class="line"></span><br><span class="line">  - name: jenkins-c</span><br><span class="line">    image: jenkins/jenkins</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: docker-conf</span><br><span class="line">      mountPath: /etc/docker/daemon.json</span><br><span class="line">    - name: jenkins-data</span><br><span class="line">      mountPath: /var/jenkins_home</span><br><span class="line">    - name: docker-cmd</span><br><span class="line">      mountPath: /usr/bin/docker</span><br><span class="line">    - name: docker-sock</span><br><span class="line">      mountPath: /var/run/docker.sock</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>部署k8s</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-2-k8s-%E9%83%A8%E7%BD%B2k8s/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-2-k8s-%E9%83%A8%E7%BD%B2k8s/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="部署K8S"><a href="#部署K8S" class="headerlink" title="部署K8S"></a>部署K8S</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><div class="table-container"><table><thead><tr><th>主机名</th><th>外网IP</th><th>内网IP</th><th>角色</th><th>应用</th><th>组件</th></tr></thead><tbody><tr><td>k8s01</td><td>10.0.0.11</td><td>172.16.1.11</td><td>k8s master</td><td>docker19.03.15、 kubeadm1.19.3</td><td>apiServer、etcd、 Scheduler、Controller、 kubelet、proxy、docker</td></tr><tr><td>k8s02</td><td>10.0.0.12</td><td>172.16.1.12</td><td>k8s node</td><td>docker19.03.15</td><td>kubelet、proxy、docker</td></tr><tr><td>k8s03</td><td>10.0.0.13</td><td>172.16.1.13</td><td>k8s node</td><td>docker19.03.15</td><td>kubelet、proxy、docker</td></tr></tbody></table></div><h3 id="IP规划"><a href="#IP规划" class="headerlink" title="IP规划"></a>IP规划</h3><div class="table-container"><table><thead><tr><th>三种Service</th><th>IP</th></tr></thead><tbody><tr><td>Pod IP</td><td>10.2.0.0/16</td></tr><tr><td>Cluster IP</td><td>10.1.0.0/16</td></tr><tr><td>NodePort/宿主机IP</td><td>10.0.0.0/24</td></tr></tbody></table></div><h3 id="K8S安装方式"><a href="#K8S安装方式" class="headerlink" title="K8S安装方式"></a>K8S安装方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.二进制安装</span><br><span class="line">2.ansible</span><br><span class="line"></span><br><span class="line">3.kubeadm（生产最佳实践）</span><br><span class="line">4.Rancher（图形化k8s管理界面）</span><br><span class="line"></span><br><span class="line">5.云服务：ACK EKS</span><br></pre></td></tr></table></figure><h3 id="安装k8s环境准备"><a href="#安装k8s环境准备" class="headerlink" title="安装k8s环境准备"></a>安装k8s环境准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################ master &amp;&amp; node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.kubelet禁用swap</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/sysconfig/kubelet &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.内核开启iptables及内核转发</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.下载docker官方源</span></span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.更改成清华源</span></span><br><span class="line">sed -i <span class="string">&#x27;s+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.做时间同步(chronyd只要启动就会自动时间同步)</span></span><br><span class="line">yum install -y chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.关闭swap</span></span><br><span class="line">sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line">swapoff -a</span><br><span class="line">free -m</span><br><span class="line">Swap: 0 0 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.加载ipvs模块（修改网络参数，网络转发）</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#! /bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.给ipvs脚本添加执行权限，并执行脚本</span></span><br><span class="line"><span class="built_in">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="built_in">source</span> /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.检查是否加载成功</span></span><br><span class="line">lsmod|grep -e <span class="string">&#x27;ip_vs&#x27;</span> -e <span class="string">&#x27;nf_conntrack_ipv&#x27;</span></span><br><span class="line">nf_conntrack_ipv4 15053 0</span><br><span class="line">nf_defrag_ipv4 12729 1 nf_conntrack_ipv4</span><br><span class="line">ip_vs_sh 12688 0</span><br><span class="line">ip_vs_wrr 12697 0</span><br><span class="line">ip_vs_rr 12600 0</span><br><span class="line">ip_vs 145497 6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class="line">nf_conntrack 133095 2 ip_vs,nf_conntrack_ipv4</span><br><span class="line">libcrc32c 12644 3 xfs,ip_vs,nf_conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.查找其他版本的docker-ce</span></span><br><span class="line">yum list docker-ce --showduplicates</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.安装docker-ce-19.03.15（安装k8s和docker相互支持的版本）</span></span><br><span class="line">yum install -y docker-ce-19.03.15 docker-ce-cli-19.03.15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 12.修改docker配置文件</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;阿里云容器加速服务&quot;</span>],</span><br><span class="line"><span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 13.启动docker</span></span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><h3 id="安装kuberadm"><a href="#安装kuberadm" class="headerlink" title="安装kuberadm"></a>安装kuberadm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################## master &amp;&amp; node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.下载kubeadm源</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装k8s相关组件</span></span><br><span class="line">yum install kubelet-1.19.3 kubeadm-1.19.3 kubectl-1.19.3 ipvsadm -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.启动kubelet，并设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########################### master</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.初始化master节点（只需要在master上执行：10.0.0.11）</span></span><br><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=10.0.0.11 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">--kubernetes-version=v1.19.3 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.2.0.0/16 \</span><br><span class="line">--service-dns-domain=cluster.local \</span><br><span class="line">--ignore-preflight-errors=Swap \</span><br><span class="line">--ignore-preflight-errors=NumCPU</span><br><span class="line"></span><br><span class="line"><span class="comment">### 执行完成后，将下面一段话，保存</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as</span><br><span class="line">root:</span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.11:6443 --token 7d5uly.zvogub8zbzgtrylr \</span><br><span class="line">--discovery-token-ca-cert-hash</span><br><span class="line">sha256:60ad6895eba7a0f1d8a94d4f36a1921e74fa235461069a5f692e2566f9ff5f68</span><br><span class="line"></span><br><span class="line"><span class="comment">## 重新初始化（初始化有问题执行这个，输入yes，就是删除之前初始化的数据）</span></span><br><span class="line">kubeadm reset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.创建k8s配置文件目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.拷贝k8s配置文件</span></span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.给k8s配置文件授权</span></span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################## node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.其他node节点加入集群</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.11:6443 --token 7d5uly.zvogub8zbzgtrylr \</span><br><span class="line">--discovery-token-ca-cert-hash \</span><br><span class="line">sha256:60ad6895eba7a0f1d8a94d4f36a1921e74fa235461069a5f692e2566f9ff5f68</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################### master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 注意：如果忘记了以上加入节点的命令，则需要执行以下命令，重新生成新的令牌（token）(master)</span></span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.在master上查看所有集群节点</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">k8s01 NotReady master 34m v1.19.3</span><br><span class="line">k8s02 NotReady &lt;none&gt; 118s v1.19.3</span><br><span class="line">k8s03 NotReady &lt;none&gt; 2m v1.19.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.修改kube-proxy配置文件，使用ipvs模块</span></span><br><span class="line">kubectl edit configmap kube-proxy -n kube-system</span><br><span class="line">将mode:<span class="string">&quot;&quot;</span> 改为 mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## k8s查看资源命令</span></span><br><span class="line">kubectl get [pod|namespace|controller|node|configmap...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.重启kube-proxy</span></span><br><span class="line"><span class="comment">## 查看所有pod</span></span><br><span class="line">kubectl -n kube-system get pod</span><br><span class="line">kube-proxy-2d479 1/1 Running 0 14m</span><br><span class="line">kube-proxy-2ng8t 1/1 Running 0 46m</span><br><span class="line">kube-proxy-t2ztv 1/1 Running 0 14m</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除kube-proxy的pod</span></span><br><span class="line">kubectl -n kube-system delete pod kube-proxy-2d479</span><br><span class="line">kubectl -n kube-system delete pod kube-proxy-2ng8t</span><br><span class="line">kubectl -n kube-system delete pod kube-proxy-t2ztv</span><br><span class="line"><span class="comment">## 快捷删除</span></span><br><span class="line">kubectl -n kube-system get pod | grep <span class="string">&quot;kube-proxy&quot;</span> \</span><br><span class="line">| awk <span class="string">&#x27;&#123;print &quot;kubectl -n kube-system delete pod&quot;$1&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 12.配置flannel网络(github)</span></span><br><span class="line">wget https://github.com/flannel-io/flannel/blob/master/Documentation/kustomization/kube-flannel/kube-flannel.yml</span><br><span class="line"><span class="comment">## 下载flannel资源清单文件(其他)</span></span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 13.修改flannel资源清单</span></span><br><span class="line">vim kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">### 修改ip</span></span><br><span class="line">net-conf.json: |</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.244.0.0/16&quot;</span>,</span><br><span class="line"><span class="string">&quot;Backend&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Type&quot;</span>: <span class="string">&quot;vxlan&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">### 修改为：</span></span><br><span class="line">net-conf.json: |</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.2.0.0/16&quot;</span>,</span><br><span class="line"><span class="string">&quot;Backend&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;Type&quot;</span>: <span class="string">&quot;vxlan&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 修改网卡名称</span></span><br><span class="line">containers:</span><br><span class="line">- name: kube-flannel</span><br><span class="line">  image: docker.io/flannel/flannel:v0.22.0</span><br><span class="line">  <span class="comment">#image: docker.io/rancher/mirrored-flannelcni-flannel:v0.22.0</span></span><br><span class="line">  <span class="built_in">command</span>:</span><br><span class="line">  - /opt/bin/flanneld</span><br><span class="line">  args:</span><br><span class="line">  - --ip-masq</span><br><span class="line">  - --kube-subnet-mgr</span><br><span class="line"><span class="comment">### 修改为：(加一条 &quot;- --iface=eth0&quot; )</span></span><br><span class="line">containers:</span><br><span class="line">  - name: kube-flannel</span><br><span class="line">  image: docker.io/flannel/flannel:v0.22.0</span><br><span class="line">  <span class="comment">#image: docker.io/rancher/mirrored-flannelcni-flannel:v0.22.0</span></span><br><span class="line">  <span class="built_in">command</span>:</span><br><span class="line">  - /opt/bin/flanneld</span><br><span class="line">  args:</span><br><span class="line">  - --ip-masq</span><br><span class="line">  - --kube-subnet-mgr</span><br><span class="line">  - --iface=eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用当前资源清单</span></span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">namespace/kube-flannel created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-ds created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看flannel资源</span></span><br><span class="line">kubectl get pod -n kube-flannel</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">kube-flannel-ds-gtjl4 1/1 Running 0 104s</span><br><span class="line">kube-flannel-ds-smrb9 1/1 Running 0 104s</span><br><span class="line">kube-flannel-ds-w5khx 1/1 Running 0 104s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看flannel资源创建过程</span></span><br><span class="line">kubectl describe pod kube-flannel-ds-gtjl4 -n kube-flannel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看node节点（都是Ready，k8s集群就ok了）</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">k8s01 Ready master 69m v1.19.3</span><br><span class="line">k8s02 Ready &lt;none&gt; 37m v1.19.3</span><br><span class="line">k8s03 Ready &lt;none&gt; 37m v1.19.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给node节点打标签</span></span><br><span class="line">kubectl label nodes k8s02 node-role.kubernetes.io/node01= node/k8s02 labeled</span><br><span class="line">kubectl label nodes k8s03 node-role.kubernetes.io/node02= node/k8s03 labeled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看node状态</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">k8s01 Ready master 75m v1.19.3</span><br><span class="line">k8s02 Ready node01 42m v1.19.3</span><br><span class="line">k8s03 Ready node02 42m v1.19.3</span><br></pre></td></tr></table></figure><h2 id="艹友好的黑科技（补全all）"><a href="#艹友好的黑科技（补全all）" class="headerlink" title="艹友好的黑科技（补全all）"></a>艹友好的黑科技（补全all）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## k8s命令补全黑科技</span></span><br><span class="line"><span class="comment">## master</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载bash-completion</span></span><br><span class="line">yum install -y bash-completion</span><br><span class="line"></span><br><span class="line"><span class="comment"># source一下bash_completion</span></span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"></span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">kubectl completion bash &gt; /etc/bash_completion.d/kubectl</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>了解k8s</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/K8s-1-k8s-%E4%BA%86%E8%A7%A3k8s/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/K8s-1-k8s-%E4%BA%86%E8%A7%A3k8s/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="学习K8S参考网站"><a href="#学习K8S参考网站" class="headerlink" title="学习K8S参考网站"></a>学习K8S参考网站</h2><ul><li>官网：<a href="https://kubernetes.io/">TP</a></li><li>官方文档：<a href="https://kubernetes.io/zh-cn/docs/home/">TP</a></li><li>官方介绍：<a href="https://kubernetes.io/zh-cn/docs/concepts/overview/">TP</a></li><li>kubeadm官方文档：<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">TP</a></li><li>docker官方文档：<a href="https://docs.docker.com/">TP</a></li><li>prometheus官方文档：<a href="https://prometheus.io/docs/introduction/overview/">TP</a></li><li>ansible安装k8s项目：<a href="https://github.com/easzlab/kubeasz">TP</a></li><li>阿里云ACK：<a href="https://www.aliyun.com/product/kubernetes">TP</a></li><li>aws亚马逊云K8S产品EKS：<a href="https://aws.amazon.com/cn/eks/?nc2=h_ql_prod_ct_eks">TP</a></li><li>腾讯云TKE：<a href="https://cloud.tencent.com/product/tke">TP</a></li></ul><h2 id="什么是k8s"><a href="#什么是k8s" class="headerlink" title="什么是k8s"></a>什么是k8s</h2><p>此页面是 Kubernetes 的概述。 </p><p>Kubernetes 是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配 置和自动化。 </p><p>Kubernetes 拥有一个庞大且快速增长的生态，其服务、支持和工具的使用范围相当广 泛。 </p><p>Kubernetes 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符 的关系。 Google 在 2014 年开源了 Kubernetes 项目。 Kubernetes 建立在 Google 大规模运行生产工 作负载十几年经验的基础上， 结合了社区中最优秀的想法和实践。 </p><p>多机编排工具</p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607163610069.png" alt="image-20230607163610069"></p><h2 id="K8S组件介绍（7个）"><a href="#K8S组件介绍（7个）" class="headerlink" title="K8S组件介绍（7个）"></a>K8S组件介绍（7个）</h2><h3 id="Master-控制平面组件（Control-Plane-Components）"><a href="#Master-控制平面组件（Control-Plane-Components）" class="headerlink" title="Master 控制平面组件（Control Plane Components）"></a>Master 控制平面组件（Control Plane Components）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiserver：所有组件的入口（接口），司令部，所有组件，想要调用其他组件，都需要APIserver</span><br><span class="line"></span><br><span class="line">ETCD：存储所有组件产生的数据（爸爸）</span><br><span class="line"></span><br><span class="line">scheduler：资源计算，资源调度</span><br><span class="line"></span><br><span class="line">controller：控制组件,控制客户端创建容器</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607163654488.png" alt="image-20230607163654488"></p><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubelet：控制容器运行时</span><br><span class="line"></span><br><span class="line">proxy：网络组件（管理端口映射网络模式）</span><br><span class="line"></span><br><span class="line">容器运行时（Container Runtime）：运行容器的软件</span><br><span class="line">docker 、containerd、 CRI-O</span><br></pre></td></tr></table></figure><h2 id="K8S架构图"><a href="#K8S架构图" class="headerlink" title="K8S架构图"></a><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607163726075.png" alt="image-20230607163726075">K8S架构图</h2><h3 id="单机节点"><a href="#单机节点" class="headerlink" title="单机节点"></a>单机节点</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607163903959.png" alt="image-20230607163903959"></p><h3 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h3><p><strong>高可用的两种做法</strong></p><ul><li>master + nginx + keepalived</li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607163935115.png" alt="image-20230607163935115"></p><ul><li>master + haproxy + keepalived</li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607164050178.png" alt="image-20230607164050178"></p><h2 id="POD创建流程"><a href="#POD创建流程" class="headerlink" title="POD创建流程"></a>POD创建流程</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607164108281.png" alt="image-20230607164108281"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607164117337.png" alt="image-20230607164117337"></p><h2 id="k8s组件"><a href="#k8s组件" class="headerlink" title="k8s组件"></a>k8s组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master：控制平面组件control-plane</span></span><br><span class="line">apiServer：所有组件之间的通信都需要经过apiServer（司令部）</span><br><span class="line">ETCD：所有组件产生的数据，存放在ETCD中</span><br><span class="line">scheduler：资源计算、资源调度</span><br><span class="line">controller：POD控制器，控制组件，根据scheduler计算出的数据，控制node节点上的kubelet创建POD</span><br><span class="line"></span><br><span class="line"><span class="comment"># node：节点组件</span></span><br><span class="line">kubelet：控制容器运行时，创建POD</span><br><span class="line">proxy：网络组件，端口映射</span><br><span class="line">container runtime：容器运行时，启动容器的应用 docker、containerd、CRI-O</span><br></pre></td></tr></table></figure><h2 id="K8S的核心资源"><a href="#K8S的核心资源" class="headerlink" title="K8S的核心资源"></a>K8S的核心资源</h2><h3 id="POD"><a href="#POD" class="headerlink" title="POD"></a>POD</h3><p><strong>1.什么是POD</strong></p><p>Pod是k8s系统中可以创建和管理的最小单元，是资源对象模型中由用户创建或部署的最小资源对象模型，也是在k8s上运行容器化应用的资源对象，其他的资源对象都是用来支撑或者扩展Pod对象功能的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、K8S中的最小单位</span><br><span class="line">2、POD的IP地址是随机的，删除POD会改变IP</span><br><span class="line">3、POD都会有一个根容器pause</span><br><span class="line">4、一个Pod内可以由一个容器或多个容器组成</span><br><span class="line">5、一个Pod内的容器共享根容器的网络、名称空间、和文件系统卷</span><br><span class="line">6、一个Pod内的网络地址由根容器提供</span><br><span class="line">7、pod是短暂的（重启就可能发生变化）</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230608161518785.png" alt="image-20230608161518785"></p><p><strong>2.POD运行状态</strong></p><div class="table-container"><table><thead><tr><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>Pending（等待）</td><td>Pod已经被K8S系统接受，但是有一个或多个容器，尚未创建，亦未运行。此 阶段包括等待Pod被调度的时间和通过网络下载镜像的时间</td></tr><tr><td>Running（运行）</td><td>Pod已经绑定到某个节点(node)，Pod中所有容器都已被创建，至少有一个容 器仍在运行，或者处于启动或重启状态</td></tr><tr><td>Succeeded（成功）</td><td>Pod中所有容器都已成功终止，并且不会再重启</td></tr><tr><td>Failed（失败）</td><td>Pod中所有容器都已成功终止，并且有一个容器是因为失败而终止</td></tr><tr><td>Unknown（未知）</td><td>因为某些原因无法获取Pod状态，这种情况，通常是因为与Pod所在主机通信 失败</td></tr></tbody></table></div><h3 id="Namespace名称空间资源"><a href="#Namespace名称空间资源" class="headerlink" title="Namespace名称空间资源"></a>Namespace名称空间资源</h3><ul><li>Namespace（名称空间）是K8S中非常重要的一个概念，Namespace将集群内部的资源进行隔离划分。 </li><li>在Namespace中，形成逻辑上的不同项目组或用户组。</li></ul><h3 id="Controller控制器资源"><a href="#Controller控制器资源" class="headerlink" title="Controller控制器资源"></a>Controller控制器资源</h3><ul><li>RC Replication Controller 控制Pod有多个副本 </li><li>RS ReplicaSet RC控制器的升级版 // 10 自动拉起 </li><li>Deployment 推荐使用，功能强大，包含了RS控制器 // 支持版本更新 </li><li>DaemonSet 保证所有的Node节点上，有且只有一个Pod运行 // 装一些客户端软件，每台只 起一</li><li>StatefulSet 有状态的应用，为Pod提供唯一标识，它可以保证部署和scale的顺序<a href="[StatefulSet 基础 | Kubernetes](https://kubernetes.io/zh-cn/docs/tutorials/stateful-application/basic-stateful-set/">官方文档</a>)</li></ul><h3 id="Service网络资源"><a href="#Service网络资源" class="headerlink" title="Service网络资源"></a>Service网络资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 三种网络资源</span></span><br><span class="line"></span><br><span class="line">NodePort：宿主机上启动端口（端口映射）</span><br><span class="line"></span><br><span class="line">ClusterIP：类似于负载均衡，帮我们找到每一个POD</span><br><span class="line"></span><br><span class="line">POD IP：每一个POD都会有自己的IP地址</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230608161518785.png" alt="image-20230608162612265"></p><h3 id="Label标签"><a href="#Label标签" class="headerlink" title="Label标签"></a>Label标签</h3><ul><li>因为在K8S中，起的任何只要带IP的资源，那么IP地址都不是固定的，都会发生变化 </li><li>所以各个资源之间进行通信，是不可能靠IP地址进行通信的 </li><li>这就是Label出现的原因，有了标签，就可以给POD、ClusterIP等一系列有IP地址的资源，打标签 </li><li>通过标签名称进行通信即可</li></ul><ul><li>Label标签是K8S中非常重要的一个属性，Label标签就像身份证一样，可以用来识别K8S的对象。 </li><li>传统架构中，不同的服务应用之间通讯，都是通过IP和端口，但是在K8S中很多匹配关系都是通过标签来找。</li></ul><h3 id="core-DNS"><a href="#core-DNS" class="headerlink" title="core DNS"></a>core DNS</h3><p><strong>做DNS服务器的应用</strong></p><ul><li>bind9 </li><li>coreDNS </li><li>dnsmsq</li></ul><p>标签和IP的解析，如果IP发生变化，自动更改解析</p><h2 id="POD和控制器（Controller）的关系"><a href="#POD和控制器（Controller）的关系" class="headerlink" title="POD和控制器（Controller）的关系"></a>POD和控制器（Controller）的关系</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230608161518785.png" alt="image-20230608162853985"></p><h2 id="资源清单数据类型"><a href="#资源清单数据类型" class="headerlink" title="资源清单数据类型"></a>资源清单数据类型</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 资源清单数据类型</span></span><br><span class="line"></span><br><span class="line">1.string：<span class="string">&#x27;字符串&#x27;</span></span><br><span class="line"></span><br><span class="line">2.boolean：布尔值</span><br><span class="line">1）True/Yes</span><br><span class="line">2）False/No</span><br><span class="line"></span><br><span class="line">3.<span class="built_in">integer</span>：整型</span><br><span class="line"></span><br><span class="line">4.[]：列表类型 [<span class="string">&#x27;苹果&#x27;</span>,<span class="string">&#x27;香蕉&#x27;</span>,<span class="string">&#x27;桃子&#x27;</span>]</span><br><span class="line"><span class="comment"># ansible</span></span><br><span class="line">yum:</span><br><span class="line">  name:</span><br><span class="line">    - nginx</span><br><span class="line">    - mysql-server</span><br><span class="line">    - php-fpm</span><br><span class="line"><span class="comment"># k8s</span></span><br><span class="line">containers:</span><br><span class="line">- name:</span><br><span class="line">  image:</span><br><span class="line">  imagePullPolicy:</span><br><span class="line">- name:</span><br><span class="line">  image:</span><br><span class="line">  imagePullPolicy:</span><br><span class="line">  </span><br><span class="line">5.object：字典类型</span><br><span class="line">name: zls</span><br><span class="line">age: 18</span><br><span class="line">app: nginx</span><br></pre></td></tr></table></figure><h2 id="K8S常用命令"><a href="#K8S常用命令" class="headerlink" title="K8S常用命令"></a>K8S常用命令</h2><div class="table-container"><table><thead><tr><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>-n</td><td>指定名称空间</td></tr><tr><td>—image</td><td>指定镜像</td></tr><tr><td>-o</td><td>指定格式输出 常用：json</td></tr><tr><td>-f</td><td>指定资源清单</td></tr><tr><td>—show-labels</td><td>查看标签</td></tr><tr><td>-c</td><td>连接pod时，指定pod中的容器名</td></tr></tbody></table></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看指定资源</span></span><br><span class="line">kubectl get [资源名称]</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get namespace</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get ns</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get [所有k8s资源]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### No resources found in default namespace. default名称空间中没有找到pod</span></span><br><span class="line"><span class="comment">### k8s默认操作的名称空间，就是default名称空间</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看指定资源的详细信息</span></span><br><span class="line">kubectl describe [资源名称]</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe pod</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe namespace</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl describe [所有k8s资源]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 给指定资源打标签</span></span><br><span class="line">kubectl label [资源名称]</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label node</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label pod</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label [所有k8s资源]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 给node打角色标签需要用到k8s的api</span></span><br><span class="line"><span class="comment"># 赋值标签 =</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label nodes k8s03 node-role.kubernetes.io/zls=</span></span><br><span class="line">node/k8s03 labeled</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">k8s01 Ready master 21h v1.19.3</span><br><span class="line">k8s02 Ready node01 20h v1.19.3</span><br><span class="line">k8s03 Ready node02,zls 20h v1.19.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除标签 -</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label nodes k8s03 node-role.kubernetes.io/zlsnode/k8s03 labeled</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get node</span></span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">k8s01 Ready master 21h v1.19.3</span><br><span class="line">k8s02 Ready node01 20h v1.19.3</span><br><span class="line">k8s03 Ready node02 20h v1.19.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建k8s资源</span></span><br><span class="line">kubectl create [资源名称]</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl create namespace zls</span></span><br><span class="line">namespace/zls created</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get namespace</span></span><br><span class="line">NAME STATUS AGE</span><br><span class="line">default Active 21h</span><br><span class="line">kube-flannel Active 20h</span><br><span class="line">kube-node-lease Active 21h</span><br><span class="line">kube-public Active 21h</span><br><span class="line">kube-system Active 21h</span><br><span class="line">zls Active 12s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除指定资源</span></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl delete pod nginx-565785f75c-c5rlr</span></span><br><span class="line"><span class="comment"># 删除namespace</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl delete namespace zls</span></span><br></pre></td></tr></table></figure><h3 id="POD资源沉浸式体验"><a href="#POD资源沉浸式体验" class="headerlink" title="POD资源沉浸式体验"></a>POD资源沉浸式体验</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行创建POD</span></span><br><span class="line"><span class="comment">## 语法：</span></span><br><span class="line">kubectl create [控制器名称] [POD名称] [--image=指定镜像]</span><br><span class="line">kubectl create deployment nginx --image=nginx:alpine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接进入容器</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl exec -it nginx-565785f75c-c5rlr -- /bin/sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动POD会启动自定义的容器和一个根容器</span></span><br><span class="line">a3e2e00e2c4e fe7edaf8a8dc <span class="string">&quot;/docker-entrypoint.…&quot;</span> 18 seconds ago Up 17 seconds</span><br><span class="line">容器名：k8s_nginx_zls-nginx-68bb69f479-68k5t_default_256c46eb-f0ee-4c7c-847f-74212a81bff6_0</span><br><span class="line"></span><br><span class="line">6f68f68b56c1 registry.aliyuncs.com/google_containers/pause:3.2 <span class="string">&quot;/pause&quot;</span> 19 seconds ago Up 17 seconds </span><br><span class="line">容器名：k8s_POD_zls-nginx-68bb69f479-68k5t_default_256c46eb-f0ee-4c7c-847f-74212a81bff6_0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看容器并输出详细信息</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE IP NODE</span><br><span class="line">NOMINATED NODE READINESS GATES</span><br><span class="line">zls-nginx-68bb69f479-68k5t 1/1 Running 0 5m18s 10.2.1.3</span><br><span class="line">k8s03 &lt;none&gt; &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 将pod输出成yaml格式</span></span><br><span class="line">kubectl get pod zls-nginx-68bb69f479-68k5t -o yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># cat nginx.yaml</span></span><br><span class="line">apiVersion: v1 <span class="comment"># api接口的版本</span></span><br><span class="line">kind: Pod <span class="comment"># kind指定资源：POD</span></span><br><span class="line">metadata: <span class="comment"># 资源的元数据：资源名、资源标签</span></span><br><span class="line">name: pod名字       <span class="comment"># 资源名字</span></span><br><span class="line">labels: <span class="comment"># 资源标签</span></span><br><span class="line">name: abc <span class="comment"># 标签名: 标签值</span></span><br><span class="line">mem: 16g</span><br><span class="line">spec: <span class="comment"># 容器相关信息</span></span><br><span class="line">containers: <span class="comment"># 指定容器信息</span></span><br><span class="line">- image: nginx:alpine <span class="comment"># 指定容器镜像</span></span><br><span class="line">imagePullPolicy: IfNotPresent <span class="comment"># 镜像拉取规则</span></span><br><span class="line">name: abc-nginx <span class="comment"># 容器名称</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 应用资源清单</span></span><br><span class="line">kubectl apply -f nginx.yaml</span><br><span class="line"></span><br><span class="line">apiVersion:</span><br><span class="line">Kind:</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用资源清单创建名称空间</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">name: kube-zls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f ns-zls.yaml</span></span><br><span class="line">namespace/kube-zls created</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl create -f ns-zls.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create：是创建，没有创建过的情况下，使用create</span><br><span class="line">apply：是应用，没创建过的情况下，会创建，创建过的情况下，会更新资源内容</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改资源清单</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl edit pod aaa</span></span><br></pre></td></tr></table></figure><h2 id="资源清单启动MySQL"><a href="#资源清单启动MySQL" class="headerlink" title="资源清单启动MySQL"></a>资源清单启动MySQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s01 ~]<span class="comment"># vim mysql-pod.yaml</span></span><br><span class="line"></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: zls</span><br><span class="line">  name: mysql-pod</span><br><span class="line">  namespace: kube-zls</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: mysql:5.7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: mysql-container</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># mysql:latest</span></span><br><span class="line">imagePullPolicy: </span><br><span class="line">- Always：如果latest镜像更新，那么每次执行资源清单都会重新拉最新镜像</span><br><span class="line">- Never：永远都不拉镜像，用本地镜像</span><br><span class="line">- IfNotPresent：如果镜像本地存在，则不拉取，如果镜像本地不存在，则拉取</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f mysql-pod.yaml</span></span><br><span class="line">pod/mysql-pod created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--character-set-server=utf8</span><br><span class="line">--collation-server=utf8_bin</span><br></pre></td></tr></table></figure><h2 id="k8s标签"><a href="#k8s标签" class="headerlink" title="k8s标签"></a>k8s标签</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 给node打角色标签</span></span><br><span class="line">kubectl label nodes k8s03 node-role.kubernetes.io/node03=</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看node标签</span></span><br><span class="line">kubectl get node --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment">## 给pod打标签</span></span><br><span class="line"><span class="comment"># 语法：</span></span><br><span class="line">kubectl label [资源] [资源的名称] [标签名=标签值]</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label pod aaa name=zls</span></span><br><span class="line">pod/aaa labeled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除pod标签</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE LABELS</span><br><span class="line">aaa 1/1 Running 1 110m mem=16g</span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl label pod aaa mem-pod/aaa labeled</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod aaa --show-labels</span></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE LABELS</span><br><span class="line">aaa 1/1 Running 1 111m &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看pod标签</span></span><br><span class="line">kubectl get pod --show-labels</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE LABELS</span><br><span class="line">aaa 1/1 Running 1 107m mem=16g</span><br><span class="line">zls-nginx-68bb69f479-68k5t 1/1 Running 0 118m app=zls-nginx,pod-template-hash=68bb69f479</span><br></pre></td></tr></table></figure><h3 id="将Pod起在指定主机上"><a href="#将Pod起在指定主机上" class="headerlink" title="将Pod起在指定主机上"></a>将Pod起在指定主机上</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 指定将pod起在哪个node上</span></span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># vim mysql-pod.yaml</span></span><br><span class="line"></span><br><span class="line">apiVersion: <span class="string">&quot;v1&quot;</span></span><br><span class="line">kind: <span class="string">&quot;Pod&quot;</span></span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: zls</span><br><span class="line">  name: mysql-pod-test</span><br><span class="line">spec:</span><br><span class="line">  nodeName: k8s02</span><br><span class="line">  nodeSelector:</span><br><span class="line">    MEM: JinShiDun</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql-container-test</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&#x27;wordpres_1111&#x27;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&#x27;456&#x27;</span></span><br><span class="line">    args:</span><br><span class="line">    - --character-set-server=utf8</span><br><span class="line">    - --collation-server=utf8_bin</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">## 方法一： 通过标签指定</span></span><br><span class="line">nodeSelector:</span><br><span class="line">  MEM: JinShiDun</span><br><span class="line"></span><br><span class="line"><span class="comment">## 方法二：通过node节点名字指定</span></span><br><span class="line">nodeName: k8s02</span><br></pre></td></tr></table></figure><h2 id="重新认识POD"><a href="#重新认识POD" class="headerlink" title="重新认识POD"></a>重新认识POD</h2><h3 id="POD网络介绍"><a href="#POD网络介绍" class="headerlink" title="POD网络介绍"></a>POD网络介绍</h3><ol><li><p>POD内的容器使用Container模式共享根容器的网络</p></li><li><p>容器看到的网络设备信息和根容器完全相同</p></li><li><p>POD内的多个容器可以使用localhost进行网络通讯</p></li><li><p>POD内的多个容器不能绑定相同的端口</p></li><li><p>POD的生命周期和根容器一样，如果根容器退出了，POD就退出了</p></li><li><p>默认情况下，同一个POD中容器之间的文件系统不共享（需要映射）</p></li></ol><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230609163452364.png" alt="image-20230609163452364"></p><h3 id="一个资源清单启动两个容器"><a href="#一个资源清单启动两个容器" class="headerlink" title="一个资源清单启动两个容器"></a>一个资源清单启动两个容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 一个资源清单启动两个容器</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># vim nginx-pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container1</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">  - name: nginx-container2</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl apply -f nginx-pod.yaml</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">nginx-pod 1/2 CrashLoopBackOff 4 2m35s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 排错：(一个POD中启相同的应用会导致端口冲突，除非修改端口)</span></span><br><span class="line"><span class="comment"># 1.查看pod创建流程详细信息</span></span><br><span class="line">kubectl describe pod nginx-pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看容器日志</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl logs nginx-pod nginx-container1</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl logs nginx-pod nginx-container2</span></span><br><span class="line">2023/06/09 04:05:38 [emerg] 1<span class="comment">#1: bind() to [::]:80 failed (98: Address in use)</span></span><br><span class="line">nginx: [emerg] <span class="built_in">bind</span>() to [::]:80 failed (98: Address <span class="keyword">in</span> use)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.一个pod有多个容器时，指定容器连接</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl exec -it nginx-pod -c nginx-container2 -- /bin/sh</span></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl exec -it nginx-pod -c nginx-container1 -- /bin/sh</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 一个pod启动两个容器</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-db-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container1</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">  - name: mysql-container-test</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">    value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">    value: <span class="string">&#x27;wordpres_1111&#x27;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">    value: <span class="string">&#x27;wp_user&#x27;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">    value: <span class="string">&#x27;456&#x27;</span></span><br><span class="line">    args:</span><br><span class="line">    - --character-set-server=utf8</span><br><span class="line">    - --collation-server=utf8_bin</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[root@k8s01 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES</span><br><span class="line">nginx-db-pod 2/2 Running 0 24s 10.2.1.10 k8s03 &lt;none&gt; &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 文件共享</span></span><br><span class="line">默认情况下一个POD内的容器文件系统是互相隔离的</span><br><span class="line">如果想让一个POD容器共享文件那么只需要定义一个Volume，然后两个容器分别挂载到这个Volume中</span><br><span class="line"></span><br><span class="line">即：共享存储</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230609164244505.png" alt="image-20230609164244505"></p><h3 id="POD之间文件共享"><a href="#POD之间文件共享" class="headerlink" title="POD之间文件共享"></a>POD之间文件共享</h3><p><strong>永久挂载</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 永久挂载(hostPath)</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-db-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: codedir</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data/nginx</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /usr/share/nginx/html/</span><br><span class="line">      name: codedir</span><br><span class="line"></span><br><span class="line">  - name: mysql-container</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /usr/share/nginx/html/</span><br><span class="line">      name: codedir</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230612175713468.png" alt="image-20230612175517897"></p><p><strong>临时挂载</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-db-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: codedir</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line"></span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /usr/share/nginx/html/</span><br><span class="line">      name: codedir</span><br><span class="line"></span><br><span class="line">  - name: mysql-container</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /usr/share/nginx/html/</span><br><span class="line">      name: codedir</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230612175713468.png" alt="image-20230612175713468"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>部署普罗米修斯</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-9-docker-%E9%83%A8%E7%BD%B2%E6%99%AE%E7%BD%97%E7%B1%B3%E4%BF%AE%E6%96%AF/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-9-docker-%E9%83%A8%E7%BD%B2%E6%99%AE%E7%BD%97%E7%B1%B3%E4%BF%AE%E6%96%AF/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="使用普罗米修斯监控容器"><a href="#使用普罗米修斯监控容器" class="headerlink" title="使用普罗米修斯监控容器"></a>使用普罗米修斯监控容器</h2><p><strong>cAdvisor</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据收集器 zabbix-agent</span><br><span class="line"></span><br><span class="line">收集容器中的数据 docker run</span><br><span class="line">监控容器</span><br></pre></td></tr></table></figure><p><strong>node_exporter</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据收集器 zabbix-agent</span><br><span class="line"></span><br><span class="line">收集宿主机的数据</span><br><span class="line">监控物理机</span><br></pre></td></tr></table></figure><p><strong>prometheus</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">监控工具：类似zabbix-server</span><br></pre></td></tr></table></figure><p><strong>grafana</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">出图工具</span><br><span class="line"></span><br><span class="line">zabbix</span><br><span class="line">elasticsearch</span><br></pre></td></tr></table></figure><h2 id="部署普罗米修斯"><a href="#部署普罗米修斯" class="headerlink" title="部署普罗米修斯"></a>部署普罗米修斯</h2><div class="table-container"><table><thead><tr><th>主机</th><th>IP</th><th>应用</th><th>角色</th></tr></thead><tbody><tr><td>xx1</td><td>21</td><td>prometheus、cAdvisor、node_exporter、grafana</td><td>监控数据</td></tr><tr><td>xx2</td><td>81</td><td>cAdvisor、node_exporter</td><td>收集数据</td></tr><tr><td>xx3</td><td>82</td><td>cAdvisor、node_exporter</td><td>收集数据</td></tr></tbody></table></div><p><strong>普罗米修斯配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">prometheus.yml</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: cadvisor</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.21:8081</span><br><span class="line">    - 10.0.0.81:8081</span><br><span class="line">    - 10.0.0.82:8081</span><br><span class="line">    </span><br><span class="line">- job_name: prometheus</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.21:9090</span><br><span class="line">  </span><br><span class="line">- job_name: node_exporter</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.21:9100</span><br><span class="line">    - 10.0.0.81:9100</span><br><span class="line">    - 10.0.0.82:9100</span><br></pre></td></tr></table></figure><p><strong>监控机docker-compose</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  prometheus:</span><br><span class="line">    image: prom/prometheus:latest</span><br><span class="line">    container_name: prometheus</span><br><span class="line">    ports:</span><br><span class="line">    - 9090:9090</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - --config.file=/etc/prometheus/prometheus.yml</span><br><span class="line">    volumes:</span><br><span class="line">    - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><br><span class="line">    depends_on:</span><br><span class="line">    - cadvisor</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">  node_exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">    - 9100:9100</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">    - 8081:8080</span><br><span class="line">    volumes:</span><br><span class="line">    - /:/rootfs:ro</span><br><span class="line">    - /var/run:/var/run:rw</span><br><span class="line">    - /sys:/sys:ro</span><br><span class="line">    - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">    - 3000:3000</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure><p><strong>被监控机docker-compose</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  node_exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">    - 9100:9100</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">    - 8081:8080</span><br><span class="line">    volumes:</span><br><span class="line">    - /:/rootfs:ro</span><br><span class="line">    - /var/run:/var/run:rw</span><br><span class="line">    - /sys:/sys:ro</span><br><span class="line">    - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607153433547.png" alt="image-20230607153433547"></p><h3 id="ceneral"><a href="#ceneral" class="headerlink" title="ceneral"></a>ceneral</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607153547591.png" alt="image-20230607153547591"></p><h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node exporter"></a>node exporter</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607153624475.png" alt="image-20230607153624475"></p><h3 id="cadvisor"><a href="#cadvisor" class="headerlink" title="cadvisor"></a>cadvisor</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607153708306.png" alt="image-20230607153708306"></p><h2 id="ceneral添加数据源"><a href="#ceneral添加数据源" class="headerlink" title="ceneral添加数据源"></a>ceneral添加数据源</h2><ul><li><strong>添加</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607153919369.png" alt="image-20230607153919369"></p><ul><li><strong>看需要添加对应的软件</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607153954617.png" alt="image-20230607153954617"></p><ul><li><strong>导入自带的插件</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154108061.png" alt="image-20230607154108061"></p><ul><li><strong>输入Prometheus网址，保存</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154200895.png" alt="image-20230607154200895"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154524732.png" alt="image-20230607154524732"></p><ul><li><strong>自带插件</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154624351.png" alt="image-20230607154624351"></p><ul><li><strong>可以选择插入模版</strong></li><li><strong>一种导入方式是json文件</strong></li><li><strong>一种导入方式是模版ID</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154727431.png" alt="image-20230607154727431"></p><ul><li><strong>在官网模版里搜索查找</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154752767.png" alt="image-20230607154752767"></p><h3 id="ID导入"><a href="#ID导入" class="headerlink" title="ID导入"></a>ID导入</h3><ul><li><strong>ID导入</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154827101.png" alt="image-20230607154827101"></p><ul><li><strong>选择软件，保存</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154850553.png" alt="image-20230607154850553"></p><ul><li><strong>有数据但不知道是什么主机和软件</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607154906244.png" alt="image-20230607154906244"></p><h4 id="修改模板"><a href="#修改模板" class="headerlink" title="修改模板"></a>修改模板</h4><ul><li><strong>没有主机和应用</strong></li><li><strong>不知道是哪台主机的数据</strong></li><li><strong>打开刚刚插入的模版</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607155203509.png" alt="image-20230607155203509"></p><ul><li><strong>点击设置</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607155225884.png" alt="image-20230607155225884"></p><ul><li><strong>修改参数</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607155248075.png" alt="image-20230607155248075"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 解释</span></span><br><span class="line"><span class="comment"># project label_values(container_last_seen, project)</span></span><br><span class="line">第一个project为名字</span><br><span class="line">后面的project为container_last_seen里的变量，现已变更为job</span><br><span class="line"></span><br><span class="line"><span class="comment"># instance label_values(container_last_seen&#123;project=~&quot;$project&quot;,server=~&quot;$server&quot;&#125;,instance)</span></span><br><span class="line"></span><br><span class="line">第一个instance为名字，最后的instance为container_last_seen里的变量</span><br><span class="line">第一个project为调用上一个的名字，<span class="variable">$project</span>为变量，现已变更为<span class="variable">$job</span></span><br><span class="line">server现在已经不需要了！！！</span><br><span class="line"></span><br><span class="line">project label_values(container_last_seen, project)</span><br><span class="line"><span class="comment"># 修改后：label_values(container_last_seen, job)</span></span><br><span class="line">instance label_values(container_last_seen&#123;project=~<span class="string">&quot;<span class="variable">$project</span>&quot;</span>,server=~<span class="string">&quot;<span class="variable">$server</span>&quot;</span>&#125;,instance)</span><br><span class="line"><span class="comment"># 修改后： label_values(container_last_seen&#123;job=~&quot;$project&quot;&#125;, instance)</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607155459508.png" alt="image-20230607155459508"></p><ul><li><strong>Label 显示名称</strong></li><li><strong>Hide 变量的意思吧，忘了哈哈，调成空就是显示</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607160355205.png" alt="image-20230607160355205"></p><ul><li><strong>识别到主机就可以保存了</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607160424566.png" alt="image-20230607160424566"></p><h4 id="无数据-需要改"><a href="#无数据-需要改" class="headerlink" title="无数据-需要改"></a>无数据-需要改</h4><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607160816128.png" alt="image-20230607160816128"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607160801165.png" alt="image-20230607160801165"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161034745.png" alt="image-20230607161034745"></p><p><strong>但是参数比较多，一个一个修改比较麻烦 - 批量改</strong></p><h3 id="json文件导入"><a href="#json文件导入" class="headerlink" title="json文件导入"></a>json文件导入</h3><ul><li><strong>找到json文件</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161156071.png" alt=""></p><ul><li><strong>复制出去</strong></li><li><strong>ctrl + f 批量把project替换成job</strong></li><li><strong>保存为json文件</strong></li><li><strong>导入</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161619403.png" alt="image-20230607161619403"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161631966.png" alt="image-20230607161631966"></p><ul><li><strong>先删除之前的docker插件</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161701397.png" alt="image-20230607161701397"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161714211.png" alt="image-20230607161714211"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161729359.png" alt="image-20230607161729359"></p><ul><li><strong>正常成功</strong></li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230607161743206.png" alt="image-20230607161743206"></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>资源限制</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-8-docker-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-8-docker-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="资源限制介绍"><a href="#资源限制介绍" class="headerlink" title="资源限制介绍"></a>资源限制介绍</h2><p>官网：<a href="https://docs.docker.com/config/containers/resource_constraints/">TP</a> </p><p>带有内存、CPU 和 GPU 的运行时选项 </p><p>默认情况下，容器没有资源限制，可以使用主机内核调度程序允许的尽可能多的给定资源。Docker 提供 了控制容器可以使用多少内存或 CPU 的方法，设置docker run命令的运行时配置标志。本节提供有关何 时应该设置此类限制以及设置这些限制的可能影响的详细信息。 </p><p>其中许多功能需要您的内核支持 Linux 功能。要检查支持，您可以使用该 docker info命令。如果您的内 核中禁用了某个功能，您可能会在输出的末尾看到如下警告：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## docker info 只要没有WARNING: no swap limit support这个警告就可以做资源限制</span></span><br><span class="line">docker info</span><br><span class="line"></span><br><span class="line">WARNING: no swap <span class="built_in">limit</span> support</span><br></pre></td></tr></table></figure><h2 id="docker内存限制"><a href="#docker内存限制" class="headerlink" title="docker内存限制"></a>docker内存限制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">-m：允许容器使用的最大内存，单位：k、m、g</span><br><span class="line"></span><br><span class="line"><span class="comment">## 限制容器内存</span></span><br><span class="line">docker run -m 200m -it busybox /bin/sh</span><br><span class="line"></span><br><span class="line">docker stats</span><br><span class="line">CONTAINER ID NAME CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS</span><br><span class="line">3ccba8015e98 test_mem1 0.00% 56KiB / 200MiB 0.03% 656B / 0B 0B / 0B 1</span><br><span class="line">e4ccf0b811bb harbor-portal 0.00% 1.375MiB / 972.6MiB 0.14% 1.54kB / 0B 266kB / 0B 2</span><br><span class="line">8adfdf10d542 registryctl 0.00% 3.078MiB / 972.6MiB 0.32% 1.54kB / 0B 2.61MB / 0B 6</span><br><span class="line">e454f59c7e0c registry 0.00% 5.043MiB / 972.6MiB 0.52% 1.5kB / 0B 3.02MB / 0B 7</span><br><span class="line">9df3af7ae3de redis 0.12% 1.207MiB / 972.6MiB 0.12% 1.54kB / 0B 258kB / 0B 4</span><br><span class="line">83445c67d178 harbor-log 0.00% 3.25MiB / 972.6MiB 0.33% 98.9kB / 59.5kB 1.5MB / 4.1kB 11</span><br><span class="line"></span><br><span class="line"><span class="comment">## 下载压测镜像</span></span><br><span class="line">docker pull lorel/docker-stress-ng</span><br><span class="line"></span><br><span class="line">--vm：指定启动几个压测内存的进程（一个进程占用内存256m）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 不限制内存够</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --name test_mem4 -it lorel/docker-stress-ng --vm 3</span><br><span class="line">CONTAINER ID NAME CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS</span><br><span class="line">9b375a58845b test_mem4 70.07% 770MiB / 3.84GiB 19.58% 656B / 0B 35MB / 5.71MB 7</span><br><span class="line">6d524edf3a2f test_mem3 52.77% 401.4MiB / 500MiB 80.27% 656B / 0B 2.44GB / 2.63GB 7</span><br><span class="line">7f81b0bb1fa4 jenkins 6.87% 187.2MiB / 3.84GiB 4.76% 656B / 0B 1.34GB / 9.81MB 46</span><br><span class="line">99d88cd4a1e3 gitlab 57.24% 1.89GiB / 3.84GiB 49.22% 656B / 0B 3.43GB / 13.7MB 269</span><br><span class="line"></span><br><span class="line"><span class="comment">## 限制内存</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --name test_mem3 -m 500m -it lorel/docker-stress-ng --vm 3</span><br><span class="line">CONTAINER ID NAME CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS</span><br><span class="line">9b375a58845b test_mem4 70.07% 770MiB / 3.84GiB 19.58% 656B / 0B 35MB / 5.71MB 7</span><br><span class="line">6d524edf3a2f test_mem3 52.77% 401.4MiB / 500MiB 80.27% 656B / 0B 2.44GB / 2.63GB 7</span><br><span class="line">7f81b0bb1fa4 jenkins 6.87% 187.2MiB / 3.84GiB 4.76% 656B / 0B 1.34GB / 9.81MB 46</span><br><span class="line">99d88cd4a1e3 gitlab 57.24% 1.89GiB / 3.84GiB 49.22% 656B / 0B 3.43GB / 13.7MB 269</span><br></pre></td></tr></table></figure><h2 id="docker限制CPU"><a href="#docker限制CPU" class="headerlink" title="docker限制CPU"></a>docker限制CPU</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">--cpus：限制该容器占用多少个CPU核心数</span><br><span class="line"></span><br><span class="line"><span class="comment">## 下载压测镜像</span></span><br><span class="line">docker pull lorel/docker-stress-ng</span><br><span class="line"></span><br><span class="line">--vm：指定启动几个压测内存的进程（一个进程占用内存256m）</span><br><span class="line">--cpu：压测CPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 不限制CPU</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --name test_cpu1 -it lorel/docker-stress-ng --cpu 8</span><br><span class="line">CONTAINER ID NAME CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS</span><br><span class="line">e5ae29cca3de test_cpu1 295.87% 17.88MiB / 3.84GiB 0.45% 656B / 0B 0B / 0B 9</span><br><span class="line">7f81b0bb1fa4 jenkins 1.06% 139MiB / 3.84GiB 3.53% 656B / 0B 1.41GB / 9.81MB 46</span><br><span class="line">99d88cd4a1e3 gitlab 25.94% 1.984GiB / 3.84GiB 51.67% 656B / 0B 4.02GB / 13.8MB 266</span><br><span class="line"></span><br><span class="line"><span class="comment">## 限制CPU</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --name test_cpu1 --cpus 1 -it lorel/docker-stress-ng --cpu 8</span><br><span class="line">CONTAINER ID NAME CPU % MEM USAGE / LIMIT MEM % NET I/O BLOCK I/O PIDS</span><br><span class="line">9a6f9487e33b test_cpu1 134.87% 17.85MiB / 3.84GiB 0.45% 656B / 0B 0B / 0B 9</span><br><span class="line">7f81b0bb1fa4 jenkins 1.34% 139.3MiB / 3.84GiB 3.54% 656B / 0B 1.42GB / 9.81MB 46</span><br><span class="line">99d88cd4a1e3 gitlab 6.55% 2.004GiB / 3.84GiB 52.20% 656B / 0B 4.05GB / 13.8MB 266</span><br></pre></td></tr></table></figure><p>我们资源限制不是目的，目的是我们要随时监控到我们的资源，能看到容器对宿主机资源的使用，才能 更好的做限制，不要盲目限制，不知道资源使用的情况下，就对容器资源限制，就是在作死。</p><h2 id="如何监控docker容器"><a href="#如何监控docker容器" class="headerlink" title="如何监控docker容器"></a>如何监控docker容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker 自带的监控命令</span></span><br><span class="line">docker ps</span><br><span class="line">docker top e4ccf0b811bb</span><br><span class="line">docker stats</span><br></pre></td></tr></table></figure><p>有了上面的命令，我们就可以使用zabbix来监控docker容器了，但是问题就是， zabbix-agent 的端 口，我们在宿主机上只能映射出来一个</p><h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><ul><li>可以映射宿主机上不同的端口</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-p10050:10050</span><br><span class="line">-p10052:10050</span><br><span class="line">-p10053:10050</span><br></pre></td></tr></table></figure><ul><li>可以起多块网卡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-p10.0.0.81:10050:10050</span><br><span class="line">-p10.0.0.88:10050:10050</span><br><span class="line">-p10.0.0.89:10050:10050</span><br><span class="line">-p10.0.0.90:10050:10050</span><br></pre></td></tr></table></figure><ul><li>修改不同容器的agent端口 </li><li>映射容器的相关文件，然后监控宿主机上的对应文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(docker run -it busybox free -m) &gt; /opt/nginx/mem.info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /opt/nginx/mem.info</span><br><span class="line">total used free shared buff/cache available</span><br><span class="line">Mem: 973 315 94 0 563 498</span><br><span class="line">Swap: 1024 49 975</span><br></pre></td></tr></table></figure><h2 id="使用普罗米修斯监控容器"><a href="#使用普罗米修斯监控容器" class="headerlink" title="使用普罗米修斯监控容器"></a>使用普罗米修斯监控容器</h2><h3 id="cAdvisor"><a href="#cAdvisor" class="headerlink" title="cAdvisor"></a>cAdvisor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据收集器 zabbix-agent</span><br><span class="line"></span><br><span class="line">收集容器中的数据 docker run</span><br><span class="line">监控容器</span><br></pre></td></tr></table></figure><h3 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node_exporter"></a>node_exporter</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据收集器 zabbix-agent</span><br><span class="line"></span><br><span class="line">收集宿主机的数据</span><br><span class="line">监控物理机</span><br></pre></td></tr></table></figure><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">监控工具：类似zabbix-server</span><br></pre></td></tr></table></figure><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">出图工具</span><br><span class="line"></span><br><span class="line">zabbix</span><br><span class="line">elasticsearch</span><br></pre></td></tr></table></figure><h2 id="练习：启动以上一套配置"><a href="#练习：启动以上一套配置" class="headerlink" title="练习：启动以上一套配置"></a>练习：启动以上一套配置</h2><div class="table-container"><table><thead><tr><th>主机</th><th>IP</th><th>应用</th><th>角色</th></tr></thead><tbody><tr><td>xx1</td><td>21</td><td>prometheus、cAdvisor、node_exporter、grafana</td><td>监控数据</td></tr><tr><td>xx2</td><td>81</td><td>cAdvisor、node_exporter</td><td>收集数据</td></tr><tr><td>xx3</td><td>82</td><td>cAdvisor、node_exporter</td><td>收集数据</td></tr></tbody></table></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 普罗米修斯配置文件</span></span><br><span class="line">prometheus.yml</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: cadvisor</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.21:8081</span><br><span class="line">    - 10.0.0.81:8081</span><br><span class="line">    - 10.0.0.82:8081</span><br><span class="line">    </span><br><span class="line">- job_name: prometheus</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.21:9090</span><br><span class="line">  </span><br><span class="line">- job_name: node_exporter</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - 10.0.0.21:9100</span><br><span class="line">    - 10.0.0.81:9100</span><br><span class="line">    - 10.0.0.82:9100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose</span></span><br><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  prometheus:</span><br><span class="line">    image: prom/prometheus:latest</span><br><span class="line">    container_name: prometheus</span><br><span class="line">    ports:</span><br><span class="line">    - 9090:9090</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - --config.file=/etc/prometheus/prometheus.yml</span><br><span class="line">    volumes:</span><br><span class="line">    - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><br><span class="line">    depends_on:</span><br><span class="line">    - cadvisor</span><br><span class="line">    </span><br><span class="line">  node_exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">    - 9100:9100</span><br><span class="line"></span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">    - 8081:8080</span><br><span class="line">    volumes:</span><br><span class="line">    - /:/rootfs:ro</span><br><span class="line">    - /var/run:/var/run:rw</span><br><span class="line">    - /sys:/sys:ro</span><br><span class="line">    - /var/lib/docker:/var/lib/docker:ro</span><br><span class="line"></span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">    - 3000:3000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose</span></span><br><span class="line">version: <span class="string">&#x27;3.2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  node_exporter:</span><br><span class="line">    image: prom/node-exporter:latest</span><br><span class="line">    container_name: node_exporter</span><br><span class="line">    ports:</span><br><span class="line">    - 9100:9100</span><br><span class="line"></span><br><span class="line">  cadvisor:</span><br><span class="line">    image: google/cadvisor:latest</span><br><span class="line">    container_name: cadvisor</span><br><span class="line">    ports:</span><br><span class="line">    - 8081:8080</span><br><span class="line">    volumes:</span><br><span class="line">    - /:/rootfs:ro</span><br><span class="line">    - /var/run:/var/run:rw</span><br><span class="line">    - /sys:/sys:ro</span><br><span class="line">    - /var/lib/docker:/var/lib/docker:ro</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>跨主机通信-网络模式</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-7-docker-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-7-docker-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="通讯模式介绍"><a href="#通讯模式介绍" class="headerlink" title="通讯模式介绍"></a>通讯模式介绍</h2><ul><li>flannel </li><li>overlay </li><li>macvlan </li><li>calico</li></ul><h2 id="静态路由介绍"><a href="#静态路由介绍" class="headerlink" title="静态路由介绍"></a>静态路由介绍</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230606180130948.png" alt="image-20230606180130948"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230606180142940.png" alt="image-20230606180142940"></p><p><strong>手动添加静态路由</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">route add -net 192.168.200.0/24 gw 10.0.0.81 dev eth0</span><br><span class="line"></span><br><span class="line">route add命令的主要作用是添加静态路由，通常的格式是：</span><br><span class="line">route ADD 157.0.0.0 MASK 255.0.0.0 157.55.80.1 METRIC 3 IF 2</span><br><span class="line">参数含义：^destination ^mask ^gateway metric^ ^interface</span><br><span class="line"></span><br><span class="line">destination【网段地址】</span><br><span class="line">mask【子网掩码】</span><br><span class="line">gateway【网关地址】</span><br><span class="line">metric 【路由跳数】</span><br><span class="line"><span class="keyword">if</span>【端口号】</span><br><span class="line">一般情况下，不涉及本机地址，除非你要做测试。</span><br><span class="line"></span><br><span class="line">【路由跳数】参数可以省略</span><br><span class="line">【端口号】参数可以省略</span><br><span class="line"><span class="comment">### mask 是关键字，不能省略。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">route add 134.105.0.0 mask 255.255.0.0 134.105.64.1</span><br><span class="line"><span class="comment"># 意思是：所有需要发往134.105.0.0/16地址段的IP数据包，全部由134.105.64.1路径转发。</span></span><br></pre></td></tr></table></figure><h2 id="flannel部署"><a href="#flannel部署" class="headerlink" title="flannel部署"></a>flannel部署</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><div class="table-container"><table><thead><tr><th>主机名</th><th>内网IP</th><th>外网IP</th><th>角色</th><th>应用</th></tr></thead><tbody><tr><td>xx1</td><td>172.16.1.21</td><td>10.0.0.21</td><td>docker</td><td>docker、flannel</td></tr><tr><td>xx2</td><td>172.16.1.81</td><td>10.0.0.81</td><td>docker</td><td>docker、flannel</td></tr><tr><td>xx3</td><td>172.16.1.82</td><td>10.0.0.82</td><td>ETCD数据库</td><td>etcd</td></tr></tbody></table></div><h3 id="部署ETCD"><a href="#部署ETCD" class="headerlink" title="部署ETCD"></a>部署ETCD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装etcd</span></span><br><span class="line">yum install -y etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.编辑etcd配置文件</span></span><br><span class="line">vim /etc/etcd/etcd.conf</span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://10.0.0.83:2379,http://127.0.0.1:2379&quot;</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;http://10.0.0.83:2379&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.启动etcd</span></span><br><span class="line">systemctl start etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.检查端口</span></span><br><span class="line">netstat -lntup</span><br><span class="line">tcp 0 0 127.0.0.1:2379 0.0.0.0:* LISTEN</span><br><span class="line">18934/etcd</span><br><span class="line">tcp 0 0 10.0.0.83:2379 0.0.0.0:* LISTEN</span><br><span class="line">18934/etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.检测集群健康状态</span></span><br><span class="line">etcdctl -C http://10.0.0.83:2379 cluster-health</span><br><span class="line"></span><br><span class="line">member 8e9e05c52164694d is healthy: got healthy result from</span><br><span class="line">http://10.0.0.83:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line"><span class="comment">## 存数据</span></span><br><span class="line">etcdctl -C http://10.0.0.83:2379 <span class="built_in">set</span> name zls</span><br><span class="line">etcdctl -C http://10.0.0.83:2379 <span class="built_in">set</span> /aaa/bbb <span class="string">&quot;&#123;name:zls&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 取数据</span></span><br><span class="line">etcdctl -C http://10.0.0.83:2379 get name</span><br><span class="line">zls</span><br><span class="line">etcdctl -C http://10.0.0.83:2379 get /aaa/bbb</span><br><span class="line">&#123;name:zls&#125;</span><br></pre></td></tr></table></figure><h3 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装flannel</span></span><br><span class="line">yum install -y flannel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.修改flannel配置文件</span></span><br><span class="line">vim /etc/sysconfig/flanneld</span><br><span class="line">FLANNEL_ETCD_ENDPOINTS=<span class="string">&quot;http://10.0.0.83:2379&quot;</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">&quot;/atomic.io/network&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.将数据保存到etcd中</span></span><br><span class="line"><span class="comment">## 以下内容二选一</span></span><br><span class="line">etcdctl -C http://10.0.0.83:2379 <span class="built_in">set</span> /atomic.io/network/config <span class="string">&#x27;&#123;&quot;Network&quot;:&quot;192.168.0.0/16&quot;&#125;&#x27;</span></span><br><span class="line">etcdctl mk /atomic.io/network/config <span class="string">&#x27;&#123;&quot;Network&quot;:&quot;192.168.0.0/16&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.查看数据</span></span><br><span class="line">etcdctl -C http://10.0.0.83:2379 get /atomic.io/network/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.启动flannel</span></span><br><span class="line">systemctl start flanneld</span><br></pre></td></tr></table></figure><h3 id="将docker和flannel关联起来"><a href="#将docker和flannel关联起来" class="headerlink" title="将docker和flannel关联起来"></a>将docker和flannel关联起来</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改docker启动脚本</span></span><br><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line">EnviromentFile=/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启docker</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启防火墙内核转发</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">systemctl restart firewalld</span><br><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure><h2 id="其他两种通讯方法"><a href="#其他两种通讯方法" class="headerlink" title="其他两种通讯方法"></a>其他两种通讯方法</h2><h3 id="overlay"><a href="#overlay" class="headerlink" title="overlay"></a>overlay</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230606181417091.png" alt="image-20230606181417091"></p><p><a href="http://www.cnblogs.com/CloudMan6/p/7270551.html">http://www.cnblogs.com/CloudMan6/p/7270551.html</a></p><p>docker03上： consul存储ip地址的分配</p><p>设置容器的主机名 consul：kv类型的存储数据库（key:value）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap</span><br></pre></td></tr></table></figure><p>接下来修改 host1 和 host2 的 docker daemon 的配置文件<code>/etc/systemd/system/docker.service</code></p><p><code>--cluster-store</code> 指定 consul 的地址。<br><code>--cluster-advertise</code> 告知 consul 自己的连接地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker01、02上：</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;cluster-store&quot;</span>: <span class="string">&quot;consul://10.0.0.13:8500&quot;</span>,</span><br><span class="line"><span class="string">&quot;cluster-advertise&quot;</span>: <span class="string">&quot;10.0.0.11:2376&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ?????先看链接</span></span><br><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>2）创建overlay网络 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d overlay --subnet 172.16.2.0/24 --gateway 172.16.2.254 ol1 </span><br></pre></td></tr></table></figure><p>3）启动容器测试 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --network ol1 --name oldboy01 busybox /bin/sh </span><br></pre></td></tr></table></figure><p>每个容器有两块网卡,eth0实现容器间的通讯,eth1实现容器访问外网</p><h3 id="macvlan"><a href="#macvlan" class="headerlink" title="macvlan"></a>macvlan</h3><p>默认一个物理网卡，只有一个物理mac地址，虚拟多个mac地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建macvlan网络</span></span><br><span class="line">docker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置eth0的网卡为混杂模式</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 promisc on</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建使用macvlan网络的容器</span></span><br><span class="line">docker run -it --network macvlan_1 --ip=10.0.0.200 busybox</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>容器代码上线</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-6-docker-%E5%AE%B9%E5%99%A8%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%BA%BF/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-6-docker-%E5%AE%B9%E5%99%A8%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%BA%BF/</url>
      
        <content type="html"><![CDATA[<hr><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230605190402236.png" alt="image-20230605190402236"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230605190402236.png" alt=""></p><h2 id="Harbor配置"><a href="#Harbor配置" class="headerlink" title="Harbor配置"></a>Harbor配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.下载Harbor</span></span><br><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.8.1/harbor-offline-installer-v2.8.1.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装docker-compose</span></span><br><span class="line">yum install -y docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.解压Harbor</span></span><br><span class="line">tar xf harbor-offline-installer-v1.9.0-rc1.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.修改docker-compose文件</span></span><br><span class="line">vim /root/harbor/harbor.yml</span><br><span class="line">hostname: 10.0.0.81</span><br><span class="line">harbor_admin_password: 123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.安装Harbor</span></span><br><span class="line">./install.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动harbor</span></span><br><span class="line"><span class="built_in">cd</span> harbor/</span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker配置文件10.0.0.81是harbor的IP</span></span><br><span class="line"><span class="built_in">cat</span> /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.81&quot;</span>],</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://pgz00k39.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="docker启动gitlab"><a href="#docker启动gitlab" class="headerlink" title="docker启动gitlab"></a>docker启动gitlab</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动gitlab</span></span><br><span class="line">docker run --detach \</span><br><span class="line">--publish 443:443 --publish 80:80 --publish 2222:22 \</span><br><span class="line">--name gitlab \</span><br><span class="line">--restart always \</span><br><span class="line">--volume /data/gitlab/config:/etc/gitlab:Z \</span><br><span class="line">--volume /data/gitlab/logs:/var/log/gitlab:Z \</span><br><span class="line">--volume /data/gitlab/data:/var/opt/gitlab:Z \</span><br><span class="line">--shm-size 256m \</span><br><span class="line">gitlab/gitlab-ce:latest</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看gitlab密码</span></span><br><span class="line">docker <span class="built_in">exec</span> -it gitlab grep <span class="string">&#x27;Password:&#x27;</span> /etc/gitlab/initial_root_password</span><br></pre></td></tr></table></figure><h2 id="docker启动jenkins"><a href="#docker启动jenkins" class="headerlink" title="docker启动jenkins"></a>docker启动jenkins</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建Jenkins用户</span></span><br><span class="line">useradd jenkins -u 1000</span><br><span class="line"><span class="built_in">chown</span> -R jenkins.jenkins /data/jenkins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉去jenkins/jenkins镜像</span></span><br><span class="line">docker pull jenkins/jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Jenkins</span></span><br><span class="line">docker run \</span><br><span class="line">--name jenkins \</span><br><span class="line">--detach \</span><br><span class="line">--restart always \</span><br><span class="line">--privileged \</span><br><span class="line">--<span class="built_in">link</span> gitlab \</span><br><span class="line">--user root \</span><br><span class="line">--volume /etc/docker/daemon.json:/etc/docker/daemon.json \</span><br><span class="line">--volume /data/jenkins:/var/jenkins_home \</span><br><span class="line">--volume /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">--volume /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">--volume /root/.docker/:/root/.docker/ \</span><br><span class="line">--volume /root/.ssh/:/root/.ssh/ \</span><br><span class="line">--publish 8080:8080 \</span><br><span class="line">--publish 50000:50000 \</span><br><span class="line">jenkins/jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看Jenkins密码</span></span><br><span class="line">docker <span class="built_in">exec</span> -it jenkins <span class="built_in">cat</span> /var/jenkins_home/secrets/initialAdminPassword1417c22ce87c448f91f6f3625010b816</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装插件大礼包</span></span><br><span class="line"><span class="comment"># 因为我们已经映射了文件目录，直接在宿主机上操作</span></span><br><span class="line"><span class="built_in">cd</span> /data/jenkins/</span><br><span class="line">rz jenkins_plugins.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -rf plugins/</span><br><span class="line">tar xf jenkins_plugins.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启jenkins</span></span><br><span class="line">docker restart jenkins</span><br></pre></td></tr></table></figure><h2 id="一些必要的准备"><a href="#一些必要的准备" class="headerlink" title="一些必要的准备"></a>一些必要的准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建gitlab代码仓库</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 1.秘钥</span></span><br><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub</span><br><span class="line">......  &gt; 写入到gitlab中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.连接harbor</span></span><br><span class="line"><span class="comment"># docker配置文件10.0.0.81是harbor的IP</span></span><br><span class="line"><span class="built_in">cat</span> /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.81&quot;</span>],</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://pgz00k39.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">docker login 10.0.0.81</span><br><span class="line">admin</span><br><span class="line">Harbor12345</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.脚本执行远程ssh命令web端的时候报错，我们需要推送一下公钥</span></span><br><span class="line"><span class="comment"># 映射目录的时候直接把~/.ssh/整个目录映射，公钥和私钥都要有</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@10.0.0.82</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 4.jenkins上添加私钥</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230605192209357.png" alt="image-20230605192209357"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230605192234936.png" alt="image-20230605192234936"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230605192254370.png" alt="image-20230605192254370"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230605192306945.png" alt="image-20230605192306945"></p><h2 id="代码上线过程"><a href="#代码上线过程" class="headerlink" title="代码上线过程"></a>代码上线过程</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 拉取代码</span></span><br><span class="line"><span class="comment">## 使用jenkins</span></span><br><span class="line">jenkins@83ab644ff3f9:~$ <span class="built_in">ls</span> -l /var/jenkins_home/workspace/xxxx/</span><br><span class="line">-rw-r--r-- 1 jenkins jenkins 10 Jun 5 02:54 README.md</span><br><span class="line">-rw-r--r-- 1 jenkins jenkins 12 Jun 5 02:54 index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">## 写Dockerfile，打包镜像</span></span><br><span class="line"><span class="built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">ADD index.html /usr/share/nginx/html/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## jenkins 脚本执行过程</span></span><br><span class="line"><span class="comment">## jenkins job</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;--------------------&#x27;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$WORKSPACE</span>/Dockerfile &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">ADD index.html /usr/share/nginx/html/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WORKSPACE</span> &amp;&amp; docker build -t 10.0.0.81/docker/web:<span class="variable">$GIT_COMMIT</span> .</span><br><span class="line"></span><br><span class="line">docker push 10.0.0.81/docker/web:<span class="variable">$GIT_COMMIT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> 82;<span class="keyword">do</span></span><br><span class="line">ssh 10.0.0.<span class="variable">$ip</span> <span class="string">&#x27;docker stop web&#x27;</span></span><br><span class="line">ssh 10.0.0.<span class="variable">$ip</span> <span class="string">&#x27;docker rm web&#x27;</span></span><br><span class="line">ssh 10.0.0.<span class="variable">$ip</span> <span class="string">&quot;docker pull 10.0.0.81/docker/web:<span class="variable">$GIT_COMMIT</span>&quot;</span></span><br><span class="line">ssh 10.0.0.<span class="variable">$ip</span> <span class="string">&quot;docker run --name web -p80:80 -d 10.0.0.81/docker/web:<span class="variable">$GIT_COMMIT</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="docker-compose管理CICD"><a href="#docker-compose管理CICD" class="headerlink" title="docker-compose管理CICD"></a>docker-compose管理CICD</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> docker-compose.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">version: <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: <span class="string">&#x27;gitlab/gitlab-ce:latest&#x27;</span></span><br><span class="line">    container_name: gitlab</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url <span class="string">&#x27;http://10.0.0.21&#x27;</span></span><br><span class="line">        gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222</span><br><span class="line">        prometheus[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        prometheus[<span class="string">&#x27;monitor_kubernetes&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        prometheus_monitoring[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        alertmanager[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        node_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        redis_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        postgres_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">        grafana[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;2222:22&#x27;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&#x27;/data/gitlab/config:/etc/gitlab&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;/data/gitlab/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;/data/gitlab/data:/var/opt/gitlab&#x27;</span></span><br><span class="line">    shm_size: <span class="string">&#x27;256m&#x27;</span></span><br><span class="line"></span><br><span class="line">  jenkins:</span><br><span class="line">    image: jenkins/jenkins</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&#x27;8080:8080&#x27;</span></span><br><span class="line">      - <span class="string">&#x27;50000:50000&#x27;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/docker/daemon.json:/etc/docker/daemon.json</span><br><span class="line">      - /data/jenkins:/var/jenkins_home</span><br><span class="line">      - /usr/bin/docker:/usr/bin/docker</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">      - /root/.docker/:/root/.docker/</span><br><span class="line">      - /root/.ssh/:/root/.ssh/</span><br><span class="line">    user: root</span><br><span class="line">    privileged: <span class="literal">true</span></span><br><span class="line">    links:</span><br><span class="line">      - gitlab</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 使用IP</span></span><br><span class="line">hostname: <span class="string">&#x27;gitlab.xxx.com&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 固定IP和端口</span></span><br><span class="line">external_url <span class="string">&#x27;http://10.0.0.21&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 2222</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 总结：</span></span><br><span class="line">1.gitlab使用非22端口拉代码</span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = <span class="string">&#x27;2222&#x27;</span></span><br><span class="line"></span><br><span class="line">2.gitlab代码地址根据docker容器的<span class="built_in">id</span>（固定）</span><br><span class="line">external_url <span class="string">&#x27;http://10.0.0.81&#x27;</span></span><br><span class="line"></span><br><span class="line">3.gitlab启动慢，配置文件优化</span><br><span class="line">prometheus[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">prometheus[<span class="string">&#x27;monitor_kubernetes&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">prometheus_monitoring[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">alertmanager[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">node_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">redis_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">postgres_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">grafana[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">4.Jenkins想要拉取gitlab代码，固定公钥</span><br><span class="line">-v /root/.ssh/:/root/.ssh/</span><br><span class="line"></span><br><span class="line">5.Jenkins要使用docker <span class="keyword">in</span> docker</span><br><span class="line">docker run --privileged</span><br><span class="line">docker-compose privileged: <span class="literal">true</span></span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">-v /usr/bin/docker:/usr/bin/docker</span><br><span class="line"></span><br><span class="line">6.Jenkins要永久登录harbor</span><br><span class="line">-v /etc/docker/daemon.json:/etc/docker/daemon.json</span><br><span class="line">-v /root/.docker/:/root/.docker/ <span class="comment">## config.json 主要记录harbor的登录信息</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;10.0.0.82&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YWRtaW46MTIz&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">7.Jenkins需要使用root用户启动</span><br><span class="line">docker run --user root</span><br><span class="line">docker-compose user: root</span><br><span class="line"></span><br><span class="line">8.Jenkins需要在宿主机上创建对应的jenkins(1000)用户</span><br><span class="line">useradd jenkins -u 1000</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>docker-comppose介绍</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-5-docker-%E5%8D%95%E6%9C%BA%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7docker-compose/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-5-docker-%E5%8D%95%E6%9C%BA%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7docker-compose/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Compose是用于定义和运行多容器 Docker应用工具</p><p>通过Compose 可以使用YML文件来配置应用程序所需要的所有服务</p><h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><p><strong>1.需要有一个镜像</strong> </p><ul><li>dockerhub 拉镜像 </li><li>dockerfile 自己制作镜像 </li></ul><p><strong>2.docker-compose定义构成应用程序的服务</strong> </p><ul><li>写一个yaml文件，来启动多个组件（容器） </li></ul><p><strong>3.启动docker-compose</strong></p><h2 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h2><div class="table-container"><table><thead><tr><th>Reference file</th><th>What changed in this version</th></tr></thead><tbody><tr><td><a href="https://docs.docker.com/compose/compose-file/compose-file-v3/">Version 3</a></td><td><a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-3">Version 3 updates</a></td></tr><tr><td><a href="https://docs.docker.com/compose/compose-file/compose-file-v2/">Version 2</a></td><td><a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-2">Version 2 updates</a></td></tr><tr><td>Version 1 (Deprecated)</td><td><a href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-1-deprecated">Version 1 updates 弃用</a></td></tr></tbody></table></div><h2 id="下载更新"><a href="#下载更新" class="headerlink" title="下载更新"></a>下载更新</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载docker-compose</span></span><br><span class="line">wget https://github.com/docker/compose/releases/download/v2.18.1/docker-compose-linux-x86_64 -O /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除老版本的docker-compose</span></span><br><span class="line"><span class="built_in">rm</span> -f /usr/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看docker-compose版本</span></span><br><span class="line">docker-compose version</span><br><span class="line">Docker Compose version v2.18.1</span><br></pre></td></tr></table></figure><h2 id="docker-compose实战"><a href="#docker-compose实战" class="headerlink" title="docker-compose实战"></a>docker-compose实战</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;版本号&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  服务名称1:</span><br><span class="line">    image: 容器镜像</span><br><span class="line">    container_name: 容器名称</span><br><span class="line">    environment:</span><br><span class="line">      - 环境变量1=值1</span><br><span class="line">      - 环境变量2=值2</span><br><span class="line">    volumes:</span><br><span class="line">      - 宿主机数据目录:容器内数据目录</span><br><span class="line">    ports:</span><br><span class="line">      - 宿主机端口:容器内映射端口</span><br><span class="line">    networks:</span><br><span class="line">      - 自定义网络名称</span><br><span class="line">    links:</span><br><span class="line">      - namenode</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - 数据库使用字符集变量时可以用</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  服务名称2:</span><br><span class="line">    image: 容器镜像</span><br><span class="line">    container_name: 容器名称</span><br><span class="line">    environment:</span><br><span class="line">      - 环境变量1=值1</span><br><span class="line">      - 环境变量2=值2</span><br><span class="line">    user: 宿主机用户:容器用户</span><br><span class="line">    volumes:</span><br><span class="line">      - 宿主机数据目录:容器内数据目录</span><br><span class="line">    ports:</span><br><span class="line">      - 宿主机端口:容器内映射端口</span><br><span class="line">    networks:</span><br><span class="line">      - 自定义网络名称</span><br><span class="line">    links:</span><br><span class="line">      - namenode</span><br><span class="line">    depends_on:</span><br><span class="line">      - 依赖服务</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">  externnal: <span class="literal">true</span></span><br><span class="line">  name: 自定义网络名称</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 例子</span></span><br><span class="line">version: <span class="string">&#x27;2.3&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  wordpress:</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    image: wordpress:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/web_data:/var/www/html</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: db</span><br><span class="line">      WORDPRESS_DB_USER: wordpress</span><br><span class="line">      WORDPRESS_DB_PASSWORD: wordpress</span><br></pre></td></tr></table></figure><h3 id="zabbix-docker-compose"><a href="#zabbix-docker-compose" class="headerlink" title="zabbix docker-compose"></a>zabbix docker-compose</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> docker-compose.yml</span><br><span class="line"></span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    container_name: mysql57 <span class="comment"># docker run --name</span></span><br><span class="line">    environment: <span class="comment"># docker run -e</span></span><br><span class="line">      - MYSQL_ROOT_PASSWORD=<span class="string">&#x27;123&#x27;</span></span><br><span class="line">      - MYSQL_DATABASE=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">      - MYSQL_USER=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">      - MYSQL_PASSWORD=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">    volumes: <span class="comment"># docker run -v /db_data:/var/lib/mysql</span></span><br><span class="line">      - /zabbix_data:/var/lib/mysql</span><br><span class="line">    ports: <span class="comment"># docker run -p</span></span><br><span class="line">      - 3306:3306</span><br><span class="line">    <span class="built_in">command</span>: <span class="comment"># --参数 例如：数据库字符集</span></span><br><span class="line">      - --character-set-server=utf8</span><br><span class="line">      - --collation-server=utf8_bin</span><br><span class="line">    restart: always <span class="comment"># 开机自启动容器，docker服务重启，则容器也会自动启动</span></span><br><span class="line"></span><br><span class="line">  zabbix-server:</span><br><span class="line">    image: zabbix/zabbix-server-mysql:latest</span><br><span class="line">    container_name: zabbix-server</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_DATABASE=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">      - DB_SERVER_HOST=<span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">      - MYSQL_USER=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">      - MYSQL_PASSWORD=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">    ports:</span><br><span class="line">      - 10051:10051</span><br><span class="line">    links:</span><br><span class="line">      - mysql</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  zabbix-web:</span><br><span class="line">    image: zabbix/zabbix-web-nginx-mysql:latest</span><br><span class="line">    container_name: zabbix-web</span><br><span class="line">    environment:</span><br><span class="line">      - DB_SERVER_HOST=<span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">      - MYSQL_USER=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">      - MYSQL_PASSWORD=<span class="string">&#x27;zabbix&#x27;</span></span><br><span class="line">      - ZBX_SERVER_HOST=<span class="string">&#x27;zabbix-server&#x27;</span></span><br><span class="line">      - PHP_TZ=<span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">    ports:</span><br><span class="line">      - 80:8080</span><br><span class="line">      - 443:8443</span><br><span class="line">    links:</span><br><span class="line">      - mysql</span><br><span class="line">      - zabbix-server</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">      - zabbix-server</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure><h3 id="restart参数"><a href="#restart参数" class="headerlink" title="restart参数"></a>restart参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--restart参数有三个可选值：no,on-failure,always</span><br><span class="line"></span><br><span class="line">no为默认值，表示容器退出时，docker不自动重启容器</span><br><span class="line">on-failure表示，若容器的退出状态非0，则docker自动重启容器，还可以指定重启次数，若超过指定次数未能启动容器则放弃</span><br></pre></td></tr></table></figure><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动docker-compose 找当前目录下的docker-compose.yml文件</span></span><br><span class="line">docker-compose up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文件启动</span></span><br><span class="line">docker-compose -f zabbix-compose.yml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放在后台启动</span></span><br><span class="line">docker-compose -f zabbix-compose.yml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器中的日志</span></span><br><span class="line">docker-compose -f zabbix-compose.yml logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时事追踪查看容器日志 tail -f</span></span><br><span class="line">docker-compose -f zabbix-compose.yml logs -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只查看某一个容器的日志</span></span><br><span class="line">docker-compose -f zabbix-compose.yml logs zabbix-web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">docker-compose start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动指定服务</span></span><br><span class="line">docker-compose start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">docker-compose stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止单个服务</span></span><br><span class="line">docker-compose start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除docker-compose文件中的所有容器</span></span><br><span class="line">docker-compose <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="官方启动命令"><a href="#官方启动命令" class="headerlink" title="官方启动命令"></a>官方启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自己先手动 docker run一遍</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再写docker-compose</span></span><br><span class="line">docker run --detach \</span><br><span class="line">--publish 443:443 --publish 80:80 --publish 2222:22 \</span><br><span class="line">--name gitlab \</span><br><span class="line">--restart always \</span><br><span class="line">--volume /data/gitlab/config:/etc/gitlab:Z \</span><br><span class="line">--volume /data/gitlab/logs:/var/log/gitlab:Z \</span><br><span class="line">--volume /data/gitlab/data:/var/opt/gitlab:Z \</span><br><span class="line">--shm-size 256m \</span><br><span class="line">gitlab/gitlab-ce:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d \</span><br><span class="line">  -p 443:443 -p 80:80 -p 2222:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  -v /data/gitlab/config:/etc/gitlab:Z \</span><br><span class="line">  -v /data/gitlab/logs:/var/log/gitlab:Z \</span><br><span class="line">  -v /data/gitlab/data:/var/opt/gitlab:Z \</span><br><span class="line">  --shm-size 256m \</span><br><span class="line">  gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先在映射机器上创建jenkins用户 uid=1000 与容器中保持一致</span></span><br><span class="line">useradd jenkins -u 1000</span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">  --name jenkins \</span><br><span class="line">  --detach \</span><br><span class="line">  --privileged \</span><br><span class="line">  --restart always \</span><br><span class="line">  --<span class="built_in">link</span> gitlab \</span><br><span class="line">  --user root \</span><br><span class="line">  --volume /data/jenkins:/var/jenkins_home \</span><br><span class="line">  --volume /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">  --volume /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  --volume /etc/docker/daemon.json:/etc/docker/daemon.json \</span><br><span class="line">  --volume /root/.docker/:/root/.docker/ \</span><br><span class="line">  --volume /root/.ssh/:/root/.ssh/ \</span><br><span class="line">  --publish 8080:8080 --publish 50000:50000 \</span><br><span class="line">  jenkins/jenkins</span><br><span class="line">  </span><br><span class="line">jenkins</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">--restart=on-failure</span><br><span class="line"></span><br><span class="line">--restart参数有三个可选值：no,on-failure,always</span><br><span class="line"></span><br><span class="line">no为默认值，表示容器退出时，docker不自动重启容器</span><br><span class="line">on-failure表示，若容器的退出状态非0，则docker自动重启容器，还可以指定重启次数，若超过指定次数未能启动容器则放弃</span><br></pre></td></tr></table></figure><h3 id="1-使用docker-compose启动gitlab"><a href="#1-使用docker-compose启动gitlab" class="headerlink" title="1.使用docker-compose启动gitlab"></a>1.使用docker-compose启动gitlab</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 可以启动</span></span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: gitlab/gitlab-ce:latest</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/gitlab/config:/etc/gitlab:Z</span><br><span class="line">      - /data/gitlab/logs:/var/log/gitlab:Z</span><br><span class="line">      - /data/gitlab/data:/var/opt/gitlab:Z</span><br><span class="line">    ports:</span><br><span class="line">      - 443:443</span><br><span class="line">      - 80:80</span><br><span class="line">      - 23:22</span><br><span class="line">    restart: always</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">## 参数报错</span></span><br><span class="line"><span class="built_in">command</span>:</span><br><span class="line">  - --shm-size 256m</span><br><span class="line">  - --hostname gitlab.xx.com</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 正确</span></span><br><span class="line">shm_size: <span class="string">&#x27;256m&#x27;</span></span><br><span class="line">hostname: <span class="string">&#x27;gitlab.xxx.com&#x27;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">## 参数报错 变量没有需要手动更改</span></span><br><span class="line">volumes:</span><br><span class="line">  - <span class="variable">$GITLAB_HOME</span>/config:/etc/gitlab:Z</span><br><span class="line">  - <span class="variable">$GITLAB_HOME</span>/logs:/var/log/gitlab:Z</span><br><span class="line">  - <span class="variable">$GITLAB_HOME</span>/data:/var/opt/gitlab:Z</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 正确</span></span><br><span class="line">修改变量，没有此变量路径</span><br></pre></td></tr></table></figure><h3 id="2-使用docker-compose启动jenkins"><a href="#2-使用docker-compose启动jenkins" class="headerlink" title="2.使用docker-compose启动jenkins"></a>2.使用docker-compose启动jenkins</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 可以启动</span></span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    image: jenkins:latest</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/jenkins:/var/jenkins_home</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">      - 50000:50000</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure><h3 id="3-jenkins从gitlab上拉代码"><a href="#3-jenkins从gitlab上拉代码" class="headerlink" title="3.jenkins从gitlab上拉代码"></a>3.jenkins从gitlab上拉代码</h3><h3 id=""><a href="#" class="headerlink" title=" "></a> </h3>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>网络模式，Harbor私有仓库</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-3-docker-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%EF%BC%8CHarbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-3-docker-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%EF%BC%8CHarbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="容器单向通信"><a href="#容器单向通信" class="headerlink" title="容器单向通信"></a>容器单向通信</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.下载busybox镜像</span></span><br><span class="line">docker pull busybox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.启动容器并连接</span></span><br><span class="line">docker run --name <span class="built_in">test</span> -it busybox /bin/sh</span><br><span class="line"></span><br><span class="line">--<span class="built_in">link</span>：单向通信</span><br><span class="line">docker run --name=test3 --<span class="built_in">link</span> <span class="built_in">test</span> -it busybox /bin/sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping test</span></span><br><span class="line">PING <span class="built_in">test</span> (172.17.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.115 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=1 ttl=64 time=0.085 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=2 ttl=64 time=0.069 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=3 ttl=64 time=0.059 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=4 ttl=64 time=0.067 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=5 ttl=64 time=0.060 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=6 ttl=64 time=0.064 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=7 ttl=64 time=0.079 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=8 ttl=64 time=0.108 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=9 ttl=64 time=0.064 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=10 ttl=64 time=0.065 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 实战--link</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.启动数据库</span></span><br><span class="line">docker run \</span><br><span class="line">--name wordpress_db \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">&#x27;123&#x27;</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">&#x27;wordpress&#x27;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&#x27;wp_user&#x27;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&#x27;123&#x27;</span> \</span><br><span class="line">-v /db_data:/var/lib/mysql \</span><br><span class="line">-d mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.启动wordpress</span></span><br><span class="line">docker run --name wp --<span class="built_in">link</span> wordpress_db -p80:80 -d wordpress:v4</span><br></pre></td></tr></table></figure><h2 id="docker启动zabbix"><a href="#docker启动zabbix" class="headerlink" title="docker启动zabbix"></a>docker启动zabbix</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## mysql</span></span><br><span class="line">docker run \</span><br><span class="line">--name zabbix_db \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">&#x27;123&#x27;</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">&#x27;zabbix&#x27;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&#x27;zabbix&#x27;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&#x27;zabbix&#x27;</span> \</span><br><span class="line">-v /zabbix_db:/var/lib/mysql \</span><br><span class="line">-d mysql:5.7 \</span><br><span class="line">--character-set-server=utf8 \</span><br><span class="line">--collation-server=utf8_bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## zabbix-server</span></span><br><span class="line">docker run \</span><br><span class="line">--name zabbix-server \</span><br><span class="line">--<span class="built_in">link</span> zabbix_db \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">&#x27;zabbix&#x27;</span> \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;zabbix_db&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## zabbix-frontend</span></span><br><span class="line">docker run \</span><br><span class="line">--name zabbix-web \</span><br><span class="line">--<span class="built_in">link</span> zabbix-server \</span><br><span class="line">--<span class="built_in">link</span> zabbix_db \</span><br><span class="line">-p 80:8080 \</span><br><span class="line">-p 443:8443 \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;zabbix_db&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix-server&quot;</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-web-nginx-mysql</span><br></pre></td></tr></table></figure><h2 id="三种网络模式"><a href="#三种网络模式" class="headerlink" title="三种网络模式"></a>三种网络模式</h2><h3 id="桥接模式（Bridge）"><a href="#桥接模式（Bridge）" class="headerlink" title="桥接模式（Bridge）"></a>桥接模式（Bridge）</h3><p>Bridge：Docker设计的NAT网络模型 默认类型</p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230601210204333.png" alt="image-20230601210204333"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看所有docker网络模式</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">2154e9bd8223 bridge bridge <span class="built_in">local</span></span><br><span class="line">19bc9cb412ac host host <span class="built_in">local</span></span><br><span class="line">7e02e5fd429d none null <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看bridge详细信息</span></span><br><span class="line">docker inspect bridge</span><br><span class="line"><span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line"><span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br><span class="line"></span><br><span class="line">容器上网，通过172.17.0.1IP进行上网(宿主机docker0)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 方法一：修改启动脚本修改网桥IP</span></span><br><span class="line">vi /usr/lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --bip=192.168.1.1/24</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt; mtu 1500</span><br><span class="line">inet 192.168.1.1 netmask 255.255.255.0 broadcast 192.168.1.255</span><br><span class="line">inet6 fe80::42:bcff:fe07:9cfc prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">ether 02:42:bc:07:9c:<span class="built_in">fc</span> txqueuelen 0 (Ethernet)</span><br><span class="line">RX packets 273121 bytes 45275719 (43.1 MiB)</span><br><span class="line">RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">TX packets 398786 bytes 768173681 (732.5 MiB)</span><br><span class="line">TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 方法二：修改配置文件修改网桥IP</span></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;bip&quot;</span>:<span class="string">&quot;10.1.1.1/24&quot;</span>,</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://pgz00k39.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255</span><br><span class="line">inet6 fe80::42:bcff:fe07:9cfc prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">ether 02:42:bc:07:9c:<span class="built_in">fc</span> txqueuelen 0 (Ethernet)</span><br><span class="line">RX packets 273115 bytes 45275503 (43.1 MiB)</span><br><span class="line">RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">TX packets 398780 bytes 768173377 (732.5 MiB)</span><br><span class="line">TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br></pre></td></tr></table></figure><h3 id="主机模式（host）"><a href="#主机模式（host）" class="headerlink" title="主机模式（host）"></a>主机模式（host）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Host：与宿主机共享Network Namespace，--network=host 性能最高</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动的时候 指定 --network host</span></span><br><span class="line"></span><br><span class="line">但是host模式不支持端口映射</span><br><span class="line">但是性能好</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -it --network=host busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line"><span class="comment">### 与宿主机共享IP ###</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230601210533860.png" alt="image-20230601210533860"></p><h3 id="容器模式（container）"><a href="#容器模式（container）" class="headerlink" title="容器模式（container）"></a>容器模式（container）</h3><p>Container：与另一个运行中的容器共享Network Namespace，—net=container:containerID（K8S）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">容器之间共享网络 k8S</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先启动一个主容器</span></span><br><span class="line">docker run -it centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用container模式启动一个nginx</span></span><br><span class="line">docker run -it --network=container:9dbc3b24fd1d nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用container模式启动一个busybox</span></span><br><span class="line">docker run -it --network=container:9dbc3b24fd1d busybox /bin/sh</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:0A:01:01:03</span><br><span class="line">inet addr:10.1.1.3 Bcast:10.1.1.255 Mask:255.255.255.0</span><br><span class="line">UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">collisions:0 txqueuelen:0</span><br><span class="line">RX bytes:656 (656.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo Link encap:Local Loopback</span><br><span class="line">inet addr:127.0.0.1 Mask:255.0.0.0</span><br><span class="line">UP LOOPBACK RUNNING MTU:65536 Metric:1</span><br><span class="line">RX packets:22 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">TX packets:22 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">collisions:0 txqueuelen:1000</span><br><span class="line">RX bytes:2066 (2.0 KiB) TX bytes:2066 (2.0 KiB)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主容器curl自己就可以访问nginx</span></span><br><span class="line">[root@9dbc3b24fd1d /]<span class="comment"># hostname -I</span></span><br><span class="line">10.1.1.3</span><br><span class="line">[root@9dbc3b24fd1d /]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="无网络模式（none）"><a href="#无网络模式（none）" class="headerlink" title="无网络模式（none）"></a>无网络模式（none）</h3><p>None：不为容器配置任何网络功能，—network=none</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --network=none busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">lo Link encap:Local Loopback</span><br><span class="line">inet addr:127.0.0.1 Mask:255.0.0.0</span><br><span class="line">UP LOOPBACK RUNNING MTU:65536 Metric:1</span><br><span class="line">RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">collisions:0 txqueuelen:1000</span><br><span class="line">RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230601210702781.png" alt="image-20230601210702781"></p><h3 id="自定义网路模式"><a href="#自定义网路模式" class="headerlink" title="自定义网路模式"></a>自定义网路模式</h3><p>以上4种模式都是docker自带的网络模式，docker还有一种叫做 自定义网络模式</p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230601210720436.png" alt="image-20230601210720436"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建自定义网络</span></span><br><span class="line">docker network create -d &lt;模式&gt; --subnet &lt;网段&gt; --gateway &lt;网关&gt; &lt;自定义网路名称&gt;</span><br><span class="line"></span><br><span class="line">docker network create -d bridge --subnet 192.168.10.0/24 --gateway 192.168.10.1 wangzhe</span><br><span class="line"></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">553146c9dbeb bridge bridge <span class="built_in">local</span></span><br><span class="line">19bc9cb412ac host host <span class="built_in">local</span></span><br><span class="line">7e02e5fd429d none null <span class="built_in">local</span></span><br><span class="line">c7c39fb300be wangzhe bridge <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker network create -d bridge --subnet 192.168.100.0/24 --gateway 192.168.100.1 lol</span><br><span class="line"></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID NAME DRIVER SCOPE</span><br><span class="line">553146c9dbeb bridge bridge <span class="built_in">local</span></span><br><span class="line">19bc9cb412ac host host <span class="built_in">local</span></span><br><span class="line">5d4bf27f621e lol bridge <span class="built_in">local</span></span><br><span class="line">7e02e5fd429d none null <span class="built_in">local</span></span><br><span class="line">c7c39fb300be wangzhe bridge <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将主机放入王者网段</span></span><br><span class="line">docker run --name wangzhe1 -it --network=wangzhe busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 02:42:C0:A8:0A:02</span><br><span class="line">inet addr:192.168.10.2 Bcast:192.168.10.255 Mask:255.255.255.0</span><br><span class="line">UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</span><br><span class="line">RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">collisions:0 txqueuelen:0</span><br><span class="line">RX bytes:656 (656.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo Link encap:Local Loopback</span><br><span class="line">inet addr:127.0.0.1 Mask:255.0.0.0</span><br><span class="line">UP LOOPBACK RUNNING MTU:65536 Metric:1</span><br><span class="line">RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">collisions:0 txqueuelen:1000</span><br><span class="line">RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping wangzhe2</span></span><br><span class="line">PING wangzhe2 (192.168.10.3): 56 data bytes</span><br><span class="line">64 bytes from 192.168.10.3: <span class="built_in">seq</span>=0 ttl=64 time=0.072 ms</span><br><span class="line">64 bytes from 192.168.10.3: <span class="built_in">seq</span>=1 ttl=64 time=0.111 ms</span><br><span class="line">64 bytes from 192.168.10.3: <span class="built_in">seq</span>=2 ttl=64 time=0.109 ms</span><br><span class="line">64 bytes from 192.168.10.3: <span class="built_in">seq</span>=3 ttl=64 time=0.073 ms</span><br><span class="line">64 bytes from 192.168.10.3: <span class="built_in">seq</span>=4 ttl=64 time=5.863 ms</span><br><span class="line">docker run --name wangzhe2 -it --network=wangzhe busybox /bin/sh</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping wangzhe1</span></span><br><span class="line">PING wangzhe1 (192.168.10.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.10.2: <span class="built_in">seq</span>=0 ttl=64 time=0.048 ms</span><br><span class="line">64 bytes from 192.168.10.2: <span class="built_in">seq</span>=1 ttl=64 time=0.106 ms</span><br><span class="line">64 bytes from 192.168.10.2: <span class="built_in">seq</span>=2 ttl=64 time=0.306 ms</span><br><span class="line">64 bytes from 192.168.10.2: <span class="built_in">seq</span>=3 ttl=64 time=0.100 ms</span><br><span class="line">64 bytes from 192.168.10.2: <span class="built_in">seq</span>=4 ttl=64 time=0.059 ms</span><br><span class="line">^C</span><br><span class="line">--- wangzhe1 ping statistics ---</span><br><span class="line">5 packets transmitted, 5 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.048/0.123/0.306 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">## 总结</span></span><br><span class="line"><span class="comment"># 放入自定义相同网段可以通信</span></span><br><span class="line"><span class="comment"># 放入自定义不同的网段不能通信</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法实现跨主机通信</span></span><br></pre></td></tr></table></figure><h2 id="Harbor私有仓库"><a href="#Harbor私有仓库" class="headerlink" title="Harbor私有仓库"></a>Harbor私有仓库</h2><p>Harbor 是为企业用户设计的容器镜像仓库开源项目，包括了权限管理(RBAC)、LDAP、审计、安全漏洞 扫描、镜像验真、管理界面、自我注册、HA 等企业必需的功能，同时针对中国用户的特点，设计镜像 复制和中文支持等功能。 </p><p>Harbor私有仓库下载地址：<a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.8.1/harbor-offline-installer-v2.8.1.tgz</span><br></pre></td></tr></table></figure><h3 id="安装部署Harbor"><a href="#安装部署Harbor" class="headerlink" title="安装部署Harbor"></a>安装部署Harbor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.下载Harbor</span></span><br><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.8.1/harbor-offline-installer-v2.8.1.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装docker-compose</span></span><br><span class="line">yum install -y docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.解压Harbor</span></span><br><span class="line">tar xf harbor-offline-installer-v1.9.0-rc1.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.修改docker-compose文件</span></span><br><span class="line">vim /root/harbor/harbor.yml</span><br><span class="line">hostname: 10.0.0.81</span><br><span class="line">harbor_admin_password: 123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.安装Harbor</span></span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230604185834964.png" alt="image-20230604185834964"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230604185845868.png" alt="image-20230604185845868"></p><h3 id="Harbor使用"><a href="#Harbor使用" class="headerlink" title="Harbor使用"></a>Harbor使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将镜像上传到harbor中，镜像命名规则</span></span><br><span class="line">harbor地址/项目名称/镜像名称:标签</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.修改docker配置文件，注册harbor仓库</span></span><br><span class="line"><span class="comment">############# 这是其他主机 ##############  10.0.0.82 这个是harbor主机</span></span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;bip&quot;</span>:<span class="string">&quot;10.1.1.1/24&quot;</span>,</span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://10.0.0.82&quot;</span>],</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://pgz00k39.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.登录harbor</span></span><br><span class="line">docker login 10.0.0.82</span><br><span class="line"></span><br><span class="line">Username: admin</span><br><span class="line">Password: 123</span><br><span class="line"></span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查看harbor的登录凭证</span></span><br><span class="line"><span class="built_in">cat</span> /root/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;10.0.0.82&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YWRtaW46MTIz&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230604190008493.png" alt="image-20230604190008493"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># harbor地址/项目名称/镜像名称:标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改镜像名称</span></span><br><span class="line">10.0.0.82/lol/wordpress:v9</span><br><span class="line">docker tag wordpress:v9 10.0.0.82/lol/wordpress:v9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送镜像</span></span><br><span class="line">docker push 10.0.0.82/lol/wordpress:v9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉镜像</span></span><br><span class="line">docker pull 10.0.0.82/lol/wordpress:v9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用docker file做镜像直接按照harbor命名规则起名</span></span><br><span class="line"><span class="comment"># . 为dockerfile 文件所在的目录</span></span><br><span class="line">docker build -t 10.0.0.82/lol/wp:v10 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送</span></span><br><span class="line">docker push 10.0.0.82/lol/wp:v10</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230604190135262.png" alt="image-20230604190135262"></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>dockerfile制作镜像</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-2-docker-%E4%BD%BF%E7%94%A8dockerfile%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-2-docker-%E4%BD%BF%E7%94%A8dockerfile%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="手动制作wordpress镜像"><a href="#手动制作wordpress镜像" class="headerlink" title="手动制作wordpress镜像"></a>手动制作wordpress镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.启动centos:7镜像</span></span><br><span class="line">docker run -it centos:7 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.删除所有官方源</span></span><br><span class="line"><span class="built_in">rm</span> -fr /etc/yum.repo.d/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.更换阿里云的yum源</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.准备php安装包</span></span><br><span class="line">docker <span class="built_in">cp</span> php.tgz a0e746d7788f:/opt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.解压安装包</span></span><br><span class="line">tar xf php.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.安装php</span></span><br><span class="line"><span class="built_in">cd</span> /opt &amp;&amp; yum localinstall -y *.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.安装nginx</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.创建www用户和组</span></span><br><span class="line">groupadd www -g 666</span><br><span class="line">useradd www -u 666 -g 666 -s /sbin/nolog -M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.修改主配置文件</span></span><br><span class="line">vi /etc/nginx/nginx.conf</span><br><span class="line">user www;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.修改php配置文件</span></span><br><span class="line">vi /etc/php-fpm.d/www.conf</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.编写博客配置文件</span></span><br><span class="line">vi /etc/nginx/conf.d/blog.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name _;</span><br><span class="line">root /code/wordpress;</span><br><span class="line">index index.php index.html;</span><br><span class="line"></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.1 创建站点目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.2下载wordpress</span></span><br><span class="line">wget https://cn.wordpress.org/latest-zh_CN.tar.gz</span><br><span class="line">docker <span class="built_in">cp</span> latest-zh_CN.tar.gz a0e746d7788f:/code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 12.启动php</span></span><br><span class="line">/usr/sbin/php-fpm --fpm-config /etc/php-fpm.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 13.启动nginx并将nginx卡在后台</span></span><br><span class="line">/usr/sbin/nginx -g <span class="string">&#x27;daemon off;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 14.部署wordpress代码</span></span><br><span class="line">tar xf latest-zh_CN.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 15.授权</span></span><br><span class="line"><span class="built_in">chown</span> -R www.www wordpress/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 16.将容器制作成镜像</span></span><br><span class="line">docker commit a0e746d7788f wordpress:v1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 17.运行手动镜像</span></span><br><span class="line">docker run --name wp -p 80:80 -d wordpress:v1 /sbin/nginx -g <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">docker run --name wp -p 80:80 -d wordpress:v1 /bin/bash /start.sh</span><br></pre></td></tr></table></figure><h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><ul><li>镜像体积大 </li><li>镜像会继承基础镜像的PID为1的进程（运行后会直接退出） </li><li>不会暴露镜像内起了哪些端口 </li><li>不会暴露镜像内的数据目录是什么</li></ul><h2 id="Dockerfile制作镜像"><a href="#Dockerfile制作镜像" class="headerlink" title="Dockerfile制作镜像"></a>Dockerfile制作镜像</h2><h3 id="什么是-Dockerfile？"><a href="#什么是-Dockerfile？" class="headerlink" title="什么是 Dockerfile？"></a>什么是 Dockerfile？</h3><p>Dockerfile 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</p><ul><li>镜像： 中药 </li><li>dockerfile： 配方 </li><li>dockerfile常用指令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM 指定基础镜像</span><br><span class="line">RUN 指定在容器中要执行的命令</span><br><span class="line">CMD 指定容器启动后，PID为1进程的命令 nginx php</span><br><span class="line">ENTRYPOINT 指定容器启动后，PID为1进程的命令 sh /start.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有ENTRYPOINT，那么就把CMD中的命令当成是PID为1的进程来执行</span></span><br><span class="line"><span class="comment"># 如果有ENTRYPOINT，那么ENTRYPOINT中的命令就是PID为1的进程，CMD中的命令则为ENTRYPOINT的参数</span></span><br><span class="line">ADD 指定需要放入容器中的配置文件或包（如果是压缩包，则会自动解压）</span><br><span class="line">COPY 指定需要放入容器中的配置文件或包（如果是压缩包，则不会自动解压）</span><br><span class="line">WORKDIR 指定容器中程序的工作目录</span><br><span class="line">EXPOSE 指定容器中起了哪些端口（声明）</span><br><span class="line">VOLUME 指定容器中可以挂载的目录（声明）</span><br><span class="line"></span><br><span class="line">ENV 指定容器中的环境变量 MYSQL_ROOT_PASSWORD MYSQL_USER</span><br><span class="line">MYSQL_DATABASE  MYSQL_PASSWORD</span><br><span class="line">LABEL 给镜像打标签</span><br><span class="line">MAINTAINER 让别人执行docker inspectc查看到，这个镜像是谁做的</span><br></pre></td></tr></table></figure><h3 id="Dockerfile制作wordpress镜像"><a href="#Dockerfile制作wordpress镜像" class="headerlink" title="Dockerfile制作wordpress镜像"></a>Dockerfile制作wordpress镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备配置文件</span></span><br><span class="line">tree</span><br><span class="line">.</span><br><span class="line">├── blog.conf</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── latest-zh_CN.tar.gz</span><br><span class="line">├── nginx.conf</span><br><span class="line">├── php.tgz</span><br><span class="line">└── www.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## Dockerfile</span></span><br><span class="line">FROM centos:7</span><br><span class="line">RUN <span class="built_in">rm</span> -fr /etc/yum.repos.d/*</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">RUN curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel7.repo</span><br><span class="line">ADD php.tgz /opt/</span><br><span class="line">RUN yum localinstall -y /opt/*.rpm</span><br><span class="line">RUN yum install -y nginx</span><br><span class="line">RUN groupadd www -g 666</span><br><span class="line">RUN useradd www -u 666 -g 666 -s /sbin/nolog -M</span><br><span class="line">COPY nginx.conf /etc/nginx/</span><br><span class="line">COPY blog.conf /etc/nginx/conf.d/</span><br><span class="line">COPY www.conf /etc/php-fpm.d/</span><br><span class="line">RUN <span class="built_in">mkdir</span> /code</span><br><span class="line">ADD latest-zh_CN.tar.gz /code/</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/php-fpm --fpm-config /etc/php-fpm.conf&quot;</span> &gt; /start.sh</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/nginx -g &#x27;daemon off;&#x27;&quot;</span> &gt;&gt; /start.sh</span><br><span class="line">RUN <span class="built_in">chown</span> -R www.www /code/wordpress/</span><br><span class="line">RUN <span class="built_in">chown</span> -R www.www /var/lib/nginx</span><br><span class="line">EXPOSE 80/tcp</span><br><span class="line">CMD [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 构建docker镜像</span></span><br><span class="line">docker build -t wordpress:v2 .</span><br><span class="line"></span><br><span class="line"><span class="comment">## 构建过程</span></span><br><span class="line">=&gt; [internal] load build definition from Dockerfile</span><br><span class="line">0.1s</span><br><span class="line">=&gt; =&gt; transferring dockerfile: 793B</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [internal] load .dockerignore</span><br><span class="line">0.1s</span><br><span class="line">=&gt; =&gt; transferring context: 2B</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [internal] load metadata <span class="keyword">for</span> docker.io/library/centos:7</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [ 1/18] FROM docker.io/library/centos:7</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [internal] load build context</span><br><span class="line">2.7s</span><br><span class="line">=&gt; =&gt; transferring context: 43.47MB</span><br><span class="line">2.7s</span><br><span class="line">=&gt; [ 2/18] RUN <span class="built_in">rm</span> -fr /etc/yum.repos.d/*</span><br><span class="line">0.9s</span><br><span class="line">=&gt; [ 3/18] RUN curl -o /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">1.6s</span><br><span class="line">=&gt; [ 4/18] RUN curl -o /etc/yum.repos.d/epel.repo</span><br><span class="line">https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">0.9s</span><br><span class="line">=&gt; [ 5/18] ADD php.tgz /opt/</span><br><span class="line">0.2s</span><br><span class="line">=&gt; [ 6/18] RUN yum localinstall -y /opt/*.rpm</span><br><span class="line">59.7s</span><br><span class="line">=&gt; [ 7/18] RUN yum install -y nginx</span><br><span class="line">16.9s</span><br><span class="line">=&gt; [ 8/18] RUN groupadd www -g 666</span><br><span class="line">0.2s</span><br><span class="line">=&gt; [ 9/18] RUN useradd www -u 666 -g 666 -s /sbin/nolog -M</span><br><span class="line">0.2s</span><br><span class="line">=&gt; [10/18] COPY nginx.conf /etc/nginx/</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [11/18] COPY blog.conf /etc/nginx/conf.d/</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [12/18] COPY www.conf /etc/php-fpm.d/</span><br><span class="line">0.0s</span><br><span class="line">=&gt; [13/18] RUN <span class="built_in">mkdir</span> /code</span><br><span class="line">0.2s</span><br><span class="line">=&gt; [14/18] ADD latest-zh_CN.tar.gz /code/</span><br><span class="line">1.1s</span><br><span class="line">=&gt; [15/18] RUN <span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/php-fpm --fpm-config /etc/php-fpm.conf&quot;</span> &gt;</span><br><span class="line">/start.sh 0.2s</span><br><span class="line">=&gt; [16/18] RUN <span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/nginx -g &#x27;daemon off;&#x27;&quot;</span> &gt;&gt; /start.sh</span><br><span class="line">0.5s</span><br><span class="line">=&gt; [17/18] RUN <span class="built_in">chown</span> -R www.www /code/wordpress/</span><br><span class="line">1.6s</span><br><span class="line">=&gt; [18/18] RUN <span class="built_in">chown</span> -R www.www /var/lib/nginx</span><br><span class="line">0.3s</span><br><span class="line">=&gt; exporting to image</span><br><span class="line">6.4s</span><br><span class="line">=&gt; =&gt; exporting layers</span><br><span class="line">6.4s</span><br><span class="line">=&gt; =&gt; writing image</span><br><span class="line">sha256:21c08faf7a3591bfb9c7fc6ce798739387fea20c351d462ec0fc775dffa97f65</span><br><span class="line">0.0s</span><br><span class="line">=&gt; =&gt; naming to docker.io/library/wordpress:v2</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Docker分段构建"><a href="#Docker分段构建" class="headerlink" title="Docker分段构建"></a>Docker分段构建</h3><p>镜像分层的好处：复用,节省磁盘空间，相同的内容只需加载一份到内存。 </p><p>修改dockerfile之后，再次构建速度快</p><p><strong>dockerfile 优化：</strong> </p><ul><li>1：尽可能选择体积小linux发行版，alpine </li><li>2：尽可能合并RUN指令，清理无用的文件（yum缓存，源码包） </li><li>3：修改dockerfile，把变化的内容尽可能放在dockerfile结尾 </li><li>4： 使用 \ 减少不必要的文件RUN 和 ADD</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">ADD php.tgz /opt/</span><br><span class="line">RUN groupadd www -g 666 &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;chown -R www.www /code/wordpress&quot;</span> &gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;chown -R www.www /var/lib/nginx&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/php-fpm --fpm-config /etc/php-fpm.conf&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/nginx -g &#x27;daemon off;&#x27;&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line">useradd www -u 666 -g 666 -s /sbin/nolog -M &amp;&amp; \</span><br><span class="line"><span class="built_in">mkdir</span> /code &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -fr /etc/yum.repos.d/* &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">&amp;&amp; \</span><br><span class="line">yum localinstall -y /opt/*.rpm &amp;&amp; \</span><br><span class="line">yum install -y nginx &amp;&amp; \</span><br><span class="line">yum clean all &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -fr /etc/yum.repos.d/* &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -fr /opt/*</span><br><span class="line">COPY nginx.conf /etc/nginx/</span><br><span class="line">COPY blog.conf /etc/nginx/conf.d/</span><br><span class="line">COPY www.conf /etc/php-fpm.d/</span><br><span class="line">ADD latest-zh_CN.tar.gz /code/</span><br><span class="line">EXPOSE 80/tcp</span><br><span class="line">CMD [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>制作wordpress镜像 </p><p>nginx </p><p>php </p><p>mysql（mariadb） </p><p>wordpress</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装mariadb</span></span><br><span class="line">yum install -y mariadb-server</span><br><span class="line"><span class="comment"># 2.初始化</span></span><br><span class="line">/usr/libexec/mariadb-prepare-db-dir %n</span><br><span class="line"><span class="comment"># 3.启动</span></span><br><span class="line">/usr/bin/mysqld_safe --basedir=/usr</span><br><span class="line"><span class="comment"># 4.创建数据库</span></span><br><span class="line">create database wordpress;</span><br><span class="line"><span class="comment"># 5.创建用户</span></span><br><span class="line">grant all on wordpress.* to wordpress@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="comment"># 6.将容器做成镜像</span></span><br><span class="line">docker commit 130ac9554a42 wordpress:v5</span><br><span class="line"><span class="comment"># 7.启动镜像</span></span><br><span class="line">docker run --name wp -p80:80 -d wordpress:v5 /bin/sh /start.sh</span><br><span class="line"></span><br><span class="line">FROM centos:7</span><br><span class="line">ADD php.tgz /opt/</span><br><span class="line">RUN groupadd www -g 666 &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;chown -R www.www /code/wordpress&quot;</span> &gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;chown -R www.www /var/lib/nginx&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/php-fpm --fpm-config /etc/php-fpm.conf&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line">/usr/bin/mysqld_safe --basedir=/usr &amp;</span><br><span class="line"><span class="built_in">echo</span> mysql -e <span class="string">&quot;create database wordpress;&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> mysql -e <span class="string">&quot;grant all on wordpress.* to wordpress@&#x27;localhost&#x27; identified by &#x27;123&#x27;;&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/sbin/nginx -g &#x27;daemon off;&#x27;&quot;</span> &gt;&gt; /start.sh &amp;&amp; \</span><br><span class="line">useradd www -u 666 -g 666 -s /sbin/nolog -M &amp;&amp; \</span><br><span class="line"><span class="built_in">mkdir</span> /code &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -fr /etc/yum.repos.d/* &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">&amp;&amp; \</span><br><span class="line">yum localinstall -y /opt/*.rpm &amp;&amp; \</span><br><span class="line">yum install -y nginx mariadb-server &amp;&amp; \</span><br><span class="line">/usr/libexec/mariadb-prepare-db-dir %n &amp;&amp; \</span><br><span class="line">yum clean all &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -fr /etc/yum.repos.d/* &amp;&amp; \</span><br><span class="line"><span class="built_in">rm</span> -fr /opt/*</span><br><span class="line">COPY nginx.conf /etc/nginx/</span><br><span class="line">COPY blog.conf /etc/nginx/conf.d/</span><br><span class="line">COPY www.conf /etc/php-fpm.d/</span><br><span class="line">ADD latest-zh_CN.tar.gz /code/</span><br><span class="line">EXPOSE 80/tcp</span><br><span class="line">CMD [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;/start.sh&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 问题</span></span><br><span class="line">数据库中的库和用户无法创建</span><br><span class="line"></span><br><span class="line"><span class="comment">## 坑：</span></span><br><span class="line">1.一个容器只做一件事，将多个服务打到一个镜像中，会出现问题</span><br><span class="line">2.如果使用两个容器，一个wordpress，一个mysql，wordpress配置中mysql的ip写死了</span><br><span class="line">3.无法做到两个容器之间通信</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 解决</span></span><br><span class="line">一个容器只做一件事</span><br><span class="line">如何让容器之间不使用ip即可通信</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>安装及基础命令</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/Docker-1-docker-%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/Docker-1-docker-%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="什么是docker"><a href="#什么是docker" class="headerlink" title="什么是docker"></a>什么是docker</h2><p>Docker 是Docker.Inc公司开源的，一个基于LXC技术之上构建的Container容器引擎，源码托管在 GitHub上，基于Go语言，并基于Apache2.0协议开源 </p><p>Docker是通过内核虚拟化技术（namespace及cgroup等）来提供容器的资源隔离与安全保障等。 </p><p>由于Docker通过操作系统层的虚拟化实现隔离，所以Docker容器在运行时，不需要类似虚拟机（VM）额外的 操作系统开销，提高资源利用率。</p><h2 id="docker和KVM的区别"><a href="#docker和KVM的区别" class="headerlink" title="docker和KVM的区别"></a>docker和KVM的区别</h2><p><img src="C:\Users\17764\AppData\Roaming\Typora\typora-user-images\image-20230530193804430.png" alt=""></p><h2 id="VM虚拟化和Docker特性对比"><a href="#VM虚拟化和Docker特性对比" class="headerlink" title="VM虚拟化和Docker特性对比"></a>VM虚拟化和Docker特性对比</h2><div class="table-container"><table><thead><tr><th>特性</th><th>Docker</th><th>VM</th></tr></thead><tbody><tr><td>启动速度</td><td>秒级</td><td>分钟级</td></tr><tr><td>硬盘使用</td><td>一般为MB</td><td>一般为GB</td></tr><tr><td>性能</td><td>接近原生</td><td>弱于原生</td></tr><tr><td>系统支持量</td><td>单机支持上千个容器</td><td>一般几十个</td></tr><tr><td>隔离性</td><td>安全隔离</td><td>完全隔离</td></tr></tbody></table></div><h2 id="namespace-cgroup"><a href="#namespace-cgroup" class="headerlink" title="namespace / cgroup"></a>namespace / cgroup</h2><h3 id="namespace-资源隔离"><a href="#namespace-资源隔离" class="headerlink" title="namespace 资源隔离"></a>namespace 资源隔离</h3><p>内核提供了namespace的机制用来隔离相关资源，namespace设计之初就是为了实现轻量级的系统资 源隔离，可以让容器中的进程仿佛置身于一个独立的系统环境中。</p><div class="table-container"><table><thead><tr><th>Namespace</th><th>系统调用参数</th><th>隔离内容</th></tr></thead><tbody><tr><td>UTC</td><td>CLONE_NEWUTC</td><td>主机名和域名</td></tr><tr><td>IPC</td><td>CLONE_NEWIPC</td><td>信号量，消息队列，共享内存</td></tr><tr><td>PID</td><td>CLONE_NEWPID</td><td>进程号</td></tr><tr><td>Network</td><td>CLONE_NEWNET</td><td>网络设备，网络栈，端口</td></tr><tr><td>Mount</td><td>CLONE_NEWNS</td><td>文件系统</td></tr><tr><td>User</td><td>CLONE_NEWUSER</td><td>用户和用户组</td></tr></tbody></table></div><h3 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h3><p>cgroups 限制一个进程能够使用的资源。cpu，内存，硬盘io</p><p><strong>作用</strong></p><ul><li><p>资源限制：例如设定任务指定内存 </p></li><li><p>优先级分配：比如跟任务分配的CPU时间，片数，磁盘IO，带宽大小来控制任务的优先级 </p></li><li>资源统计：统计CPU，内存，IO等资源使用时长，该功能比较适合用于计费 </li><li>任务控制：cgroup可以对任务进行 运行，挂起，恢复等操作</li></ul><h2 id="docker三个重要的概念"><a href="#docker三个重要的概念" class="headerlink" title="docker三个重要的概念"></a>docker三个重要的概念</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230530194218869.png" alt="image-20230530194218869"></p><h3 id="Images（镜像）"><a href="#Images（镜像）" class="headerlink" title="Images（镜像）"></a>Images（镜像）</h3><p>Docker镜像可以看做是一个特殊的文件系统，除了提供容器运行时所需要的程序、库、资源、配置文件以外， 还包含了一些为运行时，准备的配置参数（匿名卷，环境变量，用户等），镜像是不可更改的</p><h3 id="Container（容器）"><a href="#Container（容器）" class="headerlink" title="Container（容器）"></a>Container（容器）</h3><p>容器的定义和镜像，几乎是一模一样，唯一区别在于容器的最上面那一层是可读可写的。</p><h3 id="Repository（仓库）"><a href="#Repository（仓库）" class="headerlink" title="Repository（仓库）"></a>Repository（仓库）</h3><ul><li>dockerhub（公有仓库） </li><li>harbor（私有仓库）</li></ul><p>仓库是Docker用来存放镜像的地方，类似于我们之前常用的代码仓库。 </p><p>通常一个仓库会包含，同一个软件，不同版本的镜像 </p><p>我们可以通过&lt;仓库名&gt;:&lt;标签&gt;格式来指定具体使用哪个版本的镜像，如果不给标签，那么默认以Latest作为 默认标签</p><h2 id="docker组成部分"><a href="#docker组成部分" class="headerlink" title="docker组成部分"></a>docker组成部分</h2><p><strong>C/S结构的服务</strong></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230530194324639.png" alt="image-20230530194324639"></p><ul><li>Docker是传统的C/S架构，分为 docker client 和 docker server </li><li>Docker客户端是Docker用户与Docker交互的主要方式 </li><li>当使用Docker命令行运行命令时，Docker客户端将这些命令发送给服务端，服务端执行这些命令 </li><li>Docker命令使用Docker API </li><li>Docker客户端可以与多个服务端进行通讯</li></ul><h2 id="docker部署及使用"><a href="#docker部署及使用" class="headerlink" title="docker部署及使用"></a>docker部署及使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><strong>使用清华源</strong></p><p><a href="https://mirrors.tuna.tsinghua.edu.cn/">https://mirrors.tuna.tsinghua.edu.cn/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 点击问号，进入帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.如果以前安装过docker先删除</span></span><br><span class="line">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.下载docker yum源</span></span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.将官方源的url改成清华源的url</span></span><br><span class="line">sed -i <span class="string">&#x27;s+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.安装docker</span></span><br><span class="line">yum install -y docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看docker版本</span></span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动docker</span></span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><h3 id="配置镜像加速"><a href="#配置镜像加速" class="headerlink" title="配置镜像加速"></a>配置镜像加速</h3><p><strong>1.登录阿里云</strong></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230530194711317.png" alt="image-20230530194711317"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230530194725882.png" alt="image-20230530194725882"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230530194736328.png" alt="image-20230530194736328"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230530194744596.png" alt="image-20230530194744596"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建docker配置文件存放目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.编辑配置文件</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://cg1k018d.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.重启docker</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h3 id="docker操作"><a href="#docker操作" class="headerlink" title="docker操作"></a>docker操作</h3><p><strong>镜像</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0.查找镜像</span></span><br><span class="line">docker search nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.拉取镜像（dockerhub）</span></span><br><span class="line">docker pull nginx</span><br><span class="line">docker pull 镜像名称:标签</span><br><span class="line">docker pull nginx:latest</span><br><span class="line">完整的镜像名=仓库名称:标签名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看当前都拉取了哪些镜像</span></span><br><span class="line">docker image <span class="built_in">ls</span> / docker images</span><br><span class="line">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br><span class="line">nginx latest 605c77e624dd 17 months ago 141MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.只查看镜像id</span></span><br><span class="line">docker image <span class="built_in">ls</span> -q</span><br><span class="line">cc44224bfe20</span><br><span class="line">605c77e624dd</span><br><span class="line">eeb6ee3f44bd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.删除镜像指定仓库名和标签</span></span><br><span class="line">docker image rmi nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.指定id删除镜像</span></span><br><span class="line">docker image rmi cc44224bfe20</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.导出镜像</span></span><br><span class="line">docker image save eeb6ee3f44bd -o /tmp/centos7.tar.gz</span><br><span class="line">docker image save eeb6ee3f44bd &gt; /tmp/centos7.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.导入镜像</span></span><br><span class="line">docker image load -i /root/nginx_alpine.tar.gz</span><br><span class="line">docker image load &lt; /root/nginx_alpine.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.给镜像打标签 or 改名</span></span><br><span class="line">docker image tag cc44224bfe20 nginx:alpine</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>容器</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">docker container</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker：</span><br><span class="line">1.一个容器只做一件事</span><br><span class="line">2.容器运行的前提条件是进程号PID为1的进程不退出</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.查看运行了哪些容器</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看所有容器</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.运行一个容器</span></span><br><span class="line">docker run centos:7 /bin/echo <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"></span><br><span class="line">使用centos:7镜像启动一个容器，输出 hello内容</span><br><span class="line">/bin/echo <span class="string">&#x27;hello&#x27;</span> 容器PID为1的进程</span><br><span class="line"></span><br><span class="line">docker run --name=zls_c7 centos:7</span><br><span class="line"></span><br><span class="line">docker run --name=zls_nginx -d nginx:alpine</span><br><span class="line"></span><br><span class="line">docker run</span><br><span class="line">-it：提供一个交互的终端</span><br><span class="line">--name：给容器指定名字</span><br><span class="line">-d：将容器放在后台运行</span><br><span class="line">-v：挂载卷</span><br><span class="line">-p：端口映射</span><br><span class="line">• -p 宿主机端口:容器端口</span><br><span class="line">• -p 宿主机IP:宿主机端口:容器端口 <span class="comment"># 多个容器都想使用80端口</span></span><br><span class="line">• -p 宿主机IP::容器端口 <span class="comment"># 宿主机起随机端口映射到容器中</span></span><br><span class="line">• -p 宿主机端口:容器端口/udp <span class="comment"># 映射udp端口</span></span><br><span class="line">• -p 10.0.0.100::53/udp 使用宿主机的10.0.0.100这个ip地址的随机端口的udp协议映射容器的udp53端口</span><br><span class="line">• -p 81:80 –p 443:443 可以指定多个-p</span><br><span class="line">• -p 5000-65535:5000-65535 <span class="comment"># 范围端口映射</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -it centos:centos7 /bin/bash</span><br><span class="line">docker pull centos:centos7</span><br><span class="line">docker create centos:centos7</span><br><span class="line">docker start centos:centos7id</span><br><span class="line">docker <span class="built_in">exec</span> -it centos:centos7id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.停止容器</span></span><br><span class="line">docker stop 4f8bf2df4d50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.创建一个容器</span></span><br><span class="line">docker create nginx:alpine</span><br><span class="line">9e530b78f7bc29b661a9385e86249643392b1659198dc1c2633ceb8a1a10ae37</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.启动容器</span></span><br><span class="line">docker start 9e530b78f7bc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.连接到一个容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 9e530b78f7bc /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> 4f8bf2df4d50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.将宿主机文件拷贝到容器中</span></span><br><span class="line">docker <span class="built_in">cp</span> h5_games fcc042180e51:/usr/share/nginx/html</span><br></pre></td></tr></table></figure><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="1-起nginx部署h5小游戏"><a href="#1-起nginx部署h5小游戏" class="headerlink" title="1.起nginx部署h5小游戏"></a>1.起nginx部署h5小游戏</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备h5的代码</span></span><br><span class="line">ll /root/h5_games</span><br><span class="line">total 48</span><br><span class="line">drwxr-xr-x 23 root root 4096 Mar 5 2015 ceshi</span><br><span class="line">drwxr-xr-x 42 root root 4096 Mar 5 2015 game</span><br><span class="line">drwxr-xr-x 2 root root 4096 Mar 5 2015 img</span><br><span class="line">-rwxr-xr-x 1 root root 30312 Mar 5 2015 index.html</span><br><span class="line">-rwxr-xr-x 1 root root 578 Mar 5 2015 readme.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动nginx容器部署h5代码</span></span><br><span class="line">docker run --name h5_games -p80:80 -v /root/h5_games:/usr/share/nginx/html -d nginx:alpine-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到容器中</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h5_games /bin/sh</span><br></pre></td></tr></table></figure><h3 id="2-起MySQL，保证数据不丢失"><a href="#2-起MySQL，保证数据不丢失" class="headerlink" title="2.起MySQL，保证数据不丢失"></a>2.起MySQL，保证数据不丢失</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## docker镜像、容器详细信息</span></span><br><span class="line">docker inspect</span><br><span class="line">docker inspect mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看容器的日志</span></span><br><span class="line">docker logs d9e7f0217b7e</span><br><span class="line">docker logs mysql57</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动MySQL容器（错误方法）</span></span><br><span class="line">docker run --name mysql57 -p3306:3306 -d mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment">## MySQL官方镜像内置环境变量</span></span><br><span class="line">MYSQL_ROOT_PASSWORD // 指定MySQL的root用户密码</span><br><span class="line"></span><br><span class="line">MYSQL_DATABASE // 指定MySQL容器，启动后，自动创建指定的库</span><br><span class="line"></span><br><span class="line">MYSQL_USER // 指定MySQL容器，启动后，自动创建指定用户</span><br><span class="line"></span><br><span class="line">MYSQL_PASSWORD // 指定MySQL容器，启动后，自动创建指定用户的密码</span><br><span class="line"></span><br><span class="line">MYSQL_ALLOW_EMPTY_PASSWORD // 给容器中root用户一个空密码</span><br><span class="line"></span><br><span class="line">MYSQL_RANDOM_ROOT_PASSWORD // 给容器中root用户一个随机密码</span><br><span class="line"></span><br><span class="line">MYSQL_ONETIME_PASSWORD // 给容器中root用户一个临时一次性密码</span><br><span class="line"></span><br><span class="line"><span class="comment"># grant all on wordpress.* to wp_user@&#x27;%&#x27; identified by &#x27;123&#x27;;</span></span><br><span class="line"><span class="comment"># create database wordpress;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--<span class="built_in">rm</span>：停止容器时，自动删除容器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">--name wordpress_db \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">&#x27;123&#x27;</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">&#x27;wordpress&#x27;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&#x27;wp_user&#x27;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&#x27;123&#x27;</span> \</span><br><span class="line">-v /db_data:/var/lib/mysql \</span><br><span class="line">-d mysql:5.7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--character-set-server=utf8</span><br><span class="line">--collation-server=utf8_bin</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>代码上线</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/DevOps-5-devops-%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%BA%BF/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/DevOps-5-devops-%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%BA%BF/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="代码上线"><a href="#代码上线" class="headerlink" title="代码上线"></a>代码上线</h2><h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230518172059971.png" alt="image-20230518172059971"></p><h3 id="准备代码"><a href="#准备代码" class="headerlink" title="准备代码"></a>准备代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建git仓库</span></span><br><span class="line"><span class="built_in">mkdir</span> xyz</span><br><span class="line"><span class="built_in">cd</span> xyz</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment">## 准备代码</span></span><br><span class="line"><span class="comment"># cat index.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;src.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat src.js</span></span><br><span class="line">const string = <span class="string">&#x27;老板好，我是程序猿：zls，您让我写的官网页面，它会动&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span></span><br><span class="line"></span><br><span class="line"># 加到缓存区</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"># 添加远程仓库</span><br><span class="line">git remote add origin git@gitlab.xxx.com:root/xyz.git</span><br><span class="line"></span><br><span class="line"># 做本地域名解析</span><br><span class="line">vim /etc/hosts</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span> localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span> localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.91</span> gitlab.xxx.com</span><br><span class="line"></span><br><span class="line"># 推送文件至仓库</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><h3 id="修改代码-模式持续集成"><a href="#修改代码-模式持续集成" class="headerlink" title="修改代码(模式持续集成)"></a>修改代码(模式持续集成)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat index.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿&lt;/title&gt;</span><br><span class="line">&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;style.css&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;澳门皇家DC&lt;/div&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo2&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;main.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat style.css</span></span><br><span class="line"><span class="comment">#demo2&#123;</span></span><br><span class="line">margin-top: 50px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat main.js</span></span><br><span class="line">const string = <span class="string">&#x27;官网内容：澳门首家线上DC，性感荷官在线发牌，快来注册吧.&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo2.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo2.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"># 加到缓存区</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"># 存到git仓库,并打标签</span><br><span class="line">git commit -m &#x27;v1.<span class="number">2</span>&#x27;</span><br><span class="line"></span><br><span class="line"># 推送文件至仓库</span><br><span class="line">git push -u origin master</span><br><span class="line">git push --all</span><br></pre></td></tr></table></figure><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><div class="table-container"><table><thead><tr><th>主机名</th><th>外网</th><th>内网</th><th>角色</th><th>应用</th></tr></thead><tbody><tr><td>gitlab</td><td>10.0.0.91</td><td>172.16.1.91</td><td>代码仓库</td><td>gitlab</td></tr><tr><td>jenkins</td><td>10.0.0.92</td><td>172.16.1.92</td><td>代码发布</td><td>jdk jenkins</td></tr><tr><td>web01</td><td>10.0.0.7</td><td>172.16.1.7</td><td>官网</td><td>nginx</td></tr><tr><td>web02</td><td>10.0.0.8</td><td>172.16.1.8</td><td>官网</td><td>nginx</td></tr></tbody></table></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备两台机器安装nginx</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jenkins必须要免密连接web服务器</span></span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 172.16.1.8</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub 172.16.1.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入jenkins项目工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/jenkins/workspace/free</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉gitlab中的代码</span></span><br><span class="line">git <span class="built_in">clone</span> git@gitlab.xxx.com:root/xyz.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 做本地域名解析</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1 localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.0.0.91 gitlab.xxx.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># gitlab做密钥</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230518173604520.png" alt="image-20230518173604520"></p><h3 id="准备web"><a href="#准备web" class="headerlink" title="准备web"></a>准备web</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nginx</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写配置文件</span></span><br><span class="line">server&#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name _;</span><br><span class="line">root /code/xxx;</span><br><span class="line">index index.html；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="手动发布"><a href="#手动发布" class="headerlink" title="手动发布"></a>手动发布</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 手动发布</span></span><br><span class="line"><span class="comment"># 1.将代码打包</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/jenkins/workspace/free</span><br><span class="line">zip -r xyz_2023_05_18.zip ./*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.发送带web机器上(必须是其他用户有权限的目录)</span></span><br><span class="line">scp xyz_2023_05_18.zip 10.0.0.7:/opt/</span><br><span class="line">scp xyz_2023_05_18.zip 10.0.0.8:/opt/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压代码</span></span><br><span class="line">unzip xyz_2023_05_18.zip</span><br><span class="line">unzip xyz_2023_05_18.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 做软连接 部署代码</span></span><br><span class="line"><span class="built_in">ln</span> -s /opt/xyz /code/xxx</span><br><span class="line"><span class="built_in">ln</span> -s /opt/xyz /code/xxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网页验证</span></span><br><span class="line">10.0.0.7</span><br><span class="line">10.0.0.8</span><br></pre></td></tr></table></figure><h2 id="自动发布"><a href="#自动发布" class="headerlink" title="自动发布"></a>自动发布</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230518173944428.png" alt="image-20230518173944428"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建脚本存放目录路径</span></span><br><span class="line"><span class="built_in">mkdir</span> /var/lib/jenkins/scripts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line"><span class="built_in">chown</span> jenkins.jenkins /var/lib/jenkins/scripts -R</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写脚本</span></span><br><span class="line">vim /var/lib/jenkins/scripts/deploy_xyz.sh</span><br><span class="line"><span class="comment"># 1.定义变量</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%F)</span><br><span class="line">package_name=<span class="string">&quot;xyz_<span class="subst">$(DATE)</span>.zip&quot;</span></span><br><span class="line">code_dir=<span class="string">&quot;/code/hub&quot;</span></span><br><span class="line">soft_link=<span class="string">&quot;/code/xyz&quot;</span></span><br><span class="line">web_server=<span class="string">&quot;172.16.1.7 172.16.1.8&quot;</span></span><br><span class="line">dir_hub=<span class="string">&quot;/var/lib/jenkins/workspace/free&quot;</span></span><br><span class="line">dir_nginx_code=<span class="string">&quot;xyz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 将代码打包</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;dir_hub&#125;</span> &amp;&amp; \</span><br><span class="line">zip -r <span class="variable">$&#123;package_name&#125;</span> ./*</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.发送到web机器 &amp;&amp; 解压代码 删除软连接 部署代码（做软连接）</span></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$&#123;web_server&#125;</span>;<span class="keyword">do</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;rm -rf /code/hub&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;mkdir -p <span class="variable">$&#123;code_dir&#125;</span>&quot;</span></span><br><span class="line">        scp <span class="variable">$&#123;package_name&#125;</span> <span class="variable">$&#123;ip&#125;</span>:<span class="variable">$&#123;code_dir&#125;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;cd <span class="variable">$&#123;code_dir&#125;</span> &amp;&amp; unzip <span class="variable">$&#123;package_name&#125;</span>&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;rm -fr <span class="variable">$&#123;code_dir&#125;</span>/<span class="variable">$&#123;package_name&#125;</span>&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;rm -fr <span class="variable">$&#123;soft_link&#125;</span>&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;ln -s <span class="variable">$&#123;code_dir&#125;</span>/<span class="variable">$&#123;dir_nginx_code&#125;</span> <span class="variable">$&#123;soft_link&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;package_name&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x /var/lib/jenkins/scripts/deploy_xyz.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################### 完整呈现 ##############################</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%F)</span><br><span class="line">package_name=<span class="string">&quot;xyz_<span class="subst">$(DATE)</span>.zip&quot;</span></span><br><span class="line">code_dir=<span class="string">&quot;/code/hub&quot;</span></span><br><span class="line">soft_link=<span class="string">&quot;/code/xyz&quot;</span></span><br><span class="line">web_server=<span class="string">&quot;172.16.1.7 172.16.1.8&quot;</span></span><br><span class="line">dir_hub=<span class="string">&quot;/var/lib/jenkins/workspace/free&quot;</span></span><br><span class="line">dir_nginx_code=<span class="string">&quot;xyz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;dir_hub&#125;</span> &amp;&amp; \</span><br><span class="line">zip -r <span class="variable">$&#123;package_name&#125;</span> ./*</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$&#123;web_server&#125;</span>;<span class="keyword">do</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;rm -rf /code/hub&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;mkdir -p <span class="variable">$&#123;code_dir&#125;</span>&quot;</span></span><br><span class="line">        scp <span class="variable">$&#123;package_name&#125;</span> <span class="variable">$&#123;ip&#125;</span>:<span class="variable">$&#123;code_dir&#125;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;cd <span class="variable">$&#123;code_dir&#125;</span> &amp;&amp; unzip <span class="variable">$&#123;package_name&#125;</span>&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;rm -fr <span class="variable">$&#123;code_dir&#125;</span>/<span class="variable">$&#123;package_name&#125;</span>&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;rm -fr <span class="variable">$&#123;soft_link&#125;</span>&quot;</span></span><br><span class="line">        ssh <span class="variable">$&#123;ip&#125;</span> <span class="string">&quot;ln -s <span class="variable">$&#123;code_dir&#125;</span>/<span class="variable">$&#123;dir_nginx_code&#125;</span> <span class="variable">$&#123;soft_link&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;package_name&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230518174233891.png" alt="image-20230518174233891"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230518174254481.png" alt="image-20230518174254481"></p>]]></content>
      
      
      <categories>
          
          <category> devops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>jenkins介绍与部署</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/DevOps-4-devops-jenkins%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/DevOps-4-devops-jenkins%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="Jenkins介绍"><a href="#Jenkins介绍" class="headerlink" title="Jenkins介绍"></a>Jenkins介绍</h2><p>Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具</p><p>Jenkins应用广泛，大多数互联网公司都采用Jenkins配合GitLab、Docker、K8s作为实现<a href="">DevOps</a>的核心工具。</p><p>Jenkins最强大的就在于插件，Jenkins官方提供了大量的插件库，来自动化CI/CD过程中的各种琐碎功能。</p><div class="table-container"><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"></th></tr></thead><tbody><tr><td style="text-align:center"><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20211125141950900.png" alt="image-20211125141950900"></td><td style="text-align:center"><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20211125141701495.png" alt="image-20211125141701495"></td></tr></tbody></table></div><p>Jenkins最主要的工作就是将GitLab上可以构建的工程代码拉取并且进行构建，再根据流程可以选择发布到测试环境或是生产环境。</p><p>一般是GitLab上的代码经过大量的测试后，确定发行版本，再发布到生产环境。</p><p>CI/CD可以理解为：</p><ul><li>CI过程即是通过Jenkins将代码拉取、构建、制作镜像交给测试人员测试。<ul><li>持续集成：让软件代码可以持续的集成到主干上，并自动构建和测试。</li></ul></li><li>CD过程即是通过Jenkins将打好标签的发行版本代码拉取、构建、制作镜像交给运维人员部署。<ul><li>持续交付：让经过持续集成的代码可以进行手动部署。</li><li>持续部署：让可以持续交付的代码随时随地的自动化部署。</li></ul></li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">CI、CD</th></tr></thead><tbody><tr><td style="text-align:center"><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20211125154112097.png" alt="image-20211125154112097"></td></tr></tbody></table></div><h2 id="部署Jenkins"><a href="#部署Jenkins" class="headerlink" title="部署Jenkins"></a>部署Jenkins</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装jdk</span></span><br><span class="line">yum install -y java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载jenkins</span></span><br><span class="line">官网</span><br><span class="line">清华源</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装jenkins</span></span><br><span class="line">yum localinstall -y jenkins-2.303.2-1.1.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">vim /etc/sysconfig/jenkins</span><br><span class="line">JENKINS_USER=<span class="string">&quot;jenkins&quot;</span> ---&gt; JENKINS_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动jenkins</span></span><br><span class="line">systemctl start jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查进程</span></span><br><span class="line">ps -ef | grep jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口</span></span><br><span class="line">netstat -lntup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问</span></span><br><span class="line">10.0.0.92:8080</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153334273.png" alt="image-20230517153334273"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153358338.png" alt="image-20230517153358338"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/lib/jenkins/secrets/initialAdminPassword</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网页里面输入密码</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153508399.png" alt="image-20230517153508399"></p><h2 id="修改admin密码"><a href="#修改admin密码" class="headerlink" title="修改admin密码"></a>修改admin密码</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153601046.png" alt="image-20230517153601046"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153632090.png" alt="image-20230517153632090"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153644754.png" alt="image-20230517153644754"></p><h2 id="汉化"><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h2><h3 id="jenkins网页上安装"><a href="#jenkins网页上安装" class="headerlink" title="jenkins网页上安装"></a>jenkins网页上安装</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153727050.png" alt="image-20230517153727050"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153739454.png" alt="image-20230517153739454"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153752187.png" alt="image-20230517153752187"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins安装插件目录</span></span><br><span class="line">ll /var/lib/jenkins/plugins/</span><br></pre></td></tr></table></figure><h3 id="清华源安装中文插件"><a href="#清华源安装中文插件" class="headerlink" title="清华源安装中文插件"></a>清华源安装中文插件</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153833076.png" alt="image-20230517153833076"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153854692.png" alt="image-20230517153854692"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153905944.png" alt="image-20230517153905944"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153912702.png" alt="image-20230517153912702"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517153924031.png" alt="image-20230517153924031"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入jenkin插件目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/jenkins/plugins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载jenkins汉化包</span></span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/jenkins/plugins/localization-zh-cn/1.0.9/localization-zh-cn.hpi --no-check-certificate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启jenkins</span></span><br><span class="line">systemctl restart jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment">#手动解压</span></span><br><span class="line">unzip localization-zh-cn.hpi -d localization-zh-cn</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154005014.png" alt="image-20230517154005014"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154012883.png" alt="image-20230517154012883"></p><h2 id="jenkins创建自由风格构建"><a href="#jenkins创建自由风格构建" class="headerlink" title="jenkins创建自由风格构建"></a>jenkins创建自由风格构建</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154212834.png" alt="image-20230517154212834"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154243438.png" alt="image-20230517154243438"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154317904.png" alt="image-20230517154317904"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154446268.png" alt="image-20230517154446268"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154459743.png" alt="image-20230517154459743"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.丢弃旧的构建</span></span><br><span class="line">- 保留构建天数 7天</span><br><span class="line">- 每天保留最大的构建 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.构建</span></span><br><span class="line">- 执行shell</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;xxx&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154616648.png" alt="image-20230517154616648"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154702856.png" alt="image-20230517154702856"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517154717211.png" alt="image-20230517154717211"></p>]]></content>
      
      
      <categories>
          
          <category> devops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>gitlab部署</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/DevOps-3-devops-gitlab%E9%83%A8%E7%BD%B2/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/DevOps-3-devops-gitlab%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><ul><li>私有代码仓库 ，除了gitlab以外 还有gogs </li><li>精细化的权限配置 </li><li>控制用户/用户组权限，避免任何用户都可以将代码提交到 master</li></ul><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517151637431.png" alt="image-20230517151637431"></p><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载gitlab</span></span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装gitlab</span></span><br><span class="line">yum localinstall -y gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">## 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> /etc/gitlab/gitlab.rb&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置你文件 添加域名</span></span><br><span class="line">vim /etc/gitlab/gitlab.rb</span><br><span class="line">13 external_url <span class="string">&#x27;http://gitlab.xxx.com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置邮箱</span></span><br><span class="line">用户激活，用户注册，找回密码</span><br><span class="line">合并通知，领导审批，邮件告警</span><br><span class="line">52 gitlab_rails[<span class="string">&#x27;gitlab_email_enabled&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">53 gitlab_rails[<span class="string">&#x27;gitlab_email_from&#x27;</span>] = <span class="string">&#x27;2412628480@qq.com&#x27;</span></span><br><span class="line">54 gitlab_rails[<span class="string">&#x27;gitlab_email_display_name&#x27;</span>] = <span class="string">&#x27;xxx gitlab notice&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 邮件发送配置(类似于mail.rc中的配置)</span></span><br><span class="line">559 gitlab_rails[<span class="string">&#x27;smtp_enable&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">560 gitlab_rails[<span class="string">&#x27;smtp_address&#x27;</span>] = <span class="string">&quot;smtp.qq.com&quot;</span></span><br><span class="line">561 gitlab_rails[<span class="string">&#x27;smtp_port&#x27;</span>] = 465</span><br><span class="line">562 gitlab_rails[<span class="string">&#x27;smtp_user_name&#x27;</span>] = <span class="string">&quot;QQ号码&quot;</span></span><br><span class="line">563 gitlab_rails[<span class="string">&#x27;smtp_password&#x27;</span>] = <span class="string">&quot;自己的授权码&quot;</span></span><br><span class="line">564 gitlab_rails[<span class="string">&#x27;smtp_domain&#x27;</span>] = <span class="string">&quot;qq.com&quot;</span></span><br><span class="line">565 gitlab_rails[<span class="string">&#x27;smtp_authentication&#x27;</span>] = <span class="string">&quot;login&quot;</span></span><br><span class="line">566 gitlab_rails[<span class="string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">567 gitlab_rails[<span class="string">&#x27;smtp_tls&#x27;</span>] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.优化</span></span><br><span class="line"><span class="comment">## 关闭普罗米修斯</span></span><br><span class="line">1460 prometheus[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">1461 prometheus[<span class="string">&#x27;monitor_kubernetes&#x27;</span>] = <span class="literal">false</span></span><br><span class="line">1631 prometheus_monitoring[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 告警关闭</span></span><br><span class="line">1529 alertmanager[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 关闭前端node功能</span></span><br><span class="line">1551 node_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 关闭redis功能</span></span><br><span class="line">1570 redis_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 关闭postgre功能</span></span><br><span class="line">1588 postgres_exporter[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 内部监控</span></span><br><span class="line">1589 gitlab_monitor[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 图形展示</span></span><br><span class="line">1638 grafana[<span class="string">&#x27;enable&#x27;</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置文件 初始化</span></span><br><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517151903125.png" alt="image-20230517151903125"></p><h2 id="命令总结"><a href="#命令总结" class="headerlink" title="命令总结"></a>命令总结</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭所有服务</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启所有服务</span></span><br><span class="line">gitlab-ctl start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启所有服务</span></span><br><span class="line">gitlab-ctl restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">gitlab-ctl status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止单个服务</span></span><br><span class="line">gitlab-ctl stop nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启当个服务</span></span><br><span class="line">gitlab-ctl start nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有日志</span></span><br><span class="line">gitlab-ctl <span class="built_in">tail</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看单个服务日志</span></span><br><span class="line">gitlab-ctl <span class="built_in">tail</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入终端</span></span><br><span class="line">gitlab-rails console</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发邮件</span></span><br><span class="line">Notify.test_email(<span class="string">&#x27;133411023@qq.com&#x27;</span>,<span class="string">&#x27;gitlab test&#x27;</span>,<span class="string">&#x27;测试&#x27;</span>).deliver_now</span><br><span class="line"></span><br><span class="line"><span class="comment"># 忘记root密码</span></span><br><span class="line">gitlab-rails console</span><br><span class="line"></span><br><span class="line"><span class="comment">## 登录root</span></span><br><span class="line">user = User.<span class="built_in">where</span>(<span class="built_in">id</span>:1).first</span><br><span class="line">irb(main):007:0&gt; user.password=<span class="string">&#x27;12345678&#x27;</span></span><br><span class="line">=&gt; <span class="string">&quot;12345678&quot;</span></span><br><span class="line">irb(main):008:0&gt; user.password_confirmation=<span class="string">&#x27;12345678&#x27;</span></span><br><span class="line">=&gt; <span class="string">&quot;12345678&quot;</span></span><br><span class="line">irb(main):009:0&gt; user.save</span><br><span class="line">Enqueued ActionMailer::DeliveryJob (Job ID: b1415a9a-4365-4f2c-9460-cc278ed4ac0b)</span><br><span class="line">to Sidekiq(mailers) with arguments: <span class="string">&quot;DeviseMailer&quot;</span>, <span class="string">&quot;password_change&quot;</span>,</span><br><span class="line"><span class="string">&quot;deliver_now&quot;</span>, <span class="comment">#&lt;GlobalID:0x00007f4bbec6c3f0 @uri=#&lt;URI::GID</span></span><br><span class="line">gid://gitlab/User/1&gt;&gt;</span><br><span class="line">=&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="network报错"><a href="#network报错" class="headerlink" title="network报错"></a>network报错</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 做域名解析</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">IP 域名</span><br></pre></td></tr></table></figure><h2 id="汉化"><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载汉化包</span></span><br><span class="line">gitlab-v12.3.5-zh.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar xf gitlab-v12.3.5-zh.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line"><span class="built_in">cat</span> gitlab-v12.3.5-zh/VERSION</span><br><span class="line">12.3.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖</span></span><br><span class="line">\<span class="built_in">cp</span> -a /root/gitlab-v12.3.5-zh/* /opt/gitlab/embedded/service/gitlab-rails/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动所有的服务</span></span><br><span class="line">gitlab-ctl start</span><br></pre></td></tr></table></figure><h2 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152139759.png" alt="image-20230517152139759"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152159531.png" alt="image-20230517152159531"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152223476.png" alt="image-20230517152223476"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152256327.png" alt="image-20230517152256327"></p><h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152420050.png" alt="image-20230517152420050"></p><h2 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h2><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152507044.png" alt="image-20230517152507044"></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230517152516685.png" alt="image-20230517152516685"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@git.......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在本地克隆一个仓库</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> devops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>本地仓库</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/DevOps-2-devops-%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/DevOps-2-devops-%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="Git安装"><a href="#Git安装" class="headerlink" title="Git安装"></a>Git安装</h2><p><a href="https://git-scm.com/（傻瓜式安装）">https://git-scm.com/（傻瓜式安装）</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装git</span></span><br><span class="line">yum -y install git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">git --version</span><br></pre></td></tr></table></figure><p><strong>Git工作区域切换</strong></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515203126420.png" alt="image-20230515203126420"></p><p><strong>文件状态</strong></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515203153214.png" alt="image-20230515203153214"></p><h2 id="Web配置前提"><a href="#Web配置前提" class="headerlink" title="Web配置前提"></a>Web配置前提</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nginx</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">vim /etc/nginx/conf.d/www.conf</span><br><span class="line">server&#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name _;</span><br><span class="line">root /code/web;</span><br><span class="line">index index.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建站点目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /code/web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure><h2 id="思考：场景一（无git）"><a href="#思考：场景一（无git）" class="headerlink" title="思考：场景一（无git）"></a>思考：场景一（无git）</h2><p>老板：给我写一个官网 </p><p>程序猿：一天一夜，写出来了，请CEO过目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> index.html</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;src.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> src.js</span><br><span class="line"></span><br><span class="line">const string = <span class="string">&#x27;老板好，我是程序猿：zls，您让我写的官网页面，它会动&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515195625975.png" alt="image-20230515195625975"></p><p>老板：不够醒目，再改改 </p><p>程序猿：好嘞，花了一周时间，请CEO过目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> index.html</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="comment">#demo&#123;</span></span><br><span class="line">border: solid 1px red;</span><br><span class="line">width: 410px;</span><br><span class="line">height: 25px;</span><br><span class="line">background-color: lightpink;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿111&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;src.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> src.js</span><br><span class="line"></span><br><span class="line">const string = <span class="string">&#x27;老板好，我是程序猿：zls，您让我写的官网页面，它会动&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515195804564.png" alt="image-20230515195804564"></p><p>老板：还是之前的好看，改回去吧。 </p><p>程序猿：emmmmmm… 老子不干了。妈的，我该怎么撤回一周内容？</p><p><strong>该怎么撤回一周内容？</strong></p><h2 id="使用Git管理"><a href="#使用Git管理" class="headerlink" title="使用Git管理"></a>使用Git管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入目录</span></span><br><span class="line"><span class="built_in">cd</span> web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前的目录，初始化成git仓库</span></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看.git</span></span><br><span class="line">0 ✓ 14:47:15 root@gitlab.xxx.com,172.16.1.91:~/web <span class="comment"># ll -a</span></span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x 3 root root 18 May 11 14:47 .</span><br><span class="line">dr-xr-x---. 10 root root 4096 May 11 14:45 ..</span><br><span class="line">drwxr-xr-x 7 root root 119 May 11 14:47 .git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前git仓库的配置文件</span></span><br><span class="line">0 ✓ 14:47:39 root@gitlab.xxx.com,172.16.1.91:~/web <span class="comment"># cat .git/config</span></span><br><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = <span class="literal">true</span></span><br><span class="line">bare = <span class="literal">false</span></span><br><span class="line">logallrefupdates = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看隐藏文件目录结构</span></span><br><span class="line">0 ✓ 14:48:22 root@gitlab.xxx.com,172.16.1.91:~/web <span class="comment"># tree -a</span></span><br><span class="line">.</span><br><span class="line">└── .git</span><br><span class="line">├── branches</span><br><span class="line">├── config</span><br><span class="line">├── description</span><br><span class="line">├── HEAD</span><br><span class="line">├── hooks</span><br><span class="line">│ ├── applypatch-msg.sample</span><br><span class="line">│ ├── commit-msg.sample</span><br><span class="line">│ ├── post-update.sample</span><br><span class="line">│ ├── pre-applypatch.sample</span><br><span class="line">│ ├── pre-commit.sample</span><br><span class="line">│ ├── prepare-commit-msg.sample</span><br><span class="line">│ ├── pre-push.sample</span><br><span class="line">│ ├── pre-rebase.sample</span><br><span class="line">│ └── update.sample</span><br><span class="line">├── info</span><br><span class="line">│ └── exclude</span><br><span class="line">├── objects</span><br><span class="line">│ ├── info</span><br><span class="line">│ └── pack</span><br><span class="line">└── refs</span><br><span class="line">├── heads</span><br><span class="line">└── tags</span><br></pre></td></tr></table></figure><h3 id="实现需求"><a href="#实现需求" class="headerlink" title="实现需求"></a>实现需求</h3><p>老板：给我写一个官网<br>程序猿：一天一夜，写出来了，请CEO过目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在仓库中写代码</span></span><br><span class="line"><span class="built_in">cat</span> index.html</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;src.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> src.js</span><br><span class="line"></span><br><span class="line">const string = <span class="string">&#x27;老板好，我是程序猿：zls，您让我写的官网页面，它会动&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">### 查看git仓库状态</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">14</span>:<span class="number">51</span>:<span class="number">55</span> root@gitlab.xxx.com,<span class="number">172.16</span>.<span class="number">1.91</span>:~/web # git status</span><br><span class="line"></span><br><span class="line"># On branch master</span><br><span class="line">#</span><br><span class="line"># Initial commit</span><br><span class="line">#</span><br><span class="line"># Untracked files: 这两个文件还没有被添加进去</span><br><span class="line"># (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</span><br><span class="line">#</span><br><span class="line"># index.html</span><br><span class="line"># src.js 可以用git add去添加</span><br><span class="line">nothing added to commit but untracked files present (use &quot;git add&quot; to track)</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">### 添加到git仓库</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">14</span>:<span class="number">51</span>:<span class="number">55</span> root@gitlab.xxx.com,<span class="number">172.16</span>.<span class="number">1.91</span>:~/web # git add .</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">14</span>:<span class="number">53</span>:<span class="number">28</span> root@gitlab.xxx.com,<span class="number">172.16</span>.<span class="number">1.91</span>:~/web # git status</span><br><span class="line"></span><br><span class="line"># On branch master</span><br><span class="line">#</span><br><span class="line"># Initial commit</span><br><span class="line">#</span><br><span class="line"># Changes to be committed:</span><br><span class="line"># (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</span><br><span class="line">#</span><br><span class="line"># new file: index.html</span><br><span class="line"># new file: src.js</span><br><span class="line">#</span><br></pre></td></tr></table></figure><h3 id="提交代码到git仓库报错"><a href="#提交代码到git仓库报错" class="headerlink" title="提交代码到git仓库报错"></a>提交代码到git仓库报错<img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515200529949.png" alt="image-20230515200529949"></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加git用户设置</span></span><br><span class="line">git config --global user.email <span class="string">&quot;123456@qq.com&quot;</span></span><br><span class="line">git config --global user.name <span class="string">&quot;xxx&quot;</span></span><br><span class="line">git config --global color.ui auto    <span class="comment"># 添加颜色</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交代码到git仓库</span></span><br><span class="line">0 ✓ 14:53:31 root@gitlab:~/web <span class="comment"># git commit -m &#x27;源代码v1.0&#x27;</span></span><br><span class="line">[master (root-commit) 71ba271] 源代码v1.0</span><br><span class="line">2 files changed, 19 insertions(+)</span><br><span class="line">create mode 100644 index.html</span><br><span class="line">create mode 100644 src.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看提交信息</span></span><br><span class="line">0 ✓ 15:00:01 root@gitlab:~/web = <span class="comment"># git log</span></span><br><span class="line">commit 71ba27192e888af354cc2ca33ddd3fb340364b00</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date: Thu May 11 14:55:22 2023 +0800</span><br><span class="line"></span><br><span class="line">源代码v1.0</span><br></pre></td></tr></table></figure><h3 id="修改需求"><a href="#修改需求" class="headerlink" title="修改需求"></a>修改需求</h3><p>老板：不够醒目，再改改<br>程序猿：好嘞，花了一周时间，请CEO过目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置 修改代码</span></span><br><span class="line">vim index.html</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="comment">#demo&#123;</span></span><br><span class="line">border: solid 1px red;</span><br><span class="line">width: 410px;</span><br><span class="line">height: 25px;</span><br><span class="line">background-color: lightpink;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿111&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;src.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim src.js</span><br><span class="line"></span><br><span class="line">const string = <span class="string">&#x27;老板好，我是程序猿：zls，您让我写的官网页面，它会动&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">### 查看git状态</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">15</span>:<span class="number">03</span>:<span class="number">40</span> root@gitlab:~/web * # git status</span><br><span class="line"># On branch master</span><br><span class="line"># Changes not staged for commit:</span><br><span class="line"># (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class="line"># (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class="line">#</span><br><span class="line"># modified: index.html</span><br><span class="line">#</span><br><span class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</span><br><span class="line"></span><br><span class="line">### 将修改的文件重新添加提交到git之中</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">15</span>:<span class="number">03</span>:<span class="number">52</span> root@gitlab1:~/web * # git add index.html</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">15</span>:<span class="number">05</span>:<span class="number">01</span> root@gitlab:~/web * # git commit -m &#x27;源代码v1.<span class="number">1</span>(醒目)&#x27;</span><br><span class="line">[master b892777] 源代码v1.<span class="number">1</span>(醒目)</span><br><span class="line"><span class="number">1</span> file changed, <span class="number">10</span> insertions(+), <span class="number">2</span> deletions(-)</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line"><span class="number">0</span> ✓ <span class="number">15</span>:<span class="number">05</span>:<span class="number">57</span> root@gitlab:~/web = # git log</span><br><span class="line">commit b892777227242a583ff03a09ab09308777b23588</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date: Thu May <span class="number">11</span> <span class="number">15</span>:<span class="number">05</span>:<span class="number">57</span> <span class="number">2023</span> +<span class="number">0800</span></span><br><span class="line">源代码v1.<span class="number">1</span>(醒目)</span><br><span class="line">commit <span class="number">71</span>ba27192e888af354cc2ca33ddd3fb340364b00</span><br><span class="line">Author: Administrator &lt;admin@example.com&gt;</span><br><span class="line">Date: Thu May <span class="number">11</span> <span class="number">14</span>:<span class="number">55</span>:<span class="number">22</span> <span class="number">2023</span> +<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">#代码上线</span><br><span class="line">scp ./* <span class="number">10.0</span>.<span class="number">0.7</span>:/code/web</span><br><span class="line"></span><br><span class="line"># 查看浏览器</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.7</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515201308487.png" alt="image-20230515201308487"></p><h3 id="再修改需求-代码回滚"><a href="#再修改需求-代码回滚" class="headerlink" title="再修改需求(代码回滚)"></a>再修改需求(代码回滚)</h3><p>老板：还是之前的好看，改回去吧。<br>程序猿：emmmmmm… 老子不干了。妈的，我该怎么撤回一周内容？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看标签</span></span><br><span class="line">0 ✓ :07:36 root@gitlab:~/web = <span class="comment"># git log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有标签</span></span><br><span class="line">0 ✓ 15:07:36 root@gitlab:~/web = <span class="comment"># git reflog  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚标签</span></span><br><span class="line">0 ✓ 15:08:44 root@gitlab:~/web = <span class="comment"># git reset --hard 71ba</span></span><br><span class="line">HEAD is now at 71ba271 源代码v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码上线</span></span><br><span class="line">scp ./* 10.0.0.7:/code/web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启nginx访问</span></span><br><span class="line">10.0.0.7</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515201828300.png" alt="image-20230515201828300"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Untracked：  <span class="comment"># 没有被管理</span></span><br><span class="line">Staged：     <span class="comment"># 通过git add放入暂存区</span></span><br><span class="line">Unmodified： <span class="comment"># 没有被修改的状态</span></span><br><span class="line">Modified：   <span class="comment"># 文件被修改了</span></span><br></pre></td></tr></table></figure><h2 id="Git管理新需求"><a href="#Git管理新需求" class="headerlink" title="Git管理新需求"></a>Git管理新需求</h2><p>老板：给我写一个官网 </p><p>程序猿：花了一天一夜，做出来了，请老板过目</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># html文件</span></span><br><span class="line">vim index.html</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿&lt;/title&gt;</span><br><span class="line">&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;style.css&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;澳门皇家DC&lt;/div&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo2&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;main.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># css代码</span></span><br><span class="line">vim style.css</span><br><span class="line"></span><br><span class="line"><span class="comment">#demo2&#123;</span></span><br><span class="line">margin-top: 50px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># js代码</span></span><br><span class="line">vim main.js</span><br><span class="line"></span><br><span class="line">const string = <span class="string">&#x27;官网内容：澳门首家线上DC，性感荷官在线发牌，快来注册吧.&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo2.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo2.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br></pre></td></tr></table></figure><h3 id="Git操作"><a href="#Git操作" class="headerlink" title="Git操作"></a>Git操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加到暂存区</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放入版本库</span></span><br><span class="line">git commit -m <span class="string">&#x27;新官网v1.1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码上线</span></span><br><span class="line">scp ./* 10.0.0.7:/code/web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问</span></span><br><span class="line">10.0.0.7</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515203906087.png" alt="image-20230515203906087"></p><p>老板：有点丑，我希望背景颜色是yellow，醒目一些。 </p><p>老板秘书：我觉得不错，要是字体能做彩色的就好了。 </p><p>程序猿：MMP，你们的意见就不能统一一下么？</p><p><strong>现在需求是两个，，一个是背景黄色，还有字体是彩色</strong></p><h2 id="Git分支功能"><a href="#Git分支功能" class="headerlink" title="Git分支功能"></a>Git分支功能</h2><h3 id="老板需求"><a href="#老板需求" class="headerlink" title="老板需求"></a>老板需求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用git 分支功能</span></span><br><span class="line"><span class="comment">## 老板的需求 黄色背景</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建分支</span></span><br><span class="line">git branch ceo_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支 星星在哪里就是代表你在哪里</span></span><br><span class="line">git branch</span><br><span class="line">ceo_branch</span><br><span class="line">* master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到ceo分支</span></span><br><span class="line">git checkout ceo_branch</span><br><span class="line">git branch</span><br><span class="line">* ceo_branch</span><br><span class="line">master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改代码</span></span><br><span class="line"><span class="comment"># index.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;代码迭代过程-曾老湿&lt;/title&gt;</span><br><span class="line">&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;style.css&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo&quot;</span>&gt;澳门皇家DC&lt;/div&gt;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;demo2&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;main.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># js</span></span><br><span class="line">body&#123;</span><br><span class="line">background-color: yellow;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#demo2&#123;</span></span><br><span class="line">margin-top: 50px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># css</span></span><br><span class="line">const string = <span class="string">&#x27;官网内容：澳门首家线上DC，性感荷官在线发牌，快来注册吧.&#x27;</span></span><br><span class="line"><span class="built_in">let</span> n = 1</span><br><span class="line">demo2.innerHTML = string.substring(0,n)</span><br><span class="line">setInterval(()=&gt;&#123;</span><br><span class="line">n+=<span class="number">1</span></span><br><span class="line">demo2.innerHTML = string.substring(<span class="number">0</span>,n)</span><br><span class="line">&#125;,<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"># 添加暂存区</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"># 添加到版本库</span><br><span class="line">git commit -m &#x27;新官网v1.<span class="number">2</span>(背景为黄色)&#x27;</span><br><span class="line"></span><br><span class="line"># 代码上线</span><br><span class="line">scp ./* <span class="number">10.0</span>.<span class="number">0.7</span>:/code/web</span><br><span class="line"></span><br><span class="line"># 浏览器访问</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.7</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515204224314.png" alt="image-20230515204224314"></p><h3 id="秘书需求"><a href="#秘书需求" class="headerlink" title="秘书需求"></a>秘书需求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建秘书分支</span></span><br><span class="line">git branch ms_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支</span></span><br><span class="line">git branch</span><br><span class="line">ceo_branch</span><br><span class="line">* master</span><br><span class="line">ms_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到秘书分支</span></span><br><span class="line">git checkout ms_branch</span><br><span class="line">git branch</span><br><span class="line">ceo_branch</span><br><span class="line">master</span><br><span class="line">* ms_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改代码</span></span><br><span class="line">vim styles.css</span><br><span class="line"><span class="comment">#demo2&#123;</span></span><br><span class="line">margin-top: 50px;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#demo2&#123;</span></span><br><span class="line">margin-top: 50px;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#demo,#demo2 &#123;</span></span><br><span class="line">display: block;</span><br><span class="line">/*渐变背景*/</span><br><span class="line">background-image: -webkit-linear-gradient(left, <span class="comment">#3498db, #f47920 10%,#d71345 20%, #f7acbc 30%,#ffd400 40%, #3498db 50%, #f47920 60%, #d71345 70%, #f7acbc 80%, #ffd400 90%,#3498db);</span></span><br><span class="line">color: transparent; /*文字填充色为透明*/</span><br><span class="line">-webkit-text-fill-color: transparent;</span><br><span class="line">-webkit-background-clip: text; /*背景剪裁为文字，只将文字显示为背景*/</span><br><span class="line">background-size: 200% 100%; /*背景图片向水平方向扩大一倍，这样background-position才有移动与变化的空间*/</span><br><span class="line">/* 动画 */</span><br><span class="line">animation: masked-animation 4s infinite linear;</span><br><span class="line">&#125;</span><br><span class="line">@keyframes masked-animation &#123;</span><br><span class="line">0% &#123;</span><br><span class="line">background-position: 0 0; /*background-position 属性设置背景图像的起始位置。*/</span><br><span class="line">&#125;</span><br><span class="line">100% &#123;</span><br><span class="line">background-position: -100% 0;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加暂存区</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交代码</span></span><br><span class="line">git commit -m <span class="string">&quot;新官网v1.3（字体为彩色）&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515205027065.png" alt="image-20230515205027065"></p><h3 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 明确保留谁</span></span><br><span class="line">主分支</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前所在分支</span></span><br><span class="line">git branch</span><br><span class="line">ceo_branch</span><br><span class="line">master</span><br><span class="line">* ms_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到主分支</span></span><br><span class="line">git checkout master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分支</span></span><br><span class="line">git branch</span><br><span class="line">ceo_branch</span><br><span class="line">* master</span><br><span class="line">ms_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并老板分支，先进入master再把老板的分支合并到master</span></span><br><span class="line">git merge ceo_branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并秘书分支</span></span><br><span class="line">git merge ms_branch</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515205213754.png" alt="image-20230515205213754"></p><ul><li>:wq</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码上线</span></span><br><span class="line">scp ./* 10.0.0.7:/code/web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问页面</span></span><br><span class="line">10.0.0.7</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515205257645.png" alt="image-20230515205257645"></p><h2 id="Git打标签"><a href="#Git打标签" class="headerlink" title="Git打标签"></a>Git打标签</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打标签</span></span><br><span class="line">git tag -a <span class="string">&#x27;v1.3&#x27;</span> -m <span class="string">&#x27;新官网v1.3（字体为彩色）&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送标签</span></span><br><span class="line">git push origin master --tags</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> devops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>流程介绍</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/DevOps-1-devops-%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/DevOps-1-devops-%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<hr><h2 id="DevOps介绍"><a href="#DevOps介绍" class="headerlink" title="DevOps介绍"></a>DevOps介绍</h2><p><strong>软件开发最开始是由两个团队组成：</strong></p><ul><li>开发计划由<a href="">开发团队</a>从头开始设计和整体系统的构建。需要系统不停的迭代更新。</li><li><a href="">运维团队</a>将开发团队的Code进行测试后部署上线。希望系统稳定安全运行。</li></ul><p>这看似两个目标不同的团队需要协同完成一个软件的开发。</p><p>在开发团队指定好计划并完成coding后，需要提供到运维团队。</p><p>运维团队向开发团队反馈需要修复的BUG以及一些需要返工的任务。</p><p>这时开发团队需要经常等待运维团队的反馈。这无疑延长了事件并推迟了整个软件开发的周期。</p><p>会有一种方式，在开发团队等待的时候，让开发团队转移到下一个项目中。等待运维团队为之前的代码提供反馈。</p><p>可是这样就意味着一个完整的项目需要一个更长的周期才可以开发出最终代码。</p><hr><p>基于现在的互联网现状，更推崇敏捷式开发，这样就导致项目的迭代速度更快，但是由于开发团队与运维团队的沟通问题，会导致新版本上线的时间成本很高。这又违背的敏捷式开发的最初的目的。</p><p>那么如果让开发团队和运维团队整合到成一个团队，协同应对一套软件呢？这就被称为<a href="">DevOps</a>。</p><p><a href="">DevOps</a>，字面意思是Development &amp;Operations的缩写，也就是开发&amp;运维。</p><p>虽然字面意思只涉及到了开发团队和运维团队，其实QA测试团队也是参与其中的。</p><p>网上可以查看到<a href="">DevOps</a>的符号类似于一个无穷大的符号</p><div class="table-container"><table><thead><tr><th style="text-align:center"><a href="">DevOps</a></th></tr></thead><tbody><tr><td style="text-align:center"><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230515193552751.png" alt="image-20230515193552751"></td></tr></tbody></table></div><p>这表明<a href="">DevOps</a>是一个不断提高效率并且持续不断工作的过程</p><p><a href="">DevOps</a>的方式可以让公司能够更快地应对更新和市场发展变化，开发可以快速交付，部署也更加稳定。</p><p>核心就在于<a href="">简化Dev和Ops团队之间的流程，使整体软件开发过程更快速。</a></p><h2 id="DevOps流程"><a href="#DevOps流程" class="headerlink" title="DevOps流程"></a>DevOps流程</h2><p><strong>整体的软件开发流程包括：</strong></p><ul><li>PLAN：开发团队根据客户的目标制定开发计划</li><li>CODE：根据PLAN开始编码过程，需要将不同版本的代码存储在一个库中。</li><li>BUILD：编码完成后，需要将代码构建并且运行。</li><li>TEST：成功构建项目后，需要测试代码是否存在BUG或错误。</li><li>DEPLOY：代码经过手动测试和自动化测试后，认定代码已经准备好部署并且交给运维团队。</li><li>OPERATE：运维团队将代码部署到生产环境中。</li><li>MONITOR：项目部署上线后，需要持续的监控产品。</li><li>INTEGRATE：然后将监控阶段收到的反馈发送回PLAN阶段，整体反复的流程就是<a href="">DevOps</a>的核心，即持续集成、持续部署。</li></ul><p><strong>为了保证整体流程可以高效的完成，各个阶段都有比较常见的工具，如下图：</strong></p><div class="table-container"><table><thead><tr><th style="text-align:center">软件开发过程&amp;涉及工具</th></tr></thead><tbody><tr><td style="text-align:center"><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/2021-11-23_175935.png" alt="2021-11-23_175935"></td></tr></tbody></table></div><p>最终可以给<a href="">DevOps</a>下一个定义：<a href="">DevOps 强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件。</a></p><p>自动化的工具协作和沟通来完成软件的生命周期管理</p><h2 id="CI-CD理解"><a href="#CI-CD理解" class="headerlink" title="CI/CD理解"></a>CI/CD理解</h2><p><strong>CI/CD可以理解为：</strong></p><ul><li>CI过程即是通过Jenkins将代码拉取、构建、制作镜像交给测试人员测试。<ul><li>持续集成：让软件代码可以持续的集成到主干上，并自动构建和测试。</li></ul></li><li>CD过程即是通过Jenkins将打好标签的发行版本代码拉取、构建、制作镜像交给运维人员部署。<ul><li>持续交付：让经过持续集成的代码可以进行手动部署。</li><li>持续部署：让可以持续交付的代码随时随地的自动化部署。</li></ul></li></ul><div class="table-container"><table><thead><tr><th style="text-align:center">CI、CD</th></tr></thead><tbody><tr><td style="text-align:center"><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20211125154112097.png" alt="image-20211125154112097"></td></tr></tbody></table></div>]]></content>
      
      
      <categories>
          
          <category> devops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/linux%E5%9F%BA%E7%A1%80-Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/linux%E5%9F%BA%E7%A1%80-Linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<p>[toc]</p><hr><h2 id="文件管理命令"><a href="#文件管理命令" class="headerlink" title="文件管理命令"></a>文件管理命令</h2><h3 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h3><p>.           表示用户所处的当前目录</p><p>..          表示上级目录;</p><p>~          表示当前用户自己的家目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> -    <span class="comment">#切换上次所在目录</span></span><br><span class="line"><span class="built_in">cd</span> ~    <span class="comment">#切换至当前用户家目录</span></span><br><span class="line"><span class="built_in">cd</span>      <span class="comment">#切换至当前用户家目录</span></span><br><span class="line"><span class="built_in">cd</span> .    <span class="comment">#.代表当前目录,一般在拷贝、移动等情况下使用</span></span><br><span class="line"><span class="built_in">cd</span> ..   <span class="comment">#切换至当前目录的上级目录</span></span><br></pre></td></tr></table></figure><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><p>-p         递归</p><p>-v         显示过程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">=====&gt;&gt;<span class="comment">######创建文件夹#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#递归创建目录&amp;显示过程</span></span><br><span class="line"><span class="built_in">mkdir</span> -pv dir4/dir5/dir6</span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;dir4&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;dir4/dir5&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;dir4/dir5/dir6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建多目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /home/&#123;zls/&#123;1,2&#125;,oldboyedu&#125;    <span class="comment">#最终精简</span></span><br></pre></td></tr></table></figure><h3 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">=====&gt;&gt;<span class="comment">#####创建文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">touch</span> + 选项 （要创建的文件名）</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写法</span></span><br><span class="line"><span class="built_in">touch</span> /home/zls/file3 file4</span><br><span class="line"><span class="built_in">touch</span> file&#123;5,6,7&#125;</span><br><span class="line"><span class="built_in">touch</span> file&#123;10..100&#125;</span><br></pre></td></tr></table></figure><p><strong>注意</strong></p><ol><li><p>创建文件，必须要创建在一个存在的目录中</p></li><li><p>和创建目录不同的是，创建相同的文件不会报错</p></li><li><p>创建相同的文件，源文件内容不会被覆盖</p></li><li><p>在Linux当中一切皆文件</p></li></ol><h3 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h3><p>-L 数字           #查看指定目录层级</p><p>-d                   #只查看目录，不查看文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y tree   <span class="comment">#安装此功能</span></span><br><span class="line"></span><br><span class="line">tree /root/</span><br></pre></td></tr></table></figure><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>火影忍者</title>
      <link href="//%5Bobject%20Object%5D/2023/06/16/%E7%81%AB%E5%BD%B1-%E7%81%AB%E5%BD%B1%E8%B4%BA%E7%8C%9B/"/>
      <url>//%5Bobject%20Object%5D/2023/06/16/%E7%81%AB%E5%BD%B1-%E7%81%AB%E5%BD%B1%E8%B4%BA%E7%8C%9B/</url>
      
        <content type="html"><![CDATA[<h1 id="火影忍者"><a href="#火影忍者" class="headerlink" title="火影忍者"></a>火影忍者</h1><p>1999年日本漫画家岸本齐史创作的少年漫画                           </p><hr><p>​    《火影忍者》是<a href="https://baike.baidu.com/item/日本/111617?fromModule=lemma_inlink">日本</a>漫画家<a href="https://baike.baidu.com/item/岸本齐史/805104?fromModule=lemma_inlink">岸本齐史</a>的代表作，作品于1999年开始在《周刊少年JUMP》上连载，于2014年11月10日发售的JUMP第50号完结；后日谈性质的外传漫画《火影忍者外传：第七代火影与绯色花月》则于同杂志2015年第22、23合并号开始短期连载，至同年第32号完结。</p><p>​    故事成功地将原本隐藏在黑暗中，用世界上最强大的毅力和最艰辛的努力去做最密不可宣和隐讳残酷的事情的<a href="https://baike.baidu.com/item/忍者/370?fromModule=lemma_inlink">忍者</a>，描绘成了太阳下最值得骄傲最光明无限的职业。在岸本齐史笔下的忍者世界中，每一位年轻的忍者都在开拓着属于自己的忍道。</p><h2 id="百科星图"><a href="#百科星图" class="headerlink" title="百科星图"></a>百科星图</h2><p> <img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20221025104959420.png" alt="image-20221025104959420"></p><div class="table-container"><table><thead><tr><th><strong>中文名</strong></th><th>火影忍者</th><th>出版期间</th><th>2000年3月3日—2015年2月4日</th></tr></thead><tbody><tr><td><strong>原版名称</strong></td><td>NARUTO -ナルト-</td><td><strong>单行本册数</strong></td><td>73 卷(全72卷+外传1卷)</td></tr><tr><td><strong>别  名</strong></td><td>狐忍</td><td><strong>出版社</strong></td><td>集英社</td></tr><tr><td><strong>作  者</strong></td><td><a href="https://baike.baidu.com/item/%E5%B2%B8%E6%9C%AC%E9%BD%90%E5%8F%B2/805104?fromModule=lemma_inlink">岸本齐史</a></td><td><strong>定  价</strong></td><td>9.8 元(每册；第65卷起每册12元)</td></tr><tr><td><strong>类  型</strong></td><td>少年漫画</td><td><strong>开  本</strong></td><td>32 开</td></tr><tr><td><strong>地  区</strong></td><td>日本</td><td><strong>装  帧</strong></td><td>精装</td></tr><tr><td><strong>连载杂志</strong></td><td>周刊少年JUMP</td><td><strong>其他出版社</strong></td><td>东立出版社（中国台湾）</td></tr><tr><td><strong>揭载号</strong></td><td>1999年43号</td><td></td><td><a href="https://baike.baidu.com/item/北京中少动漫图书有限公司/1751585?fromModule=lemma_inlink">北京中少动漫图书有限公司</a>（发行）</td></tr><tr><td><strong>连载期间</strong></td><td>1999年43号—2014年11月10日（全700话）</td><td></td><td>连环画出版社（出版）（中国大陆）</td></tr><tr><td><strong>丛书系列</strong></td><td>JUMP COMICS</td><td><strong>网络连载平台</strong></td><td><a href="https://baike.baidu.com/item/%E8%85%BE%E8%AE%AF%E5%8A%A8%E6%BC%AB/363238?fromModule=lemma_inlink">腾讯动漫</a> ,<a href="https://baike.baidu.com/item/漫番漫画/23502599?fromModule=lemma_inlink">漫番漫画</a> ,<a href="https://baike.baidu.com/item/哔哩哔哩漫画/23525597?fromModule=lemma_inlink">哔哩哔哩漫画</a></td></tr></tbody></table></div><hr><h2 id="登场角色"><a href="#登场角色" class="headerlink" title="登场角色"></a>登场角色</h2><p><strong>角色</strong>                  <strong>配音</strong>                               <strong>简介</strong></p><p><a href="https://baike.baidu.com/item/漩涡鸣人/322717?fromModule=lemma_inlink">漩涡鸣人</a>         <a href="https://baike.baidu.com/item/竹内顺子/1414420?fromModule=lemma_inlink">竹内顺子</a>                     本作的主角，一心想要成为火影的热血少年。</p><p><a href="https://baike.baidu.com/item/宇智波佐助/401898?fromModule=lemma_inlink">宇智波佐助</a>     <a href="https://baike.baidu.com/item/杉山纪彰/382006?fromModule=lemma_inlink">杉山纪彰</a>                     木叶名门宇智波一族末裔，为复兴宇智波一族而踏上复仇之路。 </p><p><a href="https://baike.baidu.com/item/春野樱/405919?fromModule=lemma_inlink">春野樱</a>             中村千绘                     本作的女主角，第七班的唯一的女性成员，喜欢佐助。</p><p><a href="https://baike.baidu.com/item/旗木卡卡西/405593?fromModule=lemma_inlink">旗木卡卡西</a>     井上和彦 田村睦心     第七班的指导上忍，有“写轮眼卡卡西”的绰号。  </p><p>奈良鹿丸         森久保祥太郎              擅长制订战略与计策，智商高达200。  </p><p>日向雏田         水树奈奈                     一直喜欢着鸣人的女孩子，害羞但也有坚强的一面，日向一族宗家之女。  </p><p>自来也             大冢芳忠                     第四代火影的恩师，自号“妙木山蛤蟆仙人”，曾指导鸣人的忍术修行。  </p><p>大蛇丸             松本和香子                 为追求“世间的真理”，而叛离木叶建立音忍者村。  </p><p>纲手                 胜生真沙子                 初代火影的孙女，后来回归木叶成为第五代火影。  </p><p>志村团藏         糸博                             暗部“根”的首领，后来成为代理第六代火影。  </p><p><a href="https://baike.baidu.com/item/我爱罗/237248?fromModule=lemma_inlink">我爱罗</a>             <a href="https://baike.baidu.com/item/石田彰/285319?fromModule=lemma_inlink">石田彰</a>                         砂之忍者，和鸣人有着很深的羁绊，后成为第五代风影。  </p><p><a href="https://baike.baidu.com/item/勘九郎/1207032?fromModule=lemma_inlink">勘九郎</a>             <a href="https://baike.baidu.com/item/加濑康之/9374327?fromModule=lemma_inlink">加濑康之</a>                     我爱罗的哥哥，擅长操控傀儡战斗。  </p><p><a href="https://baike.baidu.com/item/手鞠/19307?fromModule=lemma_inlink">手鞠</a>                 <a href="https://baike.baidu.com/item/朴璐美/876163?fromModule=lemma_inlink">朴璐美</a>                         勘九郎、我爱罗的姐姐，擅长风遁。  </p><p>君麻吕             森川智之                     辉夜一族后裔，原为“音忍五人众”之一，十分崇拜大蛇丸。  </p><p>药师兜             神奈延年                     大蛇丸的亲信，精于算计，行为神秘。  </p><p>佩恩                 堀内贤雄                    “晓”首领，拥有轮回眼的血继限界。  </p><p>“<a href="https://baike.baidu.com/item/面具男/14894203?fromModule=lemma_inlink">面具男</a>”          内田直哉 高木涉        “晓”神秘的最新成员。  </p><p>小南                 田中敦子                     佩恩的同伴和女队友。  </p><p>绝                    飞田展男                      样似植物的神秘人，本体分为黑绝、白绝两部分，另有<a href="https://baike.baidu.com/item/阿飞/3036871?fromModule=lemma_inlink">阿飞</a>等大量分身。  </p><p>宇智波鼬         石川英郎                     佐助的哥哥，宇智波一族的精英忍者。  </p><p>迪达拉             川本克彦                     崇尚爆炸的艺术的年轻忍者。  </p><p>干柿鬼鲛         檀臣幸                         原为“忍刀七人众”之一，鼬的队友。  </p><p>蝎                    樱井孝宏                      千代的孙子，傀儡师。迪达拉的队友。  </p><p>飞段                寺杣昌纪                    “邪神教”的信徒，拥有不死的能力。</p><hr><h2 id="用语解说"><a href="#用语解说" class="headerlink" title="用语解说"></a>用语解说</h2><h3 id="忍者等级及种类"><a href="#忍者等级及种类" class="headerlink" title="忍者等级及种类"></a>忍者等级及种类</h3><p><strong>等级/种类</strong>                <strong>说明</strong></p><p><strong>忍者等级</strong>    </p><p><strong><a href="https://baike.baidu.com/item/影/18025530?fromModule=lemma_inlink">影</a></strong>                            五大国所属忍者村的首领才拥有的称号，是“村子中最伟大的忍者”。五影分别是：<a href="https://baike.baidu.com/item/火影/6892?fromModule=lemma_inlink">火影</a>、<a href="https://baike.baidu.com/item/风影/4861748?fromModule=lemma_inlink">风影</a>、<a href="https://baike.baidu.com/item/水影/6244637?fromModule=lemma_inlink">水影</a>、土影、<a href="https://baike.baidu.com/item/雷影/10791449?fromModule=lemma_inlink">雷影</a>。  </p><p><strong><a href="https://baike.baidu.com/item/上忍/1052935?fromModule=lemma_inlink">上忍</a></strong>                        村子的精英人物，可以参与决定村子方针的上忍会议。通常在难度极高的A级任务出面，有时候还会参加S级的任务。</p><p><strong>特别上忍</strong>                他们是在某些方面具有独特才能及发展的忍者，实力居中忍与上忍之间。需具有特别技艺之忍者才能胜任。  </p><p><strong><a href="https://baike.baidu.com/item/中忍/7376?fromModule=lemma_inlink">中忍</a></strong>                        相当于小队队长的阶级。一般情况下，只被允许接受B级、C级任务。</p><p><strong><a href="https://baike.baidu.com/item/下忍/7377?fromModule=lemma_inlink">下忍</a></strong>                        可以算是<a href="https://baike.baidu.com/item/实习生/4523?fromModule=lemma_inlink">实习生</a>。做最简单的C、D级任务。从忍者学校毕业以后，就可以成为下忍 </p><p><strong>忍者种类</strong>    </p><p><strong>叛忍</strong>                       出于各种原因，叛逃出了自己的忍者村。他们会受到原忍村的通缉，度过逃亡生活。  </p><p><strong>医疗忍者</strong>               使用医疗忍术治疗同伴的忍者。</p><hr><h3 id="忍者组织"><a href="#忍者组织" class="headerlink" title="忍者组织"></a>忍者组织</h3><p><strong>组织名称</strong>                         <strong>说明</strong></p><p><strong><a href="https://baike.baidu.com/item/晓/2976952?fromModule=lemma_inlink">晓</a></strong>                                 他们大多是各国通缉的重犯，以捕获尾兽为目标。（零、白、朱、南、青、玉、玄、三、北、空）</p><p><strong><a href="https://baike.baidu.com/item/暗部/15450009?fromModule=lemma_inlink">暗部</a></strong>                             第二代火影·千手扉间建立的，部队由火影直接指挥。特务组织。</p><p><strong><a href="https://baike.baidu.com/item/木叶警务部队/18187583?fromModule=lemma_inlink">木叶警务部队</a></strong>             <a href="https://baike.baidu.com/item/第二代火影/3997295?fromModule=lemma_inlink">第二代火影</a>·<a href="https://baike.baidu.com/item/千手扉间/6378425?fromModule=lemma_inlink">千手扉间</a>建立的，该部队成员主要由<a href="https://baike.baidu.com/item/宇智波一族/7832724?fromModule=lemma_inlink">宇智波一族</a>的人担任，负责维护村子的治安。</p><p><strong><a href="https://baike.baidu.com/item/根组织/1098335?fromModule=lemma_inlink">根组织</a></strong>                         根组织是<a href="https://baike.baidu.com/item/志村团藏/8310031?fromModule=lemma_inlink">志村团藏</a>以暗部培训部的名义成立的隶属于自己的独立组织。</p><hr><h3 id="忍者教育"><a href="#忍者教育" class="headerlink" title="忍者教育"></a>忍者教育</h3><p><strong>名称</strong>                                <strong>说明</strong></p><p><strong><a href="https://baike.baidu.com/item/忍者学校/5755638?fromModule=lemma_inlink">忍者学校</a></strong>                      忍者学校是第二代火影·千手扉间建立的，目的是确保教育稳定性和人才培养效率。</p><hr><h3 id="任务等级"><a href="#任务等级" class="headerlink" title="任务等级"></a>任务等级</h3><p><strong>种类</strong>                                <strong>级别</strong></p><div class="table-container"><table><thead><tr><th>种类</th><th><strong>级别</strong></th></tr></thead><tbody><tr><td>上忍</td><td>S级 A级</td></tr><tr><td>中忍</td><td>B级 C级</td></tr><tr><td>下忍</td><td>C级 D级</td></tr></tbody></table></div><hr><h3 id="等级划分"><a href="#等级划分" class="headerlink" title="等级划分"></a>等级划分</h3><div class="table-container"><table><thead><tr><th>等级</th><th>难度</th></tr></thead><tbody><tr><td>超S级</td><td>关系跨国等级的特机密任务事项。因他国请求以及个人需求而加入。</td></tr><tr><td>S级</td><td>关系国家等级的机密事项。因他国请求而加入战争。百万两的奖赏以上的任务。暗杀重要人士、偷取机密文件等。</td></tr><tr><td>A级</td><td>关系国家或村里动向的任务。因他国请求而加入战争。十五万两至百万两之间的奖赏的任务。护卫重要人士、讨伐忍者部队等。</td></tr><tr><td>B级</td><td>关系个人的任务，因个人请求而加入。五万两至十五万两之间的奖赏的任务。护卫人士，其中有敌对忍者（中忍以下）。</td></tr><tr><td>C级</td><td>关系个人的任务，因个人请求而加入。一万两至五万两之间的奖赏的任务。护卫人士（无战斗情况），送机密文件等等。</td></tr><tr><td>D级</td><td>非常琐碎的任务，因个人请求而加入。五百两至一万两之间的奖赏的任务。从找宠物到捡垃圾等等。</td></tr></tbody></table></div><h3 id="五大国与忍者村"><a href="#五大国与忍者村" class="headerlink" title="五大国与忍者村"></a>五大国与忍者村</h3><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/4ec2d5628535e5dd3a003bd176c6a7efce1b6294.jpg" alt="4ec2d5628535e5dd3a003bd176c6a7efce1b6294">                 <strong>火影忍者地理</strong></p><h3 id="尾兽"><a href="#尾兽" class="headerlink" title="尾兽"></a>尾兽</h3><p>​        尾兽是拥有尾巴的魔兽，拥有极为庞大的查克拉量。根据尾巴的数量分为一尾到九尾。人柱力则是体内封印着尾兽力量的人。详见词条：尾兽、人柱力</p><h3 id="忍者能力"><a href="#忍者能力" class="headerlink" title="忍者能力"></a>忍者能力</h3><p>​        <strong><a href="https://baike.baidu.com/item/查克拉/3424179?fromModule=lemma_inlink">查克拉</a>**</strong>：**精神能量和身体能量完美融合所产生的一种能量，一般是用来施展忍术，也可以制成线状捆绑对手或切断同为查克拉所构成的物质。简单来说，就是使用忍术时必须的能量。详见词条“<a href="https://baike.baidu.com/item/查克拉/3424179?fromModule=lemma_inlink">查克拉</a>”。</p><p>​        <strong>术：</strong>忍者所使用的忍术、体术、幻术等的总称。根据其习得的难易度，分为S（奥义、极意）、A（禁术、超高等忍术）、B（上忍等级）、C（中忍等级）、D（下忍等级）、E（忍者学校等级）这六个等级。</p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/a044ad345982b2b7a3b4faaa37adcbef76099bb1.jpg" alt="a044ad345982b2b7a3b4faaa37adcbef76099bb1"></p><p>查克拉共有七种性质，分别为火、水、风、雷、土、阴、阳。其中火、水、风、雷、土为五大性质。</p><div class="table-container"><table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong><a href="https://baike.baidu.com/item/忍术/24690177?fromModule=lemma_inlink">忍术</a></strong></td><td>通过提炼查克拉所释放的一类术，也是种类和泛用性最广的一类术，是成为忍者的基本。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/体术/6653277?fromModule=lemma_inlink">体术</a></strong></td><td>即依靠身体进行直接攻击，不需要查克拉或结印也能发动。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/幻术/20134411?fromModule=lemma_inlink">幻术</a></strong></td><td>主要用于扰乱对手、并给对手造成精神伤害的一类术。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/咒印术/5335732?fromModule=lemma_inlink">咒印术</a></strong></td><td>使对手的能力、行动等受到施术者支配的一类术。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/封印术/5335844?fromModule=lemma_inlink">封印术</a></strong></td><td>可以将查克拉、术或尾兽等封印起来的一类术。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/仙术/16683148?fromModule=lemma_inlink">仙术</a></strong></td><td>利用自身的身体能量和来自自然的自然能量所使用的术，其威力要强于一般忍术。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/秘传/2834672?fromModule=lemma_inlink">秘传</a></strong></td><td>是指某些忍者一族所特有的一类术，只在族人之间传授。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/血继限界/7692249?fromModule=lemma_inlink">血继限界</a></strong></td><td>过遗传而获得的一类特殊能力或术，通常是特定的忍者一族所拥有。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/血继淘汰/4354923?fromModule=lemma_inlink">血继淘汰</a></strong></td><td>三种任意查克拉性质融合变化而成。</td></tr><tr><td><strong><a href="https://baike.baidu.com/item/血继网罗/15435831?fromModule=lemma_inlink">血继网罗</a></strong></td><td>火、风、雷、土、水、阴、阳全部七种性质融合变化而成。</td></tr></tbody></table></div><hr><h3 id="忍具"><a href="#忍具" class="headerlink" title="忍具"></a>忍具</h3><p><strong>名称</strong>                <strong>说明</strong></p><p><strong>苦无</strong>                形似短剑的武器，近战或远战皆可使用。  </p><p><strong>手里剑</strong>            飞镖状的暗器，用于远距离攻击。  </p><p><strong>烟雾弹</strong>            释放烟雾阻碍敌人视线，借以发动攻击或逃脱。  </p><p><strong>闪光弹</strong>            发出闪光阻碍敌人视线。  </p><p><strong>护额</strong>                忍者的标志之一，护额上一般会印有该名忍者所属忍者村的标记。  </p><p><strong>起爆符</strong>            外观是一张写有术式的纸，经过一定时间后会引爆。  </p><p><strong>卷轴 </strong>               用于与通灵兽签订契约、记录历史文献或用于来往书信、也可利用卷轴上的通灵术式召唤任何东西。  </p><p><strong>千本</strong>                杀伤力很低，类似金针的暗器，通常也用于医疗。  </p><p><strong>忍刀</strong>                包括可以在其上注入查克拉的“查克拉刀”、以及普通的刀。“忍刀七人众”所使用的七把忍刀。  </p><p><strong>兵粮丸</strong>            可以恢复消耗的查克拉，或者增强查克拉的药物。  </p><p><strong>傀儡</strong>                傀儡师使用的道具，通过查克拉丝线控制傀儡进行攻击。</p><hr><h2 id="出版信息"><a href="#出版信息" class="headerlink" title="出版信息"></a>出版信息</h2><h3 id="漫画单行本"><a href="#漫画单行本" class="headerlink" title="漫画单行本"></a>漫画单行本</h3><p>日文版由集英社出版。</p><p>繁体中文版由东立出版社出版。</p><p>简体中文版由连环画出版社正式引进出版，北京中少动漫图书有限公司发行</p><hr><h2 id="作品影响"><a href="#作品影响" class="headerlink" title="作品影响"></a>作品影响</h2><p>​        2010年5月《火影忍者》在日本国内发行量突破一亿，是集英社创社以来继《乌龙派出所》、《龙珠》、《<a href="https://baike.baidu.com/item/灌篮高手/27329?fromModule=lemma_inlink">灌篮高手</a>》、《海贼王》之后第五部发行量超过一亿册的漫画。</p><p>​        截至2014年，《火影忍者》漫画已在全世界累计发行超过2亿部。</p>]]></content>
      
      
      <categories>
          
          <category> 动漫 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL的SQL语句总结</title>
      <link href="//%5Bobject%20Object%5D/2023/04/12/MySQL%E7%9A%84SQL%E8%AF%AD%E5%8F%A5%E6%80%BB%E7%BB%93/"/>
      <url>//%5Bobject%20Object%5D/2023/04/12/MySQL%E7%9A%84SQL%E8%AF%AD%E5%8F%A5%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>[toc]</p><hr><h2 id="MySQL客户端命令"><a href="#MySQL客户端命令" class="headerlink" title="MySQL客户端命令"></a>MySQL客户端命令</h2><h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">-u：指定用户</span><br><span class="line">-p：指定密码</span><br><span class="line">-S：指定socket</span><br><span class="line">-h：指定主机域</span><br><span class="line"></span><br><span class="line">-e：免交互执行SQL语句</span><br><span class="line">-P：指定端口</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接到数据库后（命令）</span></span><br><span class="line">status || \s 查看数据库基本状态</span><br><span class="line"><span class="built_in">help</span> || \h || ? 查看客户端命令的帮助</span><br><span class="line">clear || \c 终止当前的命令</span><br><span class="line">ego || \G 格式化输出结果</span><br><span class="line">quit || <span class="built_in">exit</span> || \q 退出MySQL命令行</span><br><span class="line"><span class="built_in">source</span> || \. 导入数据</span><br><span class="line">system || \! 执行系统命令</span><br><span class="line"><span class="built_in">tee</span> || \T 记录日志</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ctrl +c // MySQL5.6中会退出数据库，MySQL5.7中会终止当前的SQL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改MySQL命令提示符</span></span><br><span class="line">prompt=MySQL5.7[\d]&gt;</span><br></pre></td></tr></table></figure><h3 id="mysqladmin"><a href="#mysqladmin" class="headerlink" title="mysqladmin"></a>mysqladmin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测MySQL是否存活</span></span><br><span class="line">mysqladmin -uroot -p789 ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止数据库服务</span></span><br><span class="line">mysqladmin -uroot -p789 shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment"># 免交互建库</span></span><br><span class="line">mysqladmin -uroot -p789 create zls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 免交互删库</span></span><br><span class="line">mysqladmin -uroot -p789 drop zls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置或更改密码</span></span><br><span class="line">mysqladmin -uroot -p789 password <span class="string">&#x27;123&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 库外执行刷新日志（binlog）</span></span><br><span class="line"><span class="comment"># （binlog）（用来记录Mysql内部对数据库的改动（只记录对数据的修改操作），主要用于数据库的主从复制以及增量恢复。）</span></span><br><span class="line">mysqladmin -uroot -p123 flush-log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看MySQL的默认配置参数</span></span><br><span class="line">mysqladmin -uroot -p123 variables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载缓存</span></span><br><span class="line">mysqladmin -uroot -p123 reload</span><br></pre></td></tr></table></figure><h3 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h3><ul><li>做备份、导出数据</li></ul><h2 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h2><h2 id="DDL："><a href="#DDL：" class="headerlink" title="DDL："></a>DDL：</h2><p><strong>数据定义语言</strong></p><p>库和表的定义：对库表的增删</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增</span></span><br><span class="line">create database</span><br><span class="line">create table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删</span></span><br><span class="line">drop database</span><br><span class="line">drop table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改</span></span><br><span class="line">alter database</span><br><span class="line">alter table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查（DQL）</span></span><br></pre></td></tr></table></figure><h3 id="库定义语言"><a href="#库定义语言" class="headerlink" title="库定义语言"></a>库定义语言</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 建库语法</span></span><br><span class="line"></span><br><span class="line">Name: <span class="string">&#x27;CREATE DATABASE&#x27;</span></span><br><span class="line"></span><br><span class="line">Syntax:</span><br><span class="line">CREATE &#123;DATABASE | SCHEMA&#125; [IF NOT EXISTS] db_name</span><br><span class="line">[create_option] ...</span><br><span class="line"></span><br><span class="line">create_option: [DEFAULT] &#123;</span><br><span class="line">CHARACTER SET [=] charset_name</span><br><span class="line">| COLLATE [=] collation_name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="增（create）"><a href="#增（create）" class="headerlink" title="增（create）"></a>增（create）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##增（create）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 两种写法（针对库）</span></span><br><span class="line">create database</span><br><span class="line">create schema</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建数据库</span></span><br><span class="line">create database 库名;</span><br><span class="line">create schema 库名;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 判断数据库是否存在，如果存在则不报错，如果不存在则创建（if not exists）</span></span><br><span class="line">create database <span class="keyword">if</span> not exists zls1;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建数据库时，指定字符集（charset）</span></span><br><span class="line">mysql&gt; create database <span class="keyword">if</span> not exists test_db1 character <span class="built_in">set</span> = utf8;</span><br><span class="line">mysql&gt; create database <span class="keyword">if</span> not exists test_db2 charset utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建数据库是，指定校验规则（collate）</span></span><br><span class="line">mysql&gt; create database <span class="keyword">if</span> not exists test_db3 charset utf8 collate</span><br><span class="line">utf8_bin;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看mysql有哪些字符集</span></span><br><span class="line">show charset;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看mysql有哪些校验规则</span></span><br><span class="line">show collation;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据库字符集</span></span><br><span class="line">show variables like <span class="string">&#x27;%character%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看库/表的字符集和校验规则（查看建库/表语句）</span></span><br><span class="line">show create database xxx;</span><br><span class="line">show create table xxx;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改配置文件指定字符集</span></span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server=utf8</span><br></pre></td></tr></table></figure><h4 id="删（drop）"><a href="#删（drop）" class="headerlink" title="删（drop）"></a>删（drop）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删（drop）</span></span><br><span class="line">mysql&gt; drop database 库名;</span><br></pre></td></tr></table></figure><h4 id="改（alter）"><a href="#改（alter）" class="headerlink" title="改（alter）"></a>改（alter）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 改（alter）</span></span><br><span class="line"><span class="comment">## 修改字符集，校验规则</span></span><br><span class="line">mysql&gt; alter database 库名 charset utf8 collate utf8_bin;</span><br></pre></td></tr></table></figure><h3 id="表定义语言"><a href="#表定义语言" class="headerlink" title="表定义语言"></a>表定义语言</h3><h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 数字类型</span></span><br><span class="line">bigint 大整型 -2^63 ~ 2^63-1 </span><br><span class="line">（-9,223,372,036,854,775,808 - 9,223,372,036,854,775,807）</span><br><span class="line">int：整型 -2^31 ~ (2^31)-1 （-2147483648 - 2147483647）</span><br><span class="line">tinyint：最小整型 -128 ~ 127</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 字符串类型</span></span><br><span class="line">varchar：可变长的字符串</span><br><span class="line">char：定长字符串</span><br><span class="line"></span><br><span class="line">varchar(5)  <span class="comment"># 小于5位，是几位算几位，不能超过5位</span></span><br><span class="line">char(5)  <span class="comment"># 不能超过5位，5以内，都算是5位</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># varchar特点</span></span><br><span class="line">1、使用比固定长度类型(char)占用更少存储空间(除了使用ROW_FORMAT=FIXED创建的MyISAM表)。</span><br><span class="line">2、使用额外的1-2字节来存储值长度，列长度&lt;=255使用1字节保存，其它情况使用2字节保存。例如varchar(10)会占用11字节存储空间，varchar(500)会占用502字节存储空间。</span><br><span class="line">3、节约空间，所以性能会有帮助。在更新的时候会产生额外的工作。</span><br><span class="line">4、5.0以上版本，取值或设置值都会保存字符串末尾的空格，4.1之前的版本都会把字符串末尾的空格删除掉。</span><br><span class="line">5、最大长度远大于平均长度，很少发生更新的时候适合使用varchar，因为碎片更少了。</span><br><span class="line"><span class="comment"># char特点</span></span><br><span class="line">1、使用固定长度。</span><br><span class="line">2、保存的时候会去掉字符串末尾的空格。</span><br><span class="line">3、适合保存MD5后的哈希值或经常改变的值，因为固定的行不容易产生碎片。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 枚举类型</span></span><br><span class="line">enum(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 时间类型</span></span><br><span class="line">timestamp 1970-01-01 00:00:00 - 2038-01-19 03:14:07</span><br><span class="line">datetime 1000-01-01 00:00:00 - 9999-12-31 23:59:59</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 浮点型</span></span><br><span class="line"><span class="built_in">float</span> : 单精度浮点数</span><br><span class="line">double : 双精度浮点数</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两者的主要区别如下：</span></span><br><span class="line">　　01.在内存中占有的字节数不同</span><br><span class="line">　　　　单精度浮点数在机内存占4个字节</span><br><span class="line">　　　　双精度浮点数在机内存占8个字节</span><br><span class="line">　　02.有效数字位数不同</span><br><span class="line">　　　　单精度浮点数有效数字8位</span><br><span class="line">　　　　双精度浮点数有效数字16位</span><br><span class="line">　　03.数值取值范围</span><br><span class="line">　　　　单精度浮点数的表示范围：-3.40E+38~3.40E+38</span><br><span class="line">　　　　双精度浮点数的表示范围：-1.79E+308~-1.79E+308</span><br><span class="line">　　04.在程序中处理速度不同</span><br><span class="line">　　　　一般来说，CPU处理单精度浮点数的速度比处理双精度浮点数快</span><br><span class="line">　　　　如果不声明，默认小数为double类型，所以如果要用<span class="built_in">float</span>的话，必须进行强转</span><br><span class="line"></span><br><span class="line"><span class="comment"># 例子</span></span><br><span class="line">　　例如：<span class="built_in">float</span>  a=1.3; 会编译报错，正确的写法 <span class="built_in">float</span> a = (<span class="built_in">float</span>)1.3;或者<span class="built_in">float</span> a = 1.3f;（f或F都可以不区分大小写）</span><br><span class="line">注意：<span class="built_in">float</span>是8位有效数字，第7位数字将会四舍五入</span><br><span class="line">面试题：</span><br><span class="line">　　1.java中3*0.1==0.3将会返回什么？<span class="literal">true</span>还是<span class="literal">false</span>？</span><br><span class="line">　　　fale,因为浮点数不能完全精确的表示出来，一般会损失精度。</span><br><span class="line">　　2.java中<span class="built_in">float</span> f = 3.4;是否正确？</span><br><span class="line">　　   不正确，3.4是双精度数，将双精度型（double）赋值给浮点型（<span class="built_in">float</span>）属于向下转型会造　　成精度损失，因此需要强制类型转换<span class="built_in">float</span> f = (<span class="built_in">float</span>)3.4;或者写成 <span class="built_in">float</span> f = 3.4f;才可以。</span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(3*0.1);</span><br><span class="line">        System.out.println(3*0.1==0.3);</span><br><span class="line">　　　　//float是8位有效数字，第7位数字将会四舍五入</span><br><span class="line">        <span class="built_in">float</span> a =1.32344435f;</span><br><span class="line">        System.out.println(a);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="字段属性"><a href="#字段属性" class="headerlink" title="字段属性"></a>字段属性</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 字段属性 ###############</span></span><br><span class="line">null：可以为空</span><br><span class="line">not null：非空</span><br><span class="line">primary key：主键索引 唯一 且 非空 （一张表中，只能设置一个主键）</span><br><span class="line">unique key：唯一键索引 唯一 可以为空 + not null</span><br><span class="line">auto_increment：自增</span><br><span class="line">unsigned：一般配合整型使用，非负数（无符号）</span><br><span class="line">default：设置默认值</span><br><span class="line">zerofill：使用0自动补全</span><br><span class="line"></span><br><span class="line"><span class="comment">## ---------最重要-----------------</span></span><br><span class="line">comment：注释、备注</span><br></pre></td></tr></table></figure><h4 id="建表语句（增）"><a href="#建表语句（增）" class="headerlink" title="建表语句（增）"></a>建表语句（增）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 建表语句</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 字段 数据类型 属性 comment</span></span><br><span class="line">create table student2(</span><br><span class="line"><span class="built_in">id</span> int primary key auto_increment comment <span class="string">&#x27;学生学号&#x27;</span>,</span><br><span class="line">name varchar(10) not null comment <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">age tinyint unsigned not null comment <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">gender enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>) not null default <span class="string">&#x27;m&#x27;</span> comment <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">phone char(11) not null unique key comment <span class="string">&#x27;联系方式&#x27;</span>,</span><br><span class="line">doa datetime not null default NOW() comment <span class="string">&#x27;入学时间&#x27;</span></span><br><span class="line">) charset utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">## （zerofill）自动补0</span></span><br><span class="line">create table student4(</span><br><span class="line"><span class="built_in">id</span> int(3) zerofill primary key auto_increment comment <span class="string">&#x27;学生学号&#x27;</span>,</span><br><span class="line">name varchar(10) not null comment <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">age tinyint unsigned not null comment <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">gender enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>) not null default <span class="string">&#x27;m&#x27;</span> comment <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">phone char(11) not null unique key comment <span class="string">&#x27;联系方式&#x27;</span>,</span><br><span class="line">doa datetime not null default NOW() comment <span class="string">&#x27;入学时间&#x27;</span></span><br><span class="line">) charset utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">## primary key(&#x27;id&#x27;,&#x27;phone&#x27;) 只能有一个，但可以包含多个</span></span><br><span class="line">create table student6(</span><br><span class="line"><span class="built_in">id</span> int(3) zerofill auto_increment comment <span class="string">&#x27;学生学号&#x27;</span>,</span><br><span class="line">name varchar(10) not null comment <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">age tinyint unsigned not null comment <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">gender enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>) not null default <span class="string">&#x27;m&#x27;</span> comment <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">phone char(11) comment <span class="string">&#x27;联系方式&#x27;</span>,</span><br><span class="line">doa datetime not null default NOW() comment <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">primary key(<span class="built_in">id</span>,phone)</span><br><span class="line">) charset utf8;</span><br></pre></td></tr></table></figure><h4 id="删表"><a href="#删表" class="headerlink" title="删表"></a>删表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删表</span></span><br><span class="line">mysql&gt; drop table 库名.表名;</span><br></pre></td></tr></table></figure><h4 id="改表"><a href="#改表" class="headerlink" title="改表"></a>改表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 改表（改表结构）</span></span><br><span class="line"><span class="comment">### 改表名（rename）</span></span><br><span class="line">mysql&gt; alter table student2 rename zls_student2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 改字段</span></span><br><span class="line"><span class="comment"># 增（add）</span></span><br><span class="line"><span class="comment">## 增加字段</span></span><br><span class="line">mysql&gt; alter table zls_student2 add heqingwen char(3) not null;</span><br><span class="line">mysql&gt; alter table zls_student2 add wzk char(3) not null;</span><br><span class="line"><span class="comment">## 将字段放在指定字段的后面</span></span><br><span class="line">mysql&gt; alter table zls_student2 add kangkang varchar(5) not null</span><br><span class="line">after doa;</span><br><span class="line"><span class="comment">## 将字段放在最前面</span></span><br><span class="line">mysql&gt; alter table zls_student2 add tangxu varchar(5) not null first;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删（drop）</span></span><br><span class="line">mysql&gt; alter table zls_student2 drop heqingwen;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改（change）（modify）</span></span><br><span class="line">change  <span class="comment">## 可以修改字段名、数据类型、属性（必须写名字）</span></span><br><span class="line">modify  <span class="comment">## 只能修改数据类型和属性</span></span><br><span class="line"><span class="comment">## 修改字段数据类型</span></span><br><span class="line">mysql&gt; alter table zls_student2 change kangkang kangkang varchar(10);</span><br><span class="line">mysql&gt; alter table zls_student2 modify kangkang char(10);</span><br><span class="line"><span class="comment">## 修改字段属性</span></span><br><span class="line">mysql&gt; alter table zls_student2 modify kangkang char(10) not null;</span><br><span class="line">mysql&gt; alter table zls_student2 change kangkang kangkang char(10) null default <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="comment">## 修改字段名字</span></span><br><span class="line">mysql&gt; alter table zls_student2 change kangkang syh varchar(1);</span><br></pre></td></tr></table></figure><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DDL:数据定义语言</span><br><span class="line">针对库和表的定义 操作的都是元数据</span><br><span class="line"></span><br><span class="line"><span class="comment">## 库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增</span></span><br><span class="line">create database</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删</span></span><br><span class="line">drop database</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改</span></span><br><span class="line">alter database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增</span></span><br><span class="line">create table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删</span></span><br><span class="line">drop table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改</span></span><br><span class="line">alter table</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230404193308527.png" alt=" "></p><h2 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h2><p><strong>数据操作语言</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 数据操作语言</span></span><br><span class="line">针对表中的数据进行操作 操作的都是真实数据</span><br><span class="line"></span><br><span class="line"><span class="comment">## 插入数据之前，需要知道表的表结构（了解有哪些字段）</span></span><br><span class="line">mysql&gt; desc student3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增 (insert)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删 (delete)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 改 (update)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查(select)（DQL）</span></span><br></pre></td></tr></table></figure><h3 id="增-insert"><a href="#增-insert" class="headerlink" title="增 (insert)"></a>增 (insert)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增 (insert)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一种写法</span></span><br><span class="line">mysql&gt; insert into 库.表(字段1,字段2,字段3,字段4...) values(<span class="string">&#x27;值1&#x27;</span>,<span class="string">&#x27;值2&#x27;</span>,值3,<span class="string">&#x27;值4&#x27;</span>...);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种写法</span></span><br><span class="line">mysql&gt; insert 库.表 values(<span class="string">&#x27;值1&#x27;</span>,<span class="string">&#x27;值2&#x27;</span>,值3,<span class="string">&#x27;值4&#x27;</span>...);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例子</span></span><br><span class="line">mysql&gt; insert student3(<span class="built_in">id</span>,age,gender,name,phone,doa)</span><br><span class="line">values(3,80,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;abd&#x27;</span>,<span class="string">&#x27;12345678902&#x27;</span>,NOW());</span><br><span class="line"></span><br><span class="line">mysql&gt; insert student3 values(4,<span class="string">&#x27;abe&#x27;</span>,80,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;12345678903&#x27;</span>,NOW());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 插入多条数据</span></span><br><span class="line">mysql&gt; insert student3(age,gender,name,phone) values(32,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;abx&#x27;</span>,<span class="string">&#x27;12345678908&#x27;</span>),(31,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;abz&#x27;</span>,<span class="string">&#x27;12345678909&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="删-delete"><a href="#删-delete" class="headerlink" title="删 (delete)"></a>删 (delete)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删 (delete)</span></span><br><span class="line">mysql&gt; delete from 表名;</span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> 条件;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 规范删除方法</span></span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> <span class="built_in">id</span>=4;</span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> name=<span class="string">&#x27;abx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 多条件删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时满足执行</span></span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> name=<span class="string">&#x27;abz&#x27;</span> and doa=<span class="string">&#x27;2023-04-05 09:00:01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 满足一个就执行</span></span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> name=<span class="string">&#x27;abz&#x27;</span> or name=<span class="string">&#x27;abx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算</span></span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> <span class="built_in">id</span>=14-3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 范围</span></span><br><span class="line">mysql&gt; delete from student3 <span class="built_in">where</span> <span class="built_in">id</span>&gt;=9 and <span class="built_in">id</span>&lt;14;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加多个</span></span><br><span class="line">delete from student3 <span class="built_in">where</span> <span class="built_in">id</span>=14 or <span class="built_in">id</span>=21 or <span class="built_in">id</span>=18;</span><br><span class="line">delete from student3 <span class="built_in">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;abz&#x27;</span>,<span class="string">&#x27;abe&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="改-update"><a href="#改-update" class="headerlink" title="改 (update)"></a>改 (update)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 改 (update)</span></span><br><span class="line">mysql&gt; update 库.表 <span class="built_in">set</span> 被修改的字段=被修改的值 <span class="built_in">where</span> 条件;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 注意：只有在修改mysql.user表中的用户信息时</span></span><br><span class="line"><span class="comment">## 才需要执行 flush privileges;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断</span></span><br><span class="line">mysql&gt; update student3 <span class="built_in">set</span> name=<span class="string">&#x27;zls&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=17;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 改所有可以直接给一个永远成立的判断</span></span><br><span class="line">mysql&gt; update student3 <span class="built_in">set</span> name=<span class="string">&#x27;tls&#x27;</span> <span class="built_in">where</span> 1=1;</span><br></pre></td></tr></table></figure><h3 id="update代替delete做伪删除"><a href="#update代替delete做伪删除" class="headerlink" title="update代替delete做伪删除"></a>update代替delete做伪删除</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 设置一个字段，status,更改它的值，做到不删除数据只改变状态（伪删除）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.给表中添加状态列（添加一个字段）</span></span><br><span class="line">mysql&gt; alter table student3 add status enum(<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>) not null default <span class="string">&#x27;1&#x27;</span> comment <span class="string">&#x27;物品状态&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.使用update删除数据（变更状态信息）</span></span><br><span class="line">mysql&gt; update student3 <span class="built_in">set</span> status=<span class="string">&#x27;0&#x27;</span> <span class="built_in">where</span> <span class="built_in">id</span>=31;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查询数据时，接状态条件进行查询</span></span><br><span class="line">mysql&gt; select * from student3 <span class="built_in">where</span> status=<span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="DCL"><a href="#DCL" class="headerlink" title="DCL"></a>DCL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 数据控制语言 针对用户权限的控制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 授权 (grant)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 回收权限 (revoke)</span></span><br></pre></td></tr></table></figure><h3 id="授权-grant"><a href="#授权-grant" class="headerlink" title="授权 (grant)"></a>授权 (grant)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 授权 (grant)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 普通管理员</span></span><br><span class="line">mysql&gt; grant all on *.* to wp@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="comment">## 真的超级管理员（with grant option）</span></span><br><span class="line">mysql&gt; grant all on *.* to wp@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span> with grant option;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 安全限制</span></span><br><span class="line"><span class="comment"># (登录mysql 需要查询一次)</span></span><br><span class="line"><span class="comment"># (更新mysql 需要查询一次)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># max_queries_per_hour：一个用户每小时可发出的查询数量</span></span><br><span class="line">mysql&gt; grant all on *.* to test_grant2@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123@qqdianCOM&#x27;</span> with max_queries_per_hour 1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># max_updates_per_hour：一个用户每小时可发出的更新数量</span></span><br><span class="line">grant all on *.* to test_grant3@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123@qqdianCOM&#x27;</span> max_updates_per_hour 1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># max_connections_per_hour：一个用户每小时可连接到服务器的次数</span></span><br><span class="line">grant all on *.* to test_grant5@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123@qqdianCOM&#x27;</span> max_connections_per_hour 1;</span><br><span class="line"></span><br><span class="line"><span class="comment"># max_user_connections：允许同时连接数量</span></span><br><span class="line">grant all on *.* to test_grant6@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123@qqdianCOM&#x27;</span> with max_user_connections 2;</span><br></pre></td></tr></table></figure><h3 id="回收权限-revoke"><a href="#回收权限-revoke" class="headerlink" title="回收权限 (revoke)"></a>回收权限 (revoke)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 回收权限 (revoke)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回收wp@&#x27;%&#x27;用户select权限</span></span><br><span class="line">mysql&gt; revoke select on *.* from wp@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SELECT,INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN,PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER,CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE,REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTERROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个select,insert,update,delete权限的用户</span></span><br><span class="line">grant select,insert,update,delete on *.* to dev@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回收用户dev@&#x27;%&#x27;的delete权限</span></span><br><span class="line">revoke delete on *.* from dev@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="DQL"><a href="#DQL" class="headerlink" title="DQL"></a>DQL</h2><h3 id="库-show"><a href="#库-show" class="headerlink" title="库-show"></a>库-show</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 针对库的DQL##############</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有数据库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据库的属性</span></span><br><span class="line">mysql&gt; show create database test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前所在数据库</span></span><br><span class="line">mysql&gt; select database();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 针对表的DQL###############</span></span><br><span class="line"><span class="comment"># 查看当前库中的所有表 ls -l</span></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定库中的所有表 ls -l /opt</span></span><br><span class="line">mysql&gt; show tables from test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看表结构</span></span><br><span class="line">mysql&gt; desc student;</span><br><span class="line">mysql&gt; desc test_db.student;</span><br><span class="line"></span><br><span class="line">+--------+---------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type | Null | Key | Default | Extra |</span><br><span class="line">+--------+---------------+------+-----+---------+-------+</span><br><span class="line">| <span class="built_in">id</span> | int(11) | YES | | NULL | |</span><br><span class="line">| name | varchar(10) | YES | | NULL | |</span><br><span class="line">| age | tinyint(4) | YES | | NULL | |</span><br><span class="line">| gender | enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>) | YES | | NULL | |</span><br><span class="line">| phone | char(11) | YES | | NULL | |</span><br><span class="line">| doa | datetime | YES | | NULL | |</span><br><span class="line">+--------+---------------+------+-----+---------+-------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建表语句</span></span><br><span class="line">mysql&gt; show create table student;`</span><br><span class="line"></span><br><span class="line">student | CREATE TABLE `student` (</span><br><span class="line">`<span class="built_in">id</span>` int(11) DEFAULT NULL,</span><br><span class="line">`name` varchar(10) DEFAULT NULL,</span><br><span class="line">`age` tinyint(4) DEFAULT NULL,</span><br><span class="line">`gender` enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>) DEFAULT NULL,</span><br><span class="line">`phone` char(11) DEFAULT NULL,</span><br><span class="line">`doa` datetime DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1</span><br></pre></td></tr></table></figure><h3 id="基础查询-select"><a href="#基础查询-select" class="headerlink" title="基础查询 (select)"></a>基础查询 (select)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 危险(查看表里所有内容&#x27;*&#x27;,表比较大的情况会出现问题)</span></span><br><span class="line">mysql&gt; select * from test_db.student3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; show tables from world;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_world |</span><br><span class="line">+-----------------+</span><br><span class="line">| city | <span class="comment"># 城市表</span></span><br><span class="line">| country | <span class="comment"># 国家表</span></span><br><span class="line">| countrylanguage | <span class="comment"># 国家语言表</span></span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; desc world.city;</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type | Null | Key | Default | Extra |</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">| ID | int(11) | NO | PRI | NULL | auto_increment |</span><br><span class="line"><span class="comment"># 序号</span></span><br><span class="line">| Name | char(35) | NO | | | |</span><br><span class="line"><span class="comment"># 城市名</span></span><br><span class="line">| CountryCode | char(3) | NO | MUL | | |</span><br><span class="line"><span class="comment"># 国家代码</span></span><br><span class="line">| District | char(20) | NO | | | |</span><br><span class="line"><span class="comment"># 省</span></span><br><span class="line">| Population | int(11) | NO | | 0 | |</span><br><span class="line"><span class="comment"># 人口数量</span></span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查询所有数据</span></span><br><span class="line">mysql&gt; select * from world.city;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 单条件查询</span></span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 多条件查询</span></span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> or countrycode=<span class="string">&#x27;USA&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 题 (where判断)</span></span><br><span class="line"><span class="comment">##1. 国家代码是CHN的并且省市heillongjiang的城市名有哪些？</span></span><br><span class="line">mysql&gt; select name from world.city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> and district=<span class="string">&#x27;heilongjiang&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 范围查询 (&lt; 、&gt; 、&lt;= 、&gt;= 、 &lt;&gt; 、!=)</span></span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> <span class="built_in">id</span> &gt; 10 and <span class="built_in">id</span> &lt; 30;</span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> population &lt; 1000;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 模糊查询 (like)</span></span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> countrycode like <span class="string">&#x27;%B%&#x27;</span>;</span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> countrycode like <span class="string">&#x27;%B&#x27;</span>;</span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">where</span> countrycode like <span class="string">&#x27;B%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 分页查询 (limit)</span></span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">limit</span> 0,65;</span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">limit</span> 65,65;</span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">limit</span> 130,65;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 统计一张表有多少条数据 （count(*)统计）</span></span><br><span class="line">mysql&gt; select count(*) from world.city;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 排序查询 (order by)</span></span><br><span class="line"><span class="comment"># 顺序（order by 字段）</span></span><br><span class="line">mysql&gt; select * from world.city order by population;</span><br><span class="line"><span class="comment"># 倒序（order by 字段 desc）</span></span><br><span class="line">mysql&gt; select * from world.city order by population desc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 别名(as)</span></span><br><span class="line">mysql&gt; select <span class="built_in">id</span> as <span class="string">&#x27;序号&#x27;</span>,name as <span class="string">&#x27;城市名&#x27;</span>,countrycode as <span class="string">&#x27;国家代码&#x27;</span>,district as <span class="string">&#x27;省&#x27;</span>,population as <span class="string">&#x27;人口数量&#x27;</span> from world.city order by population desc <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 分组查询 (group by)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用过的函数</span></span><br><span class="line">password()</span><br><span class="line">now()</span><br><span class="line">database()</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL中常用的聚合函数</span></span><br><span class="line">max() <span class="comment"># 求最大值函数</span></span><br><span class="line">min() <span class="comment"># 求最小值函数</span></span><br><span class="line">avg() <span class="comment"># 求平均值函数</span></span><br><span class="line"><span class="built_in">sum</span>() <span class="comment"># 求和函数</span></span><br><span class="line">count() <span class="comment"># 统计函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查询4点</span></span><br><span class="line">1.遇到统计想函数</span><br><span class="line">2.形容词前group by</span><br><span class="line">3.函数中央是名词</span><br><span class="line">4.列名select后添加</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 题</span></span><br><span class="line"><span class="comment">#1. 统计世界上每个国家的总人口数</span></span><br><span class="line">1.<span class="built_in">sum</span>()</span><br><span class="line">2.group by contrycode</span><br><span class="line">3.<span class="built_in">sum</span>(population)</span><br><span class="line">4.select 国家代码 总人口数量</span><br><span class="line"></span><br><span class="line">select countrycode,<span class="built_in">sum</span>(population) from world.city group by countrycode order by <span class="built_in">sum</span>(population);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 统计中国各个省的人口数量(练习)</span></span><br><span class="line">1.<span class="built_in">sum</span>()</span><br><span class="line">2.group by district</span><br><span class="line">3.<span class="built_in">sum</span>(population)</span><br><span class="line">4.select 国家代码 省 总人口数量</span><br><span class="line"></span><br><span class="line">select countrycode,district,<span class="built_in">sum</span>(population) from world.city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> group by district;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 统每个国家的城市数量(练习)</span></span><br><span class="line">1.count()</span><br><span class="line">2.group by countrycode</span><br><span class="line">3.count(name)</span><br><span class="line">4.select 国家代码 城市数量</span><br><span class="line"></span><br><span class="line">select countrycode,count(name) from world.city group by countrycode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 统计中国每个省的城市数量（练习）</span></span><br><span class="line">1.count()</span><br><span class="line">2.group by district</span><br><span class="line">3.count(name)</span><br><span class="line">4.select 国家代码 省 城市数量</span><br><span class="line"></span><br><span class="line">select countrycode,district,count(name) from world.city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> group by district order by count(name);</span><br></pre></td></tr></table></figure><h2 id="Select-高级用法（连表查询）"><a href="#Select-高级用法（连表查询）" class="headerlink" title="Select 高级用法（连表查询）"></a>Select 高级用法（连表查询）</h2><h3 id="连表查询分类"><a href="#连表查询分类" class="headerlink" title="连表查询分类"></a>连表查询分类</h3><ul><li>传统连接 </li><li>自连接 </li><li>内连接 </li><li>外连接<ul><li>左外连接 </li><li>右外连接</li></ul></li></ul><h3 id="连表查询-传统连接"><a href="#连表查询-传统连接" class="headerlink" title="连表查询-传统连接"></a>连表查询-传统连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 找等价条件 + 需求条件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (select 需要查的列 from 需要查询到的表 where 等价条件 and 需求条件)</span></span><br><span class="line">mysql&gt; select stu_name.name,stu_score.mark from stu_name,stu_score</span><br><span class="line"><span class="built_in">where</span> stu_name.id=stu_score.id and name=<span class="string">&#x27;zhang3&#x27;</span>;</span><br><span class="line">+--------+------+</span><br><span class="line">| name | mark |</span><br><span class="line">+--------+------+</span><br><span class="line">| zhang3 | 80 |</span><br><span class="line">+--------+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 世界上小于100人的人口城市是哪个国家的？</span></span><br><span class="line">国家名  城市名 人口数量</span><br><span class="line">country.name city.name city.population</span><br><span class="line"></span><br><span class="line">select country.name,city.name,city.population</span><br><span class="line">from city,country</span><br><span class="line"><span class="built_in">where</span> city.countrycode=country.code</span><br><span class="line">and city.population&lt;100;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 别名 (as)</span></span><br><span class="line">select country.name as <span class="string">&#x27;国家名&#x27;</span>,city.name as <span class="string">&#x27;城市名&#x27;</span>,city.population as <span class="string">&#x27;城市人口&#x27;</span></span><br><span class="line">from city,country</span><br><span class="line"><span class="built_in">where</span> city.countrycode=country.code</span><br><span class="line">and city.population&lt;100;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 三表连查</span></span><br><span class="line"><span class="comment"># 世界上小于100人的人口城市是哪个国家的他们说的语言是什么？</span></span><br><span class="line"><span class="comment"># (select 需要查的列 from 需要查询到的表 where 等价条件 and 等价条件 and 需求条件)</span></span><br><span class="line"><span class="comment">#(a=b b=c 得a=c)</span></span><br><span class="line">国家名 城市名 人口数量 语言</span><br><span class="line">country.name city.name city.populationcountrylanguage.language</span><br><span class="line"></span><br><span class="line">mysql&gt; select</span><br><span class="line">country.name,city.name,city.population,countrylanguage.language</span><br><span class="line">-&gt; from city,country,countrylanguage</span><br><span class="line">-&gt; <span class="built_in">where</span> city.countrycode=country.code</span><br><span class="line">-&gt; and countrylanguage.countrycode=country.code</span><br><span class="line">-&gt; and city.population&lt;100;</span><br><span class="line">+----------+-----------+------------+-------------+</span><br><span class="line">| name | name | population | language |</span><br><span class="line">+----------+-----------+------------+-------------+</span><br><span class="line">| Pitcairn | Adamstown | 42 | Pitcairnese |</span><br><span class="line">+----------+-----------+------------+-------------+</span><br></pre></td></tr></table></figure><h3 id="连表查询-自连接"><a href="#连表查询-自连接" class="headerlink" title="连表查询-自连接"></a>连表查询-自连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动连接：自动找到包含等价条件的列</span></span><br><span class="line"><span class="comment"># 大前提条件：多张表中，等价条件的列名，必须一致 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (natural join)</span></span><br><span class="line"><span class="comment"># (select 需要查的列 from 表1 natural join 表2 where 需求条件)</span></span><br><span class="line">mysql&gt; select stu_name.name,stu_score.mark</span><br><span class="line">-&gt; from stu_name natural <span class="built_in">join</span> stu_score</span><br><span class="line">-&gt; <span class="built_in">where</span> name=<span class="string">&#x27;li4&#x27;</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| name | mark |</span><br><span class="line">+------+------+</span><br><span class="line">| li4 | 50 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 世界上小于100人的人口城市是哪个国家的他们说的语言是什么？</span></span><br><span class="line"><span class="comment"># (select 需要查的列 from 表1 natural join 表2 where 需求条件)</span></span><br><span class="line">city.countrycode city.name city.populationcountrylanguage.language</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">city.countrycode,city.name,city.population,countrylanguage.language</span><br><span class="line">from city natural <span class="built_in">join</span> countrylanguage</span><br><span class="line"><span class="built_in">where</span> city.population&lt;100;</span><br><span class="line">+-------------+-----------+------------+-------------+</span><br><span class="line">| countrycode | name | population | language |</span><br><span class="line">+-------------+-----------+------------+-------------+</span><br><span class="line">| PCN | Adamstown | 42 | Pitcairnese |</span><br><span class="line">+-------------+-----------+------------+-------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 三表自连接</span></span><br><span class="line"><span class="comment"># (select 需要查的列 from 表1 natural join 表2 natural join 表3 where 需求条件)</span></span><br><span class="line">mysql&gt; select stu_name.name,stu_score.mark,stu_age.age</span><br><span class="line">from stu_name natural <span class="built_in">join</span> stu_score natural <span class="built_in">join</span> stu_age</span><br><span class="line"><span class="built_in">where</span> name=<span class="string">&#x27;wang5&#x27;</span>;</span><br><span class="line">+-------+------+------+</span><br><span class="line">| name | mark | age |</span><br><span class="line">+-------+------+------+</span><br><span class="line">| wang5 | 70 | 40 |</span><br><span class="line">+-------+------+------+</span><br></pre></td></tr></table></figure><h3 id="连表查询-内连接"><a href="#连表查询-内连接" class="headerlink" title="连表查询-内连接"></a>连表查询-内连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## (join on)</span></span><br><span class="line"><span class="comment">## (注意 小表在前 join 大表在后)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A表 join B表 on 等价条件（双表）</span></span><br><span class="line"><span class="comment"># A表 join B表 join C表 on 等价条件1 and 等价条件2 (不符合SQL语句)</span></span><br><span class="line"><span class="comment"># A表 join B表 on 等价条件1 join C表 on 等价条件2 SQL-92标准（三表）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 世界上小于100人的人口城市是哪个国家的？</span></span><br><span class="line">国家名 城市名 人口数量</span><br><span class="line">country.name city.name city.population</span><br><span class="line"><span class="comment"># (select 需要查的列 from 表1 join 表2 on 等价条件 where 需求条件)</span></span><br><span class="line">select country.name,city.name,city.population</span><br><span class="line">from city <span class="built_in">join</span> country</span><br><span class="line">on city.countrycode=country.code</span><br><span class="line"><span class="built_in">where</span> city.population&lt;100;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 世界上小于100人的人口城市是哪个国家的他们说的语言是什么？</span></span><br><span class="line"><span class="comment"># (select 需要查的列 from 表1 join 表2 on 等价条件 join 表3 on 等价条件 where 需求条件)</span></span><br><span class="line">select</span><br><span class="line">country.name,city.name,city.population,countrylanguage.language</span><br><span class="line">from city <span class="built_in">join</span> country</span><br><span class="line">on city.countrycode=country.code</span><br><span class="line"><span class="built_in">join</span> countrylanguage</span><br><span class="line">on countrylanguage.countrycode=country.code</span><br><span class="line"><span class="built_in">where</span> city.population&lt;100;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 处理文件：</span></span><br><span class="line"><span class="comment"># tail</span></span><br><span class="line"><span class="comment"># (order by id desc limit 10)</span></span><br><span class="line">mysql&gt; select * from world.city order by <span class="built_in">id</span> desc <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"><span class="comment"># head</span></span><br><span class="line"><span class="comment"># (limit 10)</span></span><br><span class="line">mysql&gt; select * from world.city <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"><span class="comment"># sort</span></span><br><span class="line"><span class="comment"># (order by)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># awk</span></span><br><span class="line"><span class="comment"># (select name,population)</span></span><br><span class="line">mysql&gt; select name,population from world.city <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"><span class="comment"># grep</span></span><br><span class="line"><span class="comment"># (like &#x27;%xxx%&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 注意：小表在前大表在后 ##########</span></span><br><span class="line"><span class="comment">## 全称 (inter join on)</span></span><br></pre></td></tr></table></figure><h3 id="连表查询-外连接"><a href="#连表查询-外连接" class="headerlink" title="连表查询-外连接"></a>连表查询-外连接</h3><p><strong>左外连接</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## (left join)</span></span><br><span class="line"><span class="comment"># city left join country 谁在左边显示谁，左边隐藏</span></span><br><span class="line"></span><br><span class="line">select city.name,city.countrycode,country.name</span><br><span class="line">from city left <span class="built_in">join</span> country</span><br><span class="line">on city.countrycode=country.code</span><br><span class="line">and city.population&lt;100 <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全称 (outer join)(left outer join)</span></span><br></pre></td></tr></table></figure><p><strong>右外连接</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># right join</span></span><br><span class="line"><span class="comment"># city right join country 谁在右边显示谁，左边隐藏</span></span><br><span class="line"></span><br><span class="line">select city.name,city.countrycode,country.name</span><br><span class="line">from city right <span class="built_in">join</span> country</span><br><span class="line">on city.countrycode=country.code</span><br><span class="line">and city.population&lt;100 <span class="built_in">limit</span> 10;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全称 (right outer join on)</span></span><br></pre></td></tr></table></figure><h2 id="合并查询"><a href="#合并查询" class="headerlink" title="合并查询"></a>合并查询</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提升效率的高级用法</span></span><br><span class="line">mysql&gt; explain select * from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> or countrycode=<span class="string">&#x27;USA&#x27;</span>;</span><br><span class="line">+----+-------------+-------+------------+-------+</span><br><span class="line">| <span class="built_in">id</span> | select_type | table | partitions | <span class="built_in">type</span> |</span><br><span class="line">+----+-------------+-------+------------+-------+</span><br><span class="line">| 1 | SIMPLE | city | NULL | range |</span><br><span class="line">+----+-------------+-------+------------+-------+</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from city <span class="built_in">where</span> countrycode <span class="keyword">in</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line">+----+-------------+-------+------------+-------+</span><br><span class="line">| <span class="built_in">id</span> | select_type | table | partitions | <span class="built_in">type</span> |</span><br><span class="line">+----+-------------+-------+------------+-------+</span><br><span class="line">| 1 | SIMPLE | city | NULL | range |</span><br><span class="line">+----+-------------+-------+------------+-------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 联合查询，效率高于上面两种（union all）=（&amp;&amp;）</span></span><br><span class="line">mysql&gt; select * from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> union all select * from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;USA&#x27;</span>;</span><br><span class="line">mysql&gt; explain select * from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;CHN&#x27;</span> union all select * from city <span class="built_in">where</span> countrycode=<span class="string">&#x27;USA&#x27;</span>;</span><br><span class="line">+----+-------------+-------+------------+------+</span><br><span class="line">| <span class="built_in">id</span> | select_type | table | partitions | <span class="built_in">type</span> |</span><br><span class="line">+----+-------------+-------+------------+------+</span><br><span class="line">| 1 | PRIMARY | city | NULL | ref |</span><br><span class="line">| 2 | UNION | city | NULL | ref |</span><br><span class="line">+----+-------------+-------+------------+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 效率最低，全表扫描</span></span><br><span class="line">mysql&gt; explain select * from city;</span><br><span class="line">+----+-------------+-------+------------+------+</span><br><span class="line">| <span class="built_in">id</span> | select_type | table | partitions | <span class="built_in">type</span> |</span><br><span class="line">+----+-------------+-------+------------+------+</span><br><span class="line">| 1 | SIMPLE | city | NULL | ALL |</span><br><span class="line">+----+-------------+-------+------------+------+</span><br></pre></td></tr></table></figure><h2 id="字符集"><a href="#字符集" class="headerlink" title="字符集"></a>字符集</h2><ul><li>Linux<ul><li>utf-8：一个中文占3个字节</li><li>utf8mb4：一个中文占4个字节</li></ul></li><li>Windows：GBK（国际扩）GB2312</li><li>万国编码：unicode</li></ul><h2 id="校验规则"><a href="#校验规则" class="headerlink" title="校验规则"></a>校验规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看MySQL中所有的校验规则</span></span><br><span class="line">mysql&gt; show collation;</span><br><span class="line"></span><br><span class="line">1）ci：大小写不敏感</span><br><span class="line">2）cs或bin：大小写敏感</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看MySQL中所有的字符集</span></span><br><span class="line">mysql&gt; show charset;</span><br></pre></td></tr></table></figure><h2 id="统一字符集"><a href="#统一字符集" class="headerlink" title="统一字符集"></a>统一字符集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.操作系统</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## CentOS6</span></span><br><span class="line">root@db01,172.16.1.51:~ <span class="comment"># vim /etc/sysconfig/i18n </span></span><br><span class="line">LANG=<span class="string">&quot;en_US.UTF-8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## CentOS7</span></span><br><span class="line">root@db01,172.16.1.51:~ <span class="comment"># vim /etc/locale.conf</span></span><br><span class="line">LANG=<span class="string">&quot;en_US.UTF-8&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.远程连接工具</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.数据库</span></span><br><span class="line">create database 库名 charset utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.表</span></span><br><span class="line">create table 表名(<span class="built_in">id</span> int) charset utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server=utf8</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230406154118733.png" alt="image-20230406154118733"></p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">use linux50</span><br><span class="line"></span><br><span class="line"><span class="comment">## student</span></span><br><span class="line"></span><br><span class="line">create table student(</span><br><span class="line">sno int(20) primary key auto_increment comment <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">sname varchar(10) not null comment <span class="string">&#x27;学生姓名&#x27;</span>,</span><br><span class="line">sage tinyint unsigned not null comment <span class="string">&#x27;学生年龄&#x27;</span>,</span><br><span class="line">ssex enum(<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>) not null default <span class="string">&#x27;1&#x27;</span> comment <span class="string">&#x27;学生性别&#x27;</span>,</span><br><span class="line">sbirthday datetime default null comment <span class="string">&#x27;学生生日&#x27;</span>,</span><br><span class="line">class varchar(3) not null comment <span class="string">&#x27;学生班级&#x27;</span></span><br><span class="line">)charset utf8;</span><br><span class="line"></span><br><span class="line">insert into student(sname,sage,sbirthday,class) values(<span class="string">&#x27;徐导&#x27;</span>,<span class="string">&#x27;20&#x27;</span>,<span class="string">&#x27;2018-11-27 22:13:03&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">insert into student(sname,sage,sbirthday,class) values(<span class="string">&#x27;曾导&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;2018-11-27 22:13:03&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">insert into student(sname,sage,sbirthday,class) values(<span class="string">&#x27;李导&#x27;</span>,<span class="string">&#x27;25&#x27;</span>,<span class="string">&#x27;2018-11-27 22:13:03&#x27;</span>,<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## course</span></span><br><span class="line">create table course(</span><br><span class="line">cno int(20) primary key auto_increment comment <span class="string">&#x27;课程号&#x27;</span>,</span><br><span class="line">cname varchar(20) not null comment <span class="string">&#x27;课程名称&#x27;</span>,</span><br><span class="line">tno varchar(3) comment <span class="string">&#x27;教师编号&#x27;</span></span><br><span class="line">)charset utf8;</span><br><span class="line"></span><br><span class="line">insert into course(cname,tno) values(<span class="string">&#x27;英语&#x27;</span>,<span class="string">&#x27;001&#x27;</span>);</span><br><span class="line">insert into course(cname,tno) values(<span class="string">&#x27;语文&#x27;</span>,<span class="string">&#x27;002&#x27;</span>);</span><br><span class="line">insert into course(cname,tno) values(<span class="string">&#x27;数学&#x27;</span>,<span class="string">&#x27;003&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## score</span></span><br><span class="line">create table score(</span><br><span class="line">sno int(20) not null comment <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">cno varchar(20) not null comment <span class="string">&#x27;课程号&#x27;</span>,</span><br><span class="line">mark <span class="built_in">float</span>(4,1) not null comment <span class="string">&#x27;成绩&#x27;</span>,</span><br><span class="line">primary key(sno,cno)</span><br><span class="line">)charset utf8;</span><br><span class="line"></span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;90.0&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;10.0&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;60.0&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;90.0&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;99.5&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;80.0&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;80.5&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;60.0&#x27;</span>);</span><br><span class="line">insert into score(sno,cno,mark) values(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;88.0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## teacher</span></span><br><span class="line">create table teacher(</span><br><span class="line">tno int(3) zerofill primary key auto_increment comment <span class="string">&#x27;教师编号&#x27;</span>,</span><br><span class="line">tname varchar(10) not null comment <span class="string">&#x27;教师姓名&#x27;</span>,</span><br><span class="line">tage tinyint unsigned not null comment <span class="string">&#x27;教师年龄&#x27;</span>,</span><br><span class="line">tsex enum(<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>) not null default <span class="string">&#x27;1&#x27;</span> comment <span class="string">&#x27;教师性别&#x27;</span>,</span><br><span class="line">prof varchar(10) null comment <span class="string">&#x27;教师职称&#x27;</span>,</span><br><span class="line">depart varchar(10) not null comment <span class="string">&#x27;教师部门&#x27;</span></span><br><span class="line">)charset utf8;</span><br><span class="line"></span><br><span class="line">insert into teacher(tname,tage,prof,depart) values(<span class="string">&#x27;徐亮伟&#x27;</span>,<span class="string">&#x27;50&#x27;</span>,<span class="string">&#x27;教师总监&#x27;</span>,<span class="string">&#x27;语言系&#x27;</span>);</span><br><span class="line">insert into teacher(tname,tage,prof,depart) values(<span class="string">&#x27;曾志高翔&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;讲师&#x27;</span>,<span class="string">&#x27;文学系&#x27;</span>);</span><br><span class="line">insert into teacher(tname,tage,prof,depart) values(<span class="string">&#x27;李永宜&#x27;</span>,<span class="string">&#x27;80&#x27;</span>,<span class="string">&#x27;助教&#x27;</span>,<span class="string">&#x27;科学系&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230404180543400.png" alt="image-20230404180543400"> </p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230404201536647.png" alt="image-20230404201536647"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.将自己班级小组所有人员信息插入到student表中（数据自定义）</span></span><br><span class="line">insert linux50.student(sname,sage,sbirthday,class) </span><br><span class="line">values(<span class="string">&#x27;坤坤&#x27;</span>,20,<span class="string">&#x27;2018-11-23 21:13:03&#x27;</span>,<span class="string">&#x27;4&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;文文&#x27;</span>,21,<span class="string">&#x27;2018-05-17 21:13:03&#x27;</span>,<span class="string">&#x27;4&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;航航&#x27;</span>,22,<span class="string">&#x27;2018-03-22 14:13:03&#x27;</span>,<span class="string">&#x27;4&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;猛猛&#x27;</span>,20,<span class="string">&#x27;2018-05-21 16:14:03&#x27;</span>,<span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.将曾导、徐导、李导信息插入教师表中（数据自定义）</span></span><br><span class="line">insert linux50.teacher(tname,tage,prof,depart)</span><br><span class="line">values(<span class="string">&#x27;徐亮伟&#x27;</span>,<span class="string">&#x27;50&#x27;</span>,<span class="string">&#x27;教师总监&#x27;</span>,<span class="string">&#x27;语言系&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;曾志高翔&#x27;</span>,<span class="string">&#x27;18&#x27;</span>,<span class="string">&#x27;讲师&#x27;</span>,<span class="string">&#x27;文学系&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;李永宜&#x27;</span>,<span class="string">&#x27;80&#x27;</span>,<span class="string">&#x27;助教&#x27;</span>,<span class="string">&#x27;科学系&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.将数学、语文、英语学科插入到课程表中（数据自定义）</span></span><br><span class="line">insert linux50.course(cname,tno)</span><br><span class="line">values(<span class="string">&#x27;英语&#x27;</span>,<span class="string">&#x27;001&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;语文&#x27;</span>,<span class="string">&#x27;002&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;数学&#x27;</span>,<span class="string">&#x27;003&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.将分数插入到成绩表中（数据自定义）</span></span><br><span class="line">insert linux50.score(sno,cno,mark) values(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;90.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;10.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;60.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;90.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;99.5&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;80.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;80.5&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;60.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;88.0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 查询练习：</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.查询student表中的所有记录的sname、ssex和class列。</span></span><br><span class="line">select sname,ssex,class from linux50.student;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查询教师所有的单位即不重复的depart列。</span></span><br><span class="line">select depart from linux50.teacher group by depart;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查询student表的所有记录。</span></span><br><span class="line">select * from linux50.student;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.查询score表中成绩在60到80之间的所有记录。</span></span><br><span class="line">select * from linux50.score <span class="built_in">where</span> mark&gt;=60 and mark &lt;=80;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.查询score表中成绩为85，86或88的记录。</span></span><br><span class="line">select mark from linux50.score <span class="built_in">where</span> mark=85 or mark=86 or mark=88; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.查询student表中1班或性别为“女”的同学记录。</span></span><br><span class="line">select sname,ssex,class from linux50.student <span class="built_in">where</span> class=1 or ssex=0; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.以class降序查询Student表的所有记录。</span></span><br><span class="line">select * from linux50.student order by class desc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.以cno升序、mark降序查询Score表的所有记录</span></span><br><span class="line">select * from score arsc order by cno,mark desc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.查询2班的学生人数。</span></span><br><span class="line">select class,count(class) from linux50.student <span class="built_in">where</span> class=2 group by class;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.查询”曾志高翔“教师任课的学生成绩。</span></span><br><span class="line">select teacher.tname,course.cname,student.sname,score.mark</span><br><span class="line">from teacher,course,student,score</span><br><span class="line"><span class="built_in">where</span> teacher.tno=course.tno and course.cno=score.cno and student.sno=score.sno</span><br><span class="line">and teacher.tno=001;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select teacher.tname,course.cname,student.sname,score.mark</span><br><span class="line">from teacher <span class="built_in">join</span> course</span><br><span class="line">on teacher.tno=course.tno</span><br><span class="line"><span class="built_in">join</span> score</span><br><span class="line">on course.cno=score.cno</span><br><span class="line"><span class="built_in">join</span> student</span><br><span class="line">on student.sno=score.sno</span><br><span class="line"><span class="built_in">where</span> teacher.tno=001;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.查询语文课程所有男生的成绩并且查出对应课程的教师名，职称，及所在部门。</span></span><br><span class="line">select course.cname,student.sname,student.ssex,score.mark,teacher.tname,teacher.prof,teacher.depart</span><br><span class="line">from course,student,score,teacher</span><br><span class="line"><span class="built_in">where</span> course.cno=score.cno and score.sno=student.sno and course.tno=teacher.tno</span><br><span class="line">and course.cname=<span class="string">&#x27;语文&#x27;</span> and student.ssex=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select course.cname,student.sname,student.ssex,score.mark,teacher.tname,teacher.prof,teacher.depart</span><br><span class="line">from course <span class="built_in">join</span> score</span><br><span class="line">on course.cno=score.cno</span><br><span class="line"><span class="built_in">join</span> student</span><br><span class="line">on score.sno=student.sno</span><br><span class="line"><span class="built_in">join</span> teacher</span><br><span class="line">on course.tno=teacher.tno</span><br><span class="line"><span class="built_in">where</span> course.cname=<span class="string">&#x27;语文&#x27;</span> and student.ssex=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 12.把11题查出的成绩按照降序排序。</span></span><br><span class="line">select course.cname,student.sname,student.ssex,score.mark,teacher.tname,teacher.prof,teacher.depart</span><br><span class="line">from course,student,score,teacher</span><br><span class="line"><span class="built_in">where</span> course.cno=score.cno and score.sno=student.sno and course.tno=teacher.tno</span><br><span class="line">and course.cname=<span class="string">&#x27;语文&#x27;</span> and student.ssex=<span class="string">&#x27;1&#x27;</span> order by mark desc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select course.cname,student.sname,student.ssex,score.mark,teacher.tname,teacher.prof,teacher.depart</span><br><span class="line">from course <span class="built_in">join</span> score</span><br><span class="line">on course.cno=score.cno</span><br><span class="line"><span class="built_in">join</span> student</span><br><span class="line">on score.sno=student.sno</span><br><span class="line"><span class="built_in">join</span> teacher</span><br><span class="line">on course.tno=teacher.tno</span><br><span class="line"><span class="built_in">where</span> course.cname=<span class="string">&#x27;语文&#x27;</span> and student.ssex=<span class="string">&#x27;1&#x27;</span> order by mark desc;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>第二篇文章</title>
      <link href="//%5Bobject%20Object%5D/2023/04/09/2023-3-29-%E7%AC%AC%E4%BA%8C%E7%AF%87%E6%96%87%E7%AB%A0/"/>
      <url>//%5Bobject%20Object%5D/2023/04/09/2023-3-29-%E7%AC%AC%E4%BA%8C%E7%AF%87%E6%96%87%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="我的第二篇文章"><a href="#我的第二篇文章" class="headerlink" title="我的第二篇文章!"></a>我的第二篇文章!</h2>]]></content>
      
      
      <categories>
          
          <category> xxx </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>我有一剑</title>
      <link href="//%5Bobject%20Object%5D/2023/04/02/%E6%88%91%E6%9C%89%E4%B8%80%E5%89%91/"/>
      <url>//%5Bobject%20Object%5D/2023/04/02/%E6%88%91%E6%9C%89%E4%B8%80%E5%89%91/</url>
      
        <content type="html"><![CDATA[<h1 id="剑来"><a href="#剑来" class="headerlink" title="剑来"></a>剑来</h1><p>大千世界，无奇不有。<br>天道崩塌，我，唯有一剑，可搬山，断江，倒海，降妖，镇魔，敕神，摘星，摧城，开天。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MYSQL的三种安装方式</title>
      <link href="//%5Bobject%20Object%5D/2023/04/02/MYSQL%E7%9A%84%E4%B8%89%E7%A7%8D%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F/"/>
      <url>//%5Bobject%20Object%5D/2023/04/02/MYSQL%E7%9A%84%E4%B8%89%E7%A7%8D%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h2><p>官网：<a href="https://www.mysql.com/">https://www.mysql.com/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## MySQL5.6：GA 6-12个月，小版本是偶数版</span></span><br><span class="line"><span class="comment">## MySQL5.7：GA 6-12个月，小版本是偶数版，mysql5.7.20以上版本（MGR自带高可用）</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230328205032652.png" alt="image-20230328205032652"> </p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230328205052241.png" alt="image-20230328205052241"> </p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230328205101549.png" alt="image-20230328205101549"> </p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230328205110735.png" alt="image-20230328205110735"> </p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><div class="table-container"><table><thead><tr><th>主机名</th><th>IP</th><th>安装方式</th></tr></thead><tbody><tr><td>db01</td><td>10.0.0.51</td><td>yum安装</td></tr><tr><td>db02</td><td>10.0.0.52</td><td>5.6源码</td></tr><tr><td>db03</td><td>10.0.0.53</td><td>5.6二进制</td></tr><tr><td>db04</td><td>10.0.0.54</td><td>5.7二进制</td></tr></tbody></table></div><h2 id="MySQLyum安装"><a href="#MySQLyum安装" class="headerlink" title="MySQLyum安装"></a>MySQLyum安装</h2><ol><li><p>下载MySQL官方源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh https://dev.mysql.com/get/mysql80-community-release-el7-7.noarch.rpm</span><br></pre></td></tr></table></figure></li><li><p>查看仓库中支持哪些MySQL安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list|grep mysql</span><br></pre></td></tr></table></figure></li><li><p>修改yum仓库配置文件 // 关闭mysql80仓库 开启mysql57仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db01,172.16.1.51 <span class="comment">#vim mysql-community.repo</span></span><br><span class="line"></span><br><span class="line">[mysql57-community]</span><br><span class="line">name=MySQL 5.7 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-5.7-</span><br><span class="line">community/el/7/<span class="variable">$basearch</span></span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql-2022</span><br><span class="line">file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br><span class="line"></span><br><span class="line">[mysql80-community]</span><br><span class="line">name=MySQL 8.0 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-8.0-</span><br><span class="line">community/el/7/<span class="variable">$basearch</span></span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql-2022</span><br><span class="line">file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br></pre></td></tr></table></figure></li><li><p>安装MySQL Server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@db01,172.16.1.51:/etc/yum.repos.d <span class="comment"># yum install -y mysql-server</span></span><br></pre></td></tr></table></figure></li><li><p>启动MySQL（自动初始化）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@db01,172.16.1.51:~ <span class="comment"># systemctl start mysqld</span></span><br></pre></td></tr></table></figure></li><li><p>MySQL5.7初始密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db01,172.16.1.51:~ <span class="comment"># cat /var/log/mysqld.log</span></span><br><span class="line">root@db01,172.16.1.51:~ <span class="comment"># grep &#x27;password&#x27; /var/log/mysqld.log</span></span><br><span class="line">2023-03-28T04:38:20.263481Z 1 [Note] A temporary password is</span><br><span class="line">generated <span class="keyword">for</span> root@localhost: aslDSBoyy2<span class="comment">#y</span></span><br></pre></td></tr></table></figure></li><li><p>连接MySQL(有特殊符号进不去可以加’’号)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -paslDSBoyy2<span class="comment">#y</span></span><br></pre></td></tr></table></figure></li><li><p>第一次登录需要修改密码(第一次修改密码要符合策略)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -paslDSBoyy2<span class="comment">#y password &#x27;123@dianCOM&#x27;</span></span><br></pre></td></tr></table></figure></li></ol><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230328205711254.png" alt="image-20230328205711254"> </p><h2 id="MySQL5-6-50"><a href="#MySQL5-6-50" class="headerlink" title="MySQL5.6.50"></a>MySQL5.6.50</h2><h3 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h3><p>安装MySQL需要C语言环境<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc glibc gcc-c++ cmake openssl-devel ncurses-devel autoconf</span><br></pre></td></tr></table></figure></p><p>解压源码包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf mysql-5.6.50.tar.gz</span><br></pre></td></tr></table></figure></p><p>生成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/app/mysql-5.6.50 \</span><br><span class="line">-DMYSQL_DATADIR=/app/mysql-5.6.50/data \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/app/mysql-5.6.50/tmp/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line">-DWITH_SSL=system \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line">-DWITH_DEBUG=0</span><br></pre></td></tr></table></figure></p><p>解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定安装目录</span></span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/app/mysql-5.6.50 \</span><br><span class="line"><span class="comment">#数据存放位置</span></span><br><span class="line">-DMYSQL_DATADIR=/app/mysql-5.6.50/data \</span><br><span class="line"><span class="comment">#socket文件存放位置</span></span><br><span class="line">-DMYSQL_UNIX_ADDR=/app/mysql-5.6.50/tmp/mysql.sock \</span><br><span class="line"><span class="comment">#使用utf8字符集</span></span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line"><span class="comment">#校验规则</span></span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line"><span class="comment">#使用其他额外的字符集</span></span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line"><span class="comment">#支持的存储引擎</span></span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#禁用的存储引擎</span></span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#启用zlib库支持（zib、gzib相关）</span></span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line"><span class="comment">#启用SSL库支持（安全套接层）</span></span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line"><span class="comment">#启用本地数据导入支持</span></span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line"><span class="comment">#编译嵌入式服务器支持</span></span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line"><span class="comment"># mysql5.6支持了google的c++mock框架了，允许下载，否则会安装报错。</span></span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line"><span class="comment">#禁用debug（默认为禁用）</span></span><br><span class="line">-DWITH_DEBUG=0</span><br></pre></td></tr></table></figure></p><p>编译&amp;&amp;安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>创建安装目录的软链接(方便更新)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /app/mysql-5.6.50 /app/mysql</span><br></pre></td></tr></table></figure></p><p>编辑并替换配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /app/mysql/support-files/my-default.cnf /etc/my.cnf</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br></pre></td></tr></table></figure></p><p>拷贝启动脚本文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /app/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br></pre></td></tr></table></figure></p><p>创建socket文件存放目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /app/mysql/tmp</span><br></pre></td></tr></table></figure></p><p>创建MySQL程序用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@db02,172.16.1.52:/app/mysql/scripts <span class="comment"># useradd mysql -s /sbin/nologin -M</span></span><br></pre></td></tr></table></figure></p><p>进入初始化程序存放目录并初始化<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /app/mysql/scripts &amp;&amp; ./mysql_install_db --user=mysql --</span><br><span class="line">basedir=/app/mysql-5.6.50 --datadir=/app/mysql-5.6.50/data</span><br></pre></td></tr></table></figure></p><p>授权<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R mysql.mysql /app/mysql*</span><br></pre></td></tr></table></figure></p><p>启动服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p><p>添加环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile.d/mysql.sh</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/app/mysql/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure></p><p>允许环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile.d/mysql.sh</span><br></pre></td></tr></table></figure></p><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230330014017042.png" alt="image-20230330014017042"> </p><h3 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h3><p>1.安装依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y autoconf libaio-devel</span><br></pre></td></tr></table></figure></p><p>2.解压mysql二进制包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf mysql-5.6.50-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p><p>3.创建安装目录并移动MySQL到安装目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /app &amp;&amp; <span class="built_in">mv</span> mysql-5.6.50-linux-glibc2.12-x86_64 /app/mysql-5.6.50</span><br></pre></td></tr></table></figure></p><p>4.创建安装目录的软链接(方便更新)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /app/mysql-5.6.50 /app/mysql</span><br></pre></td></tr></table></figure></p><p>5.修改配置文件参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql // 指定程序安装的目录</span><br><span class="line">datadir=/app/mysql/data // 指定程序的数据存放目录</span><br></pre></td></tr></table></figure></p><p>6.拷贝启动脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /app/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br></pre></td></tr></table></figure></p><p>7.创建mysql用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd mysql -s /sbin/nologin -M</span><br></pre></td></tr></table></figure></p><p>8.初始化<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./mysql_install_db --user=mysql --basedir=/app/mysql --</span><br><span class="line">datadir=/app/mysql/data</span><br></pre></td></tr></table></figure></p><p>9.启动mysql<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p><p>10.修改启动脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#/usr/local#/app#g&#x27;</span> /etc/init.d/mysqld</span><br></pre></td></tr></table></figure></p><p>11.启动mysql<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p><p>12.添加环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile.d/mysql.sh</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/app/mysql/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure></p><p>13.允许环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile.d/mysql.sh</span><br></pre></td></tr></table></figure></p><p>14.登陆数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br></pre></td></tr></table></figure></p><h2 id="systemd管理mysql"><a href="#systemd管理mysql" class="headerlink" title="systemd管理mysql"></a>systemd管理mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用安装目录下的脚本文件启动</span></span><br><span class="line">/app/mysql-5.6.50/bin/mysqld --basedir=/app/mysql-5.6.50 --</span><br><span class="line">datadir=/app/mysql-5.6.50/data --plugin-dir=/app/mysql-5.6.50/lib/plugin --</span><br><span class="line">user=mysql --log-error=db02.err --pid-file=/app/mysql-5.6.50/data/db02.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化后(使用安装目录下的脚本文件启动)</span></span><br><span class="line">/app/mysql/bin/mysqld --defaults-file=/etc/my.cnf --user=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件(将mysql添加到system管理)</span></span><br><span class="line">vim /usr/lib/systemd/system/mysqld.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line"></span><br><span class="line"><span class="comment">## 服务描述</span></span><br><span class="line">After=network.target,syslog.target</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在此服务后启动</span></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/app/mysql/bin/mysqld --defaults-file=/etc/my.cnf --user=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动脚本</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br></pre></td></tr></table></figure><h2 id="密码相关操作"><a href="#密码相关操作" class="headerlink" title="密码相关操作"></a>密码相关操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更改密码mysql 5.7</span></span><br><span class="line">mysql&gt; alter user root@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;xxxxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改密码mysql 5.6</span></span><br><span class="line">mysqladmin -uroot -p password <span class="string">&#x27;123&#x27;</span></span><br><span class="line">mysqladmin -uroot -p password <span class="string">&#x27;456&#x27;</span></span><br><span class="line">mysqladmin -uroot -p456 password <span class="string">&#x27;789&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="MySQL5-7-40"><a href="#MySQL5-7-40" class="headerlink" title="MySQL5.7.40"></a>MySQL5.7.40</h2><h3 id="源码安装-1"><a href="#源码安装-1" class="headerlink" title="源码安装"></a>源码安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装MySQL需要C语言环境</span></span><br><span class="line">yum install -y gcc glibc gcc-c++ cmake openssl-devel ncurses-devel autoconf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压源码包</span></span><br><span class="line">tar xf mysql-boost-5.7.40.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在源码包解压目录生成安装文件(自定义安装 nginx:./configure mysql: cmake || gmake)</span></span><br><span class="line"><span class="built_in">cd</span> /root/mysql-5.7.40/</span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/app/mysql-5.7.40 \</span><br><span class="line">-DMYSQL_DATADIR=/app/mysql-5.7.40/data \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/app/mysql-5.7.40/tmp/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line">-DWITH_SSL=system \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line">-DWITH_DEBUG=0 \</span><br><span class="line">-DDOWNLOAD_BOOST=1 \</span><br><span class="line">-DWITH_BOOST=/root/mysql-5.7.40/boost/boost_1_59_0</span><br><span class="line"></span><br><span class="line"><span class="comment">## 解析</span></span><br><span class="line"><span class="comment">#指定安装目录</span></span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/app/mysql-5.6.50 \</span><br><span class="line"><span class="comment">#数据存放位置</span></span><br><span class="line">-DMYSQL_DATADIR=/app/mysql-5.6.50/data \</span><br><span class="line"><span class="comment">#socket文件存放位置</span></span><br><span class="line">-DMYSQL_UNIX_ADDR=/app/mysql-5.6.50/tmp/mysql.sock \</span><br><span class="line"><span class="comment">#使用utf8字符集</span></span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line"><span class="comment">#校验规则</span></span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line"><span class="comment">#使用其他额外的字符集</span></span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line"><span class="comment">#支持的存储引擎</span></span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#禁用的存储引擎</span></span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#启用zlib库支持（zib、gzib相关）</span></span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line"><span class="comment">#启用SSL库支持（安全套接层）</span></span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line"><span class="comment">#启用本地数据导入支持</span></span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line"><span class="comment">#编译嵌入式服务器支持</span></span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line"><span class="comment"># mysql5.6支持了google的c++mock框架了，允许下载，否则会安装报错。</span></span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line"><span class="comment">#禁用debug（默认为禁用）</span></span><br><span class="line">-DWITH_DEBUG=0</span><br><span class="line"><span class="comment">#启用下载boost(已下载自动忽略)</span></span><br><span class="line">-DDOWNLOAD_BOOST=1 \</span><br><span class="line"><span class="comment"># 指定本地已有boost目录</span></span><br><span class="line">-DWITH_BOOST=/root/mysql-5.7.40/boost/boost_1_59_0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译&amp;&amp;安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建安装目录的软链接(方便更新)</span></span><br><span class="line"><span class="built_in">ln</span> -s /app/mysql-5.7.40 /app/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑并替换配置文件</span></span><br><span class="line"><span class="built_in">cp</span> /app/mysql/support-files/my-default.cnf /etc/my.cnf</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝启动脚本文件</span></span><br><span class="line"><span class="built_in">cp</span> /app/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建socket文件存放目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /app/mysql/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建MySQL程序用户</span></span><br><span class="line">useradd mysql -s /sbin/nologin -M</span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line"><span class="built_in">chown</span> -R mysql.mysql /app/mysql*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入初始化程序存放目录并初始化  （-insecure不安全，无密码）</span></span><br><span class="line"><span class="built_in">cd</span> /app/mysql/bin</span><br><span class="line">./mysqld --initialize-insecure --user=mysql --basedir=/app/mysql --datadir=/app/mysql/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加环境变量</span></span><br><span class="line">vim /etc/profile.d/mysql.sh</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/app/mysql/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆数据库  （-insecure指定后，没有这一步）</span></span><br><span class="line">mysql -uroot -p<span class="string">&#x27;Bcm+FH51Ej3V&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230330014155489.png" alt="image-20230330014155489"> </p><h3 id="二进制安装-1"><a href="#二进制安装-1" class="headerlink" title="二进制安装"></a>二进制安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">yum install -y autoconf libaio-devel cmake</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压mysql二进制包</span></span><br><span class="line">tar xf mysql-5.7.40-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建安装目录并移动MySQL到安装目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /app</span><br><span class="line"><span class="built_in">mv</span> mysql-5.7.40-linux-glibc2.12-x86_64 /app/mysql-5.7.40</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建安装目录的软链接(方便更新)</span></span><br><span class="line"><span class="built_in">ln</span> -s /app/mysql-5.7.40 /app/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件参数</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/app/mysql // 指定程序安装的目录</span><br><span class="line">datadir=/app/mysql/data // 指定程序的数据存放目录</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝启动脚本</span></span><br><span class="line"><span class="built_in">cp</span> /app/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建mysql用户</span></span><br><span class="line">useradd mysql -s /sbin/nologin -M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化（-insecure不安全，无密码）</span></span><br><span class="line">./mysqld --initialize-insecure --user=mysql --basedir=/app/mysql --</span><br><span class="line">datadir=/app/mysql/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动mysql</span></span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改启动脚本</span></span><br><span class="line">sed -i <span class="string">&#x27;s#/usr/local#/app#g&#x27;</span> /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动mysql</span></span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加环境变量</span></span><br><span class="line">vim /etc/profile.d/mysql.sh</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/app/mysql/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆数据库  （-insecure指定后，没有这一步）</span></span><br><span class="line">mysql -uroot -p<span class="string">&#x27;l%)aPDhA5PCA&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="5-6与5-7安装区别"><a href="#5-6与5-7安装区别" class="headerlink" title="5.6与5.7安装区别"></a>5.6与5.7安装区别</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/application/mysql-5.7.20 \</span><br><span class="line">-DMYSQL_DATADIR=/application/mysql-5.7.20/data \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/application/mysql-5.7.20/tmp/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line">-DWITH_DEBUG=0 \</span><br><span class="line">-DDOWNLOAD_BOOST=1 \</span><br><span class="line">-DWITH_BOOST=/usr/local/boost_1_59_0</span><br><span class="line"></span><br><span class="line"><span class="comment">## 二进制</span></span><br><span class="line">root@db03,172.16.1.53:~ <span class="comment"># tar xf mysql-5.7.40-linux-glibc2.12-</span></span><br><span class="line">x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">root@db03,172.16.1.53:~ <span class="comment"># mv mysql-5.7.40-linux-glibc2.12-x86_64</span></span><br><span class="line">/app/mysql-5.7.40</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 初始化</span></span><br><span class="line">./mysqld --initialize --user=mysql --basedir=/app/mysql-5.7.40 --datadir=/app/mysql-5.7.40/data</span><br><span class="line"></span><br><span class="line">./mysqld --initialize-insecure --user=mysql --basedir=/app/mysql-5.7.40 --datadir=/app/mysql-5.7.40/data</span><br></pre></td></tr></table></figure><p><img src="https://demo-immg.oss-cn-shanghai.aliyuncs.com/note/image-20230330192248152.png" alt="image-20230330192248152"> </p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>第一篇文章</title>
      <link href="//%5Bobject%20Object%5D/2023/03/29/2023-3-29-%E7%AC%AC%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0/"/>
      <url>//%5Bobject%20Object%5D/2023/03/29/2023-3-29-%E7%AC%AC%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="这日风和日丽的一天！"><a href="#这日风和日丽的一天！" class="headerlink" title="这日风和日丽的一天！"></a>这日风和日丽的一天！</h2>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>第三篇文章</title>
      <link href="//%5Bobject%20Object%5D/2023/03/29/2023-3-29-%E7%AC%AC%E4%B8%89%E7%AF%87%E6%96%87%E7%AB%A0/"/>
      <url>//%5Bobject%20Object%5D/2023/03/29/2023-3-29-%E7%AC%AC%E4%B8%89%E7%AF%87%E6%96%87%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="我的第三篇文章"><a href="#我的第三篇文章" class="headerlink" title="我的第三篇文章!"></a>我的第三篇文章!</h2>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>第四篇文章</title>
      <link href="//%5Bobject%20Object%5D/2023/03/29/2023-3-29-%E7%AC%AC%E5%9B%9B%E7%AF%87%E6%96%87%E7%AB%A0/"/>
      <url>//%5Bobject%20Object%5D/2023/03/29/2023-3-29-%E7%AC%AC%E5%9B%9B%E7%AF%87%E6%96%87%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="我的第四篇文章"><a href="#我的第四篇文章" class="headerlink" title="我的第四篇文章!"></a>我的第四篇文章!</h2>]]></content>
      
      
      <categories>
          
          <category> medo </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>关于</title>
      <link href="/about/index.html"/>
      <url>/about/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/font.css"/>
      <url>/css/font.css</url>
      
        <content type="html"><![CDATA[@font-face {    /* 为载入的字体取名字(随意) */    font-family: 'Consola';    /* 字体文件地址(相对或者绝对路径都可以) */    src: url(/font/consola.ttf);    /* 定义加粗样式(加粗多少) */    font-weight: normal;    /* 定义字体样式(斜体/非斜体) */    font-style: normal;    /* 定义显示样式 */    font-display: block;  }@font-face {    /* 为载入的字体取名字(随意) */    font-family: 'TTBZ';    /* 字体文件地址(相对或者绝对路径都可以) */    src: url(/font/ttboz.ttf);    /* 定义加粗样式(加粗多少) */    font-weight: normal;    /* 定义字体样式(斜体/非斜体) */    font-style: normal;    /* 定义显示样式 */    font-display: block;  }]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/custom.css"/>
      <url>/css/custom.css</url>
      
        <content type="html"><![CDATA[/* 页面透明 *//* 页脚与头图透明 */#footer {    background: transparent !important;  }#page-header {    background: transparent !important;  }    /* 白天模式遮罩透明#footer::before {    background: transparent !important;  }#page-header::before {    background: transparent !important;  }    /* 夜间模式遮罩透明 */[data-theme="dark"] #footer::before {    background: transparent !important;  }[data-theme="dark"] #page-header::before {    background: transparent !important;  }div#post {    /* 最后一个值为透明度可以自己指定 */    background: rgba(255,255,255,.3);    /* 透明模糊亚克力 */    backdrop-filter: var(--backdrop-filter);  }/* 翻页按钮居中 */#pagination {    width: 100%;    margin: auto;}/* 魔改导航栏 *//* 一级菜单居中 */#nav .menus_items {    position: absolute !important;    width: fit-content !important;    left: 50% !important;    transform: translateX(-50%) !important;}/* 子菜单横向展示 */#nav .menus_items .menus_item:hover .menus_item_child {    display: flex !important;}/* 这里的2是代表导航栏的第2个元素，即有子菜单的元素，可以按自己需求修改 */.menus_items .menus_item:nth-child(5) .menus_item_child {    left: -38px;}/* 黑夜霓虹灯 *//* 日间模式不生效 */[data-theme="light"] #site-name,[data-theme="light"] #site-title,[data-theme="light"] #site-subtitle,[data-theme="light"] #post-info {  animation: none;}/* 夜间模式生效 */[data-theme="dark"] #site-name,[data-theme="dark"] #site-title {  animation: light_15px 10s linear infinite;}[data-theme="dark"] #site-subtitle {  animation: light_10px 10s linear infinite;}[data-theme="dark"] #post-info {  animation: light_5px 10s linear infinite;}/* 关键帧描述 */@keyframes light_15px {  0% {    text-shadow: #5636ed 0 0 15px;  }  12.5% {    text-shadow: #11ee5e 0 0 15px;  }  25% {    text-shadow: #f14747 0 0 15px;  }  37.5% {    text-shadow: #f1a247 0 0 15px;  }  50% {    text-shadow: #f1ee47 0 0 15px;  }  50% {    text-shadow: #b347f1 0 0 15px;  }  62.5% {    text-shadow: #002afa 0 0 15px;  }  75% {    text-shadow: #ed709b 0 0 15px;  }  87.5% {    text-shadow: #39c5bb 0 0 15px;  }  100% {    text-shadow: #5636ed 0 0 15px;  }}@keyframes light_10px {  0% {    text-shadow: #5636ed 0 0 10px;  }  12.5% {    text-shadow: #11ee5e 0 0 10px;  }  25% {    text-shadow: #f14747 0 0 10px;  }  37.5% {    text-shadow: #f1a247 0 0 10px;  }  50% {    text-shadow: #f1ee47 0 0 10px;  }  50% {    text-shadow: #b347f1 0 0 10px;  }  62.5% {    text-shadow: #002afa 0 0 10px;  }  75% {    text-shadow: #ed709b 0 0 10px;  }  87.5% {    text-shadow: #39c5bb 0 0 10px;  }  100% {    text-shadow: #5636ed 0 0 10px;  }}@keyframes light_5px {  0% {    text-shadow: #5636ed 0 0 5px;  }  12.5% {    text-shadow: #11ee5e 0 0 5px;  }  25% {    text-shadow: #f14747 0 0 5px;  }  37.5% {    text-shadow: #f1a247 0 0 15px;  }  50% {    text-shadow: #f1ee47 0 0 5px;  }  50% {    text-shadow: #b347f1 0 0 5px;  }  62.5% {    text-shadow: #002afa 0 0 5px;  }  75% {    text-shadow: #ed709b 0 0 5px;  }  87.5% {    text-shadow: #39c5bb 0 0 5px;  }  100% {    text-shadow: #5636ed 0 0 5px;  }}/* 侧边栏个人信息卡片动态渐变色 */#aside-content > .card-widget.card-info {    background: linear-gradient(      -45deg,      #e8d8b9,      #eccec5,      #a3e9eb,      #bdbdf0,      #eec1ea    );    box-shadow: 0 0 5px rgb(66, 68, 68);    position: relative;    background-size: 400% 400%;    -webkit-animation: Gradient 10s ease infinite;    -moz-animation: Gradient 10s ease infinite;    animation: Gradient 10s ease infinite !important;  }  @-webkit-keyframes Gradient {    0% {      background-position: 0% 50%;    }    50% {      background-position: 100% 50%;    }    100% {      background-position: 0% 50%;    }  }  @-moz-keyframes Gradient {    0% {      background-position: 0% 50%;    }    50% {      background-position: 100% 50%;    }    100% {      background-position: 0% 50%;    }  }  @keyframes Gradient {    0% {      background-position: 0% 50%;    }    50% {      background-position: 100% 50%;    }    100% {      background-position: 0% 50%;    }  }  /* 个人卡片渐变 */  /* 黑夜模式适配 */[data-theme="dark"] #aside-content > .card-widget.card-info {    background: #191919ee;  }    /* 个人信息Follow me按钮 */#aside-content > .card-widget.card-info > #card-info-btn {    background-color: #3eb8be;    border-radius: 8px;  }/* 鼠标样式 */#cursor {  position: fixed;  width: 16px;  height: 16px;  /* 这里改变跟随的底色 */  background: rgb(57, 197, 187);  border-radius: 8px;  opacity: 0.25;  z-index: 10086;  pointer-events: none;  transition: 0.2s ease-in-out;  transition-property: background, opacity, transform;}#cursor.hidden {  opacity: 0;}#cursor.hover {  opacity: 0.1;  transform: scale(2.5);  -webkit-transform: scale(2.5);  -moz-transform: scale(2.5);  -ms-transform: scale(2.5);  -o-transform: scale(2.5);}#cursor.active {  opacity: 0.5;  transform: scale(0.5);  -webkit-transform: scale(0.5);  -moz-transform: scale(0.5);  -ms-transform: scale(0.5);  -o-transform: scale(0.5);}/* 页面样式-抹角等 */:root {  --trans-light: rgba(255, 255, 255, 0.88);  --trans-dark: rgba(25, 25, 25, 0.66);  --border-style: 1px solid rgb(169, 169, 169);  --backdrop-filter: blur(5px) saturate(150%);}/* 首页文章卡片 */#recent-posts > .recent-post-item {  background: var(--trans-light);  backdrop-filter: var(--backdrop-filter);  border-radius: 25px;  border: var(--border-style);}/* 首页侧栏卡片 */#aside-content .card-widget {  background: var(--trans-light);  backdrop-filter: var(--backdrop-filter);  border-radius: 18px;  border: var(--border-style);}/* 文章页、归档页、普通页面 */div#post,div#page,div#archive {  background: var(--trans-light);  backdrop-filter: var(--backdrop-filter);  border: var(--border-style);  border-radius: 20px;}/* 导航栏 */#page-header.nav-fixed #nav {  background: rgba(255, 255, 255, 0.75);  backdrop-filter: var(--backdrop-filter);}[data-theme="dark"] #page-header.nav-fixed #nav {  background: rgba(0, 0, 0, 0.7) !important;}/* 夜间模式遮罩 */[data-theme="dark"] #recent-posts > .recent-post-item,[data-theme="dark"] #aside-content .card-widget,[data-theme="dark"] div#post,[data-theme="dark"] div#archive,[data-theme="dark"] div#page {  background: var(--trans-dark);}/* 夜间模式页脚页头遮罩透明 */[data-theme="dark"] #footer::before {  background: transparent !important;}[data-theme="dark"] #page-header::before {  background: transparent !important;}/* 阅读模式 */.read-mode #aside-content .card-widget {  background: rgba(158, 204, 171, 0.5) !important;}.read-mode div#post {  background: rgba(158, 204, 171, 0.5) !important;}/* 夜间模式下的阅读模式 */[data-theme="dark"] .read-mode #aside-content .card-widget {  background: rgba(34, 34, 34, 0.9) !important;  color: #ffffff;}[data-theme="dark"] .read-mode div#post {  background: rgba(32, 32, 32, 0.9) !important;  color: #ffffff;}/* 风车转动 *//* 文章页H1-H6图标样式效果 *//* 控制风车转动速度 4s那里可以自己调节快慢 */h1::before,h2::before,h3::before,h4::before,h5::before,h6::before {  -webkit-animation: ccc 4s linear infinite;  animation: ccc 4s linear infinite;}/* 控制风车转动方向 -1turn 为逆时针转动，1turn 为顺时针转动，相同数字部分记得统一修改 */@-webkit-keyframes ccc {  0% {    -webkit-transform: rotate(0deg);    transform: rotate(0deg);  }  to {    -webkit-transform: rotate(-1turn);    transform: rotate(-1turn);  }}@keyframes ccc {  0% {    -webkit-transform: rotate(0deg);    transform: rotate(0deg);  }  to {    -webkit-transform: rotate(-1turn);    transform: rotate(-1turn);  }}/* 设置风车颜色 */#content-inner.layout h1::before {  color: #ef50a8;  margin-left: -1.55rem;  font-size: 1.3rem;  margin-top: -0.23rem;}#content-inner.layout h2::before {  color: #fb7061;  margin-left: -1.35rem;  font-size: 1.1rem;  margin-top: -0.12rem;}#content-inner.layout h3::before {  color: #ffbf00;  margin-left: -1.22rem;  font-size: 0.95rem;  margin-top: -0.09rem;}#content-inner.layout h4::before {  color: #a9e000;  margin-left: -1.05rem;  font-size: 0.8rem;  margin-top: -0.09rem;}#content-inner.layout h5::before {  color: #57c850;  margin-left: -0.9rem;  font-size: 0.7rem;  margin-top: 0rem;}#content-inner.layout h6::before {  color: #5ec1e0;  margin-left: -0.9rem;  font-size: 0.66rem;  margin-top: 0rem;}/* s设置风车hover动效 6s那里可以自己调节快慢*/#content-inner.layout h1:hover,#content-inner.layout h2:hover,#content-inner.layout h3:hover,#content-inner.layout h4:hover,#content-inner.layout h5:hover,#content-inner.layout h6:hover {  color: var(--theme-color);}#content-inner.layout h1:hover::before,#content-inner.layout h2:hover::before,#content-inner.layout h3:hover::before,#content-inner.layout h4:hover::before,#content-inner.layout h5:hover::before,#content-inner.layout h6:hover::before {  color: var(--theme-color);  -webkit-animation: ccc 6s linear infinite;  animation: ccc 6s linear infinite;}/* 右边定位挂件 */body::-webkit-scrollbar {  width: 0;}.neko {  width: 64px;  height: 64px;  background-image: url("https://bu.dusays.com/2022/07/20/62d812db74be9.png");  position: absolute;  right: 32px;  background-repeat: no-repeat;  background-size: contain;  transform: translateX(50%);  cursor: pointer;  font-family: tzy;  font-weight: 600;  font-size: 16px;  color: #6f42c1;  display: none;}.neko::after {  display: none;  width: 100px;  height: 100px;  background-image: url("https://bu.dusays.com/2022/07/20/62d812d95e6f5.png");  background-size: contain;  z-index: 9999;  position: absolute;  right: 50%;  text-align: center;  line-height: 100px;  top: -115%;}.neko.showMsg::after {  content: attr(data-msg);  display: block;  overflow: hidden;  text-overflow: ellipsis;}.neko:hover::after {  content: attr(data-msg);  display: block;  overflow: hidden;  text-overflow: ellipsis;}.neko.fontColor::after {  color: #333;}/*** @description: 滚动条样式  跟猫二选一*/@media screen and (max-width:992px) {  ::-webkit-scrollbar {      width: 8px !important;      height: 8px !important  }  ::-webkit-scrollbar-track {      border-radius: 2em;  }  ::-webkit-scrollbar-thumb {      background-color: rgb(255 255 255 / .3);      background-image: -webkit-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent);      border-radius: 2em  }  ::-webkit-scrollbar-corner {      background-color: transparent  }}/* 右键菜单 */#rightMenu {  display: none;  position: fixed;  width: 160px;  height: fit-content;  top: 10%;  left: 10%;    /* 菜单面板背景色 */  background-color: var(--card-bg);    /* 菜单面板文字颜色 */  border: 1px solid var(--font-color);  border-radius: 8px;  z-index: 100;}#rightMenu .rightMenu-group {  padding: 7px 6px;}#rightMenu .rightMenu-group:not(:nth-last-child(1)) {  border-bottom: 1px solid var(--font-color);}#rightMenu .rightMenu-group.rightMenu-small {  display: flex;  justify-content: space-between;}#rightMenu .rightMenu-group .rightMenu-item {  height: 30px;  line-height: 30px;  border-radius: 8px;  transition: 0.3s;  color: var(--font-color);}#rightMenu .rightMenu-group.rightMenu-line .rightMenu-item {  display: flex;  height: 40px;  line-height: 40px;  padding: 0 4px;}#rightMenu .rightMenu-group .rightMenu-item:hover {    /* 鼠标悬浮选项颜色 */  background-color: var(--text-bg-hover);}#rightMenu .rightMenu-group .rightMenu-item i {  display: inline-block;  text-align: center;  line-height: 30px;  width: 30px;  height: 30px;  padding: 0 5px;}#rightMenu .rightMenu-group .rightMenu-item span {  line-height: 30px;}#rightMenu .rightMenu-group.rightMenu-line .rightMenu-item * {  height: 40px;  line-height: 40px;}.rightMenu-group.hide {  display: none;}/* 全局宽度 */.layout {  max-width: 1400px;}/* 侧边卡片栏宽度 */.aside-content {  max-width: 318px;  min-width: 300px;}/* 平板尺寸自适应(不启用侧边栏宽度限制) */@media screen and (max-width: 900px) {  .aside-content {    max-width: none !important;    padding: 0 5px 0 5px;  }}/* 除了首页以外其他页面隐藏卡片，并采用宽屏显示 */#archive,#page,#category,#tag {  width: 100%;}.page:not(.page.home) .aside-content {  display: none;}/* tzy页脚样式 */#ft {  max-width: 1200px;  margin: 0 auto 12px;  display: flex;  color: rgb(255 255 255 / 80%) !important;  text-align: left;  flex-wrap: wrap;}.ft-item-1,.ft-item-2 {  display: flex;  height: 100%;  padding: 2px 14px;}.ft-item-1 {  flex-direction: column;  flex: 2;}.ft-item-2 {  flex: 1;  flex-direction: column;}.t-top {  display: flex;}.t-top .t-t-l {  display: flex;  flex-direction: column;  flex: 1.4;  margin-right: 10px;}.t-top .t-t-l .bg-ad {  width: 85%;  border-radius: 10px;  padding: 0 10px;}.btn-xz-box {  margin-top: 10px;}/* 按钮背景颜色等 */.btn-xz {  display: block;  background-color: var(--btn-bg);  color: var(--btn-color);  text-align: center;  line-height: 2.4;  margin: 8px 0;}.btn-xz:hover {  text-decoration: none !important;}/* 按钮悬浮颜色 */.btn-xz-box:hover .btn-xz {  background-color: var(--text-bg-hover);}.t-top .t-t-r {  display: flex;  flex-direction: column;  flex: 1;}.ft-links {  padding: 0 14px;  list-style: none;  margin-top: 0 !important;}.ft-links li a {  display: inline-block !important;  width: 50%;}/* 链接悬浮颜色 */.ft-links li a:hover {  text-decoration: none !important;  color: var(--theme-color) !important;}.ft-item-2 .ft-img-group {  width: 100%;}.ft-t {  font-size: 1.1rem;  margin-bottom: 20px;  line-height: 1;  font-weight: 600;}.t-l-t {  padding-left: 14px;}.ft-item-2 .ft-img-group .img-group-item {  display: inline-block;  width: 18.4%;  margin-right: 14px;  margin-bottom: 6px;}.ft-item-2 .ft-img-group .img-group-item a {  display: inline-block;  width: 100%;  height: 100%;}.ft-item-2 .ft-img-group .img-group-item a img {  width: 100%;  max-height: 80px;  border-radius: 10px;}/* 头像悬浮颜色框 */.ft-item-2 .ft-img-group .img-group-item a img:hover {  border: 2px solid var(--theme-color);}@media screen and (max-width: 768px) {  .ft-item-1 {    flex-basis: 100% !important;  }  .ft-item-2 {    flex-basis: 100% !important;  }  .t-top .t-t-l .bg-ad {    width: 100%;  }}@media screen and (max-width: 576px) {  .t-top {    flex-wrap: wrap;  }  .t-top .t-t-l {    flex-basis: 100% !important;  }  .t-top .t-t-r {    margin-top: 16px;    flex-basis: 100% !important;  }}#footer-wrap a {  border-radius: 30px;}#footer-wrap {  padding: 20px 20px;}/* 页脚心跳动画 */#heartbeat {  color: red;  animation: iconAnimate 1s ease-in-out infinite;}@-moz-keyframes iconAnimate {  0%,  100% {    transform: scale(1);  }  10%,  30% {    transform: scale(0.9);  }  20%,  40%,  60%,  80% {    transform: scale(1.1);  }  50%,  70% {    transform: scale(1.1);  }}@-webkit-keyframes iconAnimate {  0%,  100% {    transform: scale(1);  }  10%,  30% {    transform: scale(0.9);  }  20%,  40%,  60%,  80% {    transform: scale(1.1);  }  50%,  70% {    transform: scale(1.1);  }}@-o-keyframes iconAnimate {  0%,  100% {    transform: scale(1);  }  10%,  30% {    transform: scale(0.9);  }  20%,  40%,  60%,  80% {    transform: scale(1.1);  }  50%,  70% {    transform: scale(1.1);  }}@keyframes iconAnimate {  0%,  100% {    transform: scale(1);  }  10%,  30% {    transform: scale(0.9);  }  20%,  40%,  60%,  80% {    transform: scale(1.1);  }  50%,  70% {    transform: scale(1.1);  }}/* 帧率检测 */#fps {  position: fixed;  /* 指定位置 */  left: 10px;  bottom: 10px;  z-index: 1919810;}[data-theme="light"] #fps {  background-color: rgba(255, 255, 255, 0.85);  backdrop-filter: var(--backdrop-filter);  padding: 4px;  border-radius: 4px;}[data-theme="dark"] #fps {  background-color: rgba(0, 0, 0, 0.72);  backdrop-filter: var(--backdrop-filter);  padding: 4px;  border-radius: 4px;}/* 头像呼吸灯 */[data-theme="light"] .avatar-img {  animation: huxi_light 4s ease-in-out infinite;}[data-theme="dark"] .avatar-img {  animation: huxi_dark 4s ease-in-out infinite;}@keyframes huxi_light {  0% {    box-shadow: 0px 0px 1px 1px #d83868;  }  50% {    box-shadow: 0px 0px 5px 5px #7626b8;  }  100% {    box-shadow: 0px 0px 1px 1px #15bd69;  }}@keyframes huxi_dark {  0% {    box-shadow: 0px 0px 1px 1px #3ed320;  }  50% {    box-shadow: 0px 0px 5px 5px #39c5bb;  }  100% {    box-shadow: 0px 0px 1px 1px #3ee614;  }}/* 波浪css */.main-hero-waves-area {  width: 100%;  position: absolute;  left: 0;  bottom: -11px;  z-index: 5;}.waves-area .waves-svg {  width: 100%;  height: 5rem;}/* Animation */.parallax > use {  animation: move-forever 25s cubic-bezier(0.55, 0.5, 0.45, 0.5) infinite;}.parallax > use:nth-child(1) {  animation-delay: -2s;  animation-duration: 7s;  fill: #f7f9febd;}.parallax > use:nth-child(2) {  animation-delay: -3s;  animation-duration: 10s;  fill: #f7f9fe82;}.parallax > use:nth-child(3) {  animation-delay: -4s;  animation-duration: 13s;  fill: #f7f9fe36;}.parallax > use:nth-child(4) {  animation-delay: -5s;  animation-duration: 20s;  fill: #f7f9fe;}/* 黑色模式背景 */[data-theme="dark"] .parallax > use:nth-child(1) {  animation-delay: -2s;  animation-duration: 7s;  fill: #18171dc8;}[data-theme="dark"] .parallax > use:nth-child(2) {  animation-delay: -3s;  animation-duration: 10s;  fill: #18171d80;}[data-theme="dark"] .parallax > use:nth-child(3) {  animation-delay: -4s;  animation-duration: 13s;  fill: #18171d3e;}[data-theme="dark"] .parallax > use:nth-child(4) {  animation-delay: -5s;  animation-duration: 20s;  fill: #18171d;}@keyframes move-forever {  0% {    transform: translate3d(-90px, 0, 0);  }  100% {    transform: translate3d(85px, 0, 0);  }}/*Shrinking for mobile*/@media (max-width: 768px) {  .waves-area .waves-svg {    height: 40px;    min-height: 40px;  }}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/readPercent.css"/>
      <url>/css/readPercent.css</url>
      
        <content type="html"><![CDATA[/* 返回顶部 */button#go-up #percent {    display: none;    font-weight: bold;    font-size: 15px !important;}button#go-up span {    font-size: 12px!important;    margin-right: -1px;}/* 鼠标滑动到按钮上时显示返回顶部图标 */button#go-up:hover i {    display: block !important;}button#go-up:hover #percent {    display: none !important;}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/progress_bar.css"/>
      <url>/css/progress_bar.css</url>
      
        <content type="html"><![CDATA[/* 博客加载条 */.pace {    -webkit-pointer-events: none;    pointer-events: none;    -webkit-user-select: none;    -moz-user-select: none;    user-select: none;    z-index: 2000;    position: fixed;    margin: auto;    top: 4px;    left: 0;    right: 0;    height: 8px;    border-radius: 8px;    width: 7rem;    background: #eaecf2;    border: 1px #e3e8f7;    overflow: hidden}.pace-inactive .pace-progress {    opacity: 0;    transition: .3s ease-in}.pace .pace-progress {    -webkit-box-sizing: border-box;    -moz-box-sizing: border-box;    -ms-box-sizing: border-box;    -o-box-sizing: border-box;    box-sizing: border-box;    -webkit-transform: translate3d(0, 0, 0);    -moz-transform: translate3d(0, 0, 0);    -ms-transform: translate3d(0, 0, 0);    -o-transform: translate3d(0, 0, 0);    transform: translate3d(0, 0, 0);    max-width: 200px;    position: absolute;    z-index: 2000;    display: block;    top: 0;    right: 100%;    height: 100%;    width: 100%;    /* linear-gradient(to right, #3494e6, #ec6ead) */    background: linear-gradient(to right, #43cea2, #3866ca);    animation: gradient 2s ease infinite;    background-size: 200%}.pace.pace-inactive {    opacity: 0;    transition: .3s;    top: -8px}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/universe.css"/>
      <url>/css/universe.css</url>
      
        <content type="html"><![CDATA[/* 背景宇宙星光  */#universe{    display: block;    position: fixed;    margin: 0;    padding: 0;    border: 0;    outline: 0;    left: 0;    top: 0;    width: 100%;    height: 100%;    pointer-events: none;    /* 这个是调置顶的优先级的，-1在文章页下面，背景上面，个人推荐这种 */    z-index: -1;  }]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/cat.js"/>
      <url>/js/cat.js</url>
      
        <content type="html"><![CDATA[/* 定位挂件 */if (document.body.clientWidth > 992) {    function getBasicInfo() {        /* 窗口高度 */        var ViewH = $(window).height();        /* document高度 */        var DocH = $("body")[0].scrollHeight;        /* 滚动的高度 */        var ScrollTop = $(window).scrollTop();        /* 可滚动的高度 */        var S_V = DocH - ViewH;        var Band_H = ScrollTop / (DocH - ViewH) * 100;        return {            ViewH: ViewH,            DocH: DocH,            ScrollTop: ScrollTop,            Band_H: Band_H,            S_V: S_V        }    };    function show(basicInfo) {        if (basicInfo.ScrollTop > 0.001) {            $(".neko").css('display', 'block');        } else {            $(".neko").css('display', 'none');        }    }    (function ($) {        $.fn.nekoScroll = function (option) {            var defaultSetting = {                top: '0',                scroWidth: 6 + 'px',                z_index: 9999,                zoom: 0.9,                borderRadius: 5 + 'px',                right: 60 + 'px',                // 这里可以换为你喜欢的图片，例如我就换为了雪人，但是要抠图                nekoImg: "https://bu.dusays.com/2022/07/20/62d812db74be9.png",                hoverMsg: "喵喵喵~",                color: "#6f42c1",                during: 500,                blog_body: "body",            };            var setting = $.extend(defaultSetting, option);            var getThis = this.prop("className") !== "" ? "." + this.prop("className") : this.prop("id") !== "" ? "#" +                this.prop("id") : this.prop("nodeName");            if ($(".neko").length == 0) {                this.after("<div class=\"neko\" id=" + setting.nekoname + " data-msg=\"" + setting.hoverMsg + "\"></div>");            }            let basicInfo = getBasicInfo();            $(getThis)                .css({                    'position': 'fixed',                    'width': setting.scroWidth,                    'top': setting.top,                    'height': basicInfo.Band_H * setting.zoom * basicInfo.ViewH * 0.01 + 'px',                    'z-index': setting.z_index,                    'background-color': setting.bgcolor,                    "border-radius": setting.borderRadius,                    'right': setting.right,                    'background-image': 'url(' + setting.scImg + ')',                    'background-image': '-webkit-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent)', 'border-radius': '2em',                    'background-size': 'contain'                });            $("#" + setting.nekoname)                .css({                    'position': 'fixed',                    'top': basicInfo.Band_H * setting.zoom * basicInfo.ViewH * 0.01 - 50 + 'px',                    'z-index': setting.z_index * 10,                    'right': setting.right,                    'background-image': 'url(' + setting.nekoImg + ')',                });            show(getBasicInfo());            $(window)                .scroll(function () {                    let basicInfo = getBasicInfo();                    show(basicInfo);                    $(getThis)                        .css({                            'position': 'fixed',                            'width': setting.scroWidth,                            'top': setting.top,                            'height': basicInfo.Band_H * setting.zoom * basicInfo.ViewH * 0.01 + 'px',                            'z-index': setting.z_index,                            'background-color': setting.bgcolor,                            "border-radius": setting.borderRadius,                            'right': setting.right,                            'background-image': 'url(' + setting.scImg + ')',                            'background-image': '-webkit-linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent)', 'border-radius': '2em',                            'background-size': 'contain'                        });                    $("#" + setting.nekoname)                        .css({                            'position': 'fixed',                            'top': basicInfo.Band_H * setting.zoom * basicInfo.ViewH * 0.01 - 50 + 'px',                            'z-index': setting.z_index * 10,                            'right': setting.right,                            'background-image': 'url(' + setting.nekoImg + ')',                        });                    if (basicInfo.ScrollTop == basicInfo.S_V) {                        $("#" + setting.nekoname)                            .addClass("showMsg")                    } else {                        $("#" + setting.nekoname)                            .removeClass("showMsg");                        $("#" + setting.nekoname)                            .attr("data-msg", setting.hoverMsg);                    }                });            this.click(function (e) {                btf.scrollToDest(0, 500)            });            $("#" + setting.nekoname)                .click(function () {                    btf.scrollToDest(0, 500)                });            return this;        }    })(jQuery);    $(document).ready(function () {        //部分自定义        $("#myscoll").nekoScroll({            bgcolor: 'rgb(0 0 0 / .5)', //背景颜色，没有绳子背景图片时有效            borderRadius: '2em',            zoom: 0.9        }        );        //自定义（去掉以下注释，并注释掉其他的查看效果）        /*        $("#myscoll").nekoScroll({            nekoname:'neko1', //nekoname，相当于id            nekoImg:'img/猫咪.png', //neko的背景图片            scImg:"img/绳1.png", //绳子的背景图片            bgcolor:'#1e90ff', //背景颜色，没有绳子背景图片时有效            zoom:0.9, //绳子长度的缩放值            hoverMsg:'你好~喵', //鼠标浮动到neko上方的对话框信息            right:'100px', //距离页面右边的距离            fontFamily:'楷体', //对话框字体            fontSize:'14px', //对话框字体的大小            color:'#1e90ff', //对话框字体颜色            scroWidth:'8px', //绳子的宽度            z_index:100, //不用解释了吧            during:1200, //从顶部到底部滑动的时长        });        */    })}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>categories</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/cursor.js"/>
      <url>/js/cursor.js</url>
      
        <content type="html"><![CDATA[/* 听话鼠标 */var CURSOR;Math.lerp = (a, b, n) => (1 - n) * a + n * b;const getStyle = (el, attr) => {    try {        return window.getComputedStyle            ? window.getComputedStyle(el)[attr]            : el.currentStyle[attr];    } catch (e) {}    return "";};class Cursor {    constructor() {        this.pos = {curr: null, prev: null};        this.pt = [];        this.create();        this.init();        this.render();    }    move(left, top) {        this.cursor.style["left"] = `${left}px`;        this.cursor.style["top"] = `${top}px`;    }    create() {        if (!this.cursor) {            this.cursor = document.createElement("div");            this.cursor.id = "cursor";            this.cursor.classList.add("hidden");            document.body.append(this.cursor);        }        var el = document.getElementsByTagName('*');        for (let i = 0; i < el.length; i++)            if (getStyle(el[i], "cursor") == "pointer")                this.pt.push(el[i].outerHTML);        document.body.appendChild((this.scr = document.createElement("style")));        // 这里改变鼠标指针的颜色 由svg生成        this.scr.innerHTML = `* {cursor: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' width='8px' height='8px'><circle cx='4' cy='4' r='4' opacity='1.0' fill='rgb(57, 197, 187)'/></svg>") 4 4, auto}`;    }    refresh() {        this.scr.remove();        this.cursor.classList.remove("hover");        this.cursor.classList.remove("active");        this.pos = {curr: null, prev: null};        this.pt = [];        this.create();        this.init();        this.render();    }    init() {        document.onmouseover  = e => this.pt.includes(e.target.outerHTML) && this.cursor.classList.add("hover");        document.onmouseout   = e => this.pt.includes(e.target.outerHTML) && this.cursor.classList.remove("hover");        document.onmousemove  = e => {(this.pos.curr == null) && this.move(e.clientX - 8, e.clientY - 8); this.pos.curr = {x: e.clientX - 8, y: e.clientY - 8}; this.cursor.classList.remove("hidden");};        document.onmouseenter = e => this.cursor.classList.remove("hidden");        document.onmouseleave = e => this.cursor.classList.add("hidden");        document.onmousedown  = e => this.cursor.classList.add("active");        document.onmouseup    = e => this.cursor.classList.remove("active");    }    render() {        if (this.pos.prev) {            this.pos.prev.x = Math.lerp(this.pos.prev.x, this.pos.curr.x, 0.15);            this.pos.prev.y = Math.lerp(this.pos.prev.y, this.pos.curr.y, 0.15);            this.move(this.pos.prev.x, this.pos.prev.y);        } else {            this.pos.prev = this.pos.curr;        }        requestAnimationFrame(() => this.render());    }}(() => {    CURSOR = new Cursor();    // 需要重新获取列表时，使用 CURSOR.refresh()})();]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/fps.js"/>
      <url>/js/fps.js</url>
      
        <content type="html"><![CDATA[if (window.localStorage.getItem("fpson") == undefined || window.localStorage.getItem("fpson") == "1") {    var rAF = function () {        return (            window.requestAnimationFrame ||            window.webkitRequestAnimationFrame ||            function (callback) {                window.setTimeout(callback, 1000 / 60);            }        );    }();    var frame = 0;    var allFrameCount = 0;    var lastTime = Date.now();    var lastFameTime = Date.now();    var loop = function () {        var now = Date.now();        var fs = (now - lastFameTime);        var fps = Math.round(1000 / fs);        lastFameTime = now;        // 不置 0，在动画的开头及结尾记录此值的差值算出 FPS        allFrameCount++;        frame++;        if (now > 1000 + lastTime) {            var fps = Math.round((frame * 1000) / (now - lastTime));            if (fps <= 5) {                var kd = `<span style="color:#bd0000">卡成ppt🤢</span>`            } else if (fps <= 15) {                var kd = `<span style="color:red">电竞级帧率😖</span>`            } else if (fps <= 25) {                var kd = `<span style="color:orange">有点难受😨</span>`            } else if (fps < 35) {                var kd = `<span style="color:#9338e6">不太流畅🙄</span>`            } else if (fps <= 45) {                var kd = `<span style="color:#08b7e4">还不错哦😁</span>`            } else {                var kd = `<span style="color:#39c5bb">十分流畅🤣</span>`            }            document.getElementById("fps").innerHTML = `FPS:${fps} ${kd}`;            frame = 0;            lastTime = now;        };        rAF(loop);    }    loop();} else {    document.getElementById("fps").style = "display:none!important"}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/readPercent.js"/>
      <url>/js/readPercent.js</url>
      
        <content type="html"><![CDATA[window.onscroll = percent;// 执行函数// 页面百分比function percent() {    let a = document.documentElement.scrollTop || window.pageYOffset, // 卷去高度        b = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight, document.body.offsetHeight, document.documentElement.offsetHeight, document.body.clientHeight, document.documentElement.clientHeight) - document.documentElement.clientHeight, // 整个网页高度        result = Math.round(a / b * 100), // 计算百分比        up = document.querySelector("#go-up") // 获取按钮    if (result <= 95) {        up.childNodes[0].style.display = 'none'        up.childNodes[1].style.display = 'block'        up.childNodes[1].innerHTML = result;    } else {        up.childNodes[1].style.display = 'none'        up.childNodes[0].style.display = 'block'    }}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/rightmenu.js"/>
      <url>/js/rightmenu.js</url>
      
        <content type="html"><![CDATA[function setMask() {    //设置遮罩    if (document.getElementsByClassName("rmMask")[0] != undefined)        return document.getElementsByClassName("rmMask")[0];    mask = document.createElement('div');    mask.className = "rmMask";    mask.style.width = window.innerWidth + 'px';    mask.style.height = window.innerHeight + 'px';    mask.style.background = '#fff';    mask.style.opacity = '.0';    mask.style.position = 'fixed';    mask.style.top = '0';    mask.style.left = '0';    mask.style.zIndex = 998;    document.body.appendChild(mask);    document.getElementById("rightMenu").style.zIndex = 19198;    return mask;}function insertAtCursor(myField, myValue) {    //IE 浏览器    if (document.selection) {        myField.focus();        sel = document.selection.createRange();        sel.text = myValue;        sel.select();    }    //FireFox、Chrome等    else if (myField.selectionStart || myField.selectionStart == '0') {        var startPos = myField.selectionStart;        var endPos = myField.selectionEnd;        // 保存滚动条        var restoreTop = myField.scrollTop;        myField.value = myField.value.substring(0, startPos) + myValue + myField.value.substring(endPos, myField.value.length);        if (restoreTop > 0) {            myField.scrollTop = restoreTop;        }        myField.focus();        myField.selectionStart = startPos + myValue.length;        myField.selectionEnd = startPos + myValue.length;    } else {        myField.value += myValue;        myField.focus();    }}let rmf = {};rmf.showRightMenu = function (isTrue, x = 0, y = 0) {    let $rightMenu = $('#rightMenu');    $rightMenu.css('top', x + 'px').css('left', y + 'px');    if (isTrue) {        $rightMenu.show();    } else {        $rightMenu.hide();    }}rmf.copyWordsLink = function () {    let url = window.location.href    let txa = document.createElement("textarea");    txa.value = url;    document.body.appendChild(txa)    txa.select();    document.execCommand("Copy");    document.body.removeChild(txa);}rmf.switchReadMode = function () {    const $body = document.body    $body.classList.add('read-mode')    const newEle = document.createElement('button')    newEle.type = 'button'    newEle.className = 'fas fa-sign-out-alt exit-readmode'    $body.appendChild(newEle)    function clickFn() {        $body.classList.remove('read-mode')        newEle.remove()        newEle.removeEventListener('click', clickFn)    }    newEle.addEventListener('click', clickFn)}//复制选中文字rmf.copySelect = function () {    document.execCommand('Copy', false, null);}//回到顶部rmf.scrollToTop = function () {    document.getElementsByClassName("menus_items")[1].setAttribute("style", "");    document.getElementById("name-container").setAttribute("style", "display:none");    btf.scrollToDest(0, 500);}document.body.addEventListener('touchmove', function () {}, { passive: false });function popupMenu() {    window.oncontextmenu = function (event) {        // if (event.ctrlKey) return true;        // 当关掉自定义右键时候直接返回        if (mouseMode == "off") return true;        $('.rightMenu-group.hide').hide();        if (document.getSelection().toString()) {            $('#menu-text').show();        }        if (document.getElementById('post')) {            $('#menu-post').show();        } else {            if (document.getElementById('page')) {                $('#menu-post').show();            }        }        var el = window.document.body;        el = event.target;        var a = /^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\*\+,;=.]+$/        if (a.test(window.getSelection().toString()) && el.tagName != "A") {            $('#menu-too').show()        }        if (el.tagName == 'A') {            $('#menu-to').show()            rmf.open = function () {                if (el.href.indexOf("http://") == -1 && el.href.indexOf("https://") == -1 || el.href.indexOf("yisous.xyz") != -1) {                    pjax.loadUrl(el.href)                }                else {                    location.href = el.href                }            }            rmf.openWithNewTab = function () {                window.open(el.href);                // window.location.reload();            }            rmf.copyLink = function () {                let url = el.href                let txa = document.createElement("textarea");                txa.value = url;                document.body.appendChild(txa)                txa.select();                document.execCommand("Copy");                document.body.removeChild(txa);            }        } else if (el.tagName == 'IMG') {            $('#menu-img').show()            rmf.openWithNewTab = function () {                window.open(el.src);                // window.location.reload();            }            rmf.click = function () {                el.click()            }            rmf.copyLink = function () {                let url = el.src                let txa = document.createElement("textarea");                txa.value = url;                document.body.appendChild(txa)                txa.select();                document.execCommand("Copy");                document.body.removeChild(txa);            }            rmf.saveAs = function () {                var a = document.createElement('a');                var url = el.src;                var filename = url.split("/")[-1];                a.href = url;                a.download = filename;                a.click();                window.URL.revokeObjectURL(url);            }        } else if (el.tagName == "TEXTAREA" || el.tagName == "INPUT") {            $('#menu-paste').show();            rmf.paste = function () {                navigator.permissions                    .query({                        name: 'clipboard-read'                    })                    .then(result => {                        if (result.state == 'granted' || result.state == 'prompt') {                            //读取剪贴板                            navigator.clipboard.readText().then(text => {                                console.log(text)                                insertAtCursor(el, text)                            })                        } else {                            Snackbar.show({                                text: '请允许读取剪贴板！',                                pos: 'top-center',                                showAction: false,                            })                        }                    })            }        }        let pageX = event.clientX + 10;        let pageY = event.clientY;        let rmWidth = $('#rightMenu').width();        let rmHeight = $('#rightMenu').height();        if (pageX + rmWidth > window.innerWidth) {            pageX -= rmWidth + 10;        }        if (pageY + rmHeight > window.innerHeight) {            pageY -= pageY + rmHeight - window.innerHeight;        }        mask = setMask();        // 滚动消失的代码和阅读进度有冲突，因此放到readPercent.js里面了        $(".rightMenu-item").click(() => {            $('.rmMask').attr('style', 'display: none');        })        $(window).resize(() => {            rmf.showRightMenu(false);            $('.rmMask').attr('style', 'display: none');        })        mask.onclick = () => {            $('.rmMask').attr('style', 'display: none');        }        rmf.showRightMenu(true, pageY, pageX);        $('.rmMask').attr('style', 'display: flex');        return false;    };    window.addEventListener('click', function () {        rmf.showRightMenu(false);    });}if (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))) {    popupMenu()}const box = document.documentElementfunction addLongtabListener(target, callback) {    let timer = 0 // 初始化timer    target.ontouchstart = () => {        timer = 0 // 重置timer        timer = setTimeout(() => {            callback();            timer = 0        }, 380) // 超时器能成功执行，说明是长按    }    target.ontouchmove = () => {        clearTimeout(timer) // 如果来到这里，说明是滑动        timer = 0    }    target.ontouchend = () => { // 到这里如果timer有值，说明此触摸时间不足380ms，是点击        if (timer) {            clearTimeout(timer)        }    }}addLongtabListener(box, popupMenu)// 全屏rmf.fullScreen = function () {    if (document.fullscreenElement) document.exitFullscreen();    else document.documentElement.requestFullscreen();}// 右键开关if (localStorage.getItem("mouse") == undefined) {    localStorage.setItem("mouse", "on");}var mouseMode = localStorage.getItem("mouse");function changeMouseMode() {    if (localStorage.getItem("mouse") == "on") {        mouseMode = "off";        localStorage.setItem("mouse", "off");        debounce(function () {            new Vue({                data: function () {                    this.$notify({                        title: "切换右键模式成功🍔",                        message: "当前鼠标右键已恢复为系统默认！",                        position: 'top-left',                        offset: 50,                        showClose: true,                        type: "success",                        duration: 5000                    });                }            })        }, 300);    } else {        mouseMode = "on";        localStorage.setItem("mouse", "on");        debounce(function () {            new Vue({                data: function () {                    this.$notify({                        title: "切换右键模式成功🍔",                        message: "当前鼠标右键已更换为网站指定样式！",                        position: 'top-left',                        offset: 50,                        showClose: true,                        type: "success",                        duration: 5000                    });                }            })        }, 300);    }}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/runtime.js"/>
      <url>/js/runtime.js</url>
      
        <content type="html"><![CDATA[var now = new Date();function createtime() {  // 当前时间  now.setTime(now.getTime() + 1000);  var start = new Date("08/01/2022 00:00:00"); // 旅行者1号开始计算的时间  var dis = Math.trunc(23400000000 + ((now - start) / 1000) * 17); // 距离=秒数*速度 记住转换毫秒  var unit = (dis / 149600000).toFixed(6);  // 天文单位  var grt = new Date("03/26/2023 00:00:00");// 网站诞生时间  var days = (now - grt) / 1e3 / 60 / 60 / 24,    dnum = Math.floor(days),    hours = (now - grt) / 1e3 / 60 / 60 - 24 * dnum,    hnum = Math.floor(hours);  1 == String(hnum).length && (hnum = "0" + hnum);  var minutes = (now - grt) / 1e3 / 60 - 1440 * dnum - 60 * hnum,    mnum = Math.floor(minutes);  1 == String(mnum).length && (mnum = "0" + mnum);  var seconds = (now - grt) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,    snum = Math.round(seconds);  1 == String(snum).length && (snum = "0" + snum);  let currentTimeHtml = "";  (currentTimeHtml =    hnum < 18 && hnum >= 9    ? `<img class='boardsign' src='https://demo-immg.oss-cn-shanghai.aliyuncs.com/blog/yejiaodaima/Fwu.svg' title='什么时候能够实现财富自由呀~'><br> <div style="font-size:13px;font-weight:bold">本站居然运行了 ${dnum} 天 ${hnum} 小时 ${mnum} 分 ${snum} 秒 <i id="heartbeat" class='fas fa-heartbeat'></i> <br> 旅行者 1 号当前距离地球 ${dis} 千米，约为 ${unit} 个天文单位 🚀</div>`    : `<img class='boardsign' src='https://demo-immg.oss-cn-shanghai.aliyuncs.com/blog/yejiaodaima/Fxiao.svg' title='下班了就该开开心心地玩耍~'><br> <div style="font-size:13px;font-weight:bold">本站居然运行了 ${dnum} 天 ${hnum} 小时 ${mnum} 分 ${snum} 秒 <i id="heartbeat" class='fas fa-heartbeat'></i> <br> 旅行者 1 号当前距离地球 ${dis} 千米，约为 ${unit} 个天文单位 🚀</div>`),    document.getElementById("workboard") &&    (document.getElementById("workboard").innerHTML = currentTimeHtml);}// 设置重复执行函数，周期1000mssetInterval(() => {  createtime();}, 1000);]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/sun_moon.js"/>
      <url>/js/sun_moon.js</url>
      
        <content type="html"><![CDATA[function switchNightMode() {    document.querySelector('body').insertAdjacentHTML('beforeend', '<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"><div id="sun"></div><div id="moon"></div></div></div>'),        setTimeout(function () {            document.querySelector('body').classList.contains('DarkMode') ? (document.querySelector('body').classList.remove('DarkMode'), localStorage.setItem('isDark', '0'), document.getElementById('modeicon').setAttribute('xlink:href', '#icon-moon')) : (document.querySelector('body').classList.add('DarkMode'), localStorage.setItem('isDark', '1'), document.getElementById('modeicon').setAttribute('xlink:href', '#icon-sun')),                setTimeout(function () {                    document.getElementsByClassName('Cuteen_DarkSky')[0].style.transition = 'opacity 3s';                    document.getElementsByClassName('Cuteen_DarkSky')[0].style.opacity = '0';                    setTimeout(function () {                        document.getElementsByClassName('Cuteen_DarkSky')[0].remove();                    }, 1e3);                }, 2e3)        })    const nowMode = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'    if (nowMode === 'light') {        // 先设置太阳月亮透明度        document.getElementById("sun").style.opacity = "1";        document.getElementById("moon").style.opacity = "0";        setTimeout(function () {            document.getElementById("sun").style.opacity = "0";            document.getElementById("moon").style.opacity = "1";        }, 1000);        activateDarkMode()        saveToLocal.set('theme', 'dark', 2)        // GLOBAL_CONFIG.Snackbar !== undefined && btf.snackbarShow(GLOBAL_CONFIG.Snackbar.day_to_night)        document.getElementById('modeicon').setAttribute('xlink:href', '#icon-sun')        // 延时弹窗提醒        setTimeout(() => {            new Vue({                data: function () {                    this.$notify({                        title: "关灯啦🌙",                        message: "当前已成功切换至夜间模式！",                        position: 'top-left',                        offset: 50,                        showClose: true,                        type: "success",                        duration: 5000                    });                }            })        }, 2000)    } else {        // 先设置太阳月亮透明度        document.getElementById("sun").style.opacity = "0";        document.getElementById("moon").style.opacity = "1";        setTimeout(function () {            document.getElementById("sun").style.opacity = "1";            document.getElementById("moon").style.opacity = "0";        }, 1000);                activateLightMode()        saveToLocal.set('theme', 'light', 2)        document.querySelector('body').classList.add('DarkMode'), document.getElementById('modeicon').setAttribute('xlink:href', '#icon-moon')        setTimeout(() => {            new Vue({                data: function () {                    this.$notify({                        title: "开灯啦🌞",                        message: "当前已成功切换至白天模式！",                        position: 'top-left',                        offset: 50,                        showClose: true,                        type: "success",                        duration: 5000                    });                }            })        }, 2000)    }    // handle some cases    typeof utterancesTheme === 'function' && utterancesTheme()    typeof FB === 'object' && window.loadFBComment()    window.DISQUS && document.getElementById('disqus_thread').children.length && setTimeout(() => window.disqusReset(), 200)}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/shuijiwen.js"/>
      <url>/js/shuijiwen.js</url>
      
        <content type="html"><![CDATA[// 发现有时会和当前页面重复，加一个判断function randomPost() {    fetch('/baidusitemap.xml').then(res => res.text()).then(str => (new window.DOMParser()).parseFromString(str, "text/xml")).then(data => {        let ls = data.querySelectorAll('url loc');        while (true) {            let url = ls[Math.floor(Math.random() * ls.length)].innerHTML;            if (location.href == url) continue;            location.href = url;            return;        }    })}// 阅读文章时看了一遍写的代码，发现加个数组和一个遍历完全没必要，改成下面这个即可。// function randomPost() {//     fetch('/baidusitemap.xml').then(res => res.text()).then(str => (new window.DOMParser()).parseFromString(str, "text/xml")).then(data => {//         let ls = data.querySelectorAll('url loc');//         location.href = ls[Math.floor(Math.random() * ls.length)].innerHTML//     })// }// 旧代码// function randomPost() {    // fetch('/baidusitemap.xml').then(res => res.text()).then(str => (new window.DOMParser()).parseFromString(str, "text/xml")).then(data => {    //     let ls = data.querySelectorAll('url loc');    //     let list = [];    //     ls.forEach(i => list.push(i.innerHTML))    //     location.href = list[Math.floor(Math.random() * ls.length)]    // })// }]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/title.js"/>
      <url>/js/title.js</url>
      
        <content type="html"><![CDATA[//动态标题var OriginTitile = document.title;var titleTime;document.addEventListener('visibilitychange', function () {  if (document.hidden) {    //离开当前页面时标签显示内容    document.title = '👀快来看美人出浴图~';    clearTimeout(titleTime);  } else {    //返回当前页面时标签显示内容    document.title = '🐖魔法师的博客～';    //两秒后变回正常标题    titleTime = setTimeout(function () {      document.title = OriginTitile;    }, 2000);  }});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/js/universe.js"/>
      <url>/js/universe.js</url>
      
        <content type="html"><![CDATA[function dark() {window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;var n,e,i,h,t=.05,s=document.getElementById("universe"),o=!0,a="180,184,240",r="226,225,142",d="226,225,224",c=[];function f(){n=window.innerWidth,e=window.innerHeight,i=.216*n,s.setAttribute("width",n),s.setAttribute("height",e)}function u(){h.clearRect(0,0,n,e);for(var t=c.length,i=0;i<t;i++){var s=c[i];s.move(),s.fadeIn(),s.fadeOut(),s.draw()}}function y(){this.reset=function(){this.giant=m(3),this.comet=!this.giant&&!o&&m(10),this.x=l(0,n-10),this.y=l(0,e),this.r=l(1.1,2.6),this.dx=l(t,6*t)+(this.comet+1-1)*t*l(50,120)+2*t,this.dy=-l(t,6*t)-(this.comet+1-1)*t*l(50,120),this.fadingOut=null,this.fadingIn=!0,this.opacity=0,this.opacityTresh=l(.2,1-.4*(this.comet+1-1)),this.do=l(5e-4,.002)+.001*(this.comet+1-1)},this.fadeIn=function(){this.fadingIn&&(this.fadingIn=!(this.opacity>this.opacityTresh),this.opacity+=this.do)},this.fadeOut=function(){this.fadingOut&&(this.fadingOut=!(this.opacity<0),this.opacity-=this.do/2,(this.x>n||this.y<0)&&(this.fadingOut=!1,this.reset()))},this.draw=function(){if(h.beginPath(),this.giant)h.fillStyle="rgba("+a+","+this.opacity+")",h.arc(this.x,this.y,2,0,2*Math.PI,!1);else if(this.comet){h.fillStyle="rgba("+d+","+this.opacity+")",h.arc(this.x,this.y,1.5,0,2*Math.PI,!1);for(var t=0;t<30;t++)h.fillStyle="rgba("+d+","+(this.opacity-this.opacity/20*t)+")",h.rect(this.x-this.dx/4*t,this.y-this.dy/4*t-2,2,2),h.fill()}else h.fillStyle="rgba("+r+","+this.opacity+")",h.rect(this.x,this.y,this.r,this.r);h.closePath(),h.fill()},this.move=function(){this.x+=this.dx,this.y+=this.dy,!1===this.fadingOut&&this.reset(),(this.x>n-n/4||this.y<0)&&(this.fadingOut=!0)},setTimeout(function(){o=!1},50)}function m(t){return Math.floor(1e3*Math.random())+1<10*t}function l(t,i){return Math.random()*(i-t)+t}f(),window.addEventListener("resize",f,!1),function(){h=s.getContext("2d");for(var t=0;t<i;t++)c[t]=new y,c[t].reset();u()}(),function t(){document.getElementsByTagName('html')[0].getAttribute('data-theme')=='dark'&&u(),window.requestAnimationFrame(t)}()};dark()]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>电影</title>
      <link href="/movies/index.html"/>
      <url>/movies/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>音乐</title>
      <link href="/music/index.html"/>
      <url>/music/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>友链</title>
      <link href="/link/index.html"/>
      <url>/link/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>tags</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
  
</search>
